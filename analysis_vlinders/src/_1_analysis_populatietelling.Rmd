

# Vlinders - gebiedstelling"

```{r}

species_group <- "vlinders"
protocol_selection <- c("Vlinders - Gebiedstelling", "Vlinders - Gebiedstelling (v1)", "Vlinders - Gebiedstelling (mobiel)")
name_analysis <- "vlinders_gebiedstelling"

set.seed(4783023)
```

## Selectie analyseset

```{r select data gebieds, warning = FALSE}

locatie_detail <- get_locations_smp() %>%
  st_drop_geometry() %>%
  filter(locatie_type == "locatie") %>%
  select(meetnet, locatie, is_active, is_sample)

visits <- get_visits_smp(species_group) %>%
  filter(protocol %in% protocol_selection) %>%
  mutate(protocol = "Vlinders - Gebiedstelling")
  
counts <- get_counts_smp(species_group = species_group, count_aggregation = "individuals") %>%
  filter(primaire_soort) %>%
  filter(protocol %in% protocol_selection) %>%
  mutate(protocol = "Vlinders - Gebiedstelling")

count_period <- get_characteristics_smp() %>%
  mutate(doy_min = as.numeric(format(start_telperiode, "%j")),
         doy_max = as.numeric(format(einde_telperiode, "%j")),
         doy_mid = doy_min + round((doy_max - doy_min)/2, 0)) %>%
  distinct(meetnet, protocol, doy_min, doy_max, doy_mid)

meetnetten_selection <- visits %>%
  group_by(meetnet, protocol) %>%
  summarise(n_jaar = n_distinct(jaar)) %>%
  filter(n_jaar >= 3)

visits_selection <- visits %>%
  filter(meetnet %in% meetnetten_selection$meetnet) %>%
  filter(validatie != -1) %>%
  left_join(locatie_detail, by = c("meetnet", "locatie")) %>%
  filter(voor_analyse & !is.na(is_active)) %>%
  left_join(count_period, by = c("meetnet", "protocol")) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         fjaar = factor(jaar)) %>%
  group_by(soortgroep, meetnet, protocol, locatie, jaar, fjaar) %>%
  mutate(n_obs = n_distinct(visit_id)) %>%
  ungroup()

counts_selection <- visits_selection %>%
  select(soortgroep, meetnet, protocol, locatie, jaar, datum, doy, doy_scaled, doy_min, doy_max, doy_mid, visit_id, n_obs, voor_analyse, is_active, is_sample, bezoek_status, bezoek_status_oud) %>%
  left_join(select(counts, visit_id, soort_nl, soort_wet, aantal), by = "visit_id")

```


```{r}

counts_analysis <- counts_selection %>%
  group_by(meetnet, locatie) %>%
  mutate(n_jaren = n_distinct(jaar),
            max_count = max(aantal)) %>%
  ungroup() %>%
  filter(n_jaren > 1 & max_count > 0) %>%
  mutate(fjaar = factor(jaar),
         locatie = factor(locatie),
         doy_scaled_2 = doy_scaled * doy_scaled)
  
analyseset_by_species <- counts_analysis %>%
  group_by(meetnet) %>%
  nest()


``` 

```{r}

write_vc(counts_analysis, 
         file = str_c("analyseset_", name_analysis), 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("meetnet", "locatie", "visit_id"), 
         strict = FALSE)
  
```

## Dataverkenning

```{r}
  
# counts_analysis %>%
#   group_split(meetnet) %>%
#   map(~ggplot(., aes(x = doy, y = aantal)) +
#   geom_point() +
#   geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 0.4, colour = "blue") +
#   facet_grid(meetnet ~ jaar))

counts_analysis %>%
  filter(meetnet == "Grote weerschijnvlinder") %>%
  ggplot(aes(x = doy, y = aantal)) +
  geom_point() +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 6) , size = 0.4, colour = "blue") +
  facet_grid(meetnet ~ jaar)

counts_analysis %>%
  filter(meetnet == "Bruine eikenpage") %>%
  ggplot(aes(x = doy, y = aantal)) +
  geom_point() +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 0.4, colour = "blue") +
  facet_grid(meetnet ~ jaar)

counts_analysis %>%
  filter(meetnet == "Bruine eikenpage") %>%
  mutate(jaar = factor(jaar)) %>%
  ggplot(aes(x = doy, y = aantal, group = jaar, colour = jaar, fill = jaar)) +
  #geom_point(alpha = 0.4) +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 1) 


```


## Modelering

```{r test, eval = FALSE}

analyseset_species <- counts_analysis %>%
  filter(meetnet == "Bruine eikenpage")

set.seed(536382)
indexmodel_nbinom_inla <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species)
indexmodel_nbinom_inla$summary.fixed
indexmodel_nbinom_inla$summary.hyperpar

set.seed(383735)
indexmodel_nbinom_inlabru <- fit_indexmodel_nbinom_inlabru(analyseset_species)
indexmodel_nbinom_inla$summary.fixed
indexmodel_nbinom_inla$summary.hyperpar

set.seed(65243)
trendmodel_nbinom_inlabru <- fit_trendmodel_nbinom_inlabru(analyseset_species = analyseset_species)
summary(trendmodel_nbinom_inlabru)

set.seed(98363)
index <- derive_index_inla(analyseset_species, indexmodel_nbinom_inla)

set.seed(35367)
max_count <- derive_max_count_inla(analyseset_species, indexmodel_nbinom_inla)

set.seed(353637)
trend <- derive_trend_inlabru(analyseset_species, trendmodel_nbinom_inlabru)

plot(dispersion_check(indexmodel_nbinom_inla))

plot(fast_distribution_check(indexmodel_nbinom_inla))



```
### Modellering seizoenaliteit

Varianten:

+ enkel jaareffect, geen dageffect
+ jaareffect en 2de graadspolynoom dageffect (seizoenseffect identiek voor alle jaren)
+ jaareffect en interactie jaareffect/2de graadspolynoom dageffect (seizoenseffect verschilt per jaar)

```{r}
analyseset_species <- counts_analysis %>%
  filter(meetnet == "Bruine eikenpage")

analyseset_species <- analyseset_species %>%
    mutate(fjaar = factor(jaar),
           locatie = as.character(locatie),
           locatie = as.factor(locatie))
  
prec.prior <- list(prec = list(param = c(0.001, 0.001)))

model.matrix(~fjaar, analyseset_species) %>% # create dummy variable for year
  as.data.frame() %>%
  select(-1) %>% # drop intercept
  bind_cols(analyseset_species) -> analyseset_species_bru

analyseset_species_bru <- analyseset_species_bru %>%
  mutate(loc_id = as.integer(factor(locatie)))

n_loc <- n_distinct(analyseset_species_bru$locatie)

fjaar_formula <- analyseset_species_bru %>%
  select(starts_with("fjaar"), -fjaar) %>% 
  unique() %>%
  colnames() %>%
  str_c(collapse = " + ")

# inla - no season effect

indexmodel_nbinom_iid <- inla(aantal ~ fjaar + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

# inlabru - no season effect

comp_inlabru <- as.formula(str_c("aantal ~ ", 
                                   fjaar_formula, 
                                   "+ site(map = loc_id, model = \"iid\", n = n_loc, hyper = prec.prior)",
                                   sep = ""))
  
indexmodel_nbinom_iid_inlabru <- bru(comp_inlabru, data = analyseset_species_bru, family = "nbinomial")

# inla - with season effect

indexmodel_nbinom_doy_iid <- inla(aantal ~ fjaar + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

# inlabru - with season effect

comp_inlabru <- as.formula(str_c("aantal ~ doy_scaled + doy_scaled_2", 
                                   fjaar_formula, 
                                   "site(map = loc_id, model = \"iid\", n = n_loc, hyper = prec.prior)",
                                   sep = " + "))
  
indexmodel_nbinom_doy_iid_inlabru <- bru(comp_inlabru, data = analyseset_species_bru, family = "nbinomial")

# inla - with season effect per year

indexmodel_nbinom_test <- inla(aantal ~ fjaar + doy_scaled:fjaar + doy_scaled_2:fjaar + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

result_no_seasonality_inla <- derive_index_inla(analyseset_species, indexmodel_nbinom_iid) %>%
  mutate(type = "no season effect",
         package = "inla") %>%
  select(package, type, everything())

result_no_seasonality_inlabru <- derive_index_inlabru(analyseset_species, indexmodel_nbinom_iid_inlabru) %>%
  mutate(type = "no season effect",
         package = "inlabru") %>%
  select(package, type, everything())

result_seasonality_inla <- derive_index_inla(analyseset_species, indexmodel_nbinom_doy_iid)  %>%
  mutate(type = "season effect",
         package = "inla") %>%
  select(package, type, everything())

result_seasonality_inlabru <- derive_index_inlabru(analyseset_species, indexmodel_nbinom_doy_iid_inlabru)  %>%
  mutate(type = "season effect",
         package = "inlabru") %>%
  select(package, type, everything())

result_seasonality_test <- derive_index_inla(analyseset_species, indexmodel_nbinom_test)  %>%
  mutate(type = "season effect per year",
         package = "inla") %>%
  select(package, type, everything())

bind_rows(result_no_seasonality_inla,
          result_no_seasonality_inlabru,
          result_seasonality_inla,
          result_seasonality_inlabru,
          result_seasonality_test) %>%
  select(package, type, soort_nl, jaar, mean, lcl_0.90, ucl_0.90) %>%
  kable() %>%
  kable_styling()

# plot(dispersion_check(indexmodel_nbinom_iid))
# 
# plot(fast_distribution_check(indexmodel_nbinom_iid))

fixed_effects_M1 <- indexmodel_nbinom_iid$summary.fixed %>%
  add_rownames(var = "parameter") %>%
  select(parameter, mean, "0.025quant", "0.975quant")

fixed_effects_M3 <- indexmodel_nbinom_test$summary.fixed %>%
  add_rownames(var = "parameter") %>%
  select(parameter, mean, "0.025quant", "0.975quant")

fixed_effects_M2 <- indexmodel_nbinom_doy_iid$summary.fixed %>%
  add_rownames(var = "parameter") %>%
  select(parameter, mean, "0.025quant", "0.975quant")





```



```{r}
data_sim <- analyseset_species %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy_mid, doy = full_seq(doy, 1)) %>%
  mutate(doy_scaled = (doy - doy_mid)/28) %>%
  mutate(aantal_predict_m3 = ifelse(fjaar == 2018, 1.2409078 + doy_scaled * (-4.2923265) + doy_scaled * doy_scaled * (-3.6761174),
                                 ifelse(fjaar == 2019, 1.2409078 - 0.5393773  + doy_scaled * (-1.5946901) + doy_scaled * doy_scaled * (-2.5266631),
                                 ifelse(fjaar == 2020, 1.2409078 - 0.6784697  + doy_scaled * (-0.5388839) + doy_scaled * doy_scaled * (-0.3413522),
                                 ifelse(fjaar == 2021, 1.2409078 + 0.3788856  + doy_scaled * (3.1001747) + doy_scaled * doy_scaled * (-6.9995236	), NA)))),
         aantal_predict_m2 = ifelse(fjaar == 2018,  1.6311418 + doy_scaled * (-1.3495344	) + doy_scaled * doy_scaled * (-0.8584400),
                                 ifelse(fjaar == 2019, 1.6311418 - 0.9596684 + doy_scaled * (-1.3495344	) + doy_scaled * doy_scaled * (-0.8584400),
                                 ifelse(fjaar == 2020,  1.6311418 - 1.0126010 + doy_scaled * (-1.3495344	) + doy_scaled * doy_scaled * (-0.8584400),
                                 ifelse(fjaar == 2021, 1.6311418 + 0.0992148 + doy_scaled * (-1.3495344	) + doy_scaled * doy_scaled * (-0.8584400), NA)))),
         aantal_predict_m1 = ifelse(fjaar == 2018, 1.8162725	,
                                 ifelse(fjaar == 2019, 1.8162725	- 1.1072072,
                                 ifelse(fjaar == 2020, 1.8162725 - 1.2573584 ,
                                 ifelse(fjaar == 2021, 1.8162725 - 0.6250479, NA))))) %>%
  mutate(seizoenseffect = exp(aantal_predict_m2),
         seizoenseffect_jaar = exp(aantal_predict_m3),
          geen_seizoenseffect = exp(aantal_predict_m1)) %>%
  left_join(select(analyseset_species, aantal, fjaar, doy), by = c("fjaar", "doy")) %>%
  pivot_longer(cols = c(geen_seizoenseffect, seizoenseffect, seizoenseffect_jaar), names_to = "model", values_to = "aantal_predict")
               


```


```{r, fig.cap = "Gemodelleerde aantallen per jaar voor verschillende modellen"}
data_sim %>%
  ggplot(aes(x = doy, y = aantal_predict, group = fjaar, colour = fjaar)) +
  geom_line() +
  facet_wrap(~ model)
```


```{r, fig.cap = "Gemodelleerde aantallen en geobserveerde aantallen v"}
ggplot(data = data_sim, aes(x = doy, y = aantal_predict, colour = fjaar)) +
  geom_line() +
  geom_point(data = data_sim, aes(x = doy, y = aantal), alpha = 0.4) +
  facet_grid(fjaar ~ model)
  
```

```{r}

analyseset_species <- analyseset_species %>%
    mutate(min_year = min(jaar),
           year_scaled = jaar - min_year)

trendmodel_nbinom_doy_iid <- inla(aantal ~ year_scaled + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                  family = "nbinomial",
                                  data = analyseset_species,
                                  control.compute = list(config = TRUE, waic = TRUE),
                                  control.predictor = list(compute = TRUE))

trendmodel_nbinom_iid <- inla(aantal ~ year_scaled + f(locatie, model = "iid", hyper = prec.prior),
                                  family = "nbinomial",
                                  data = analyseset_species,
                                  control.compute = list(config = TRUE, waic = TRUE),
                                  control.predictor = list(compute = TRUE))

trend_seasoneffect_inla <- derive_trend(analyseset_species, trendmodel_nbinom_doy_iid) %>%
  mutate(type = "season effect",
         package = "inla") %>%
  select(package, type, everything())

trend_noseasoneffect_inla <- derive_trend(analyseset_species, trendmodel_nbinom_iid) %>%
  mutate(type = "no season effect",
         package = "inla") %>%
  select(package, type, everything())

analyseset_species <- analyseset_species %>%
  mutate(loc_id = as.integer(factor(locatie)))

formula_no_seasoneffect <- aantal ~  year_scaled +
  site(map = loc_id, model = "iid", n = n_loc, hyper = prec.prior)

trendmodel_no_seasoneffect_inlabru <- bru(formula_no_seasoneffect, 
                                 data = analyseset_species, 
                                 family = "nbinomial")

formula_seasoneffect <- aantal ~  year_scaled + doy_scaled + doy_scaled_2 +
  site(map = loc_id, model = "iid", n = n_loc, hyper = prec.prior)

trendmodel_seasoneffect_inlabru <- bru(formula_seasoneffect, 
                                 data = analyseset_species, 
                                 family = "nbinomial")

trend_seasoneffect_inlabru <- derive_trend(analyseset_species, trendmodel_seasoneffect_inlabru) %>%
  mutate(type = "season effect",
         package = "inlabru") %>%
  select(package, type, everything())

trend_noseasoneffect_inlabru <- derive_trend(analyseset_species, trendmodel_no_seasoneffect_inlabru) %>%
  mutate(type = "no season effect",
         package = "inlabru") %>%
  select(package, type, everything())

bind_rows(trend_noseasoneffect_inla,
          trend_noseasoneffect_inlabru,
          trend_seasoneffect_inla,
          trend_seasoneffect_inlabru) %>%
  select(package, type, soort_nl, mean, lcl_0.90, ucl_0.90) %>%
  kable() %>%
  kable_styling()
```





```{r}
models_inlabru <- analyseset_by_species %>% 
  mutate(indexmodel = map(data, fit_indexmodel_nbinom_inlabru),
         trendmodel = map(data, fit_trendmodel_nbinom_inlabru))

models_inla <- analyseset_by_species %>%
  mutate(indexmodel = map(data, fit_indexmodel_nbinom_inla))

results_indexmodel <- models_inla %>%
  transmute(index = map2(data, indexmodel, derive_index_inla),
            max_count = map2(data, indexmodel, derive_max_count_inla))

results_trendmodel <- models_inlabru %>%
  transmute(trend = map2(data, trendmodel, derive_trend_inlabru),
            waic_index =  map2(data, indexmodel, get_waic_inlabru),
            waic_trend = map2(data, trendmodel, get_waic_inlabru))

```

```{r}
results_index <- results_indexmodel %>%
  select(meetnet, index) %>%
  unnest(index)

results_max_count <- results_indexmodel %>%
  select(meetnet, max_count) %>%
  unnest(max_count)

# results_diff_years <- results_indexmodel %>%
#   select(meetnet, diff_years) %>%
#   unnest(diff_years)

results_trend <- results_trendmodel %>%
  select(meetnet, trend) %>%
  unnest(trend)

results_waic_index <- results_trendmodel %>%
  select(meetnet, waic_index) %>%
  unnest(waic_index) %>%
  mutate(model = "indexmodel")

results_waic_trend <- results_trendmodel %>%
  select(meetnet, waic_trend) %>%
  unnest(waic_trend) %>%
  mutate(model = "trendmodel")

results_waic <- bind_rows(results_waic_index, 
                         results_waic_trend) %>%
  spread(key = "model", value = "waic") %>%
  mutate(diff_waic = trendmodel - indexmodel,
         type_trend = ifelse(diff_waic > 0,
                               "Niet lineair",
                               ifelse(diff_waic > -2,
                                      "Quasi lineair", "Lineair")))

```

```{r}

bind_rows(results_index, 
          results_max_count) %>%
  write_vc(file = "results_indexmodel", 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("parameter", "soort_nl", "jaar"),
         strict = FALSE)

results_trend %>%
  write_vc(file = "results_trendmodel", 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("parameter", "soort_nl"), strict = FALSE)

results_waic %>%
  write_vc(file = "results_waic", 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("parameter", "soort_nl"),
         strict = FALSE)

```


## Validatie

```{r}
model_validation <- models_inla %>%
  transmute(dispersion_check_model = map(indexmodel, dispersion_check),
            distribution_check_model = map(indexmodel, fast_distribution_check),
            iid_check = map(indexmodel, check_random_effect)
            )


dispersion <- model_validation %>%
  transmute(dispersion_data = map(dispersion_check_model, "data"),
            dispersion_model = map(dispersion_check_model, "model")) %>%
  select(meetnet, dispersion_data, dispersion_model) %>%
  unnest(c(dispersion_data, dispersion_model))

distribution <- model_validation %>%
  select(meetnet, distribution_check_model) %>%
  unnest(distribution_check_model) %>%
  filter(lcl < 0.98 & ucl < 1)

iid_checked <- model_validation %>%
  select(meetnet, iid_check) %>%
  unnest(iid_check)

```

### Dispersie

```{r}

ggplot(data = dispersion, aes(x = dispersion_model)) +
      geom_density() +
      geom_vline(data = dispersion, aes(xintercept = dispersion_data), linetype = 2) +
      facet_wrap(~meetnet, scales = "free_x")
     
```

### Distributie

```{r, fig.height= 8}
distribution %>%
  mutate(
      median = .data$ecdf / .data$median,
      lcl = .data$ecdf / .data$lcl,
      ucl = .data$ecdf / .data$ucl
    ) %>%
  ggplot(aes_string(x = "x", y = "median")) +
   # geom_blank(data = data.frame(x = min(x$x), median = c(0.95, 1.05))) +
    geom_hline(yintercept = 1, linetype = 2) +
    geom_line(aes_string(y = "lcl"), linetype = 3, alpha = 0.5) +
    geom_line(aes_string(y = "ucl"), linetype = 3, alpha = 0.5) +
    geom_ribbon(alpha = 0.1, aes_string(ymin = "lcl", ymax = "ucl")) +
    geom_line() +
    scale_y_continuous("observed / expected", labels = scales::percent) +
    facet_wrap(~meetnet, scales = "free", ncol = 2)
```

### Random effect

```{r}

iid_checked_plot <- iid_checked %>%
  group_by(meetnet) %>%
  mutate(x_c = sim_iid - mean(sim_iid),
         y = exp(x_c + log(1))) %>%
  ungroup()

iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      facet_wrap(~meetnet + sigma_tekst, scales = "free")
    
```





## Visualisatie model

```{r}
model_simulate <- models_inlabru %>%
  transmute(data_simulated = map2(data, indexmodel, simulate_data_model_inlabru))

results_data_simulated <- model_simulate %>%
  unnest(data_simulated)
```



```{r, warning=FALSE, fig.height= 9}

ggplot(data = results_data_simulated, aes(x = doy)) + 
  geom_line(aes(y = mean, group = loc_id), linetype = 2 ) +
  geom_point(aes(y = y_obs), alpha = 0.5, size = 1) +
  geom_line(aes(y = mean_year), size = 1, colour = "black") +
  geom_ribbon(aes(ymin = lci_0.95_year, ymax = uci_0.95_year), alpha = 0.3) +
  facet_grid(soort_nl ~ jaar, scales = "free") +
  theme(legend.position = "none")
```


## Documenteer analyse

```{r}

mypath <- here(str_c("analysis_", species_group, "/output/temp"))

hashes <-
    tibble(filepath = str_c(mypath, "/",
        list.files(path = mypath,
            recursive = TRUE)
      )) %>%
    mutate(name_analysis = name_analysis,
           version = Sys.Date(),
           filename = str_match(filepath, "(.+\\/)*(.+)")[,3],
           md5 = map(filepath, function(x) {
                           file(x) %>% md5 %>% str_c(collapse = '')
                         }) %>% as.character,
           sha256 = map(filepath, function(x) {
                          file(x) %>% sha256 %>% str_c(collapse = '')
                          }) %>% as.character
           ) %>%
    select(name_analysis,
           version,
           filename,
           md5,
           sha256)

file_name <- here(str_c("analysis_", species_group, "/output/analysis_hashes.csv"))

if (!file.exists(file_name)) {
  
  new_analysis <- TRUE
  
  analysis_hashes <- hashes

} else {
  
  analysis_hashes <- read_csv(file_name)
  
  hashes_new <- hashes %>%
    anti_join(analysis_hashes, by = c("name_analysis", "filename", "md5", "sha256"))
  
  new_analysis <- nrow(hashes_new) > 0
  
  analysis_hashes <- bind_rows(analysis_hashes,
                               hashes)
  
}

if (new_analysis) {
  
  new_path <- here(str_c("analysis_", species_group, "/output/", name_analysis, "_", Sys.Date()))
  
  if (!dir.exists(new_path)) {
    
    dir.create(new_path)
    file.copy(from = str_c(mypath, "/analyseset.tsv"), to = str_c(new_path, "/analyseset.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/analyseset.yml"), to = str_c(new_path, "/analyseset.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_indexmodel.tsv"), to = str_c(new_path, "/results_indexmodel.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_indexmodel.yml"), to = str_c(new_path, "/results_indexmodel.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_trendmodel.tsv"), to = str_c(new_path, "/results_trendmodel.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_trendmodel.yml"), to = str_c(new_path, "/results_trendmodel.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_waic.tsv"), to = str_c(new_path, "/results_waic.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_waic.yml"), to = str_c(new_path, "/results_waic.yml"), overwrite = TRUE)
  }
  
  analysis_hashes %>%
    write_csv(file_name)
  
}

```


