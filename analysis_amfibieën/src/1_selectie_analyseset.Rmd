# Selectie analyseset

```{r}

species_group <- "amfibieën"

species <- "Boomkikker"

```

## Raw data

```{r}
visits <- get_visits_smp(species_group = species_group) %>%
  mutate(protocol = ifelse(protocol == "Amfibieën - Fuiken (v1)", 
                           "Amfibieën - Fuiken", 
                           protocol),
         protocol = ifelse(protocol == "Vuursalamander - Transect (v1)", 
                           "Vuursalamander - Transect", 
                           protocol)) 

covar <- get_covariates_smp(species_group = species_group) 

counts <- get_counts_smp(species_group = species_group)

locations <- get_locations_smp(only_active = FALSE) %>%
  st_drop_geometry() %>%
  filter(locatie_type == "locatie")
```


## Preprocessing locaties 

```{r}

locatie_clusters <- locations %>%
  filter(meetnet %in% c("Kamsalamander", "Heikikker", "Boomkikker", "Poelkikker")) %>%
  select(meetnet, locatie, is_active, is_sample) %>%
  mutate(cluster = ifelse(str_detect(locatie, " - "), 
                          str_sub(locatie,  end = str_locate(locatie, " - ")),
                          locatie),
         cluster = str_remove_all(cluster, str_c(as.character(c(0:9)), collapse = "|")),
         cluster = str_remove(cluster, "NR"),
         cluster = str_trim(cluster),
         poel =  str_extract(locatie, str_c(str_c("(n|[:space:])", c(1:35), "([:alpha:]|$)"), collapse = "|")),
         poel = ifelse(cluster == "Merkske",  str_sub(locatie, start = str_locate(locatie, "B")[,"start"]),
                       poel),
         poel = ifelse(is.na(poel), "1", poel)) 

```


## Preprocessing larvetellingen

+ Bij het protocol voor larvetellingen werden initieel de aantallen per schep ingevoerd. Later werd het protocol gewijzigd en werd het totaal aantal larven en het aantal schepbewegingen ingevoerd. We sommeren de aantallen per schep en werken verder met de totalen en het aantal schepbewegingen.

+ Bij larvetellingen wordt ook aangegeven of er enkel larventellingen, enkel tellingen van metamorfen of beide tellingen werden uitgevoerd. In de databank wordt er een nul gegenereerd voor aantal larven ook al geeft men aan dat er enkel metamorfen werden geteld. Ook omgekeerd is dit het geval voor aantal metamorfen. Deze nullen zetten we om naar ontbrekende waarden.    


```{r select data, warning = FALSE}

catch_effort <- covar %>%
  filter(bezoekvariabele %in% c("aantal keer geschept", "zoekinspanning")) %>%
  select(visit_id, bezoekvariabele, waarde) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(n_catch = "aantal keer geschept") %>%
  mutate(n_catch = as.numeric(n_catch))

counts_larven <- counts %>%
  filter(protocol %in% c("Amfibieën - Larven", "Amfibieën - Larven en metamorfen")) %>%
  group_by(meetnet, protocol, visit_id, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() %>%
  left_join(catch_effort, by = "visit_id") %>%
  mutate(larvetelling = zoekinspanning %in% c("alleen larven geschept", "larven geschept en metamorfen op land geteld") | (is.na(zoekinspanning) & levensstadium == "larve"),
         metamorftelling = zoekinspanning %in% c("alleen metamorfen op land geteld", "larven geschept en metamorfen op land geteld")) %>%
  mutate(aantal = ifelse(levensstadium == "larve" & larvetelling, aantal, 
                         ifelse(levensstadium == "metamorf" & metamorftelling, aantal,
                                ifelse(levensstadium == "adult", aantal, NA)))) %>%
  filter(!((protocol == "Amfibieën - Larven en metamorfen") & (levensstadium == "adult")))

dataset_larven <-  visits %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  inner_join(select(counts_larven, visit_id,  soort_nl, soort_wet, aantal, levensstadium, primaire_soort, n_catch, zoekinspanning, larvetelling, metamorftelling), by = "visit_id") 
  
  
```

## Analyseset larvetelling

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_larven %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_larven_actief <- dataset_larven %>%
  filter(is_active)

locaties_niet_actief <- dataset_larven %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_larven_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```



+ We selecteren enkel tellingen die geschikt zijn voor analyse
  + Geen veldwerk mogelijk - locatie ongechikt: wanneer de poel droog staat rekenen we dit mee als een nulwaarning (dit moet aangepast worden in de databank: voor_analyse = TRUE)
  
```{r}

check_gvm <- dataset_larven_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  filter(levensstadium == "larve") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, voor_analyse, aantal, notes) 

check_gvm %>%
  datatable(rownames = FALSE)
```

```{r}
dataset_larven_actief_voor_analyse <- dataset_larven_actief %>%
  mutate(voor_analyse = ifelse(visit_id %in% check_gvm$visit_id, TRUE, voor_analyse)) %>%
  filter(voor_analyse)

dataset_larven <- dataset_larven_actief_voor_analyse
```



### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

Alles lijkt OK!


```{r}

dataset_check2 <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, zoekinspanning, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```
### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}

duur_cyclus <- 3

analyseset_larven <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  mutate(start_cyclus = ifelse(meetnet == "Kamsalamander", 2017, 2016),
    meetcyclus = ceiling((jaar - start_cyclus +1)/ duur_cyclus)) %>%
  group_by(meetcyclus, meetnet) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus -1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, doy, visit_id, bezoek_status, zoekinspanning, larvetelling, metamorftelling, n_catch, primaire_soort, soort_nl, soort_wet, levensstadium, aantal)
```



## Analyseset roepkoren Boomkikker

```{r}
dataset_roepkoren <-  visits %>%
  filter(meetnet == "Boomkikker") %>%
  filter(protocol == "Padden en kikkers - Roepkoren") %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") 
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_roepkoren %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_roepkoren_actief <- dataset_roepkoren %>%
  filter(is_active)

locaties_niet_actief <- dataset_roepkoren %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_roepkoren_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```



+ We selecteren enkel tellingen die geschikt zijn voor analyse
  + Geen veldwerk mogelijk - locatie ongechikt: wanneer de poel droog staat rekenen we dit mee als een nulwaarning (dit moet aangepast worden in de databank: voor_analyse = TRUE)
  
```{r}

check_gvm <- dataset_roepkoren_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, notes) 

check_gvm %>%
  datatable(rownames = FALSE)
```

```{r}
dataset_roepkoren_actief_voor_analyse <- dataset_roepkoren_actief %>%
  mutate(voor_analyse = ifelse(visit_id %in% check_gvm$visit_id, TRUE, voor_analyse),
         aantal = ifelse(visit_id %in% check_gvm$visit_id, 0, aantal),
         levensstadium = ifelse(visit_id %in% check_gvm$visit_id, "adult", levensstadium),
         soort_nl = ifelse(visit_id %in% check_gvm$visit_id, "Boomkikker", soort_nl),
          primaire_soort = ifelse(visit_id %in% check_gvm$visit_id, TRUE, primaire_soort),
         soort_wet = ifelse(visit_id %in% check_gvm$visit_id, "Hyla arborea", soort_wet)) %>%
  filter(voor_analyse)

dataset_roepkoren <- dataset_roepkoren_actief_voor_analyse
```



### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

Alles lijkt OK!


```{r}

dataset_check2 <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_roepkoren%>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}

analyseset_roepkoren_boomkikker <-  dataset_roepkoren %>%
  filter(!is.na(aantal))
```

```{r}
duur_cyclus <- 3
start_cyclus <- 2016

analyseset_roepkoren_boomkikker <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus +1)/ duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus -1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium,  aantal)
```

## Analyseset Fuiken Kamsalamander

```{r}
visits_kam <- visits %>%
  filter(protocol == "Amfibieën - Fuiken") 

counts_kam <- counts %>%
  semi_join(visits_kam, by = "visit_id") %>%
  group_by(protocol, visit_id) %>%
  mutate( n_fuiken = n_distinct(sample_id)) %>%
  ungroup() %>%
  group_by(visit_id, n_fuiken, soort_nl, soort_wet, primaire_soort, levensstadium, geslacht) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() 

dataset_fuiken <-  visits_kam %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  inner_join(counts_kam, by = "visit_id") 

```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_fuiken %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}

dataset_fuiken_actief <- dataset_fuiken %>%
  filter(is_active)

locaties_niet_actief <- dataset_fuiken %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_fuiken_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()

```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  
```{r}

check_gvm <- dataset_fuiken_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, notes) 

check_gvm %>%
  datatable(rownames = FALSE)
```

### Overzicht van aantal fuiken

```{r}

dataset_fuiken_actief_voor_analyse <- dataset_fuiken_actief %>%
  filter(voor_analyse)

dataset_fuiken <- dataset_fuiken_actief_voor_analyse

dataset_fuiken %>%
  distinct(visit_id, bezoek_status, n_fuiken, is_sample) %>%
  ggplot(aes(x = factor(n_fuiken), fill = is_sample)) +
  geom_bar() +
  labs(x = "Aantal fuiken", y = "Aantal bezoeken", fill = "Meetnetlocatie")
```



### Overzicht van de type tellingen: primaire soort, levensstadium, geslacht

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium
+ geslacht



```{r}

dataset_check2 <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium, geslacht) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE)
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}
locaties_geen_data <- locatie_clusters %>%
  filter(meetnet == "Kamsalamander") %>%
  filter(is_sample) %>%
  anti_join(dataset_fuiken, by = "locatie")
```


```{r}
duur_cyclus <- 3
start_cyclus <- 2017

analyseset_fuiken_detail <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ifelse(jaar <= 2020, 1, 2)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = ifelse(meetcyclus == 1, 2020, 2023)) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, n_fuiken, primaire_soort, soort_nl, soort_wet, levensstadium, geslacht, aantal)

analyseset_fuiken_totaal <- analyseset_fuiken_detail %>%
  group_by(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, n_fuiken, primaire_soort, soort_nl, soort_wet) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup() %>%
  group_by(protocol, locatie) %>%
  mutate(paired = n_distinct(meetcyclus) > 1) %>%
  ungroup()

check <- analyseset_fuiken_totaal %>%
  group_by(protocol, meetcyclus,meetcyclus_start, meetcyclus_end, is_sample,  paired) %>%
  summarise(n = n_distinct(locatie))
```






## Bewaar analyseset

```{r, eval = FALSE}

names_analysis <- c(name_analysis0, name_analysis1, name_analysis2, name_analysis3)

mypath <- here(str_c("analysis_vlinders/output/temp"))

hashes <-
    tibble(filepath = str_c(mypath, "/",
        list.files(path = mypath,
            recursive = TRUE)
      )) %>%
    mutate(version = Sys.Date(),
           filename = str_match(filepath, "(.+\\/)*(.+)")[,3],
           name_analysis = str_extract(filename, str_c(names_analysis, collapse =  "|")),
           md5 = map(filepath, function(x) {
                           file(x) %>% md5 %>% str_c(collapse = '')
                         }) %>% as.character,
           sha256 = map(filepath, function(x) {
                          file(x) %>% sha256 %>% str_c(collapse = '')
                          }) %>% as.character
           ) %>%
    select(name_analysis,
           version,
           filename,
           md5,
           sha256) %>%
  filter(str_detect(filename, "analyseset"))

file_name <- here(str_c("analysis_vlinders/output/analysis_hashes.tsv"))

if (!file.exists(file_name)) {
  
  new_analysis <- TRUE
  
  analysis_hashes <- hashes

} else {
  
  analysis_hashes <- read_vc(file = "analysis_hashes", root = here("analysis_vlinders/output/"))
  
  hashes_new <- hashes %>%
    anti_join(analysis_hashes, by = c("name_analysis", "filename", "md5", "sha256"))
  
  new_analysis <- nrow(hashes_new) > 0
  
  analysis_hashes <- bind_rows(analysis_hashes,
                               hashes)
  
  names_analysis <- unique(hashes_new$name_analysis) 
  
}

if (new_analysis) {
  
  for (name_analysis in names_analysis) {
    
     new_path <- here(str_c("analysis_vlinders/output/analyseset/", name_analysis, "_", Sys.Date()))
     
     if (!dir.exists(new_path)) {
       
       dir.create(new_path)
       
       file.copy(from = str_c(mypath, "/analyseset_", name_analysis,".tsv"), 
                 to = str_c(new_path,  "/analyseset_", name_analysis,".tsv"), 
                 overwrite = TRUE)
       
       file.copy(from = str_c(mypath, "/analyseset_", name_analysis,".yml"), 
                 to = str_c(new_path, "/analyseset_", name_analysis,".yml"), 
                 overwrite = TRUE)
       }
     
     
  }
  
  analysis_hashes %>%
       write_vc(file = "analysis_hashes", root = here("analysis_vlinders/output/"), sorting = c("name_analysis", "version", "filename"), strict = FALSE)
  
  } 
 
  
 

```



