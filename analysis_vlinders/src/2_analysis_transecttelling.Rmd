# overleg Thierry
sectie met enkel nullen verwijderen
correlatiestructuur secties --> welke staan in verbinding 

jaar -> 1ste orde rw
seizoen -> 2de orde rw -> week?
dag -> starten vanaf 1
inlatools simuleren
sigma rw voldoende klein, 1ste orde kleiner dan 2de orde
priors zelf instellen
sigma = 1 random intercept
sigma =0.3 1ste orde rw
sigma = 0.01 2de orde rw
offset inlabru als covariaat met aangepaste prior --> control.fixed -> naam_var + precisie -> offset: precisie hoog zetten -> gemiddelde op 1 zetten

rw plotten

rw met interactie generatie wrap()

temp herschalen

gecorreleerde random slope en random intercept

of kijken naar residuals per locatie: verschil tov van gemiddelde trend

derive_index
lijst
posterior.sample : map latent --> matrix --> rijen met fjaar selecteren










# Vlinders - Transecttelling

```{r}

species_group <- "dagvlinders"
protocol_selection <- c("Vlinders - Transecten")

name_analysis <- "vlinders_transecten"

set.seed(47830)
```

## Selectie analyseset

```{r select data, warning = FALSE}

locatie_detail <- get_locations_smp() %>%
  st_drop_geometry() %>%
  filter(locatie_type == "locatie") %>%
  select(meetnet, locatie, is_active, is_sample)

visits <- get_visits_smp(species_group = species_group) %>%
  filter(protocol == protocol_selection)

counts_all <- get_counts_smp(species_group = species_group, count_aggregation = "individuals")

counts <-  counts_all %>%
  filter(primaire_soort)

covars <- get_covariates_smp(species_group = species_group) %>%
  filter(protocol %in% protocol_selection) %>%
  select(-eenheid) %>%
  pivot_wider(names_from = "bezoekvariabele", values_from = "waarde") %>%
  mutate(bewolking = factor(bewolking, levels = c("heldere hemel (0/8)", "lichtbewolkt (1 tot 2/8)", "halfbewolkt (3 tot 5/8)", "zwaarbewolkt (6 tot 7/8)", "betrokken (8/8)")),
         temperatuur = as.numeric(temperatuur),
         windkracht = factor(windkracht, levels = c("windstil (0 Bft)", "zeer zwakke wind (1 Bft)", "zwakke wind (2 Bft)" , "vrij matige wind (3 Bft)", "matige wind (4 Bft)", "vrij krachtige wind (5 Bft)", "krachtige wind (6 Bft)", "stormachtig (8 Bft)")))
  
count_period_generatie <- get_characteristics_smp() %>%
  mutate(doy_min_generatie = as.numeric(format(start_telperiode, "%j")),
         doy_max_generatie = as.numeric(format(einde_telperiode, "%j")),
         doy_mid_generatie = doy_min_generatie + round((doy_max_generatie - doy_min_generatie)/2, 0)) %>%
  distinct(meetnet, protocol, generatie, doy_min_generatie, doy_max_generatie, doy_mid_generatie)

count_period <- get_characteristics_smp() %>%
  mutate(doy_min = as.numeric(format(start_telperiode, "%j")),
         doy_max = as.numeric(format(einde_telperiode, "%j"))) %>%
  group_by(meetnet, protocol) %>%
  summarise(doy_min = min(doy_min),
            doy_max = max(doy_max)) %>%
  ungroup() %>%
  mutate(doy_mid = doy_min + round((doy_max - doy_min)/2, 0)) %>%
  distinct(meetnet, protocol, doy_min, doy_max, doy_mid)

```

+ We selecteren de meetnetten die al minstens drie jaar lopen.

```{r}
meetnetten_selection <- visits %>%
  filter(protocol == protocol_selection) %>%
  group_by(meetnet, protocol) %>%
  summarise(n_jaar = n_distinct(jaar)) %>%
  filter(n_jaar >= 3)

meetnetten_selection %>%
  kable(caption = "selectie meetnetten") %>%
  kable_styling()
```


+ We selecteren bezoeken, die geschikt zijn voor analyse (voor_analyse = TRUE), aan actieve locaties

```{r}
visits_selection <- visits %>%
  filter(meetnet %in% meetnetten_selection$meetnet) %>%
  mutate(generatie = ifelse(doy < 175, "generatie1", "generatie2")) %>%
  left_join(locatie_detail, by = c("meetnet", "locatie")) %>%
  filter(voor_analyse & !is.na(is_active)) %>%
  left_join(count_period, by = c("meetnet", "protocol")) %>%
  left_join(count_period_generatie, by = c("meetnet", "protocol", "generatie")) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         doy_scaled_generatie = (doy - doy_mid_generatie)/28,
         fjaar = factor(jaar)) %>%
  group_by(soortgroep, meetnet, protocol, locatie, jaar, fjaar) %>%
  mutate(n_obs = n_distinct(visit_id)) %>%
  ungroup()

locaties_niet_actief <- visits %>%
  distinct(meetnet, locatie) %>%
  anti_join(visits_selection, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel locaties waar de soort minstens tijdens 1 bezoek werd waargenomen

```{r}
counts_sublocation_selection <- visits_selection %>%
  select(soortgroep, meetnet, protocol, generatie, locatie, jaar, datum, doy, doy_scaled, doy_min, doy_max, doy_mid, doy_scaled_generatie, doy_min_generatie, doy_max_generatie, doy_mid_generatie,  visit_id, n_obs, voor_analyse, is_active, is_sample, bezoek_status, bezoek_status_oud) %>%
  left_join(select(counts, visit_id, sublocatie, soort_nl, soort_wet, aantal), by = "visit_id") %>%
  left_join(covars, by = c("meetnet", "protocol", "visit_id")) %>%
  group_by(meetnet, locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)

locations_absence <- visits_selection %>%
  group_by(meetnet, locatie) %>%
  summarise(n_visits = n_distinct(visit_id)) %>%
  ungroup() %>%
  anti_join(counts_sublocation_selection, by = c("meetnet", "locatie"))

locations_absence %>%
  kable(caption = "Locaties met enkel nulwaarnemingen") %>%
  kable_styling()
```


## Transectlengte

We berekenen de lengte per sectie op basis van de ingevoerde transecten in de meetnetten.be databank. Indien geen transect werd ingevoerd voor een locatie veronderstellen we dat elke sectie 50 meter meet.

Om de analyse te vereenvoudigen werken we verder met gesommeerde aantallen over het volledige transect.

```{r}
transecten <- get_transects_smp() %>% 
  filter(soortgroep == "dagvlinders") %>%
  st_transform(crs = 31370) %>%
  mutate(lengte_sectie = round(drop_units(st_length(geom)), 0)) %>%
  st_drop_geometry() %>%
  select( meetnet, locatie, sublocatie, lengte_sectie) %>%
  group_by(meetnet, locatie) %>%
  mutate(lengte_transect = sum(lengte_sectie)) %>%
  ungroup() %>%
  mutate(sectie_nr = as.numeric(str_sub(sublocatie, start = 7))) %>%
  arrange(meetnet, locatie, sectie_nr)

```

```{r}
transect_missing <- counts_sublocation_selection %>%
  group_by(meetnet, locatie, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id)) %>%
  anti_join(transecten, by = c("meetnet", "locatie")) 
  
transect_missing %>%
  kable(caption = "Locaties waarvoor transecten nog niet in meetnetten.be-databanken zitten") %>%
  kable_styling()

# transect_missing %>%
#   write_csv2("../output/vlinders_ontbrekende_transecten.csv")

```


```{r}
counts_sublocation_selection_transect <- counts_sublocation_selection %>%
  left_join(transecten, by = c("meetnet", "locatie", "sublocatie")) %>%
  mutate(sectie_missing = is.na(lengte_sectie),
         sectie_nr = as.numeric(str_sub(sublocatie, start = 7)),
        lengte_sectie = ifelse(is.na(lengte_sectie), 50, lengte_sectie))


  
```

```{r}
check_missing_transect <- counts_all %>% 
  semi_join(visits_selection, by = "visit_id") %>%
  left_join(transecten, by = c("meetnet", "locatie", "sublocatie")) %>%
  mutate(sectie_missing = is.na(lengte_sectie),
         sectie_nr = as.numeric(str_sub(sublocatie, start = 7))) %>%
  filter(sectie_missing) %>%
  group_by(meetnet, locatie, sublocatie, sectie_nr) %>%
  summarise(sum_counts_all = sum(aantal),
            n_visits = n_distinct(visit_id),
            n_species = n_distinct(soort_nl)) %>%
  ungroup()
 
```



```{r}

counts_location_selection_transect <- counts_sublocation_selection_transect %>%
  group_by(soortgroep, meetnet, soort_nl, soort_wet, protocol, generatie, locatie, jaar, datum, doy, doy_scaled, doy_min, doy_max, doy_mid, doy_scaled_generatie, doy_min_generatie, doy_max_generatie, doy_mid_generatie, visit_id, n_obs, voor_analyse, is_active, is_sample, bezoek_status, windkracht, temperatuur, bewolking) %>%
  summarise(aantal = sum(aantal),
         lengte_transect = sum(lengte_sectie)) %>%
  ungroup()


analyseset_sublocations <- counts_sublocation_selection_transect %>%
  mutate(fjaar = factor(jaar),
         locatie = factor(locatie),
         doy_scaled_2 = doy_scaled * doy_scaled,
         doy_scaled_generatie_2 = doy_scaled_generatie * doy_scaled_generatie,
         log_section_100 = log(lengte_transect/100)) %>%
  mutate(generatie = ifelse(soort_nl %in% c("Argusvlinder", "Bruin dikkopje", "Klaverblauwtje"),
                            ifelse(doy < 175, "generatie1", "generatie2"),
                            "generatie1"))

analyseset_sublocations_by_species <-  analyseset_sublocations %>%
  group_by(meetnet) %>%
  nest()

analyseset_locations <- counts_location_selection_transect %>%
  mutate(fjaar = factor(jaar),
         locatie = factor(locatie),
         doy_scaled_2 = doy_scaled * doy_scaled,
         doy_scaled_generatie_2 = doy_scaled_generatie * doy_scaled_generatie,
         log_section_100 = log(lengte_transect/100)) %>%
  mutate(generatie = ifelse(soort_nl %in% c("Argusvlinder", "Bruin dikkopje", "Klaverblauwtje"),
                            ifelse(doy < 175, "generatie1", "generatie2"),
                            "generatie1"))

analyseset_locations_by_species <- analyseset_locations %>%
  group_by(meetnet) %>%
  nest()


``` 

```{r}

write_vc(analyseset_sublocations, file = str_c("analyseset_sublocations_", name_analysis), 
       root = here(str_c("analysis_vlinders/output/temp")), 
       sorting = c("meetnet", "locatie", "sublocatie", "visit_id"), 
       strict = FALSE)


write_vc(analyseset_locations, file = str_c("analyseset_locations_", name_analysis), 
       root = here(str_c("analysis_vlinders/output/temp")), 
       sorting = c("meetnet", "locatie",  "visit_id"), 
       strict = FALSE)
  
```

## Dataverkenning

### Getelde aantallen

```{r, fig.cap= "Gemiddeld aantal getelde individuen per jaar", eval=FALSE}
analyseset_locations %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot",  alpha = 0.8) +
  facet_wrap(~ soort_nl, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  theme(legend.position = "bottom") 
```

```{r, fig.cap = "Gemiddeld aantal getelde individuen per 100 meter transectlengte"}
analyseset_locations %>%
  ggplot(aes(x= jaar, y = aantal *100/ lengte_transect)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot",  alpha = 0.8) +
  facet_wrap(~ soort_nl, scale = "free_y") +
  labs(y = "Aantal getelde individuen per 1000m transect", x = "Jaar") +
  theme(legend.position = "bottom") 
```


```{r, fig.height = 11, eval=FALSE}
analyseset_locations %>%
  ggplot(aes(x = doy, y = aantal, colour = generatie)) +
  geom_point(alpha = 0.6) +
  facet_grid(meetnet ~ jaar, scales = "free_y")
```
```{r, fig.height= 7, fig.cap= "Getelde aantallen per 100 meter transectlengte"}
analyseset_locations %>%
  ggplot(aes(x = doy, y = aantal * 100 / lengte_transect, colour = generatie)) +
  geom_point(alpha = 0.6) +
  facet_grid(meetnet ~ jaar, scales = "free_y")
```

### Seizoenaliteit

```{r, fig.height= 6,  fig.cap= "Vergelijking seizoenaliteit via gam-smoother (enkel voor jaren met minstens 18 observaties)"}
analyseset_locations %>%
  group_by(meetnet, jaar) %>%
  filter(n_distinct(visit_id) > 17) %>%
  ungroup() %>%
  mutate(jaar = factor(jaar)) %>%
  ggplot(aes(x = doy, y = aantal, group = interaction(jaar, generatie), colour = jaar, fill = jaar)) +
  #geom_point(alpha = 0.4) +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 1) +
  ylim(c(0,35)) +
  facet_wrap(~ meetnet, scales = "free")
```

### Effect weersomstandigheden

```{r, fig.height= 6, fig.cap= "Effect van windkracht op getelde aantallen per 100 meter transectlengte"}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  ggplot(aes(x = windkracht, y = aantal_100m)) +
  geom_boxplot() +
  facet_wrap(~meetnet, scale = "free_x") + 
  coord_flip()
```
```{r, fig.height= 6, fig.cap=  "Effect van bewolking op getelde aantallen per 100 meter transectlengte"}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  ggplot(aes(x = bewolking, y = aantal_100m)) +
  geom_boxplot() +
  facet_wrap(~meetnet, scales = "free_x") + 
  coord_flip()
```

```{r, fig.height= 6, fig.cap =  "Effect van temperatuur op getelde aantallen per 100 meter transectlengte"}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  ggplot(aes(x = temperatuur, y = aantal_100m)) +
  geom_point() +
  facet_wrap(~meetnet, scales = "free_y") +
  geom_smooth()
```

Volgend model geeft globaal gezien (voor alle meetnetten samen) enkel een significant effect van bewolking op de getelde aantallen. 

```{r}
analyseset_locations <- analyseset_locations %>%
  mutate(bewolking_max = as.numeric(str_sub(bewolking, start = -4, end = -4)),
         bewolking_min = ifelse(bewolking_max > 0, as.numeric(str_sub(bewolking, start = -10, end = -10)), 0),
         bewolking_cont = (bewolking_max + bewolking_min)/2/8,
         windkracht = as.numeric(str_sub(windkracht, start = -6, end = -6)),
         temperatuur_2 = temperatuur * temperatuur,
         aantal_100m = aantal * 100 / lengte_transect)

prec.prior <- list(prec = list(param = c(0.001, 0.001)))

model_conditions <- inla(aantal ~ temperatuur + temperatuur_2 + windkracht + bewolking_cont + f(meetnet, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))


model_conditions$summary.fixed %>%
  kable(caption = "Parameterschatting voor variabelen gerelateerd aan weersomstandigheden") %>%
  kable_styling()
```

```{r, fig.height= 6, fig.cap= "Gecombineerd effect van bewolking en temperatuur op getelde aantallen"}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  group_by(meetnet) %>%
  mutate(aantal_100m_scaled = aantal_100m/ max(aantal_100m)) %>%
  ungroup() %>%
  ggplot(aes(x = temperatuur, y = bewolking_cont, size = aantal_100m_scaled)) +
  geom_jitter(alpha = 0.4) +
  facet_wrap(~meetnet)
```


## Vergelijking van verschillende analysemodellen


```{r, eval = FALSE}

analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Veldparelmoervlinder")

# library(lme4)
# model_lme <- glmer.nb(aantal ~ fjaar + doy_scaled + doy_scaled_2 + (1|locatie),
#                          data = analyseset_species)
# 
# summary(model_lme)


# compare inla and inlabru with offset

indexmodel_nbinom_inla_offset_season_effect <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100")

indexmodel_nbinom_inlabru_offset_season_effect <- fit_indexmodel_nbinom_inlabru(analyseset_species = analyseset_species_locations, offset_var = "log_section_100")

compare <- bind_rows(indexmodel_nbinom_inla_offset_season_effect$summary.fixed,
                     indexmodel_nbinom_inlabru_offset_season_effect$summary.fixed)

## offset not working wit inlabru

# compare inla and inlabru without offset

indexmodel_nbinom_inla <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species_locations)

indexmodel_nbinom_inlabru <- fit_indexmodel_nbinom_inlabru(analyseset_species = analyseset_species_locations)

compare2 <- bind_rows(indexmodel_nbinom_inla$summary.fixed,
                     indexmodel_nbinom_inlabru$summary.fixed)

compare3 <- bind_rows(indexmodel_nbinom_inlabru_offset_season_effect$summary.fixed,
                     indexmodel_nbinom_inlabru$summary.fixed)


indexmodel_nbinom_inla_offset_noseason_effect <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100", season_effect = FALSE)


index <- derive_index_inla(analyseset_species_locations, indexmodel_nbinom_inla) %>%
  mutate(offset = "nee",
         type = "season effect")

index_offset_season <- derive_index_inla(analyseset_species_locations, indexmodel_nbinom_inla_offset_season_effect) %>%
  mutate(offset = "ja",
         type = "season effect")

index_offset_noseason <- derive_index_inla(analyseset_species_locations, indexmodel_nbinom_inla_offset_noseason_effect) %>%
  mutate(offset = "ja",
         type = "no season effect")

index_vergelijk <- bind_rows(index, index_offset_season, index_offset_noseason) %>%
  select(offset, everything())

trendmodel_nbinom_inla <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species)
trendmodel_nbinom_inla_offset <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species, offset_var = "log_section_100")

trend <- derive_trend(analyseset_species, trendmodel_nbinom_inla) %>%
  mutate(offset = "nee")

trend_offset <- derive_trend(analyseset_species, trendmodel_nbinom_inla_offset) %>%
  mutate(offset = "ja")

trend_vergelijk <- bind_rows(trend, trend_offset) %>%
  select(offset, everything())


# max_count <- derive_max_count_inla(analyseset_species, indexmodel_nbinom_inla)%>%
#   mutate(offset = "nee")
# max_count_offset <- derive_max_count_inla(analyseset_species, indexmodel_nbinom_inla_offset) %>%
#   mutate(offset = "ja")
# max_count_vergelijk <- bind_rows(max_count, max_count_offset) %>%
#   select(offset, everything())


# simulate_data <- simulate_data_model_inlabru(analyseset_species_locations, indexmodel_nbinom_inla_offset_season_effect)

```

### Modellering van seizoenaliteit

#### Model voor soort met één generaties

Vergelijking tussen twee manieren om seizoenaliteit te modelleren:

+ 2de graads polynoom voor doy (day of year)


+ random walk


```{r}

analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Veldparelmoervlinder") %>%
  mutate(fjaar = factor(jaar),
         locatie = as.character(locatie),
         locatie = as.factor(locatie),
         generatie = as.factor(generatie))

data_sim_add <- analyseset_species_locations %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy_mid, doy = full_seq(doy, 1)) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         doy_scaled_2 = doy_scaled * doy_scaled,
         doy_centered = doy - min(analyseset_species_locations$doy)) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_species_locations %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

prec.prior <- list(prec = list(param = c(0.001, 0.001)))

indexmodel_doy_iid <- inla(aantal ~ fjaar  + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doyrw_iid <- inla(aantal ~ fjaar  + f(doy_centered, model = "rw1", hyper = list(
theta = list(prior = "pc.prec", param = c(0.25, 0.05)))) + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))
bind_rows(
get_waic(analyseset_species_locations, indexmodel_doy_iid) %>%
  mutate(model = "2de graads polynoom voor doy"), 
get_waic(analyseset_species_locations, indexmodel_doyrw_iid) %>%
  mutate(model = "random walk voor doy")) %>%
  select( model, everything()) %>%
  kable(caption = "Vergelijking modellen voor Veldparelmoervlinder") %>%
  kable_styling()

  
```

```{r, fig.cap= "Gemodelleerde en geobserveerde aantallen voor Veldparelmoervlinder op basis van model met 2de graads polynoom voor doy"}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doy_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doy_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doy_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)


data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_100m_obs, x = doy)) +
  facet_wrap(~fjaar)
```

```{r, fig.cap= "Gemodelleerde en geobserveerde aantallen voor Veldparelmoervlinder op basis van model met random walk voor doy"}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doyrw_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doyrw_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doyrw_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)


data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_100m_obs, x = doy)) +
  facet_wrap(~fjaar)
```

#### Model voor soort met twee generaties

Bij enkele soorten zijn er twee generaties binnen het seizoen. 
We vergelijken verschillende manieren om de generatie mee op te nemen in het model:

+ generatie als extra covariabele 
+ generatie als extra covariabele inclusief een interactie seizoenseffect en generatie (seizoenseffect kan verschillen per generatie)


```{r}
analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Bruin dikkopje")

analyseset_species_locations <- analyseset_species_locations %>%
  mutate(fjaar = factor(jaar),
         locatie = as.character(locatie),
         locatie = as.factor(locatie),
         generatie = as.factor(generatie))

prec.prior <- list(prec = list(param = c(0.001, 0.001)))

indexmodel_doy_iid <- inla(aantal ~ fjaar + f(doy_scaled, model = "clinear", range = c(0, Inf)) + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))


indexmodel_doy_iid_generatie_interactie <- inla(aantal ~ fjaar  + doy_scaled*generatie + doy_scaled_2*generatie + f(locatie, model = "iid", hyper = prec.prior),
                                     family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie <- inla(aantal ~ fjaar + generatie + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_iid_generatie <- inla(aantal ~ fjaar  + generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

index <- derive_index_inla(analyseset_species_locations, indexmodel_doy_iid) %>%
  mutate(model = "zonder generatie-effect, met seizoenaliteit")

index_generatie <- derive_index_inla(analyseset_species_locations, indexmodel_doy_iid_generatie) %>%
  mutate(model = "met generatie-effect en seizoenaliteit")

index_generatie2 <- derive_index_inla(analyseset_species_locations, indexmodel_doy_iid_generatie_interactie) %>%
  mutate(model = "interactie generatie-seizoenaliteit ")

index_generatie3 <- derive_index_inla(analyseset_species_locations, indexmodel_iid_generatie) %>%
  mutate(model = "met generatie-effect zonder seizoenaliteit")

waic<- get_waic(analyseset_species_locations, indexmodel_doy_iid) %>%
  mutate(model = "zonder generatie-effect, met seizoenaliteit")

waic_generatie <- get_waic(analyseset_species_locations, indexmodel_doy_iid_generatie) %>%
  mutate(model = "met generatie-effect en seizoenaliteit")

waic_generatie2<- get_waic(analyseset_species_locations, indexmodel_doy_iid_generatie_interactie) %>%
  mutate(model = "interactie generatie-seizoenaliteit ")

waic_generatie3 <- get_waic(analyseset_species_locations, indexmodel_iid_generatie) %>%
  mutate(model = "met generatie-effect zonder seizoenaliteit")




```

```{r}


bind_rows(waic, waic_generatie) %>%
  bind_rows(waic_generatie2) %>%
  bind_rows(waic_generatie3) %>%
  select(soort_nl, model, waic) %>%
  kable(caption = "Vergelijking verschillende modellen voor Bruin dikkopje") %>%
  kable_styling() %>%
  collapse_rows(1)
```

```{r}
bind_rows(index, index_generatie) %>%
  bind_rows(index_generatie2) %>%
  bind_rows(index_generatie3) %>%
  select(soort_nl, model, jaar, ref_jaar, mean, lcl_0.90, ucl_0.90) %>%
  kable(caption = "Vergelijking parameterschattingen (jaarlijkse index) voor verschillende modellen voor Bruin dikkopje") %>%
  kable_styling() %>%
  collapse_rows(c(1,2))
```



```{r}

fitted_data_generatie <- analyseset_species_locations %>%
  mutate(fitted_mean = indexmodel_doy_iid_generatie$summary.fitted.values$mean,
         fitted_0.025quant = indexmodel_doy_iid_generatie$summary.fitted.values$`0.025quant`,
         fitted_0.975quant = indexmodel_doy_iid_generatie$summary.fitted.values$`0.975quant`,
         residuals = aantal - fitted_mean,
         model = "met generatie-effect")

fitted_data_generatie_interactie <- analyseset_species_locations %>%
  mutate(fitted_mean = indexmodel_doy_iid_generatie_interactie$summary.fitted.values$mean,
         fitted_0.025quant = indexmodel_doy_iid_generatie_interactie$summary.fitted.values$`0.025quant`,
         fitted_0.975quant = indexmodel_doy_iid_generatie_interactie$summary.fitted.values$`0.975quant`,
         residuals = aantal - fitted_mean,
         model = "met generatie-effect en interactie")

fitted_data_zondergeneratie <- analyseset_species_locations %>%
  mutate(fitted_mean = indexmodel_doy_iid$summary.fitted.values$mean,
         fitted_0.025quant = indexmodel_doy_iid$summary.fitted.values$`0.025quant`,
         fitted_0.975quant = indexmodel_doy_iid$summary.fitted.values$`0.975quant`,
         residuals = aantal - fitted_mean,
         model = "zonder generatie-effect")

fitted_data <- bind_rows(fitted_data_generatie,
                         fitted_data_generatie_interactie,
                         fitted_data_zondergeneratie)

```

```{r, fig.height= 6, fig.cap= "Residuen voor verschillende modellen"}
fitted_data %>% 
ggplot(aes(x = doy, y = residuals, colour = generatie)) +
  geom_point(alpha = 0.6) +
  facet_grid(model~ fjaar)
```



```{r, eval = FALSE}

fixed_effects <- indexmodel_doy_iid_generatie$summary.fixed %>%
  rownames_to_column(var = "parameter") %>%
  select(parameter, mean)

fjaar_effect <- fixed_effects %>%
  filter(str_sub(parameter, 1, 5) == "fjaar") %>%
  rename(mean_year = mean, fjaar = parameter) %>%
  mutate(fjaar = str_sub(fjaar, start = 6))

intercept <- (fixed_effects %>%
                        filter(parameter == "(Intercept)"))$mean

generatie_effect <- fixed_effects %>%
  filter(parameter == "generatiegeneratie2") %>%
  rename(mean_generatie = mean,
         generatie = parameter) %>%
  mutate(generatie = str_sub(generatie, start = 10))

doy_effect <- fixed_effects %>%
  filter(str_detect(parameter, c(":|doy"))) %>%
  mutate(generatie = ifelse(str_detect(parameter, ":"), "generatie2", "generatie1"),
         parameter = ifelse(str_detect(parameter, "_2"), "doy_scaled_2", "doy_scaled")) %>%
  pivot_wider(names_from = "generatie",
              values_from = "mean") %>%
  mutate(generatie2 = generatie2 + generatie1) %>%
  pivot_longer(cols = c("generatie1", "generatie2"), 
               names_to = "generatie",
               values_to = "mean") %>%
  pivot_wider(names_from = "parameter", 
              names_prefix = "coef_", 
              values_from = "mean"
                )

data_sim <- analyseset_species_locations %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy = full_seq(doy, 1)) %>%
  mutate(generatie = ifelse(doy < 175, "generatie1", "generatie2"),
         intercept = intercept) %>%
  left_join(distinct(analyseset_species_locations, generatie, doy_mid_generatie), by = "generatie") %>%
  mutate(doy_scaled_generatie = (doy - doy_mid_generatie)/28) %>%
  left_join(fjaar_effect, by = "fjaar") %>%
  left_join(generatie_effect, by = "generatie") %>%
  left_join(doy_effect, by = "generatie") %>%
  mutate(mean_year = ifelse(is.na(mean_year), 0, mean_year),
         mean_generatie = ifelse(is.na(mean_generatie), 0, mean_generatie)) %>%
  mutate(aantal_predict = exp(intercept + mean_year + mean_generatie + doy_scaled_generatie * coef_doy_scaled + doy_scaled_generatie * doy_scaled_generatie * coef_doy_scaled_2)) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)
```

```{r, "Gemoddelleerde en geobserveerde aantallen voor model met generatie als covariabele", eval=FALSE}
ggplot(data = data_sim) +
  geom_line(aes(y = aantal_predict, x = doy, group = generatie, colour = generatie)) +
  geom_point(aes(y = aantal_100m_obs, x = doy,  colour = generatie)) +
  facet_wrap(~fjaar) 
```

```{r}

generatie_min_max <- analyseset_species_locations %>%
  group_by(generatie) %>%
  summarise(doy_min_generatie = min(doy),
            doy_max_generatie = max(doy)) %>%
  ungroup()

data_sim_add <- analyseset_species_locations %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy_mid, doy = full_seq(doy, 1)) %>%
  mutate(generatie = ifelse(doy < 175, "generatie1", "generatie2")) %>%
  left_join(generatie_min_max, by = "generatie") %>%
 filter((doy >= doy_min_generatie) & (doy <= doy_max_generatie)) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         doy_scaled_2 = doy_scaled * doy_scaled) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_species_locations %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

indexmodel_doy_iid_generatie_interactie <- inla(aantal ~ fjaar  + doy_scaled*generatie + doy_scaled_2*generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie<- inla(aantal ~ fjaar  + generatie + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie2 <- inla(aantal ~ fjaar + generatie  + f(doy_scaled, model = "clinear", range = c(0, Inf)) + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid<- inla(aantal ~ fjaar + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

data_predict_generatie <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doy_iid_generatie$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doy_iid_generatie$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doy_iid_generatie$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, generatie, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect) %>%
  mutate(model = "met generatie-effect")

data_predict_generatie_interactie <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doy_iid_generatie_interactie$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doy_iid_generatie_interactie$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doy_iid_generatie_interactie$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, generatie, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)%>%
  mutate(model = "met generatie-effect en interactie")

data_predict_zondergeneratie <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doy_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doy_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doy_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, generatie, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)%>%
  mutate(model = "zonder generatie-effect") 

data_predict <- bind_rows(data_predict_generatie,
                          data_predict_generatie_interactie) %>%
  bind_rows(data_predict_zondergeneratie)



```

```{r, fig.height= 6, fig.cap = "Gemodelleerde en geobserveerde aantallen voor verschillende modellen van Bruin dikkopje" }
data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy, group = generatie, fill = generatie, colour = generatie, ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_100m_obs, x = doy,  colour = generatie)) +
  facet_grid(model ~ fjaar)
```



```{r}
trendmodel_generatie <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100", generation_effect = TRUE)

trendmodel_nogeneratie <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100", generation_effect = FALSE)

trend_generatie <- derive_trend(analyseset_species_locations, trendmodel_generatie) %>%
  mutate(model = "met generatie effect")
trend_nogeneratie <- derive_trend(analyseset_species_locations, trendmodel_nogeneratie) %>%
  mutate(model = "zonder generatie effect")

bind_rows(trend_generatie) %>%
  bind_rows(trend_nogeneratie) %>%
  select(model, parameter, soort_nl, mean , lcl_0.90, ucl_0.90) %>%
  kable(caption = "Effect van het al dan niet opnemen van generatie in model op de geschatte trend") %>%
  kable_styling()
```

### Effect weersomstandigheden

Voor de Aardbeivlinder vergelijken we modellen met en zonder covariabelen gerelateerd aan het weer.

```{r}

analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Aardbeivlinder")

indexmodel_doy_iid_weather <- inla(aantal ~ fjaar  + bewolking_cont + temperatuur + windkracht +  doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_no_weather <- inla(aantal ~ fjaar + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))


waic_weather <- get_waic(analyseset_species_locations, indexmodel_doy_iid_weather) %>%
  mutate(model = "met effect van weersomstandigheden")

waic_noweather <- get_waic(analyseset_species_locations, indexmodel_doy_iid_no_weather) %>%
  mutate(model = "zonder effect van weersomstandigheden")

bind_rows(waic_weather, waic_noweather) %>%
  select(soort_nl, model, waic) %>%
  kable(caption = "Vergelijking van modellen met en zonder covariabelen gerelateerd aan het weer") %>%
  kable_styling()



```



```{r}
indexmodel_doy_iid_weather$summary.fixed %>%
  kable(digits = 4, caption = "Geschatte parameters voor model met covariabelen gerelateerd aan weersomstandigheden") %>%
  kable_styling()
```
Zowel temperatuur en windkracht hebben significant effect op de aantallen.

```{r}
indexmodel_doy_iid_no_weather$summary.fixed %>%
  kable(digits = 4, caption = "Geschatte parameters voor model zonder covariabelen gerelateerd aan weersomstandigheden") %>%
  kable_styling()
```

### Informatie per locatie

We willen ook een (ruw) signaal krijgen als een bepaalde locatie sterk achteruitgaat of sterk vooruitgaat. Hiervoor testen we een model uit met random intercept en random slope.

```{r}
analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Veldparelmoervlinder")
```


```{r, eval=FALSE}
analyseset_species_locations %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot",  alpha = 0.8) +
  facet_wrap(~ locatie, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  theme(legend.position = "bottom") 
```
```{r, fig.height= 6, fig.cap= "Aantallen per locatie voor Veldparelmoervlinder met gam-smoother"}
analyseset_species_locations %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  geom_point(alpha = 0.6) +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 4) , size = 1) +
  facet_wrap(~ locatie, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  theme(legend.position = "bottom") 
```



```{r}
### via random slope

analyseset_species_locations <- analyseset_species_locations %>%
  mutate(fjaar = factor(jaar),
         locatie = as.character(locatie),
         locatie = as.factor(locatie),
         min_year = min(jaar),
         year_scaled = jaar - min_year,
         locatie2 = locatie,
         data_type = "observed") 

sim_data <- analyseset_species_locations %>%
  as_tibble %>%
  tidyr::expand(nesting(locatie, locatie2, year_scaled, jaar, fjaar)) %>%
  mutate(data_type = "simulated")

data_combined <- analyseset_species_locations %>%
  bind_rows(sim_data)

prec.prior <- list(prec = list(param = c(0.001, 0.001)))


trendmodel_doy_iid<- inla(aantal ~ year_scaled + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

trendmodel_doy_iid2<- inla(aantal ~ year_scaled + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior)  + f(locatie2, year_scaled,  model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combined,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))



to_sigma <- function(tau){sqrt(1/tau)}

cat("sigma random intercept: \n")
sigma_randomintercept <-  trendmodel_doy_iid2$marginals.hyperpar$`Precision for locatie` %>%
inla.tmarginal(fun = to_sigma) %>%
inla.zmarginal()

cat("\nsigma random slope: \n")
sigma_randomslope <- trendmodel_doy_iid2$marginals.hyperpar$`Precision for locatie2` %>%
inla.tmarginal(fun = to_sigma) %>%
inla.zmarginal()

data_simulated <- data_combined %>%
  mutate(mean = exp(trendmodel_doy_iid2$summary.fitted.values$mean),
         lcl_0.95 = exp(trendmodel_doy_iid2$summary.fitted.values$`0.025quant`),
         ucl_0.95 = exp(trendmodel_doy_iid2$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(soort_nl, locatie, jaar, fjaar, mean, lcl_0.95, ucl_0.95)

```

```{r, fig.cap = "Gemoddelleerde trend per locatie voor Veldparelmoervlinder"}
data_simulated %>%
  ggplot(aes(x = jaar, y = mean, group = locatie,  colour = locatie)) +
  geom_line() +
  scale_colour_brewer(palette = "Set1")
```


```{r, fig.cap = "Gemoddelleerde trend per locatie voor Veldparelmoervlinder met 95%-betrouwbaarheidsinterval"}
data_simulated %>%
  ggplot(aes(x = jaar, y = mean, group = locatie, ymin = lcl_0.95, ymax = ucl_0.95)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) + 
  ylim(0,40) +
  facet_wrap(~locatie)
```

```{r}

get_trend_mean <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame()
  
} 

get_trend_quantiles <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
} 

trend_locatie_mean <- map_df(trendmodel_doy_iid2$marginals.random$locatie2, get_trend_mean) 

trend_locatie_quantiles <- map_df(trendmodel_doy_iid2$marginals.random$locatie2, get_trend_quantiles) %>%
  mutate(locatie = unique(data_simulated$locatie)) %>%
  bind_cols(trend_locatie_mean)



```

```{r, fig.cap= "Schatting en classificatie van trend per locatie met 60%-betrouwbaarheidsinterval"}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- trend_locatie_quantiles %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.60_log = log(lcl_0.60/100 + 1),
         ucl_0.60_log = log(ucl_0.60/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) *100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) *100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.60, ucl_0.60, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c(-60, -50, -25, 0, 33, 100)/100 + 1)
labels_show <- str_c(c(-60,  -50, -25, 0, 33, 100), " %")

trend %>%
  ggplot( aes(x = locatie, y = mean_log, ymin = lcl_0.60_log, ymax = ucl_0.60_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 +1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "Locatie") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```

```{r, eval=FALSE}
trendmodel_doy_iid2$summary.random$locatie %>%
  rename(locatie = ID, lcl_0.95 = "0.025quant", ucl_0.95= "0.975quant") %>%
  ggplot(aes(x = locatie, y = exp(mean), ymin = exp(lcl_0.95), ymax = exp(ucl_0.95))) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point() +
  ylim(0,20) +
  coord_flip()
```




## Modellering voor alle soorten

### Keuze model

We opteren voor een model met:

+ seizoenseffect via 2de graads polynoom
+ random intercept voor locatie
+ generatie als covariabele en interactie generatie en seizoenseffect voor Argusvlinder, Bruin dikkopje en Klaverblauwtje
+ jaar als continue variabele voor trendmodel
+ jaar als factor variabele voor indexmodel 

### Gebruikte functies

+ fit_indexmodel_nbinom_inla
+ derive_index_inla
+ fit_trendmodel_nbinom_inla
+ derive trend

Zie onderstaande code-blok.

```{r}
fit_indexmodel_nbinom_inla <- function(analyseset_species, offset_var = NULL, season_effect = TRUE, generation_effect = FALSE) {
  
  analyseset_species <- analyseset_species %>%
    mutate(fjaar = factor(jaar),
           locatie = as.character(locatie),
           locatie = as.factor(locatie))
  
  prec.prior <- list(prec = list(param = c(0.001, 0.001)))
  
  if (season_effect) {
    
    if (generation_effect) {
      
      formula_indexmodel <- as.formula("aantal ~ fjaar + generatie*doy_scaled + generatie*doy_scaled_2 + f(locatie, model = \"iid\", hyper = prec.prior)")
      
    } else {
      
      formula_indexmodel <- as.formula("aantal ~ fjaar + doy_scaled + doy_scaled_2 + f(locatie, model = \"iid\", hyper = prec.prior)")
      
    }
    
  } else {
    
    if (generation_effect) {
      
      formula_indexmodel <- as.formula("aantal ~ fjaar + generatie + f(locatie, model = \"iid\", hyper = prec.prior)")
      
    } else {
      
      formula_indexmodel <- as.formula("aantal ~ fjaar + f(locatie, model = \"iid\", hyper = prec.prior)")
      
    }
    
  } 
  
  if(is.null(offset_var)) {
    
  indexmodel_nbinom_doy_iid <- inla(formula_indexmodel,
                                      family = "nbinomial",
                                      data = analyseset_species,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))
  } else {
    
    analyseset_species2 <- analyseset_species %>%
      rename(offset = offset_var)
    
    indexmodel_nbinom_doy_iid <- inla(formula_indexmodel,
                                      family = "nbinomial",
                                      data = analyseset_species2,
                                      offset = offset,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))
    
  }
  
  
  return(indexmodel_nbinom_doy_iid)
  
}

derive_index_inla <- function(analyseset_species, indexmodel_nbinom_inla, ref_method = "min") {
  
  if (min(analyseset_species$jaar) == 2016){
    
    fun = function(...) {
      c(exp(fjaar2017),  exp(fjaar2018), exp(fjaar2019), exp(fjaar2020), exp(fjaar2021))
    }
    
  } else if (min(analyseset_species$jaar) == 2017) {
    
    fun = function(...) {
      c(exp(fjaar2018), exp(fjaar2019), exp(fjaar2020), exp(fjaar2021))
    }
      
    } else if (min(analyseset_species$jaar) == 2018) {
      
      fun = function(...) {
        c(exp(fjaar2019), exp(fjaar2020), exp(fjaar2021))
      } 
        } else if (min(analyseset_species$jaar) == 2019) {
      
          fun = function(...) {
            c(exp(fjaar2020), exp(fjaar2021))
          }
    
  }
  
  model_inla.samples <- inla.posterior.sample(1000, indexmodel_nbinom_inla)
  
  quantile_values <- c(0.025, 0.05, 0.20, 0.35,  0.65, 0.80, 0.95, 0.975)
  
  predict_year_inla <- inla.posterior.sample.eval(fun, model_inla.samples) %>%
    as.data.frame() %>%
    mutate(jaar = (min(analyseset_species$jaar) + 1):max(analyseset_species$jaar)) %>%
    gather(starts_with("sample"), key = "sample", value = "waarde") %>%
    group_by(jaar) %>%
    mutate(mean = mean(waarde),
           sd = sd(waarde)) %>%
    ungroup() %>%
    group_by(jaar, mean, sd) %>%
    summarise(qs = quantile(waarde, quantile_values), prob = quantile_values) %>%
    ungroup() %>%
    mutate(l_u = ifelse(prob < 0.5, "lcl", "ucl"),
           ci = ifelse(prob %in% c(0.025, 0.975), "0.95",
                       ifelse(prob %in% c(0.05, 0.95), "0.90",
                              ifelse(prob %in% c(0.20, 0.80), "0.60",
                                     ifelse(prob %in% c(0.35, 0.65), "0.30", NA)))),
           type = str_c(l_u, "_", ci)) %>%
    select(-prob, -l_u, -ci) %>%
    spread(key = type, value = qs) %>%
    mutate(soort_nl = unique(analyseset_species$soort_nl),
           soort_wet = unique(analyseset_species$soort_wet),
           ref_jaar = min(jaar) - 1,
           parameter = "index") %>%
    select(parameter, soort_nl, soort_wet, jaar, ref_jaar, everything())
  
  return(predict_year_inla)
    
}

fit_trendmodel_nbinom_inla <- function(analyseset_species, offset_var = NULL, generation_effect = FALSE) {
  
  analyseset_species <- analyseset_species %>%
    mutate(fjaar = factor(jaar),
           locatie = as.character(locatie),
           locatie = as.factor(locatie),
           min_year = min(jaar),
           year_scaled = jaar - min_year)
  
  prec.prior <- list(prec = list(param = c(0.001, 0.001)))
  
  if (generation_effect) {
    
    trendmodel_formula <- as.formula("aantal ~ year_scaled + doy_scaled*generatie + doy_scaled_2*generatie + f(locatie, model = \"iid\", hyper = prec.prior)")
    
  } else  {
    
    trendmodel_formula <- as.formula("aantal ~ year_scaled + doy_scaled + doy_scaled_2 + f(locatie, model = \"iid\", hyper = prec.prior)")
    
  }
  
  
  if(is.null(offset_var)) {
    
    trendmodel_nbinom_doy_iid <- inla(trendmodel_formula,
                                      family = "nbinomial",
                                      data = analyseset_species,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))
  } else {
    
    analyseset_species2 <- analyseset_species %>%
      rename(offset = offset_var)
    
    trendmodel_nbinom_doy_iid <- inla(trendmodel_formula,
                                      family = "nbinomial",
                                      data = analyseset_species2,
                                      offset = offset,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))
  }
  
  return(trendmodel_nbinom_doy_iid)
  
}


derive_trend <- function(analyseset_species, trendmodel_nbinom) {
  
  #gemiddelde jaarlijkse trend
  
  trend_average <- trendmodel_nbinom$marginals.fixed$year_scaled %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame() %>%
    mutate(parameter = "trend_average",
           soort_nl = unique(analyseset_species$soort_nl),
           soort_wet = unique(analyseset_species$soort_wet),
           jaar_min = min(analyseset_species$jaar),
           jaar_max = max(analyseset_species$jaar)) %>%
    select(parameter, soort_nl, soort_wet, jaar_min, jaar_max, mean, sd, lcl_0.95 = quant0.025, ucl_0.95 = quant0.975)
  
  trend_quantiles <- trendmodel_nbinom$marginals.fixed$year_scaled %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
  trend_average <- trend_average %>%
    bind_cols(trend_quantiles)
  
  #totale trend over volledige periode 
  
  periode <- n_distinct(analyseset_species$jaar)

  trend_totaal <- trendmodel_nbinom$marginals.fixed$year_scaled %>%
    inla.tmarginal(fun = function(x) (exp(x * (periode - 1)) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame() %>%
    mutate(parameter = "trend_total",
           soort_nl = unique(analyseset_species$soort_nl),
           soort_wet = unique(analyseset_species$soort_wet),
           jaar_min = min(analyseset_species$jaar),
           jaar_max = max(analyseset_species$jaar)) %>%
    select(parameter, soort_nl, soort_wet, jaar_min, jaar_max, mean, sd, lcl_0.95 = quant0.025, ucl_0.95 = quant0.975)
  
  trend_totaal_quantiles <- trendmodel_nbinom$marginals.fixed$year_scaled %>%
    inla.tmarginal(fun = function(x) (exp(x * (periode - 1)) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
  trend_totaal <- trend_totaal %>%
    bind_cols(trend_totaal_quantiles)
  
  trend <- bind_rows(trend_average,
                     trend_totaal)
  
  return(trend)
  
} 

```




```{r}

analyseset_locations_by_species <- analyseset_locations %>%
  group_by(meetnet) %>%
  nest() %>%
  mutate(offset_var = "log_section_100",
         season_effect = TRUE,
         generation_effect = meetnet %in% c("Argusvlinder", "Bruin dikkopje", "Klaverblauwtje"))

models_inla <- analyseset_locations_by_species %>%
  mutate(indexmodel = pmap(list(data, offset_var, season_effect, generation_effect), fit_indexmodel_nbinom_inla),
         trendmodel = pmap(list(data, offset_var, generation_effect), fit_trendmodel_nbinom_inla))

results_indexmodel <- models_inla %>%
  transmute(index = map2(data, indexmodel, derive_index_inla)) %>%
  select(meetnet, index) %>%
  unnest()

results_trendmodel  <- models_inla %>%
  transmute(trend = map2(data, trendmodel, derive_trend)) %>%
  select(meetnet, trend) %>%
  unnest()

waic_index  <- models_inla %>%
  transmute(waic_index =  map2(data, indexmodel, get_waic)) %>%
  select(meetnet, waic_index) %>%
  unnest() %>%
  mutate(model = "indexmodel")

waic_trend  <- models_inla %>%
  transmute(waic_trend =  map2(data, trendmodel, get_waic)) %>%
  select(meetnet, waic_trend) %>%
  unnest() %>%
  mutate(model = "trendmodel")

results_waic <- bind_rows(waic_index, 
                         waic_trend) %>%
  spread(key = "model", value = "waic") %>%
  mutate(diff_waic = trendmodel - indexmodel,
         type_trend = ifelse(diff_waic > 0,
                               "Niet lineair",
                               ifelse(diff_waic > -2,
                                      "Quasi lineair", "Lineair")))

check_model <- analyseset_locations %>%
  filter(meetnet == "Argusvlinder") %>% 
  fit_indexmodel_nbinom_inla(offset_var = "log_section_100", generation_effect = TRUE)

check <- analyseset_locations %>%
  filter(meetnet == "Argusvlinder") %>%
  derive_index_inla(check_model)

check <- results_indexmodel %>%
  filter(meetnet == "Argusvlinder") %>%
  bind_rows(check)

```




```{r}

results_indexmodel %>%
  write_vc(file = "results_indexmodel", 
         root = here(str_c("analysis_vlinders/output/temp")), 
         sorting = c("parameter", "soort_nl", "jaar"),
         strict = FALSE)

results_trendmodel %>%
  write_vc(file = "results_trendmodel", 
         root = here(str_c("analysis_vlinders/output/temp")), 
         sorting = c("parameter", "soort_nl"), strict = FALSE)

results_waic %>%
  write_vc(file = "results_waic", 
         root = here(str_c("analysis_vlinders/output/temp")), 
         sorting = c("parameter", "soort_nl"),
         strict = FALSE)

```


### Validatie

```{r}
model_validation <- models_inla %>%
  transmute(dispersion_check_model = map(indexmodel, dispersion_check),
            distribution_check_model = map(indexmodel, fast_distribution_check),
            iid_check = map(indexmodel, check_random_effect)
            )


dispersion <- model_validation %>%
  transmute(dispersion_data = map(dispersion_check_model, "data"),
            dispersion_model = map(dispersion_check_model, "model")) %>%
  select(meetnet, dispersion_data, dispersion_model) %>%
  unnest(c(dispersion_data, dispersion_model))

distribution <- model_validation %>%
  select(meetnet, distribution_check_model) %>%
  unnest(distribution_check_model) %>%
  filter(lcl < 0.98 & ucl < 1)

iid_checked <- model_validation %>%
  select(meetnet, iid_check) %>%
  unnest(iid_check)

```

#### Dispersie

```{r}

ggplot(data = dispersion, aes(x = dispersion_model)) +
      geom_density() +
      geom_vline(data = dispersion, aes(xintercept = dispersion_data), linetype = 2) +
      facet_wrap(~meetnet, scales = "free_x")
     
```

#### Distributie

```{r, fig.height= 8}
distribution %>%
  mutate(
      median = .data$ecdf / .data$median,
      lcl = .data$ecdf / .data$lcl,
      ucl = .data$ecdf / .data$ucl
    ) %>%
  ggplot(aes_string(x = "x", y = "median")) +
   # geom_blank(data = data.frame(x = min(x$x), median = c(0.95, 1.05))) +
    geom_hline(yintercept = 1, linetype = 2) +
    geom_line(aes_string(y = "lcl"), linetype = 3, alpha = 0.5) +
    geom_line(aes_string(y = "ucl"), linetype = 3, alpha = 0.5) +
    geom_ribbon(alpha = 0.1, aes_string(ymin = "lcl", ymax = "ucl")) +
    geom_line() +
    scale_y_continuous("observed / expected", labels = scales::percent) +
    facet_wrap(~meetnet, scales = "free")
```

#### Random effect

```{r}

iid_checked_plot <- iid_checked %>%
  group_by(meetnet) %>%
  mutate(x_c = sim_iid - mean(sim_iid),
         y = exp(x_c + log(1))) %>%
  ungroup()

iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      facet_wrap(~meetnet + sigma_tekst, scales = "free")
    
```





### Resultaten


#### Vergelijking tussen de jaren

```{r}
verschillen_jaren <- results_indexmodel %>%
  filter(parameter == "index") %>%
  mutate(klasse = classification(lcl_0.90, ucl_0.90, threshold = c(0.75, 1.33), reference = 1),
         klasse = format(klasse, type = "markdown")) %>%
  select(soort_nl, soort_wet, ref_jaar, jaar, klasse) %>%
  spread(key = "jaar", value = "klasse") %>%
  ungroup() %>%
  select(-meetnet)
  
```
```{r}
verschillen_jaren %>%
  select(-soort_wet) %>%
  rename("Nederlandse naam" = soort_nl,  Referentiejaar = ref_jaar) %>%
  kbl(caption = "Verschil in aantallen t.o.v. referentiejaar",
      booktabs = TRUE,
      escape = FALSE,
      align = "lcccccc") %>%
kable_styling() %>%
add_header_above(c(" " = 2, "Verschil t.o.v. referentiejaar" = 5))
```


#### Trends

```{r, fig.cap = "Schatting en classificatie van trends voor de verschillende soorten met 90%-betrouwbaarheidsinterval"}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- results_trendmodel %>%
 # filter(meetnet != "Klaverblauwtje") %>%
  filter(parameter == "trend_average") %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) *100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) *100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c(-75, -50, -25, 0, 33, 100)/100 + 1)
labels_show <- str_c(c(-75,  -50, -25, 0, 33, 100), " %")

trend %>%
  ggplot( aes(x = meetnet, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 +1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "Soort") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```

#### WAIC

```{r}
results_waic %>%
  mutate(indexmodel = round(indexmodel, 1),
         trendmodel = round(trendmodel, 1),
         diff_waic = round(diff_waic, 1)) %>%
  select(meetnet, waic_indexmodel = indexmodel, waic_trendmodel = trendmodel, diff_waic, type_trend) %>%
  kable() %>%
  kable_styling()
```


## Documenteer analyse

```{r}

mypath <- here(str_c("analysis_vlinders/output/temp"))

hashes <-
    tibble(filepath = str_c(mypath, "/",
        list.files(path = mypath,
            recursive = TRUE)
      )) %>%
    mutate(name_analysis = name_analysis,
           version = Sys.Date(),
           filename = str_match(filepath, "(.+\\/)*(.+)")[,3],
           md5 = map(filepath, function(x) {
                           file(x) %>% md5 %>% str_c(collapse = '')
                         }) %>% as.character,
           sha256 = map(filepath, function(x) {
                          file(x) %>% sha256 %>% str_c(collapse = '')
                          }) %>% as.character
           ) %>%
    select(name_analysis,
           version,
           filename,
           md5,
           sha256)

file_name <- here(str_c("analysis_vlinders/output/analysis_hashes.csv"))

if (!file.exists(file_name)) {
  
  new_analysis <- TRUE
  
  analysis_hashes <- hashes

} else {
  
  analysis_hashes <- read_csv(file_name)
  
  hashes_new <- hashes %>%
    anti_join(analysis_hashes, by = c("name_analysis", "filename", "md5", "sha256"))
  
  new_analysis <- nrow(hashes_new) > 0
  
  analysis_hashes <- bind_rows(analysis_hashes,
                               hashes)
  
}

if (new_analysis) {
  
  new_path <- here(str_c("analysis_vlinders/output/", name_analysis, "_", Sys.Date()))
  
  if (!dir.exists(new_path)) {
    
    dir.create(new_path)
    file.copy(from = str_c(mypath, "/analyseset.tsv"), to = str_c(new_path, "/analyseset.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/analyseset.yml"), to = str_c(new_path, "/analyseset.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_indexmodel.tsv"), to = str_c(new_path, "/results_indexmodel.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_indexmodel.yml"), to = str_c(new_path, "/results_indexmodel.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_trendmodel.tsv"), to = str_c(new_path, "/results_trendmodel.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_trendmodel.yml"), to = str_c(new_path, "/results_trendmodel.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_waic.tsv"), to = str_c(new_path, "/results_waic.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_waic.yml"), to = str_c(new_path, "/results_waic.yml"), overwrite = TRUE)
  }
  
  analysis_hashes %>%
    write_csv(file_name)
  
}

```


