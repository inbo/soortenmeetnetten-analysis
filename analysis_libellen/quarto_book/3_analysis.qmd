# Analyse

```{r}
#| label: setup  
#| output: false
#| cache: false

library(knitr)
options(knitr.kable.NA = '')

library(tidyverse)
library(INBOtheme)
library(INBOmd)
library(sf)
library(INLA)
library(inlatools)
library(kableExtra)
library(units)
library(effectclass)
library(openssl)
library(git2rdata)
library(n2khab)
library(DT)

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::lag)
conflicted::conflicts_prefer(tidyr::expand)
```

```{r}
#| label: load-functions

path_functions <- fileman_up("soortenmeetnetten-analysis")

source(file.path(path_functions, "source/functions_smp.R"))

```

## Transecttelling

```{r}
#| label: load-data

name_analysis2 <- "libellen_transecten"

name_analyseset <- str_c("analyseset_", name_analysis2)
versie <- str_c(name_analysis2, "_2025-11-12")

analyseset_transect <- read_vc(file = name_analyseset,
                               root = str_c("../output/analyseset/", versie))

```

### Keuze model

We kiezen een model met volgende kenmerken:

-   Seizoenseffect
    -   tweede orde random walk voor dagnummer
-   Locatie-effect
    -   random intercept voor locatie
-   Zoekinspanning: het logaritme van van de transectlengte/50 als offset
-   Tijdseffect
    -   Meetcyclus = 1 jaar
        -   Verschillen tussen de jaren: jaar als eerste orde random walk (index per jaar)
        -   Gemiddelde jaarlijkse verschil: jaar als continue variabele (trend)
    -   Meetcyclus = 3 jaar
        -   Verschillen tussen meetcycli: meetcyclus als factor (index per meetcyclus)
        -   Gemiddelde verschil tussen meetcycli: meetcyclus als continue variabele (trend meetcyclus)
        -   Trend meetcyclus herrekenen naar jaarlijkse trend.

```{r}
#| label: analysis-jaarmodel

seed <- 15486

analyseset_transect <- analyseset_transect %>%
  mutate(log_section_50 = log(lengte_transect/50)) %>%
  filter(meetnet != "Beekrombout")

analyseset_transect_by_species <- analyseset_transect %>%
  group_by(meetnet) %>%
  nest() %>%
  mutate(offset_var = "log_section_50",
         use_seed = seed,
         use_meetcyclus = FALSE)

models_inla <- analyseset_transect_by_species %>%
  mutate(indexmodel = pmap(list(data, offset_var, use_meetcyclus), fit_indexmodel_rw_nbinom_inla),
         trendmodel = map2(data, offset_var, fit_trendmodel_rw_nbinom_inla))

results_indexmodel <- models_inla %>%
  transmute(index = pmap(list(data, indexmodel, use_meetcyclus, use_seed), derive_index_rw_inla)) %>%
  unnest(cols = c(meetnet, index))

results_trendmodel_jaar  <- models_inla %>%
  transmute(trend = map2(data, trendmodel, derive_trend)) %>%
  unnest(cols = c(meetnet, trend))

waic_index  <- models_inla %>%
  transmute(waic_index =  map2(data, indexmodel, get_waic)) %>%
  select(meetnet, waic_index) %>%
  unnest() %>%
  mutate(model = "indexmodel")

waic_trend  <- models_inla %>%
  transmute(waic_trend =  map2(data, trendmodel, get_waic)) %>%
  select(meetnet, waic_trend) %>%
  unnest() %>%
  mutate(model = "trendmodel")

results_waic <- bind_rows(waic_index, 
                         waic_trend) %>%
  spread(key = "model", value = "waic") %>%
  mutate(diff_waic = trendmodel - indexmodel,
         type_trend = ifelse(diff_waic > 0,
                               "Niet lineair",
                               ifelse(diff_waic > -2,
                                      "Quasi lineair", "Lineair")))

```

```{r}
#| label: analysis-meetcyclusmodel

analyseset_meetcyclus <- analyseset_transect %>%
  filter(duur_meetcyclus > 1) %>%
  group_by(meetnet, meetcyclus) %>%
  filter((min(jaar) + duur_meetcyclus - 1) <= 2024) %>%
  mutate(periode = str_c(min(jaar), "_", min(jaar) + duur_meetcyclus - 1)) %>%
  ungroup() %>%
  mutate(locatie = as.factor(locatie),
         doy_scaled = doy - min(doy))

indexmodel_doyrw2_iid_meetcyclus <- inla(aantal ~ periode  + 
                                f(doy_scaled, model = "rw2", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                 f(locatie, model = "iid", 
                                   hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                              family = "nbinomial",
                              data = analyseset_meetcyclus %>%
                                filter(meetnet == "Bosbeekjuffer"),
                              offset = log_section_50,
                              control.compute = list(config = TRUE, waic = TRUE),
                              control.predictor = list(compute = TRUE))

seed <- 551515

index_meetcyclus_bj <- derive_index_meetcyclus_inla(
  indexmodel_nbinom_inla = indexmodel_doyrw2_iid_meetcyclus,
  function_eval = function(...) {c(exp(periode2021_2023))},
  set_seed = seed)

indexmodel_doyrw2_iid_meetcyclus <- inla(aantal ~ periode  + 
                                f(doy_scaled, model = "rw2", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                 f(locatie, model = "iid", 
                                   hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                              family = "nbinomial",
                              data = analyseset_meetcyclus %>%
                                filter(meetnet == "Variabele waterjuffer"),
                              offset = log_section_50,
                              control.compute = list(config = TRUE, waic = TRUE),
                              control.predictor = list(compute = TRUE))

index_meetcyclus_vwj <- derive_index_meetcyclus_inla(
  indexmodel_nbinom_inla = indexmodel_doyrw2_iid_meetcyclus,
  function_eval = function(...) {c(exp(periode2020_2022))},
  set_seed = seed)

indexmodel_doyrw2_iid_meetcyclus <- inla(aantal ~ periode  + 
                                f(doy_scaled, model = "rw2", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                 f(locatie, model = "iid", 
                                   hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                              family = "nbinomial",
                              data = analyseset_meetcyclus %>%
                                filter(meetnet == "Vroege glazenmaker",
                                      periode != "2023_2025" ),
                              offset = log_section_50,
                              control.compute = list(config = TRUE, waic = TRUE),
                              control.predictor = list(compute = TRUE))

set.seed(54545)

index_meetcyclus_vg <- derive_index_meetcyclus_inla(
  indexmodel_nbinom_inla = indexmodel_doyrw2_iid_meetcyclus,
  function_eval = function(...) {c(exp(periode2020_2022))},
  set_seed = seed)

result_indexmodel_meetcyclus <- index_meetcyclus_bj %>%
  bind_rows(index_meetcyclus_vwj) %>%
  bind_rows(index_meetcyclus_vg)

models_trend_meetcyclus <- analyseset_meetcyclus %>%
  filter(meetnet %in% analyseset_meetcyclus$soort_nl) %>%
  group_by(meetnet) %>%
  nest() %>%
  mutate(offset_var = "log_section_50",
         use_seed = seed,
         use_meetcyclus = TRUE) %>%
  mutate(trendmodel = pmap(list(data, offset_var, use_meetcyclus), fit_trendmodel_rw_nbinom_inla))

results_trendmodel_meetcyclus  <- models_trend_meetcyclus %>%
  transmute(trend = pmap(list(data, trendmodel, use_meetcyclus), derive_trend)) %>%
  unnest(cols = c(meetnet, trend))

```

```{r}
#| label: write-result
#| output: false

results_indexmodel %>%
  filter(parameter != "sample_value") %>%
  write_vc(file = str_c("results_indexmodel_", name_analysis2), 
        
         sorting = c("parameter", "soort_nl", "jaar"),
         strict = FALSE)

result_indexmodel_meetcyclus %>%
  write_vc(file = str_c("results_indexmodel_meetcyclus_", name_analysis2), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl", "meetcyclus"),
         strict = FALSE)

results_trendmodel_jaar %>%
  write_vc(file = str_c("results_trendmodel_", name_analysis2), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl"), strict = FALSE)

results_trendmodel_meetcyclus %>%
  write_vc(file = str_c("results_trendmodel_meetcyclus_", name_analysis2), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl"), strict = FALSE)

results_waic %>%
  write_vc(file = str_c("results_waic_", name_analysis2), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl"),
         strict = FALSE)

```

### Validatie model

```{r}
#| label: validatie

model_validation <- models_inla %>%
  transmute(dispersion_check_model = map(indexmodel, dispersion_check),
            distribution_check_model = map(indexmodel, fast_distribution_check),
            iid_check = map(indexmodel, check_random_effect)
            )

dispersion <- model_validation %>%
  transmute(dispersion_data = map(dispersion_check_model, "data"),
            dispersion_model = map(dispersion_check_model, "model")) %>%
  select(meetnet, dispersion_data, dispersion_model) %>%
  unnest(c(dispersion_data, dispersion_model))

distribution <- model_validation %>%
  select(meetnet, distribution_check_model) %>%
  unnest(distribution_check_model) %>%
  filter(lcl < 0.98 & ucl < 1)

iid_checked <- model_validation %>%
  select(meetnet, iid_check) %>%
  unnest(iid_check)

```

#### Dispersie

```{r}
#| label: fig-dispersie
#| fig-cap: "Dispersie"

ggplot(data = dispersion, aes(x = dispersion_model)) +
      geom_density() +
      geom_vline(data = dispersion, aes(xintercept = dispersion_data), linetype = 2) +
      facet_wrap(~meetnet, scales = "free_x")
     
```

#### Distributie

```{r, fig.height= 8}

#| label: fig-distributie
#| fig-cap: "Distributie"

distribution %>%
  mutate(
      median = .data$ecdf / .data$median,
      lcl = .data$ecdf / .data$lcl,
      ucl = .data$ecdf / .data$ucl
    ) %>%
  ggplot(aes_string(x = "x", y = "median")) +
   # geom_blank(data = data.frame(x = min(x$x), median = c(0.95, 1.05))) +
    geom_hline(yintercept = 1, linetype = 2) +
    geom_line(aes_string(y = "lcl"), linetype = 3, alpha = 0.5) +
    geom_line(aes_string(y = "ucl"), linetype = 3, alpha = 0.5) +
    geom_ribbon(alpha = 0.1, aes_string(ymin = "lcl", ymax = "ucl")) +
    geom_line() +
    scale_y_continuous("observed / expected", labels = scales::percent) +
    facet_wrap(~meetnet, scales = "free")
```

#### Random effect

```{r}
#| label: fig-random-effect
#| fig-cap: "Random effect"

iid_checked_plot <- iid_checked %>%
  group_by(meetnet) %>%
  mutate(x_c = sim_iid - mean(sim_iid),
         y = exp(x_c + log(1))) %>%
  ungroup()

iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      facet_wrap(~meetnet + sigma_tekst, scales = "free")
    
```

## Gebiedstelling

```{r}
#| label: load-data-gebied

name_analysis1 <- "libellen_gebiedstelling"

name_analyseset <- str_c("analyseset_", name_analysis1)
versie <- str_c(name_analysis1, "_2025-11-12")

analyseset_gebied <- read_vc(file = name_analyseset,
                               root = str_c("../output/analyseset/", versie))

```

### Keuze model

We kiezen voor het zelfde model als bij de transecttellingen maar dan zonder offset (geen zoekinspanning bepaald).

```{r}
#| label: analysis-gebied

seed <- 20211124

set.seed(seed)

analyseset_locations_by_species <- analyseset_gebied %>%
  group_by(meetnet) %>%
  nest() %>%
  mutate(use_seed = seed,
         use_meetcyclus = FALSE)

models_inla <- analyseset_locations_by_species %>%
  mutate(indexmodel = map(data, fit_indexmodel_rw_nbinom_inla),
         trendmodel = map(data, fit_trendmodel_rw_nbinom_inla))

results_indexmodel_gebied <- models_inla %>%
  transmute(index = pmap(list(data, indexmodel, use_meetcyclus, use_seed), derive_index_rw_inla)) %>%
  unnest(cols = c(meetnet, index))

results_trendmodel_gebied  <- models_inla %>%
  transmute(trend = map2(data, trendmodel, derive_trend)) %>%
  select(meetnet, trend) %>%
  unnest()

waic_index_gebied  <- models_inla %>%
  transmute(waic_index =  map2(data, indexmodel, get_waic)) %>%
  select(meetnet, waic_index) %>%
  unnest() %>%
  mutate(model = "indexmodel")

waic_trend_gebied  <- models_inla %>%
  transmute(waic_trend =  map2(data, trendmodel, get_waic)) %>%
  select(meetnet, waic_trend) %>%
  unnest() %>%
  mutate(model = "trendmodel")

results_waic_gebied <- bind_rows(waic_index_gebied, 
                         waic_trend_gebied) %>%
  spread(key = "model", value = "waic") %>%
  mutate(diff_waic = trendmodel - indexmodel,
         type_trend = ifelse(diff_waic > 0,
                               "Niet lineair",
                               ifelse(diff_waic > -2,
                                      "Quasi lineair", "Lineair")))
```

```{r}
#| label: results-gebied
#| output: false

results_indexmodel_gebied %>%
  filter(parameter != "sample_vaue") %>%
  write_vc(file = str_c("results_indexmodel_", name_analysis1), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl", "jaar"),
         strict = FALSE)

results_trendmodel_gebied %>%
  write_vc(file = str_c("results_trendmodel_", name_analysis1), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl"), strict = FALSE)

results_waic_gebied %>%
  write_vc(file = str_c("results_waic_", name_analysis1), 
         root = "../output/temp", 
         sorting = c("parameter", "soort_nl"),
         strict = FALSE)

```

### Validatie

```{r}
#| label: validatie-gebied

model_validation <- models_inla %>%
  transmute(dispersion_check_model = map(indexmodel, dispersion_check),
            distribution_check_model = map(indexmodel, fast_distribution_check),
            iid_check = map(indexmodel, check_random_effect)
            )

dispersion <- model_validation %>%
  transmute(dispersion_data = map(dispersion_check_model, "data"),
            dispersion_model = map(dispersion_check_model, "model")) %>%
  select(meetnet, dispersion_data, dispersion_model) %>%
  unnest(c(dispersion_data, dispersion_model))

distribution <- model_validation %>%
  select(meetnet, distribution_check_model) %>%
  unnest(distribution_check_model) %>%
  filter(lcl < 0.98 & ucl < 1)

iid_checked <- model_validation %>%
  select(meetnet, iid_check) %>%
  unnest(iid_check)

```

#### Dispersie

```{r}
#| label: fig-dispersie-gebied
#| fig-cap: Dispersie

ggplot(data = dispersion, aes(x = dispersion_model)) +
      geom_density() +
      geom_vline(data = dispersion, aes(xintercept = dispersion_data), linetype = 2) +
      facet_wrap(~meetnet, scales = "free_x")

```

#### Distributie

```{r}
#| label: fig-distributie-gebied
#| fig-cap: Distributie

distribution %>%
  mutate(
      median = .data$ecdf / .data$median,
      lcl = .data$ecdf / .data$lcl,
      ucl = .data$ecdf / .data$ucl
    ) %>%
  ggplot(aes_string(x = "x", y = "median")) +
   # geom_blank(data = data.frame(x = min(x$x), median = c(0.95, 1.05))) +
    geom_hline(yintercept = 1, linetype = 2) +
    geom_line(aes_string(y = "lcl"), linetype = 3, alpha = 0.5) +
    geom_line(aes_string(y = "ucl"), linetype = 3, alpha = 0.5) +
    geom_ribbon(alpha = 0.1, aes_string(ymin = "lcl", ymax = "ucl")) +
    geom_line() +
    scale_y_continuous("observed / expected", labels = scales::percent) +
    facet_wrap(~meetnet, scales = "free")
```

#### Random effect

```{r}
#| label: fig-randomeffect-gebied
#| fig-cap: Random effect

iid_checked_plot <- iid_checked %>%
  group_by(meetnet) %>%
  mutate(x_c = sim_iid - mean(sim_iid),
         y = exp(x_c + log(1))) %>%
  ungroup()

iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      facet_wrap(~meetnet + sigma_tekst, scales = "free")
    
```

## Resultaten

### Vergelijking tussen de jaren

```{r}
#| label: results-jaar-ref

results_indexmodel_all <- bind_rows(results_indexmodel,
                                results_indexmodel_gebied)

verschil_jaren_ref <- results_indexmodel_all %>%
  filter(parameter == "index") %>%
  filter(!is.na(mean)) %>%
  mutate(klasse = classification(lcl_0.90, ucl_0.90, threshold = c(0.75, 1.33), reference = 1),
         klasse = format(klasse, type = "markdown"))
  
verschil_jaren_ref_add <- verschil_jaren_ref %>%
  distinct(soort_nl, soort_wet, ref_jaar) %>%
  mutate(jaar = ref_jaar,
        mean = 1,
         klasse = "R") 

verschil_jaren_ref <- verschil_jaren_ref %>%
  bind_rows(verschil_jaren_ref_add) %>%
  mutate(mean_log = log(mean) + 1,
          lcl_0.90_log = log(lcl_0.90) + 1,
         ucl_0.90_log = log(ucl_0.90) + 1)
  
```

```{r}
#| label: fig-jaar
#| fig-cap: Verschillen t.o.v. referentiejaar
#| fig-height: 9

c(rev(traffic_palette(7)), "grey65", "grey35", "grey50") %>%
  setNames(
    c("++", "+", "+~", "~", "-~", "-", "--", "?+", "?-", "?")
  ) -> klasse_color
klasse_color[4] <- inbo_steun_blauw

breaks_log <- log(c(0.01, 0.1, 0.25, 0.5, 0.75, 1, 1.33, 2, 3, 6)) + 1
labels_show <- str_c(c(-99, -90, -75, -50, -25, 0, 33, 100, 200, 500), " %")

verschil_jaren_ref %>%
  mutate(klasse = str_remove_all(klasse, "`")) %>%
  ggplot(aes(x = jaar, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_errorbar(width = 0, size = 6, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_hline(yintercept = log(0.75) + 1, linetype = 3) +
  geom_hline(yintercept = log(1.33) + 1, linetype = 3) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Verschil t.o.v. referentiejaar", x = "Jaar") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show) +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide") +
  facet_wrap(~soort_nl, scales = "free_y")

ggsave("../output/libellen_index.png",
       width = 14,
       height = 10)
```

```{r}
#| label: results-jaar-previous

verschil_vorigjaar <- results_indexmodel_all %>%
  filter(parameter == "diff_previous_year") %>%
  mutate(periode = str_c(lag(jaar), " - ", jaar )) %>%
  filter(!is.na(mean)) %>%
  mutate(klasse = classification(lcl_0.90, ucl_0.90, threshold = c(0.75, 1.33), reference = 1),
         klasse = format(klasse, type = "markdown")) %>%
  mutate(mean_log = log(mean) + 1,
          lcl_0.90_log = log(lcl_0.90) + 1,
         ucl_0.90_log = log(ucl_0.90) + 1)
  
```

```{r, fig.height=11}
#| label: fig-jaar-previous
#| fig-cap: Verschil t.o.v. vorig jaar

verschil_vorigjaar %>%
  mutate(klasse = str_remove_all(klasse, "`")) %>%
  ggplot(aes(x = periode, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_errorbar(width = 0, size = 6, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_hline(yintercept = log(0.75) + 1, linetype = 3) +
  geom_hline(yintercept = log(1.33) + 1, linetype = 3) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Verschil opeenvolgende jarenr", x = "Jaar") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show) +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide",
        axis.text.x = element_text(angle = 45)) +
  facet_wrap(~soort_nl, scales = "free_y")
```

### Vergelijking tussen de meetcycli

```{r}
#| label: results-meetcyclus

verschil_meetcyclus <- result_indexmodel_meetcyclus %>%
  mutate(klasse = classification(lcl_0.90, ucl_0.90, threshold = c(0.75, 1.33), reference = 1),
         klasse = format(klasse, type = "markdown")) %>%
  mutate(mean_log = log(mean) + 1,
         lcl_0.90_log = log(lcl_0.90) + 1,
         ucl_0.90_log = log(ucl_0.90) + 1)

verschil_meetcyclus_add <- verschil_meetcyclus %>%
  distinct(soort_nl, soort_wet) %>%
  mutate(klasse = "R",
         periode = ifelse(soort_nl == "Oranje zandoogje", "2017-2019", "2016-2018"),
         mean = 0,
         mean_log = 1)
```

```{r}
#| label: fig-results-meetcyclus
#| fig-cap: Verschil t.o.v. referntiemeetcyclus

verschil_meetcyclus <- verschil_meetcyclus %>%
  bind_rows(verschil_meetcyclus_add)

verschil_meetcyclus %>%
  mutate(klasse = str_remove_all(klasse, "`")) %>%
  ggplot(aes(x = periode, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_hline(yintercept = log(0.75) + 1, linetype = 3) +
  geom_hline(yintercept = log(1.33) + 1, linetype = 3) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Verschil t.o.v. referentiemeetcyclus", x = "Meetcyclus") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show) +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide", 
        axis.text.x = element_text(angle = 45)) +
  facet_wrap(~soort_nl, scales = "free")
```

### Trends

```{r}
#| label: results-trend

results_trendmodel_all <- bind_rows(results_trendmodel_jaar %>%
                                      filter(!soort_nl %in% c("Variabele waterjuffer", "Vroege glazenmaker", "Bosbeekjuffer")),
                                    results_trendmodel_meetcyclus,
                                    results_trendmodel_gebied)

klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- results_trendmodel_all %>%
  filter(parameter %in% c("trend_average", "trend_jaar")) %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) * 100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) * 100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

```

```{r}
#| label: fig-results-trend
#| fig-cap: Schatting en classificatie van trends voor de verschillende soorten met 90%-betrouwbaarheidsinterval

volgorde_soorten <- (trend %>%
  arrange(mean))$meetnet

breaks_log <- log(c(-75, -50, -25, 0, 33, 100, 200)/100 + 1)
labels_show <- str_c(c(-75, -50, -25, 0, 33, 100, 200), " %")

trend %>%
  mutate(meetnet = factor(meetnet, levels = volgorde_soorten)) %>%
  ggplot( aes(x = meetnet, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 +1))), linetype = 3, alpha = 0.8) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = 2, alpha = 0.8) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "Soort") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")

ggsave("../output/libellen_trend.png")
```

```{r}

names_analysis <- c(name_analysis1, name_analysis2)

mypath <- "../output/temp"

hashes <-
    tibble(filepath = str_c(mypath, "/",
        list.files(path = mypath,
            recursive = TRUE)
      )) %>%
    mutate(version = Sys.Date(),
           filename = str_match(filepath, "(.+\\/)*(.+)")[,3],
           name_analysis = str_extract(filename, str_c(names_analysis, collapse =  "|")),
           md5 = map(filepath, function(x) {
                           file(x) %>% md5 %>% str_c(collapse = '')
                         }) %>% as.character,
           sha256 = map(filepath, function(x) {
                          file(x) %>% sha256 %>% str_c(collapse = '')
                          }) %>% as.character
           ) %>%
    select(name_analysis,
           version,
           filename,
           md5,
           sha256) %>%
  filter(str_detect(filename, "result"))

file_name <- "../output/analysis_hashes.tsv"

if (!file.exists(file_name)) {
  
  new_analysis <- TRUE
  
  analysis_hashes <- hashes
  
  hashes_new <- analysis_hashes

} else {
  
  analysis_hashes <- read_vc(file = "analysis_hashes", root = "../output")
  
  hashes_new <- hashes %>%
    anti_join(analysis_hashes, by = c("name_analysis", "filename", "md5", "sha256"))
  
  new_analysis <- nrow(hashes_new) > 0
  
  analysis_hashes <- bind_rows(analysis_hashes,
                               hashes)
  
  names_analysis <- unique(hashes_new$name_analysis) 
  
}

if (new_analysis) {
  
  for (i in 1:nrow(hashes_new)) {
    
     path_to <- str_c("../output/results/", hashes_new$name_analysis[i], "_", hashes_new$version[i])
     
     if (!dir.exists(path_to)) {
       
     dir.create(path_to)
       
     }
       
       file.copy(from = str_c(mypath,"/", hashes_new$filename[i]), 
                 to = str_c(path_to, "/", hashes_new$filename[i]), 
                 overwrite = TRUE)

  }
  
     analysis_hashes %>%
       write_vc(file = "analysis_hashes", root = "../output", sorting = c("name_analysis", "version", "filename"), strict = FALSE)
}


```

```{r}
#| eval: false

read_vc(file = "analysis_hashes", root = "../output") %>%
  datatable(rownames = FALSE)
```

## Gebruikte functies

-   fit_indexmodel_rw_nbinom_inla

```{r}
fit_indexmodel_rw_nbinom_inla
```

-   fit_trendmodel_rw_nbinom_inla

```{r}
fit_trendmodel_rw_nbinom_inla
```

-   derive_index_rw_sample

```{r}
derive_index_rw_sample
```

-   derive_index_rw_inla

```{r}
derive_index_rw_inla
```

-   derive_trend

```{r}
derive_trend
```
