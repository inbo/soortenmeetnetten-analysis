

# Vlinders - Transecttelling"

```{r}

species_group <- "dagvlinders"
protocol_selection <- c("Vlinders - Transecten")

name_analysis <- "vlinders_transecten"

set.seed(47830)
```

## Selectie analyseset

```{r select data, warning = FALSE}

locatie_detail <- get_locations_smp() %>%
  st_drop_geometry() %>%
  filter(locatie_type == "locatie") %>%
  select(meetnet, locatie, is_active, is_sample)

visits <- get_visits_smp(species_group = species_group) %>%
  filter(protocol == protocol_selection)

counts <- get_counts_smp(species_group = species_group, count_aggregation = "individuals") %>%
  filter(primaire_soort)

covars <- get_covariates_smp(species_group = species_group) %>%
  filter(protocol %in% protocol_selection) %>%
  select(-eenheid) %>%
  pivot_wider(names_from = "bezoekvariabele", values_from = "waarde") %>%
  mutate(bewolking = factor(bewolking, levels = c("heldere hemel (0/8)", "lichtbewolkt (1 tot 2/8)", "halfbewolkt (3 tot 5/8)", "zwaarbewolkt (6 tot 7/8)", "betrokken (8/8)")),
         temperatuur = as.numeric(temperatuur),
         windkracht = factor(windkracht, levels = c("windstil (0 Bft)", "zeer zwakke wind (1 Bft)", "zwakke wind (2 Bft)" , "vrij matige wind (3 Bft)", "matige wind (4 Bft)", "vrij krachtige wind (5 Bft)", "krachtige wind (6 Bft)", "stormachtig (8 Bft)")))
  
count_period_generatie <- get_characteristics_smp() %>%
  mutate(doy_min_generatie = as.numeric(format(start_telperiode, "%j")),
         doy_max_generatie = as.numeric(format(einde_telperiode, "%j")),
         doy_mid_generatie = doy_min_generatie + round((doy_max_generatie - doy_min_generatie)/2, 0)) %>%
  distinct(meetnet, protocol, generatie, doy_min_generatie, doy_max_generatie, doy_mid_generatie)

count_period <- get_characteristics_smp() %>%
  mutate(doy_min = as.numeric(format(start_telperiode, "%j")),
         doy_max = as.numeric(format(einde_telperiode, "%j"))) %>%
  group_by(meetnet, protocol) %>%
  summarise(doy_min = min(doy_min),
            doy_max = max(doy_max)) %>%
  ungroup() %>%
  mutate(doy_mid = doy_min + round((doy_max - doy_min)/2, 0)) %>%
  distinct(meetnet, protocol, doy_min, doy_max, doy_mid)

```

+ We selecteren de meetnetten die al minstens drie jaar lopen.

```{r}
meetnetten_selection <- visits %>%
  filter(protocol == protocol_selection) %>%
  group_by(meetnet, protocol) %>%
  summarise(n_jaar = n_distinct(jaar)) %>%
  filter(n_jaar >= 3)

meetnetten_selection %>%
  kable(caption = "selectie meetnetten") %>%
  kable_styling()
```


+ We selecteren bezoeken voor actieve locaties waarvoor die aangeduid zijn als geschikt voor analyse (voor_analyse = TRUE)

```{r}
visits_selection <- visits %>%
  filter(meetnet %in% meetnetten_selection$meetnet) %>%
  mutate(generatie = ifelse(doy < 175, "generatie1", "generatie2")) %>%
  left_join(locatie_detail, by = c("meetnet", "locatie")) %>%
  filter(voor_analyse & !is.na(is_active)) %>%
  left_join(count_period, by = c("meetnet", "protocol")) %>%
  left_join(count_period_generatie, by = c("meetnet", "protocol", "generatie")) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         doy_scaled_generatie = (doy - doy_mid_generatie)/28,
         fjaar = factor(jaar)) %>%
  group_by(soortgroep, meetnet, protocol, locatie, jaar, fjaar) %>%
  mutate(n_obs = n_distinct(visit_id)) %>%
  ungroup()

locaties_niet_actief <- visits %>%
  distinct(meetnet, locatie) %>%
  anti_join(visits_selection, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel locaties waar de soort minstens tijdens 1 bezoek werd waargenomen

```{r}
counts_sublocation_selection <- visits_selection %>%
  select(soortgroep, meetnet, protocol, generatie, locatie, jaar, datum, doy, doy_scaled, doy_min, doy_max, doy_mid, doy_scaled_generatie, doy_min_generatie, doy_max_generatie, doy_mid_generatie,  visit_id, n_obs, voor_analyse, is_active, is_sample, bezoek_status, bezoek_status_oud) %>%
  left_join(select(counts, visit_id, sublocatie, soort_nl, soort_wet, aantal), by = "visit_id") %>%
  left_join(covars, by = c("meetnet", "protocol", "visit_id")) %>%
  group_by(meetnet, locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)

locations_absence <- visits_selection %>%
  group_by(meetnet, locatie) %>%
  summarise(n_visits = n_distinct(visit_id)) %>%
  ungroup() %>%
  anti_join(counts_sublocation_selection, by = c("meetnet", "locatie"))

locations_absence %>%
  kable(caption = "Locaties met enkel nulwaarnemingen") %>%
  kable_styling()
```


### Transectlengte

We bereken de lengte per sectie op basis van de ingevoerde transecten in de meetnetten.be databank. Indien geen transect werd ingevoerd voor een locatie veronderstellen we dat het transect 50 meter meet.

```{r}
transecten <- get_transects_smp() %>% 
  filter(soortgroep == "dagvlinders") %>%
  st_transform(crs = 31370) %>%
  mutate(lengte_sectie = round(drop_units(st_length(geom)), 0)) %>%
  st_drop_geometry() %>%
  select( meetnet, locatie, sublocatie, lengte_sectie) %>%
  group_by(meetnet, locatie) %>%
  mutate(lengte_transect = sum(lengte_sectie)) %>%
  ungroup() %>%
  mutate(sectie_nr = as.numeric(str_sub(sublocatie, start = 7))) %>%
  arrange(meetnet, locatie, sectie_nr)

```

```{r}
transect_missing <- counts_sublocation_selection %>%
  group_by(meetnet, locatie, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id)) %>%
  anti_join(transecten, by = c("meetnet", "locatie")) 
  
transect_missing %>%
  kable(caption = "locaties waarvoor transecten nog niet in meetnetten.be-databanken zitten") %>%
  kable_styling()

```





```{r}
counts_sublocation_selection_transect <- counts_sublocation_selection %>%
  left_join(transecten, by = c("meetnet", "locatie", "sublocatie")) %>%
  mutate(lengte_sectie = ifelse(is.na(lengte_sectie), 50, lengte_sectie))

counts_location_selection_transect <- counts_sublocation_selection_transect %>%
  group_by(soortgroep, meetnet, soort_nl, soort_wet, protocol, generatie, locatie, jaar, datum, doy, doy_scaled, doy_min, doy_max, doy_mid, doy_scaled_generatie, doy_min_generatie, doy_max_generatie, doy_mid_generatie, visit_id, n_obs, voor_analyse, is_active, is_sample, bezoek_status, windkracht, temperatuur, bewolking) %>%
  summarise(aantal = sum(aantal),
         lengte_transect = sum(lengte_sectie)) %>%
  ungroup()
  
```




```{r}
analyseset_sublocations <- counts_sublocation_selection_transect %>%
  mutate(fjaar = factor(jaar),
         locatie = factor(locatie),
         doy_scaled_2 = doy_scaled * doy_scaled,
         doy_scaled_generatie_2 = doy_scaled_generatie * doy_scaled_generatie,
         log_section_100 = log(lengte_transect/100)) %>%
  mutate(generatie = ifelse(soort_nl %in% c("Argusvlinder", "Bruin dikkopje", "Klaverblauwtje"),
                            ifelse(doy < 175, "generatie1", "generatie2"),
                            "generatie1"))

analyseset_sublocations_by_species <-  analyseset_sublocations %>%
  group_by(meetnet) %>%
  nest()

analyseset_locations <- counts_location_selection_transect %>%
  mutate(fjaar = factor(jaar),
         locatie = factor(locatie),
         doy_scaled_2 = doy_scaled * doy_scaled,
         doy_scaled_generatie_2 = doy_scaled_generatie * doy_scaled_generatie,
         log_section_100 = log(lengte_transect/100)) %>%
  mutate(generatie = ifelse(soort_nl %in% c("Argusvlinder", "Bruin dikkopje", "Klaverblauwtje"),
                            ifelse(doy < 175, "generatie1", "generatie2"),
                            "generatie1"))

analyseset_locations_by_species <- analyseset_locations %>%
  group_by(meetnet) %>%
  nest()


``` 

```{r}

write_vc(analyseset_sublocations, file = str_c("analyseset_sublocations_", name_analysis), 
       root = here(str_c("analysis_vlinders/output/temp")), 
       sorting = c("meetnet", "locatie", "sublocatie", "visit_id"), 
       strict = FALSE)


write_vc(analyseset_locations, file = str_c("analyseset_locations_", name_analysis), 
       root = here(str_c("analysis_vlinders/output/temp")), 
       sorting = c("meetnet", "locatie",  "visit_id"), 
       strict = FALSE)
  
```

## Dataverkenning

### Getelde aantallen

```{r}
analyseset_locations %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot",  alpha = 0.8) +
  facet_wrap(~ soort_nl, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  theme(legend.position = "bottom") 
```

```{r}
analyseset_locations %>%
  ggplot(aes(x= jaar, y = aantal *100/ lengte_transect)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot",  alpha = 0.8) +
  facet_wrap(~ soort_nl, scale = "free_y") +
  labs(y = "Aantal getelde individuen per 1000m transect", x = "Jaar") +
  theme(legend.position = "bottom") 
```


```{r, fig.height = 11}
analyseset_locations %>%
  ggplot(aes(x = doy, y = aantal, colour = generatie)) +
  geom_point() +
  facet_grid(meetnet ~ jaar, scales = "free_y")
```
```{r, fig.height = 11}
analyseset_locations %>%
  ggplot(aes(x = doy, y = aantal * 100 / lengte_transect, colour = generatie)) +
  geom_point() +
  facet_grid(meetnet ~ jaar, scales = "free_y")
```

```{r, fig.height = 10}
analyseset_locations %>%
  group_by(meetnet, jaar) %>%
  filter(n_distinct(visit_id) > 15) %>%
  ungroup() %>%
  mutate(jaar = factor(jaar)) %>%
  ggplot(aes(x = doy, y = aantal, group = interaction(jaar, generatie), colour = jaar, fill = jaar)) +
  #geom_point(alpha = 0.4) +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 1) +
  ylim(c(0,35)) +
  facet_wrap(~ meetnet, scales = "free")
```

### Effect weersomstandigheden

```{r, fig.height=9}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  ggplot(aes(x = windkracht, y = aantal_100m)) +
  geom_boxplot() +
  facet_wrap(~meetnet, scales = "free", ncol = 2) + 
  coord_flip()
```
```{r, fig.height=9}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  ggplot(aes(x = bewolking, y = aantal_100m)) +
  geom_boxplot() +
  facet_wrap(~meetnet, scales = "free", ncol = 2) + 
  coord_flip()
```

```{r, fig.height=9}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  ggplot(aes(x = temperatuur, y = aantal_100m)) +
  geom_point() +
  facet_wrap(~meetnet, scales = "free", ncol = 2) +
  geom_smooth() 
```

```{r}
analyseset_locations <- analyseset_locations %>%
  mutate(bewolking_max = as.numeric(str_sub(bewolking, start = -4, end = -4)),
         bewolking_min = ifelse(bewolking_max > 0, as.numeric(str_sub(bewolking, start = -10, end = -10)), 0),
         bewolking_cont = (bewolking_max + bewolking_min)/2/8,
         windkracht = as.numeric(str_sub(windkracht, start = -6, end = -6)))

prec.prior <- list(prec = list(param = c(0.001, 0.001)))

model_conditions <- inla(aantal ~ temperatuur + windkracht + bewolking_cont + f(meetnet, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))


model_conditions$summary.fixed
```

```{r, fig.height= 10}
analyseset_locations %>%
  mutate(aantal_100m = aantal * 100 / lengte_transect) %>%
  group_by(meetnet) %>%
  mutate(aantal_100m_scaled = aantal_100m/ max(aantal_100m)) %>%
  ungroup() %>%
  ggplot(aes(x = temperatuur, y = bewolking_cont, size = aantal_100m_scaled)) +
  geom_jitter(alpha = 0.4) +
  facet_wrap(~meetnet)
```


## Modelering


```{r, eval = FALSE}

analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Veldparelmoervlinder")

# library(lme4)
# model_lme <- glmer.nb(aantal ~ fjaar + doy_scaled + doy_scaled_2 + (1|locatie),
#                          data = analyseset_species)
# 
# summary(model_lme)


# compare inla and inlabru with offset

indexmodel_nbinom_inla_offset_season_effect <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100")

indexmodel_nbinom_inlabru_offset_season_effect <- fit_indexmodel_nbinom_inlabru(analyseset_species = analyseset_species_locations, offset_var = "log_section_100")

compare <- bind_rows(indexmodel_nbinom_inla_offset_season_effect$summary.fixed,
                     indexmodel_nbinom_inlabru_offset_season_effect$summary.fixed)

## offset not working wit inlabru

# compare inla and inlabru without offset

indexmodel_nbinom_inla <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species_locations)

indexmodel_nbinom_inlabru <- fit_indexmodel_nbinom_inlabru(analyseset_species = analyseset_species_locations)

compare2 <- bind_rows(indexmodel_nbinom_inla$summary.fixed,
                     indexmodel_nbinom_inlabru$summary.fixed)

compare3 <- bind_rows(indexmodel_nbinom_inlabru_offset_season_effect$summary.fixed,
                     indexmodel_nbinom_inlabru$summary.fixed)


indexmodel_nbinom_inla_offset_noseason_effect <- fit_indexmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100", season_effect = FALSE)


index <- derive_index_inla(analyseset_species_locations, indexmodel_nbinom_inla) %>%
  mutate(offset = "nee",
         type = "season effect")

index_offset_season <- derive_index_inla(analyseset_species_locations, indexmodel_nbinom_inla_offset_season_effect) %>%
  mutate(offset = "ja",
         type = "season effect")

index_offset_noseason <- derive_index_inla(analyseset_species_locations, indexmodel_nbinom_inla_offset_noseason_effect) %>%
  mutate(offset = "ja",
         type = "no season effect")

index_vergelijk <- bind_rows(index, index_offset_season, index_offset_noseason) %>%
  select(offset, everything())

trendmodel_nbinom_inla <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species)
trendmodel_nbinom_inla_offset <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species, offset_var = "log_section_100")

trend <- derive_trend(analyseset_species, trendmodel_nbinom_inla) %>%
  mutate(offset = "nee")

trend_offset <- derive_trend(analyseset_species, trendmodel_nbinom_inla_offset) %>%
  mutate(offset = "ja")

trend_vergelijk <- bind_rows(trend, trend_offset) %>%
  select(offset, everything())


# max_count <- derive_max_count_inla(analyseset_species, indexmodel_nbinom_inla)%>%
#   mutate(offset = "nee")
# max_count_offset <- derive_max_count_inla(analyseset_species, indexmodel_nbinom_inla_offset) %>%
#   mutate(offset = "ja")
# max_count_vergelijk <- bind_rows(max_count, max_count_offset) %>%
#   select(offset, everything())


# simulate_data <- simulate_data_model_inlabru(analyseset_species_locations, indexmodel_nbinom_inla_offset_season_effect)

```
### Model voor soort met een generaties

```{r}

analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Veldparelmoervlinder") %>%
  mutate(fjaar = factor(jaar),
         locatie = as.character(locatie),
         locatie = as.factor(locatie),
         generatie = as.factor(generatie))

data_sim_add <- analyseset_species_locations %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy_mid, doy = full_seq(doy, 1)) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         doy_scaled_2 = doy_scaled * doy_scaled,
         doy_centered = doy - min(analyseset_species_locations$doy)) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_species_locations %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

prec.prior <- list(prec = list(param = c(0.001, 0.001)))

indexmodel_doy_iid <- inla(aantal ~ fjaar  + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doyrw_iid <- inla(aantal ~ fjaar  + f(doy_centered, model = "rw1", hyper = list(
theta = list(prior = "pc.prec", param = c(0.25, 0.05)))) + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))
bind_rows(
get_waic(analyseset_species_locations, indexmodel_doy_iid) %>%
  mutate(model = "polynoom voor doy"), 
get_waic(analyseset_species_locations, indexmodel_doyrw_iid) %>%
  mutate(model = "rw voor doy")) %>%
  select( model, everything()) %>%
  kable() %>%
  kable_styling()

  
```

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doy_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doy_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doy_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)


data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_100m_obs, x = doy)) +
  facet_wrap(~fjaar)
```

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doyrw_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doyrw_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doyrw_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)


data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_100m_obs, x = doy)) +
  facet_wrap(~fjaar)
```

### Model voor soort met twee generaties

```{r}
analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Bruin dikkopje")

analyseset_species_locations <- analyseset_species_locations %>%
  mutate(fjaar = factor(jaar),
         locatie = as.character(locatie),
         locatie = as.factor(locatie),
         generatie = as.factor(generatie))

prec.prior <- list(prec = list(param = c(0.001, 0.001)))

indexmodel_doy_iid <- inla(aantal ~ fjaar + f(doy_scaled, model = "clinear", range = c(0, Inf)) + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie <- inla(aantal ~ fjaar  + doy_scaled_generatie*generatie + doy_scaled_generatie_2*generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie2 <- inla(aantal ~ fjaar  + doy_scaled*generatie + doy_scaled_2*generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_rw_generatie2 <- inla(aantal ~ fjaar  + doy_scaled*generatie + doy_scaled_2*generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie3 <- inla(aantal ~ fjaar + generatie + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_iid_generatie <- inla(aantal ~ fjaar  + generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

index <- derive_index_inla(analyseset_species_locations, indexmodel_doy_iid) %>%
  mutate(model = "without generatie-effect")

index_generatie <- derive_index_inla(analyseset_species_locations, indexmodel_doy_iid_generatie) %>%
  mutate(model = "with generatie-effect")

index_generatie2 <- derive_index_inla(analyseset_species_locations, indexmodel_doy_iid_generatie2) %>%
  mutate(model = "with generatie-effect2")

index_generatie3 <- derive_index_inla(analyseset_species_locations, indexmodel_iid_generatie) %>%
  mutate(model = "with generatie-effect3")

bind_rows(index, index_generatie) %>%
  bind_rows(index_generatie2) %>%
  bind_rows(index_generatie3) %>%
  select(model, soort_nl, jaar, ref_jaar, mean, lcl_0.90, ucl_0.90) %>%
  kable() %>%
  kable_styling()


```

```{r}
waic<- get_waic(analyseset_species_locations, indexmodel_doy_iid) %>%
  mutate(model = "without generatie-effect")

waic_generatie <- get_waic(analyseset_species_locations, indexmodel_doy_iid_generatie) %>%
  mutate(model = "with generatie-effect")

waic_generatie2<- get_waic(analyseset_species_locations, indexmodel_doy_iid_generatie2) %>%
  mutate(model = "with generatie-effect2")

waic_generatie3 <- get_waic(analyseset_species_locations, indexmodel_iid_generatie) %>%
  mutate(model = "with generatie-effect3")

bind_rows(waic, waic_generatie) %>%
  bind_rows(waic_generatie2) %>%
  bind_rows(waic_generatie3) %>%
  select(model, everything()) %>%
  kable() %>%
  kable_styling()
```


```{r}



fitted_data <- analyseset_species_locations %>%
  mutate(fitted_mean = indexmodel_doy_iid_generatie$summary.fitted.values$mean,
         fitted_0.025quant = indexmodel_doy_iid_generatie$summary.fitted.values$`0.025quant`,
         fitted_0.975quant = indexmodel_doy_iid_generatie$summary.fitted.values$`0.975quant`,
         residuals = aantal - fitted_mean)


fitted_data %>% 
ggplot(aes(x = locatie, y = residuals)) +
  geom_boxplot() +
  facet_wrap(~generatie) +
  coord_flip()
```

```{r}
fitted_data %>% 
ggplot(aes(x = doy, y = residuals, colour = generatie)) +
  geom_point(alpha = 0.6) +
  facet_wrap(~fjaar)
```



```{r}

fixed_effects <- indexmodel_doy_iid_generatie$summary.fixed %>%
  rownames_to_column(var = "parameter") %>%
  select(parameter, mean)

fjaar_effect <- fixed_effects %>%
  filter(str_sub(parameter, 1, 5) == "fjaar") %>%
  rename(mean_year = mean, fjaar = parameter) %>%
  mutate(fjaar = str_sub(fjaar, start = 6))

intercept <- (fixed_effects %>%
                        filter(parameter == "(Intercept)"))$mean

generatie_effect <- fixed_effects %>%
  filter(parameter == "generatiegeneratie2") %>%
  rename(mean_generatie = mean,
         generatie = parameter) %>%
  mutate(generatie = str_sub(generatie, start = 10))

doy_effect <- fixed_effects %>%
  filter(str_detect(parameter, c(":|doy"))) %>%
  mutate(generatie = ifelse(str_detect(parameter, ":"), "generatie2", "generatie1"),
         parameter = ifelse(str_detect(parameter, "_2"), "doy_scaled_2", "doy_scaled")) %>%
  pivot_wider(names_from = "generatie",
              values_from = "mean") %>%
  mutate(generatie2 = generatie2 + generatie1) %>%
  pivot_longer(cols = c("generatie1", "generatie2"), 
               names_to = "generatie",
               values_to = "mean") %>%
  pivot_wider(names_from = "parameter", 
              names_prefix = "coef_", 
              values_from = "mean"
                )

data_sim <- analyseset_species_locations %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy = full_seq(doy, 1)) %>%
  mutate(generatie = ifelse(doy < 175, "generatie1", "generatie2"),
         intercept = intercept) %>%
  left_join(distinct(analyseset_species_locations, generatie, doy_mid_generatie), by = "generatie") %>%
  mutate(doy_scaled_generatie = (doy - doy_mid_generatie)/28) %>%
  left_join(fjaar_effect, by = "fjaar") %>%
  left_join(generatie_effect, by = "generatie") %>%
  left_join(doy_effect, by = "generatie") %>%
  mutate(mean_year = ifelse(is.na(mean_year), 0, mean_year),
         mean_generatie = ifelse(is.na(mean_generatie), 0, mean_generatie)) %>%
  mutate(aantal_predict = exp(intercept + mean_year + mean_generatie + doy_scaled_generatie * coef_doy_scaled + doy_scaled_generatie * doy_scaled_generatie * coef_doy_scaled_2)) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)
```

```{r}
ggplot(data = data_sim) +
  geom_line(aes(y = aantal_predict, x = doy, group = generatie, colour = generatie)) +
  geom_point(aes(y = aantal_100m_obs, x = doy,  colour = generatie)) +
  facet_wrap(~fjaar) 
```

```{r}
data_sim_add <- analyseset_species_locations %>%
  as_tibble() %>%
  tidyr::expand(fjaar, doy_mid, doy = full_seq(doy, 1)) %>%
  mutate(generatie = ifelse(doy < 175, "generatie1", "generatie2")) %>%
  mutate(doy_scaled = (doy - doy_mid)/28,
         doy_scaled_2 = doy_scaled * doy_scaled) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_species_locations %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

indexmodel_doy_iid_generatie2 <- inla(aantal ~ fjaar  + doy_scaled*generatie + doy_scaled_2*generatie + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_generatie3 <- inla(aantal ~ fjaar + generatie  + f(doy_scaled, model = "clinear", range = c(0, Inf)) + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combine,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_doy_iid_generatie3$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_doy_iid_generatie3$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_doy_iid_generatie3$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(fjaar, doy, generatie, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_species_locations, aantal_obs = aantal, doy, fjaar, lengte_transect), by = c("doy", "fjaar")) %>%
  mutate(aantal_100m_obs = aantal_obs * 100/ lengte_transect)


data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy, group = generatie, fill = generatie, colour = generatie, ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_100m_obs, x = doy,  colour = generatie)) +
  facet_wrap(~fjaar)

```


```{r}
trendmodel_generatie <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100", generation_effect = TRUE)

trendmodel_nogeneratie <- fit_trendmodel_nbinom_inla(analyseset_species = analyseset_species_locations, offset_var = "log_section_100", generation_effect = FALSE)

trend_generatie <- derive_trend(analyseset_species_locations, trendmodel_generatie) %>%
  mutate(model = "generatie effect")
trend_nogeneratie <- derive_trend(analyseset_species_locations, trendmodel_nogeneratie) %>%
  mutate(model = "no generatie effect")

bind_rows(trend_generatie) %>%
  bind_rows(trend_nogeneratie) %>%
  select(model, parameter, soort_nl, mean , lcl_0.90, ucl_0.90) %>%
  kable() %>%
  kable_styling()
```

### Effect weersomstandigheden

```{r}

analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Aardbeivlinder")

indexmodel_doy_iid_weather <- inla(aantal ~ fjaar  + bewolking_cont + temperatuur + windkracht +  doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

indexmodel_doy_iid_no_weather <- inla(aantal ~ fjaar + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))


waic_weather <- get_waic(analyseset_species_locations, indexmodel_doy_iid_weather) %>%
  mutate(model = "with weather effect")

waic_noweather <- get_waic(analyseset_species_locations, indexmodel_doy_iid_no_weather) %>%
  mutate(model = "without weather effect")

bind_rows(waic_weather, waic_noweather) %>%
  kable() %>%
  kable_styling()



```

```{r}
indexmodel_doy_iid_weather$summary.fixed
```
### Trend per locatie

```{r}
analyseset_species_locations <- analyseset_locations %>%
  filter(meetnet == "Veldparelmoervlinder")
```


```{r}
analyseset_species_locations %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot",  alpha = 0.8) +
  facet_wrap(~ locatie, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  theme(legend.position = "bottom") 
```
```{r}
analyseset_species_locations %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  geom_point(alpha = 0.6) +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 4) , size = 1) +
  facet_wrap(~ locatie, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  theme(legend.position = "bottom") 
```



```{r}
### via random slope


analyseset_species_locations <- analyseset_species_locations %>%
  mutate(fjaar = factor(jaar),
         locatie = as.character(locatie),
         locatie = as.factor(locatie),
         min_year = min(jaar),
         year_scaled = jaar - min_year,
         locatie2 = locatie,
         data_type = "observed") 

sim_data <- analyseset_species_locations %>%
  as_tibble %>%
  tidyr::expand(nesting(locatie, locatie2, year_scaled, jaar, fjaar)) %>%
  mutate(data_type = "simulated")

data_combined <- analyseset_species_locations %>%
  bind_rows(sim_data)

prec.prior <- list(prec = list(param = c(0.001, 0.001)))


trendmodel_doy_iid<- inla(aantal ~ year_scaled + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = analyseset_species_locations,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

trendmodel_doy_iid2<- inla(aantal ~ year_scaled + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior)  + f(locatie2, year_scaled,  model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combined,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

trendmodel_doy_iid3<- inla(aantal ~ f(jaar, model = "rw1") + doy_scaled + doy_scaled_2 + f(locatie, model = "iid", hyper = prec.prior)  + f(locatie2, year_scaled,  model = "iid", hyper = prec.prior),
                                      family = "nbinomial",
                                      data = data_combined,
                                      offset = log_section_100,
                                      control.compute = list(config = TRUE, waic = TRUE),
                                      control.predictor = list(compute = TRUE))

to_sigma <- function(tau){sqrt(1/tau)}

sigma_randomintercept <-  trendmodel_doy_iid2$marginals.hyperpar$`Precision for locatie` %>%
inla.tmarginal(fun = to_sigma) %>%
inla.zmarginal()

sigma_randomslope <- trendmodel_doy_iid2$marginals.hyperpar$`Precision for locatie2` %>%
inla.tmarginal(fun = to_sigma) %>%
inla.zmarginal()

data_simulated <- data_combined %>%
  mutate(mean = exp(trendmodel_doy_iid2$summary.fitted.values$mean),
         lcl_0.95 = exp(trendmodel_doy_iid2$summary.fitted.values$`0.025quant`),
         ucl_0.95 = exp(trendmodel_doy_iid2$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(soort_nl, locatie, jaar, fjaar, mean, lcl_0.95, ucl_0.95)

```

```{r}
data_simulated %>%
  ggplot(aes(x = jaar, y = mean, group = locatie,  colour = locatie)) +
  geom_line() +
  scale_colour_brewer(palette = "Set1")
```


```{r, fig.height=10}
data_simulated %>%
  ggplot(aes(x = jaar, y = mean, group = locatie, ymin = lcl_0.95, ymax = ucl_0.95)) +
  geom_line() +
  geom_ribbon(alpha = 0.2) + 
  facet_wrap(~locatie, scales = "free", ncol = 3)
```

```{r}

get_trend_mean <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame()
  
} 

get_trend_quantiles <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
} 

trend_locatie_mean <- map_df(trendmodel_doy_iid2$marginals.random$locatie2, get_trend_mean) 

trend_locatie_quantiles <- map_df(trendmodel_doy_iid2$marginals.random$locatie2, get_trend_quantiles) %>%
  mutate(locatie = unique(data_simulated$locatie)) %>%
  bind_cols(trend_locatie_mean)



```

```{r}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- trend_locatie_quantiles %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.60_log = log(lcl_0.60/100 + 1),
         ucl_0.60_log = log(ucl_0.60/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) *100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) *100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.60, ucl_0.60, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c(-60, -50, -25, 0, 33, 100)/100 + 1)
labels_show <- str_c(c(-60,  -50, -25, 0, 33, 100), " %")

trend %>%
  ggplot( aes(x = locatie, y = mean_log, ymin = lcl_0.60_log, ymax = ucl_0.60_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 +1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "Locatie") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```

```{r}
trendmodel_doy_iid2$summary.random$locatie %>%
  rename(locatie = ID, lcl_0.95 = "0.025quant", ucl_0.95= "0.975quant") %>%
  ggplot(aes(x = locatie, y = exp(mean))) +
  geom_point() +
  coord_flip()
```



```{r}
data_simulated2 <- data_combined %>%
  mutate(mean = exp(trendmodel_doy_iid3$summary.fitted.values$mean),
         lcl_0.95 = exp(trendmodel_doy_iid3$summary.fitted.values$`0.025quant`),
         ucl_0.95 = exp(trendmodel_doy_iid3$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(soort_nl, locatie, jaar, fjaar, mean, lcl_0.95, ucl_0.95)
```

```{r}
data_simulated2 %>%
  ggplot(aes(x = jaar, y = mean, group = locatie,  colour = locatie)) +
  geom_line() +
  scale_colour_brewer(palette = "Set1")
```

```{r, fig.height=10}
data_simulated2 %>%
  ggplot(aes(x = jaar, y = mean, group = locatie, ymin = lcl_0.95, ymax = ucl_0.95)) +
  geom_line() +
  geom_point() +
  geom_ribbon(alpha = 0.2) + 
  facet_wrap(~locatie, scales = "free", ncol = 3)
```


### Alle soorten


```{r}

analyseset_locations_by_species <- analyseset_locations %>%
  group_by(meetnet) %>%
  nest() %>%
  mutate(offset_var = "log_section_100",
         season_effect = TRUE,
         generation_effect = meetnet %in% c("Argusvlinder", "Bruin dikkopje"))

models_inla <- analyseset_locations_by_species %>%
  mutate(indexmodel = pmap(list(data, offset_var, season_effect, generation_effect), fit_indexmodel_nbinom_inla),
         trendmodel = pmap(list(data, offset_var, generation_effect), fit_trendmodel_nbinom_inla))

results_indexmodel <- models_inla %>%
  transmute(index = map2(data, indexmodel, derive_index_inla)) %>%
  select(meetnet, index) %>%
  unnest()

results_trendmodel  <- models_inla %>%
  transmute(trend = map2(data, trendmodel, derive_trend)) %>%
  select(meetnet, trend) %>%
  unnest()

waic_index  <- models_inla %>%
  transmute(waic_index =  map2(data, indexmodel, get_waic)) %>%
  select(meetnet, waic_index) %>%
  unnest() %>%
  mutate(model = "indexmodel")

waic_trend  <- models_inla %>%
  transmute(waic_trend =  map2(data, trendmodel, get_waic)) %>%
  select(meetnet, waic_trend) %>%
  unnest() %>%
  mutate(model = "trendmodel")

results_waic <- bind_rows(results_waic_index, 
                         results_waic_trend) %>%
  spread(key = "model", value = "waic") %>%
  mutate(diff_waic = trendmodel - indexmodel,
         type_trend = ifelse(diff_waic > 0,
                               "Niet lineair",
                               ifelse(diff_waic > -2,
                                      "Quasi lineair", "Lineair")))

check_model <- analyseset_locations %>%
  filter(meetnet == "Argusvlinder") %>% 
  fit_indexmodel_nbinom_inla(offset_var = "log_section_100", generation_effect = TRUE)

check <- analyseset_locations %>%
  filter(meetnet == "Argusvlinder") %>%
  derive_index_inla(check_model)

check <- results_indexmodel %>%
  filter(meetnet == "Argusvlinder") %>%
  bind_rows(check)

```


```{r}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- results_trendmodel %>%
  filter(meetnet != "Klaverblauwtje") %>%
  filter(parameter == "trend_average") %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) *100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) *100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c(-75, -50, -25, 0, 33, 100)/100 + 1)
labels_show <- str_c(c(-75,  -50, -25, 0, 33, 100), " %")

trend %>%
  ggplot( aes(x = meetnet, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 +1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "Soort") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```



```{r}

bind_rows(results_indexmodel) %>%
  write_vc(file = "results_indexmodel", 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("parameter", "soort_nl", "jaar"),
         strict = FALSE)

results_trend %>%
  write_vc(file = "results_trendmodel", 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("parameter", "soort_nl"), strict = FALSE)

results_waic %>%
  write_vc(file = "results_waic", 
         root = here(str_c("analysis_", species_group, "/output/temp")), 
         sorting = c("parameter", "soort_nl"),
         strict = FALSE)

```


## Validatie

```{r}
model_validation <- models_inla %>%
  transmute(dispersion_check_model = map(indexmodel, dispersion_check),
            distribution_check_model = map(indexmodel, fast_distribution_check),
            iid_check = map(indexmodel, check_random_effect)
            )


dispersion <- model_validation %>%
  transmute(dispersion_data = map(dispersion_check_model, "data"),
            dispersion_model = map(dispersion_check_model, "model")) %>%
  select(meetnet, dispersion_data, dispersion_model) %>%
  unnest(c(dispersion_data, dispersion_model))

distribution <- model_validation %>%
  select(meetnet, distribution_check_model) %>%
  unnest(distribution_check_model) %>%
  filter(lcl < 0.98 & ucl < 1)

iid_checked <- model_validation %>%
  select(meetnet, iid_check) %>%
  unnest(iid_check)

```

### Dispersie

```{r}

ggplot(data = dispersion, aes(x = dispersion_model)) +
      geom_density() +
      geom_vline(data = dispersion, aes(xintercept = dispersion_data), linetype = 2) +
      facet_wrap(~meetnet, scales = "free_x")
     
```

### Distributie

```{r, fig.height= 8}
distribution %>%
  mutate(
      median = .data$ecdf / .data$median,
      lcl = .data$ecdf / .data$lcl,
      ucl = .data$ecdf / .data$ucl
    ) %>%
  ggplot(aes_string(x = "x", y = "median")) +
   # geom_blank(data = data.frame(x = min(x$x), median = c(0.95, 1.05))) +
    geom_hline(yintercept = 1, linetype = 2) +
    geom_line(aes_string(y = "lcl"), linetype = 3, alpha = 0.5) +
    geom_line(aes_string(y = "ucl"), linetype = 3, alpha = 0.5) +
    geom_ribbon(alpha = 0.1, aes_string(ymin = "lcl", ymax = "ucl")) +
    geom_line() +
    scale_y_continuous("observed / expected", labels = scales::percent) +
    facet_wrap(~meetnet, scales = "free", ncol = 2)
```

### Random effect

```{r}

iid_checked_plot <- iid_checked %>%
  group_by(meetnet) %>%
  mutate(x_c = sim_iid - mean(sim_iid),
         y = exp(x_c + log(1))) %>%
  ungroup()

iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      facet_wrap(~meetnet + sigma_tekst, scales = "free")
    
```





## Visualisatie model

```{r}
model_simulate <- models_inlabru %>%
  transmute(data_simulated = map2(data, indexmodel, simulate_data_model_inlabru))

results_data_simulated <- model_simulate %>%
  unnest(data_simulated)
```




```{r, warning=FALSE, fig.height= 9}

ggplot(data = results_data_simulated, aes(x = doy)) + 
  geom_line(aes(y = mean, group = loc_id, colour = factor(loc_id)), linetype = 2 ) +
  geom_point(aes(y = y_obs), alpha = 0.5, size = 1) +
  geom_line(aes(y = mean_year), size = 1, colour = "black") +
  geom_ribbon(aes(ymin = lci_0.95_year, ymax = uci_0.95_year), alpha = 0.3) +
  facet_grid(soort_nl ~ jaar, scales = "free") +
  theme(legend.position = "none")
```
```{r, fig.width= 9, fig.height= 9}
# analyseset_species <- counts_analysis %>%
#   filter(meetnet == "Speerwaterjuffer")
# 
# analyseset_species %>%
#   ggplot(aes(x = jaar, y = aantal)) +
#   geom_point() +
#   facet_wrap(~locatie)

counts_analysis %>%
  ggplot(aes(x = locatie, y =aantal)) +
  geom_point(alpha = 0.4, size = 2) +
  coord_flip() +
  facet_wrap(~meetnet, scales = "free_y", ncol = 1)
  

```

## Documenteer analyse

```{r}

mypath <- here(str_c("analysis_", species_group, "/output/temp"))

hashes <-
    tibble(filepath = str_c(mypath, "/",
        list.files(path = mypath,
            recursive = TRUE)
      )) %>%
    mutate(name_analysis = name_analysis,
           version = Sys.Date(),
           filename = str_match(filepath, "(.+\\/)*(.+)")[,3],
           md5 = map(filepath, function(x) {
                           file(x) %>% md5 %>% str_c(collapse = '')
                         }) %>% as.character,
           sha256 = map(filepath, function(x) {
                          file(x) %>% sha256 %>% str_c(collapse = '')
                          }) %>% as.character
           ) %>%
    select(name_analysis,
           version,
           filename,
           md5,
           sha256)

file_name <- here(str_c("analysis_", species_group, "/output/analysis_hashes.csv"))

if (!file.exists(file_name)) {
  
  new_analysis <- TRUE
  
  analysis_hashes <- hashes

} else {
  
  analysis_hashes <- read_csv(file_name)
  
  hashes_new <- hashes %>%
    anti_join(analysis_hashes, by = c("name_analysis", "filename", "md5", "sha256"))
  
  new_analysis <- nrow(hashes_new) > 0
  
  analysis_hashes <- bind_rows(analysis_hashes,
                               hashes)
  
}

if (new_analysis) {
  
  new_path <- here(str_c("analysis_", species_group, "/output/", name_analysis, "_", Sys.Date()))
  
  if (!dir.exists(new_path)) {
    
    dir.create(new_path)
    file.copy(from = str_c(mypath, "/analyseset.tsv"), to = str_c(new_path, "/analyseset.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/analyseset.yml"), to = str_c(new_path, "/analyseset.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_indexmodel.tsv"), to = str_c(new_path, "/results_indexmodel.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_indexmodel.yml"), to = str_c(new_path, "/results_indexmodel.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_trendmodel.tsv"), to = str_c(new_path, "/results_trendmodel.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_trendmodel.yml"), to = str_c(new_path, "/results_trendmodel.yml"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_waic.tsv"), to = str_c(new_path, "/results_waic.tsv"), overwrite = TRUE)
    file.copy(from = str_c(mypath, "/results_waic.yml"), to = str_c(new_path, "/results_waic.yml"), overwrite = TRUE)
  }
  
  analysis_hashes %>%
    write_csv(file_name)
  
}

```



### Effect van lengte tijdsreeks op index

#### Gevlekte witsnuitlibel

```{r,eval=FALSE}

soort <- "Gevlekte witsnuitlibel"

analyseset_soort <- counts_analysis %>%
  filter(meetnet == soort)

model_soort <- analyseset_soort %>%
  fit_indexmodel_nbinom_inlabru() 
  
index_soort_2020 <- derive_index_inlabru(analyseset_soort, model_soort) %>%
  mutate(tijdsreeks = "2016-2020")

analyseset_soort <- counts_analysis %>%
  filter(meetnet == soort) %>%
  filter(jaar <= 2019)

model_soort <- analyseset_soort %>%
  fit_indexmodel_nbinom_inlabru() 
  
index_soort_2019 <- derive_index_inlabru(analyseset_soort, model_soort) %>%
  mutate(tijdsreeks = "2016-2019")

analyseset_soort <- counts_analysis %>%
  filter(meetnet == soort) %>%
  filter(jaar <= 2018)

model_soort <- analyseset_soort %>%
  fit_indexmodel_nbinom_inlabru() 
  
index_soort_2018 <- derive_index_inlabru(analyseset_soort, model_soort) %>%
  mutate(tijdsreeks = "2016-2018")

index_soort <- bind_rows(
  index_soort_2018,
  index_soort_2019,
  index_soort_2020
  
)

```



```{r,eval=FALSE}

index_soort %>%
  mutate(ref_jaar_tekst = str_c("ref. jaar = ", ref_jaar)) %>%
  filter(parameter == "index") %>%
  ggplot(aes(y = mean, ymin = lcl_0.95, ymax = ucl_0.95, x = as.character(jaar), group = soort_nl)) +
  geom_point() +
  geom_errorbar(width = 0.1) +
  geom_hline(yintercept = 1, linetype = 3) +
  geom_line( colour = inbo.steun.blauw, linetype = 2) +
  #geom_ribbon(alpha = 0.2) + 
  labs(y = "Jaarlijkse index", x = "Jaar") +
  #scale_x_continuous(breaks= c(2017, 2018)) +
  scale_y_continuous(labels = scales::percent, limits = c(0,NA)) +
  facet_wrap(~ tijdsreeks + ref_jaar_tekst)
```

#### Maanwaterjuffer

```{r,eval=FALSE}

soort <- "Maanwaterjuffer"

analyseset_soort <- counts_analysis %>%
  filter(meetnet == soort)

model_soort <- analyseset_soort %>%
  fit_indexmodel_nbinom_inlabru() 
  
index_soort_2020 <- derive_index_inlabru(analyseset_soort, model_soort) %>%
  mutate(tijdsreeks = "2016-2020")

analyseset_soort <- counts_analysis %>%
  filter(meetnet == soort) %>%
  filter(jaar <= 2019)

model_soort <- analyseset_soort %>%
  fit_indexmodel_nbinom_inlabru() 
  
index_soort_2019 <- derive_index_inlabru(analyseset_soort, model_soort) %>%
  mutate(tijdsreeks = "2016-2019")

analyseset_soort <- counts_analysis %>%
  filter(meetnet == soort) %>%
  filter(jaar <= 2018)

model_soort <- analyseset_soort %>%
  fit_indexmodel_nbinom_inlabru() 
  
index_soort_2018 <- derive_index_inlabru(analyseset_soort, model_soort) %>%
  mutate(tijdsreeks = "2016-2018")

index_soort <- bind_rows(
  index_soort_2018,
  index_soort_2019,
  index_soort_2020
  
)

```



```{r,eval=FALSE}

index_soort %>%
  mutate(ref_jaar_tekst = str_c("ref. jaar = ", ref_jaar)) %>%
  filter(parameter == "index") %>%
  ggplot(aes(y = mean, ymin = lcl_0.95, ymax = ucl_0.95, x = as.character(jaar), group = soort_nl)) +
  geom_point() +
  geom_errorbar(width = 0.1) +
  geom_hline(yintercept = 1, linetype = 3) +
  geom_line( colour = inbo.steun.blauw, linetype = 2) +
  #geom_ribbon(alpha = 0.2) + 
  labs(y = "Jaarlijkse index", x = "Jaar") +
  #scale_x_continuous(breaks= c(2017, 2018)) +
  scale_y_continuous(labels = scales::percent, limits = c(0,NA)) +
  facet_wrap(~ tijdsreeks + ref_jaar_tekst)
```

