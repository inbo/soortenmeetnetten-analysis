---
title: "Prioritering locaties voor inhaalslag Zeggekorfslak"
author: 
  -
    name: "Toon Westra "
    email: "Toon.Westra@inbo.be"
subtitle: "Technisch rapport"
ordernr: ""
reportnr: "xxx"
link-citations: TRUE
always_allow_html: yes
site: bookdown::bookdown_site
output:
  bookdown::html_document2:
    keep_md: TRUE
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---


```{r setup, include = FALSE}
library(knitr)

options(knitr.kable.NA = '')
opts_chunk$set(
  echo = FALSE, 
  eval = TRUE,
  cache = FALSE,
  dpi = 120,
  fig.width = 150 / 25.4,
  fig.height = 100 / 25.4,
  fig.align = "center",
  warning = FALSE,
  error = TRUE,
  message = FALSE,
  dev = 'png'
)
```


```{r, cache = FALSE}

#devtools::install_github("dmurdoch/leaflet@crosstalk4")

library(tidyverse)
library(INBOtheme)
library(sf)
library(crosstalk)
library(leaflet)
library(leaflet.extras2)
library(leaflet.extras)
library(DT)
library(kableExtra)
library(git2rdata)
library(n2khab)
library(units)
library(here)
library(lubridate)

```



```{r}
source(here("src", "functions_smp.R"))
```





<!--chapter:end:index.Rmd-->


# Voortgang inhaalslag Zeggekorfslak

## Data

We beschikken over volgende gegevens:

+ Gegevens ingevoerd in meetnetten.be-databank

```{r}

aantallen_mollusken <- get_counts_smp(species_group = "mollusken")

data_mollusken_meetnetten <- aantallen_mollusken %>%
  filter(primaire_soort) %>%
  mutate(id = str_c("mn_", observation_id)) %>%
  group_by(id, meetnet, locatie, jaar, datum, visit_id, x, y) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup() %>%
  mutate(nieuwe_locatie = FALSE,
         bron = "meetnetten.be",
         validatie = "goedgekeurd") %>%
  filter(meetnet == "Zeggekorfslak")

data_mollusken_meetnetten_union <- data_mollusken_meetnetten %>%
  st_as_sf(coords = c("x", "y"), crs = 31370) %>%
  group_by(meetnet) %>%
  summarise(n = n()) %>%
  ungroup()

```


+ Gegevens ingevoerd in waarnemingen.be, aangeleverd door Natuurpunt Studie
  + Gegevens met zelfde locatie/datum als een bezoek in meetnetten.be en die op minder dan 100 meter verwijderd liggen van de dichtsbijzijnste meetnetten.be-waarneming beschouwen we als dubbel ingevoerde gegevens en worden verwijderd. 

```{r}
data_mollusken_extern <- read_vc(file = "processed/data_mollusken",
                             root = fileman_up("soortenmeetnetten-data")) %>%
  mutate(id = str_c("wnm_", id)) %>%
  select(id, meetnet, jaar, datum, locatie, aantal, x, y, gebied, validatie) %>%
  mutate(nieuwe_locatie = is.na(locatie),
         locatie = ifelse(is.na(locatie),
                          ifelse(gebied != "" & !is.na(gebied), gebied, str_c("nieuw_", id)),
                          locatie)) %>%
  select(-gebied) %>%
  mutate(bron = "waarnemingen.be") %>%
  filter(meetnet == "Zeggekorfslak")

data_mollusken_extern_remove <- data_mollusken_extern %>%
  st_as_sf(coords = c("x", "y"), crs = 31370) %>%
  mutate(distance_mn = drop_units(st_distance(geometry, data_mollusken_meetnetten_union))) %>%
  semi_join(data_mollusken_meetnetten, by = c("locatie", "datum")) %>%
  filter(distance_mn < 100)

data_mollusken_extern <- data_mollusken_extern %>%
  anti_join(data_mollusken_extern_remove, by = "id")

```



```{r}

locaties_prioritair <- get_locations_smp(species_group = "mollusken")

locaties_zeggekorfslak <- locaties_prioritair %>%
  filter(meetnet == "Zeggekorfslak") %>%
  select(locatie)

data_mollusken_all <- bind_rows(
  data_mollusken_extern,
  data_mollusken_meetnetten
) %>%
  mutate(locatie_prioritair = locatie %in% locaties_prioritair$locatie) %>%
  arrange(meetnet, locatie, jaar) 

data_zeggekorfslak_sf <- data_mollusken_all %>%
  st_as_sf(coords = c("x", "y"), crs = 31370) 

data_zeggekorfslak_union <- data_zeggekorfslak_sf %>%
  group_by(meetnet) %>%
  summarise(n_rec = n()) %>%
  ungroup()
```

+ extra gegevens INBO
  + we verwijderen gegevens die in het zelfde jaar en op een afstand van minder dan 25 meter gelegen zijn t.o.v. de gegevens uit meetnetten.be en waarnemingen.be 

```{r}
data_zeggekorfslak_inbo <- read_sf("../data/Zkorf30112016.shp", crs = 31370) %>%
  mutate(soort = "Zeggekorfslak") %>%
  select(id = OBJECTID, soort, datum = MaxVandatu) %>%
  mutate(id = str_c("inbo_", id)) %>%
  mutate(jaar = year(datum)) %>%
  mutate(bron = "inbo_extra") %>%
  st_join(st_transform(locaties_zeggekorfslak, crs = 31370)) %>%
  mutate(locatie_prioritair = !is.na(locatie))

data_zeggekorfslak_buffer <- data_zeggekorfslak_sf %>%
  mutate(jaar_wnm = year(datum)) %>%
  select(jaar_wnm) %>%
  st_buffer(25)

 data_zeggekorfslak_inbo_remove <- data_zeggekorfslak_inbo %>%
  mutate(distance_mn = round(drop_units(st_distance(geometry, data_zeggekorfslak_union)), 0)) %>%
  st_join(data_zeggekorfslak_buffer) %>%
  st_drop_geometry() %>%
  filter(jaar == jaar_wnm)
 
 data_zeggekorfslak_inbo <- data_zeggekorfslak_inbo %>%
   anti_join(data_zeggekorfslak_inbo_remove, by = "id") 
 


```








## Overzicht onderzochte locaties

Onderstaande tabel geeft een overzicht van het aantal onderzochte locaties op basis van alle aangeleverde data (zowel meetnetten.be en waarnemingen.be).


```{r}


data_mollusken_locatie <- data_mollusken_all %>%
  group_by(meetnet, locatie, nieuwe_locatie, locatie_prioritair) %>%
  arrange(jaar, bron, validatie) %>%
  summarise(aantal_individuen_goedgekeurd = sum(aantal * (validatie == "goedgekeurd")),
            aantal_individuen_niet_beoordeeld = sum(aantal * (validatie == "niet beoordeeld")),
            aantal_bezoeken = n_distinct(datum, locatie),
            n_punten = n(),
            bron = str_c(unique(bron), collapse = "; "),
            jaar = str_c(unique(jaar), collapse = "; "),
            validatie = sum(validatie == "goedgekeurd") > 0 ) %>%
  ungroup() %>%
  mutate(validatie = ifelse(validatie, "goedgekeurd", "niet beoordeeld"))
```


```{r}
overzicht_mollusken <- data_mollusken_locatie %>%
  filter(meetnet == "Zeggekorfslak") %>%
  group_by(meetnet, locatie_prioritair) %>%
  summarise(n_locaties_bezocht = n(),
            n_locaties_aanwezig_goedgekeurd = sum(aantal_individuen_goedgekeurd > 0),
            n_locaties_aanwezig_niet_beoordeeld = sum((aantal_individuen_niet_beoordeeld > 0) & (aantal_individuen_goedgekeurd == 0)), 
            n_locaties_afwezig = sum((aantal_individuen_goedgekeurd + aantal_individuen_niet_beoordeeld) == 0)) %>%
  ungroup()
```


```{r}
overzicht_mollusken %>%
    mutate(locatie_prioritair = ifelse(locatie_prioritair, "Ja", "Nee")) %>%
  arrange(meetnet, locatie_prioritair) %>%
  select(meetnet, "Gebied meetnetten.be" = locatie_prioritair, "bezocht" = n_locaties_bezocht, "aanwezigheid goedgekeurd" = n_locaties_aanwezig_goedgekeurd, "aanwezigheid niet beoordeeld" = n_locaties_aanwezig_niet_beoordeeld, "afwezig" = n_locaties_afwezig) %>%
  kable() %>%
  kable_styling() %>%
    collapse_rows(c(1,2)) %>%
    add_header_above(c(" " = 2, "Aantal gebieden" = 4))  
```


Hieronder vind je een kaart met alle gebieden die in meetnetten.be zitten voor de inhaalslagen van de mollusken, met de status per locatie.
De kaart toont ook:

+ de observaties uit meetnetten.be en waarnemingen.be (grijze cirkels) en het jaartal van de observatie (label)
+ de extra observaties die het INBO bezit (paarse cirkels) en het jaartal van de observatie (label)

```{r}

shapes_to_filter <- locaties_prioritair %>%
  filter(meetnet == "Zeggekorfslak") %>%
  left_join(data_mollusken_locatie, by = c("meetnet", "locatie")) %>%
  mutate(locatie_status = ifelse(is.na(aantal_bezoeken), "niet onderzocht",
                                 ifelse(aantal_individuen_goedgekeurd > 0, "aanwezig - goedgekeurd",
                                        ifelse(aantal_individuen_niet_beoordeeld > 0, "aanwezig - niet beoordeeld", "afwezig")))
         ) %>% 
  select(meetnet, locatie, locatie_status, bron, jaar, aantal_bezoeken, n_punten, aantal_individuen_goedgekeurd, aantal_individuen_niet_beoordeeld, jaar) %>%
  as_Spatial()


```

```{r}
sd_map <- SharedData$new(shapes_to_filter)
sd_df <- SharedData$new(as.data.frame(shapes_to_filter@data), group = sd_map$groupName())

colorpal <- c(inbo_groen, "yellow", inbo_rood, "blue")
factpal <- colorFactor(colorpal, sd_map$locatie_status)

#Create crosstalk filters using sd_df:

bscols(filter_checkbox("locatie_status",  "Locatiestatus", sd_df, ~locatie_status)
)

#Create the map using the sd_map object:

leaflet(sd_map) %>%
  addProviderTiles("OpenStreetMap") %>%
  addPolygons( color = ~factpal(locatie_status), label = ~locatie, group = "locaties inhaalslag") %>%
  addCircleMarkers(data = st_transform(data_zeggekorfslak_sf, 4326), label = ~(str_c("jaar = ", jaar, "; aantal = ", aantal)), color = "grey",  group = "observaties mn en wnm") %>%
  addCircleMarkers(data = st_transform(data_zeggekorfslak_inbo, 4326), label = ~(str_c("jaar = ", jaar)), color = "purple",  group = "extra observaties inbo") %>%
  addLegend(pal = factpal, values = ~locatie_status) %>%
  addLayersControl(overlayGroups = c("locaties inhaalslag", "observaties mn en wnm", "extra observaties inbo"),
    options = layersControlOptions(collapsed = FALSE))

datatable(sd_df,
          rownames = FALSE,
            filter = 'top')
```


```{r}
data_zeggekorfslak_all <- data_zeggekorfslak_sf %>%
  bind_rows(data_zeggekorfslak_inbo)
```



<!--chapter:end:10_inhaalslag.Rmd-->

# Potentieel leefgebied

## Data

We maken gebruik van de Habitatkaart 2020.

## Afbakening potentieel leefgebied Zeggekorfslak

In het monitoringsprotocol (Packet et al., 2018) wordt het potentieel leefgebied als volg afgeleid:

+ selectie polygonen van de Habitatkaart  met een van volgende bwk-codes: mc, mr, vn, vm, md, hfc
+ selectie met polygonen
  + met een van volgende bwk-codes: mk, mp, sf, va, vc, hc;
  + en gelegen op een afstand van maximaal 100 meter van een een polygoon met mc (grote Zeggenvegetaties)
  


```{r}
habitatmap <- read_habitatmap()

habitatmap_stdized <- read_habitatmap_stdized()

bwk_code_grote_zegge <- "^mc$"

bwk_codes_leefgebied <- c("^mc$|^mr$|^vn$|^vm$|^md$|^hfc$")
bwk_codes_leefgebied_extra <- c("^mk$|^mp$|^sf$|^va$|^vc$|^hc$")

bwk_codes_leefgebied_ruim <- c("mc|mr|vn|vm|md|hfc")
bwk_codes_leefgebied_extra_ruim <- c("mk|mp|sf|va|vc|hc")

bwk_codes_leefgebied_variant <- c("mc|^vm$|^md$|^hfc$")
bwk_codes_leefgebied_variant_extra <- c("^mk$|^mp$|^sf$|^va$|^vc$|^hc$|^mr$|^vn$")
```

```{r}
habitatmap_leefgebied_basis_ruim <- habitatmap %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied_ruim)) %>%
  mutate(soort_nl = "Zeggekofslak",
         type_leefgebied = "basis_ruim")

habitatmap_mc_ruim <- habitatmap %>%
  filter(str_detect(bwk_label, "mc")) %>%
  mutate(soort_nl = "Zeggekofslak",
         type_leefgebied = "mc_ruim")

habitatmap_mc_ruim_union <-  habitatmap_mc_ruim %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

habitatmap_leefgebied_extra_ruim <- habitatmap %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied_extra_ruim)) %>%
  mutate(distance_to_mc = drop_units(st_distance(geometry, habitatmap_mc_ruim_union))) %>%
  filter(distance_to_mc <= 100) %>%
  filter(! polygon_id %in% habitatmap_leefgebied_basis_ruim$polygon_id) %>%
  mutate(type_leefgebied = "extra_ruim")

habitatmap_leefgebied_extra_ruim_union <-  habitatmap_leefgebied_extra_ruim %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

habitatmap_leefgebied_ruim <- bind_rows(habitatmap_leefgebied_basis_ruim,
                                   habitatmap_leefgebied_extra_ruim) %>%
  mutate(type_leefgebied = "basis + extra ruim")

habitatmap_leefgebied_ruim_union <-  habitatmap_leefgebied_ruim %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

```

```{r}
selectie_leefgebied_basis <- habitatmap_leefgebied_basis_ruim %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep =  " \\+ ") %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied)) %>%
  select(polygon_id, bwk_label)

habitatmap_leefgebied_basis <- habitatmap %>%
  filter(polygon_id %in% selectie_leefgebied_basis$polygon_id) %>%
  mutate(soort_nl = "Zeggekofslak",
         type_leefgebied = "basis")

habitatmap_leefgebied_basis_union <-  habitatmap_leefgebied_basis %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

selectie_mc <- habitatmap_leefgebied_basis_ruim %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep =  " \\+ ") %>%
  filter(str_detect(bwk_label, "^mc$")) %>%
  select(polygon_id, bwk_label)

habitatmap_mc <- habitatmap %>%
  filter(polygon_id %in% selectie_mc$polygon_id) %>%
  mutate(soort_nl = "Zeggekofslak",
         type_leefgebied = "mc")

habitatmap_mc_union <-  habitatmap_mc %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

selectie_leefgebied_extra <- habitatmap_leefgebied_extra_ruim %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep =  " \\+ ") %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied_extra)) %>%
  select(polygon_id, bwk_label)

habitatmap_leefgebied_extra <- habitatmap %>%
  filter(polygon_id %in% selectie_leefgebied_extra$polygon_id) %>%
  filter(! polygon_id %in% habitatmap_leefgebied_basis$polygon_id) %>%
  mutate(distance_to_mc = drop_units(st_distance(geometry, habitatmap_mc_union))) %>%
  filter(distance_to_mc <= 100) %>%
  mutate(type_leefgebied = "extra")

habitatmap_leefgebied_extra_union <-  habitatmap_leefgebied_extra %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

habitatmap_leefgebied <- bind_rows(habitatmap_leefgebied_basis,
                                   habitatmap_leefgebied_extra) %>%
  mutate(type_leefgebied = "basis + extra")

habitatmap_leefgebied_union <-  habitatmap_leefgebied %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()


habitatmap_rbbmc <- habitatmap_stdized$habitatmap_types %>%
  filter(type == "rbbmc") 

habitatmap_rbbmc_polygons <- habitatmap_stdized$habitatmap_polygons %>%
  inner_join(habitatmap_rbbmc, by = "polygon_id") %>%
  mutate(type_leefgebied = "rbbmc")

habitatmap_leefgebied_rbbmc_union <-  habitatmap_rbbmc_polygons %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()


  
```


```{r}

bwk_codes_leefgebied_variant <- c("mc|^vm$|^md$|^hfc$")
bwk_codes_leefgebied_variant_extra <- c("^mk$|^mp$|^sf$|^va$|^vc$|^hc$|^mr$|^vn$")

selectie_leefgebied_variant_basis <- habitatmap_leefgebied_basis_ruim %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep =  " \\+ ") %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied_variant)) %>%
  select(polygon_id, bwk_label)

habitatmap_leefgebied_variant_basis <- habitatmap %>%
  filter(polygon_id %in% selectie_leefgebied_basis$polygon_id) %>%
  mutate(soort_nl = "Zeggekofslak",
         type_leefgebied = "basis variant")

habitatmap_leefgebied_variant_basis_union <-  habitatmap_leefgebied_variant_basis %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()


selectie_leefgebied_variant_extra <- habitatmap %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep =  " \\+ ") %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied_variant_extra)) %>%
  select(polygon_id, bwk_label)

habitatmap_leefgebied_variant_extra <- habitatmap %>%
  filter(polygon_id %in% selectie_leefgebied_variant_extra$polygon_id) %>%
  filter(! polygon_id %in% habitatmap_leefgebied_variant_basis$polygon_id) %>%
  mutate(distance_to_mc = drop_units(st_distance(geometry, habitatmap_mc_ruim_union))) %>%
  filter(distance_to_mc <= 100) %>%
  mutate(type_leefgebied = "extra")

habitatmap_leefgebied_variant_extra_union <-  habitatmap_leefgebied_variant_extra %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()

habitatmap_leefgebied_variant <- bind_rows(habitatmap_leefgebied_variant_basis,
                                   habitatmap_leefgebied_variant_extra) %>%
  mutate(type_leefgebied = "basis + extra variant")

habitatmap_leefgebied_variant_union <-  habitatmap_leefgebied_variant %>%
  group_by(type_leefgebied) %>%
  summarise(n_pol = n()) %>%
  ungroup()


st_write(habitatmap_leefgebied_variant, "../output/inhaalslag_zeggekorfslak.gpkg", "leefgebied_2020", driver = "gpkg")

st_write(habitatmap_leefgebied_variant, "../output/inhaalslag_zeggekorfslak.gpkg", "rbbmc", driver = "gpkg")
```


Onderstaande tabel geeft een overzicht van de bwk-codes die geselecteerd worden en de oppervlakte van de polygonen per bwk-code binnen het potentieel leefgebied van de Zeggekorfslak. 


```{r}
codes_strikt <- habitatmap_leefgebied %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep = " \\+ ") %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied) |
           str_detect(bwk_label, bwk_codes_leefgebied_extra)) %>%
  group_by(bwk_label) %>%
  summarise(n = n()) %>%
  ungroup()

overzicht_codes <- habitatmap_leefgebied_ruim %>%
  st_drop_geometry() %>%
  separate_rows(bwk_label, sep = " \\+ ") %>%
  select(polygon_id, bwk_label, area_m2) %>%
  filter(str_detect(bwk_label, bwk_codes_leefgebied_ruim) |
           str_detect(bwk_label, bwk_codes_leefgebied_extra_ruim)) %>%
  mutate(code_leefgebied_strikt = str_extract(bwk_label, str_c(bwk_codes_leefgebied_ruim, bwk_codes_leefgebied_extra_ruim, sep = "|"))) %>%
  group_by(code_leefgebied_strikt, bwk_label) %>%
  summarise(n = n(),
            opp_ha = round(sum(area_m2)/10000, 1)) %>%
  arrange(desc(n)) %>%
  ungroup() %>%
  arrange(code_leefgebied_strikt)

  
  overzicht_codes %>%
    group_by(code_leefgebied_strikt) %>%
    mutate(bwk_label2 = str_replace(bwk_label,  "\\*", "\\\\*")) %>%
    summarise(bwk_codes = str_c(str_c(bwk_label2, " (", opp_ha, " ha)"), collapse = "; ")) %>%
    select("bwk-code hoofdgroep" = code_leefgebied_strikt, "geselecteerde bwk-codes uit Habitatkaart (aantal polygonen)" = bwk_codes) %>%
    kable() %>%
    kable_styling() %>%
    collapse_rows(1)
  
  
```

We evalueren verder verschillende varianten van het potentieel leefgebied:

+ potentieel leefgebied strikt: bevat enkel de bwk-codes uit de eerste kolom van bovenstaande tabel
+ potentieel leefgebied ruim: bevat alle bwk-codes uit de tweede kolom van bovenstaande tabel.
+ potentieel leefgebied nieuw:
  + enkel voor mc selecteren we alle varianten/combinaties uit de tweede kolom, voor de overige codes selecteren we enkel de 'zuivere' variant uit de eerste kolom;
  + in tegenstelling tot aangegeven in Packet et al. (2018), selecteren we mr en vn enkel als die gelegen zijn op een afstand van een polygoon met mc (of een variant die mc bevat).
+ regionaal belangrijke biotoop rbbmc


## BWK-codes observaties

Onderstaande tabel geeft het aantal observaties van Zeggekorfslak voor de verschillende bwk-klassen die deel uitmaken van het potentieel leefgebied. 
De tabel bevat ook het aantal observaties per oppervlakte (100 ha) van een bwk-klasse binnen het leefgebied. 
Dit getal kan als een maat voor de trefkans beschouwd worden. 


```{r}
data_zeggekorfslak_bwkcode <- data_zeggekorfslak_all%>%
  st_join(select(habitatmap, bwk_label)) %>%
  st_drop_geometry() 

data_zeggekorfslak_bwkcode_long <- data_zeggekorfslak_bwkcode %>%
  separate_rows(bwk_label, sep = " \\+ ")

```

```{r}
overzicht <- data_zeggekorfslak_bwkcode_long %>%
  filter(aantal > 0) %>%
  group_by(bwk_label) %>%
  summarise(n_obs = n()) %>%
  ungroup() %>%
  left_join(overzicht_codes, by = "bwk_label") %>%
  mutate(bwk_codes_leefgebied = str_detect(bwk_label, str_c(bwk_codes_leefgebied_ruim, bwk_codes_leefgebied_extra_ruim, sep = "|")),
         n_obs_100ha = round(n_obs/opp_ha * 100, 2)) %>%
  arrange(desc(n_obs)) 

overzicht %>%
  filter(bwk_codes_leefgebied) %>%
  select("bwk-code" = bwk_label, "oppervlakte (ha)" = opp_ha, "aantal observaties" = n_obs, "aantal observaties per 100 ha" = n_obs_100ha) %>%
  kable() %>%
  kable_styling()


```



# Prioritering locaties

```{r}

rm(habitatmap)
rm(habitatmap_stdized)

data_zeggekorfslak_leefgebied <- data_zeggekorfslak_sf %>%
  mutate(dist_leefgebied = drop_units(st_distance(geometry, habitatmap_leefgebied_union)),
         dist_rbbmc = drop_units(st_distance(geometry, habitatmap_leefgebied_rbbmc_union)),
         dist_leefgebied_ruim = drop_units(st_distance(geometry, habitatmap_leefgebied_ruim_union)),
         dist_leefgebied_nieuw =  drop_units(st_distance(geometry, habitatmap_leefgebied_variant_union))) %>%
  mutate(aanwezig = aantal > 0)
```

```{r}
data_zeggekorfslak_leefgebied_long <- data_zeggekorfslak_leefgebied %>%
  st_drop_geometry() %>%
  pivot_longer(cols = starts_with("dist"), names_to = "type_leefgebied", values_to = "distance_m", names_prefix = "dist_") %>%
  group_by(type_leefgebied, aanwezig) %>%
  mutate(mean_dist = mean(distance_m)) %>%
  ungroup() %>%
  mutate(in_leefgebied = distance_m == 0,
         leefgebied_150m = distance_m <= 150)


```

```{r}
area_leefgebied <- tibble(
  type_leefgebied = c("leefgebied", "leefgebied_ruim", "rbbmc", "leefgebied_nieuw"),
  opp_leefgebied_ha = c(drop_units(st_area(habitatmap_leefgebied_union))/10000,
                        drop_units(st_area(habitatmap_leefgebied_ruim_union))/10000,
                        drop_units(st_area(habitatmap_leefgebied_rbbmc_union))/10000,
                        drop_units(st_area(habitatmap_leefgebied_variant_union))/10000)
)


overzicht <- data_zeggekorfslak_leefgebied_long %>%
  left_join(area_leefgebied, by = "type_leefgebied") %>%
  group_by(type_leefgebied, aanwezig, opp_leefgebied_ha) %>%
  summarise(n = n(),
            obs_in_leefgebied = sum(in_leefgebied),
            obs_leefgebied_150m = sum(leefgebied_150m),
            prop_in_leefgebied = round(sum(in_leefgebied)/n, 2),
            prop_leefgebied_150m = round(sum(leefgebied_150m)/n, 2)) %>%
  ungroup() %>%
  mutate(obs_in_leefgebied_per100ha = obs_in_leefgebied/ opp_leefgebied_ha * 100,
         obs_leefgebied_150m_per100ha = obs_leefgebied_150m/ opp_leefgebied_ha * 100)
```

## Dichtheid observaties binnen verschillende varianten van het leefgebied

Onderstaande tabel geeft voor de verschillende varianten van het potentieel leefgebied:

+ de oppervlakte in hectare
+ prop in leefgebied: proportie van de observaties die in leefgebied vallen
+ prop binnen 150m leefgebied: proportie van de observaties die binnen een buffer van 150 meter rond het leefgebied liggen
+ obs per 100 ha leefgebied: aantal observaties in het leefgebied per 100 hectare leefgebied
+ obs_buffer150m per 100 ha leefgebied: aantal observaties binnen een buffer van 150 meter rond het leefgebied per 100 hectare leefgebied

Naast 'leefgebied strikt' en 'leefgebied ruim' kijken we ook naar de Regionaal Belangrijke Biotoop (RBB) grote zeggenvegetaties (rbbmc). 

```{r}
overzicht %>%
  filter(aanwezig) %>%
  mutate(opp_leefgebied_ha = round(opp_leefgebied_ha),
         obs_in_leefgebied_per100ha = round(obs_in_leefgebied_per100ha, 2),
         obs_leefgebied_150m_per100ha = round(obs_leefgebied_150m_per100ha, 2)) %>%
  select(type_leefgebied, "opp leefgebied (ha)" = opp_leefgebied_ha, "prop in leefgebied" = prop_in_leefgebied, "prop binnen 150m leefgebied" = prop_leefgebied_150m, "obs per 100 ha leefgebied" = obs_in_leefgebied_per100ha, "obs_buffer150m per 100 ha leefgebied" = obs_leefgebied_150m_per100ha) %>%
  kable() %>%
  kable_styling()
```

De ruime variant van het leefgebied bevat het grootste aantal observaties van Zeggekorfslak maar is ook ruim de grootste in oppervlakte.
De strikte variant van het leefgebied en rbbmc hebben een grotere dichtheid aan observaties, zeker als er met een buffer van 150 gewerkt wordt. 

Op basis van de ruime variant van het leefgebied werden reeds locaties afgelijnd voor de inhaalslag van de Zeggekorfslak. 
De oppervlakte 'strikt leefgebied' en rbbmc binnen elke locatie zou als maat kunnen gebruikt worden voor een verdere prioritering van de gebieden. 




```{r, eval = FALSE}
data_zeggekorfslak_leefgebied_long %>%
  filter(aanwezig) %>%
  ggplot(aes(x = distance_m)) +
  geom_density() +
  geom_vline(data = filter(data_zeggekorfslak_leefgebied_long, aanwezig), aes(xintercept = mean_dist), color = "red", linetype = 2) +
  facet_wrap(~type_leefgebied, scales = "free")
```

```{r, eval = FALSE}
data_zeggekorfslak_leefgebied_long %>%
  ggplot(aes(x = leefgebied_150m, fill = aanwezig)) +
  geom_bar(position = "dodge") +
  facet_wrap(~type_leefgebied)
```


## Oppervlakre leefgebied in locaties inhaalslag


```{r}
locaties_prioritair <- locaties_prioritair %>%
  filter(meetnet == "Zeggekorfslak") %>%
  st_transform(31370) %>%
  select(meetnet, locatie)

st_write(locaties_prioritair, "../output/inhaalslag_zeggekorfslak.gpkg", "locaties_zeggekorfslak_meetnetten", driver = "gpkg")

overlay_locatie_rbbmc <- habitatmap_rbbmc_polygons %>%
  st_join(locaties_prioritair, largest = TRUE) %>%
  filter(!is.na(meetnet)) %>%
  st_intersection(locaties_prioritair)

area_rbbmc <- overlay_locatie_rbbmc %>%
  mutate(area_rbbmc = drop_units(st_area(geom)) * phab/100) %>%
  st_drop_geometry() %>%
  group_by(meetnet, locatie) %>%
  summarise(area_rbbmc_ha = round(sum(area_rbbmc)/10000, 3)) %>%
  ungroup()

overlay_locatie_leefgebied <- habitatmap_leefgebied %>%
  st_join(locaties_prioritair, largest = TRUE) %>%
  filter(!is.na(meetnet)) %>%
  st_intersection(locaties_prioritair)

area_leefgebied <- overlay_locatie_leefgebied %>%
  mutate(area_leefgebied = drop_units(st_area(geometry))) %>%
  st_drop_geometry() %>%
  group_by(meetnet, locatie) %>%
  summarise(area_leefgebied_ha = round(sum(area_leefgebied)/10000, 3)) %>%
  ungroup()

overlay_locatie_leefgebied_ruim <- habitatmap_leefgebied_ruim %>%
  st_join(locaties_prioritair, largest = TRUE) %>%
  filter(!is.na(meetnet)) %>%
  st_intersection(locaties_prioritair)

area_leefgebied_ruim <- overlay_locatie_leefgebied_ruim %>%
  mutate(area_leefgebied = drop_units(st_area(geometry))) %>%
  st_drop_geometry() %>%
  group_by(meetnet, locatie) %>%
  summarise(area_leefgebied_ruim_ha = round(sum(area_leefgebied)/10000, 3)) %>%
  ungroup()

overlay_locatie_leefgebied_nieuw <- habitatmap_leefgebied_variant %>%
  st_join(locaties_prioritair, largest = TRUE) %>%
  filter(!is.na(meetnet)) %>%
  st_intersection(locaties_prioritair)

area_leefgebied_nieuw <- overlay_locatie_leefgebied_nieuw %>%
  mutate(area_leefgebied = drop_units(st_area(geometry))) %>%
  st_drop_geometry() %>%
  group_by(meetnet, locatie) %>%
  summarise(area_leefgebied_nieuw_ha = round(sum(area_leefgebied)/10000, 3)) %>%
  ungroup()

locaties_prioritair_area_leefgebied <- locaties_prioritair %>%
  left_join(area_leefgebied, by = c("meetnet", "locatie")) %>%
  mutate(area_leefgebied_ha = ifelse(is.na(area_leefgebied_ha), 0, area_leefgebied_ha),
         area_leefgebied_class = ifelse(area_leefgebied_ha == 0, "afwezig",
                                  ifelse(area_leefgebied_ha < 1, "opp leefgebied < 1 ha", 
                                         ifelse(area_leefgebied_ha < 5, "1 ha < opp leefgebied < 5 ha", "opp leefgebied > 5 ha"))),
         area_leefgebied_class = factor(area_leefgebied_class, levels = c("afwezig", "opp leefgebied < 1 ha", "1 ha < opp leefgebied < 5 ha", "opp leefgebied > 5 ha"))) %>%
  left_join(area_leefgebied_nieuw, by = c("meetnet", "locatie")) %>%
  mutate(area_leefgebied_nieuw_ha = ifelse(is.na(area_leefgebied_nieuw_ha), 0, area_leefgebied_nieuw_ha),
         area_leefgebied_nieuw_class = ifelse(area_leefgebied_nieuw_ha == 0, "afwezig",
                                  ifelse(area_leefgebied_nieuw_ha < 1, "opp leefgebied < 1 ha", 
                                         ifelse(area_leefgebied_nieuw_ha < 5, "1 ha < opp leefgebied < 5 ha", "opp leefgebied > 5 ha"))),
         area_leefgebied_nieuw_class = factor(area_leefgebied_nieuw_class, levels = c("afwezig", "opp leefgebied < 1 ha", "1 ha < opp leefgebied < 5 ha", "opp leefgebied > 5 ha"))) %>%
  left_join(area_rbbmc, by = c("meetnet", "locatie")) %>%
  mutate(area_rbbmc_ha = ifelse(is.na(area_rbbmc_ha), 0, area_rbbmc_ha),
         area_rbbmc_class = ifelse(area_rbbmc_ha == 0, "afwezig",
                                  ifelse(area_rbbmc_ha < 1, "opp rbbmc < 1 ha", 
                                         ifelse(area_rbbmc_ha < 5, "1 ha < opp rbbmc < 5 ha", "opp rbbmc > 5 ha"))),
         area_rbbmc_class = factor(area_rbbmc_class, levels = c("afwezig", "opp rbbmc < 1 ha", "1 ha < opp rbbmc < 5 ha", "opp rbbmc > 5 ha"))) %>%
  left_join(area_leefgebied_ruim, by = c("meetnet", "locatie")) %>%
  mutate(area_leefgebied_ruim_ha = ifelse(is.na(area_leefgebied_ruim_ha), 0, area_leefgebied_ruim_ha))

locaties_prioritair_area_leefgebied %>%
  st_drop_geometry() %>%
  write_csv2("../output/zeggekorfslak_prioritering.csv")

locaties_prioritair_area_leefgebied %>%
  st_write("../output/zeggekorfslak_prioritering.gpkg", layer = "locaties_prioritering", delete_layer = TRUE)

st_write(overlay_locatie_rbbmc, "../output/zeggekorfslak_prioritering.gpkg", layer = "locaties_rbbmc", append = TRUE)
st_write(overlay_locatie_leefgebied, "../output/zeggekorfslak_prioritering.gpkg", layer = "locaties_leefgebied", append = TRUE)
st_write(overlay_locatie_leefgebied_ruim, "../output/zeggekorfslak_prioritering.gpkg", layer = "locaties_leefgebied_ruim", append = TRUE)

```

### rbbmc

Onderstaande kaart geeft een overzicht van de oppervlakte rbbmc binnen de locaties van de inhaalslag Zeggekorfslak. De polygonen met rbbmc binnen de inhaalslaglocaties worden in het blauw weergegeven (inzoomen om dit te kunnen zien). 

```{r}

pal <- colorNumeric(
  palette = c("red", "orange", "yellow", "green"),
  domain = locaties_prioritair_area_leefgebied$area_rbbmc_ha)

factpal <- colorFactor(c("red", "orange", "yellow", "green"), locaties_prioritair_area_leefgebied$area_rbbmc_class)

locaties_prioritair_area_leefgebied %>%
  st_transform(4326) %>%
  mutate(label = str_c(locatie, ": ", area_rbbmc_ha, " ha rbbmc")) %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(color = ~factpal(area_rbbmc_class), fillOpacity = 0.8, opacity = 0.8, label = ~label, group = "locaties") %>%
  # addPolygons(data = st_transform(overlay_locatie_leefgebied_ruim, 4326), group = "leefgebied_ruim", color = "blue", opacity = 0, fillOpacity = 1) %>%
  addPolygons(data = st_transform(overlay_locatie_rbbmc, 4326), group = "rbbmc", color = "blue", opacity = 0, fillOpacity = 1) %>%
  addLegend(pal = factpal, values = ~area_rbbmc_class,
            title = "Oppervlakte rbbmc (ha)",
            opacity = 1) %>%
  addLayersControl(overlayGroups = c("locaties", "rbbmc"),
                   options = layersControlOptions(collapsed = FALSE))
```

### Leefgebied, strikte variant

Onderstaande kaart geeft een overzicht van de oppervlakte leefgebied_strikt binnen de locaties van de inhaalslag Zeggekorfslak. De polygonen met leefgebied_strikt binnen de inhaalslaglocaties worden in het blauw weergegeven (inzoomen om dit te kunnen zien). 

```{r}

factpal <- colorFactor(c("red", "orange", "yellow", "green"), locaties_prioritair_area_leefgebied$area_leefgebied_class)

locaties_prioritair_area_leefgebied %>%
  st_transform(4326) %>%
  mutate(label = str_c(locatie, ": ", area_leefgebied_ha, " ha leefgebied")) %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(color = ~factpal(area_leefgebied_class), fillOpacity = 0.8, opacity = 0.8, label = ~label, group = "locaties") %>%
  addPolygons(data = st_transform(overlay_locatie_leefgebied, 4326), group = "leefgebied_strikt", color = "blue", opacity = 0, fillOpacity = 1) %>%
  addLegend(pal = factpal, values = ~area_leefgebied_class,
            title = "Oppervlakte leefgebied_strikt (ha)",
            opacity = 1) %>%
  addLayersControl(overlayGroups = c("locaties", "leefgebied_strikt"),
                   options = layersControlOptions(collapsed = FALSE))
```


### Leefgebied, nieuw variant

Onderstaande kaart geeft een overzicht van de oppervlakte leefgebied_nieuw binnen de locaties van de inhaalslag Zeggekorfslak. De polygonen met leefgebied_nieuw binnen de inhaalslaglocaties worden in het blauw weergegeven (inzoomen om dit te kunnen zien). 

```{r}

factpal <- colorFactor(c("red", "orange", "yellow", "green"), locaties_prioritair_area_leefgebied$area_leefgebied_nieuw_class)

locaties_prioritair_area_leefgebied %>%
  st_transform(4326) %>%
  mutate(label = str_c(locatie, ": ", area_leefgebied_nieuw_ha, " ha leefgebied")) %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(color = ~factpal(area_leefgebied_nieuw_class), fillOpacity = 0.8, opacity = 0.8, label = ~label, group = "locaties") %>%
  addPolygons(data = st_transform(overlay_locatie_leefgebied_nieuw, 4326), group = "leefgebied_nieuw", color = "blue", opacity = 0, fillOpacity = 1) %>%
  addLegend(pal = factpal, values = ~area_leefgebied_class,
            title = "Oppervlakte leefgebied_nieuw (ha)",
            opacity = 1) %>%
  addLayersControl(overlayGroups = c("locaties", "leefgebied_nieuw"),
                   options = layersControlOptions(collapsed = FALSE))
```

### Overzicht locaties

Hieronder een overzicht van de locaties gesorteerd volgens oppervlakte rbbmc.

```{r, cache = FALSE}

selectie_prioritair <- locaties_prioritair_area_leefgebied %>%
  st_drop_geometry() %>%
  arrange(desc(area_rbbmc_ha)) %>%
  select(locatie, "oppervlakte leefgebied ruim (ha)" = area_leefgebied_ruim_ha, "oppervlakte leefgebied strikt (ha)" = area_leefgebied_ha, "oppervlakte rbbmc (ha)" = area_rbbmc_ha, "oppervlakte leefgebied nieuw (ha)" = area_leefgebied_nieuw_ha) 

datatable(selectie_prioritair, 
          rownames = FALSE,
          filter = "top")
```


<!--chapter:end:20_leefgebied.Rmd-->

# Herbevestiging gebieden/locaties zonder recente waarnemingen

## Gebieden

Onderstaande tabel geeft weer hoeveel jaar geleden de meest recente waarneming van Zeggekorfslak is gebeurd per gebied (zoals gedefinieerd in meetnetten.be of waarnemingen.be).

```{r}
historiek_locaties <- data_zeggekorfslak_all %>%
  filter(is.na(aantal) | aantal > 0) %>%
  filter(!is.na(locatie)) %>%
  filter(!locatie_prioritair) %>%
  filter(str_sub(locatie, 1, 5) != "nieuw") %>%
  st_drop_geometry() %>%
  group_by(locatie) %>%
  summarise(min_jaar = min(jaar),
            max_jaar = max(jaar)) %>%
  ungroup() %>%
  mutate(laatste_wmn = ifelse((2021 - max_jaar) >= 12,  ">= 12 jaar geleden",
                              ifelse((2021 - max_jaar) >= 6,  "tussen 6 en 12 jaar geleden", "< 6 jaar geleden")),
         laatste_wmn = factor(laatste_wmn, levels = c(">= 12 jaar geleden", "tussen 6 en 12 jaar geleden", "< 6 jaar geleden"))) %>%
  arrange(laatste_wmn, max_jaar, locatie) 

locaties_12jaar <- historiek_locaties %>%
  filter(laatste_wmn == ">= 12 jaar geleden")

historiek_locaties %>%
  select( "recentste wnm" = laatste_wmn,locatie, min_jaar, max_jaar) %>%
  kable() %>%
  kable_styling() %>%
  collapse_rows(1)


```

```{r}
wnm_herbezoek <- data_zeggekorfslak_all %>%
  filter(locatie %in% locaties_12jaar$locatie) 

wnm_herbezoek_buffer <- wnm_herbezoek %>%
  st_buffer(dist = 150) %>%
  select(locatie)

leefgebied_herbezoek <- habitatmap_leefgebied_ruim %>%
  st_join(wnm_herbezoek_buffer) %>%
  filter(!is.na(locatie)) %>%
  group_by(locatie) %>%
  summarise(n_pol = n()) %>%
  ungroup()

```

```{r}
leefgebied_herbezoek %>%
  st_transform(crs = 4326) %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(label = ~locatie) %>%
  addCircleMarkers(data = st_transform(wnm_herbezoek, crs = 4326))
```



## Puntlocaties

Voor elke waarneming op een puntlocatie kijken we ook naar het jaartal van de meest recente waarneming binnen een straal van 500 meter.

```{r}

presence_buffer <- data_zeggekorfslak_all %>%
  filter(is.na(aantal) | aantal > 0) %>%
  st_buffer(500) %>%
  select(jaar_buffer500 = jaar)

obs_most_recent <- data_zeggekorfslak_all %>%
  filter(is.na(aantal) | aantal > 0) %>%
  st_join(presence_buffer) %>%
  group_by(id, jaar) %>%
  summarise(maxjaar_buffer = max(jaar_buffer500)) %>%
  ungroup() %>%
   mutate(laatste_wmn = ifelse((2021 - maxjaar_buffer) >= 12,  ">= 12 jaar geleden",
                              ifelse((2021 - maxjaar_buffer) >= 6,  "tussen 6 en 12 jaar geleden", "< 6 jaar geleden")),
         laatste_wmn = factor(laatste_wmn, levels = c(">= 12 jaar geleden", "tussen 6 en 12 jaar geleden", "< 6 jaar geleden")))

st_write(obs_most_recent, "../output/inhaalslag_zeggekorfslak.gpkg", "recentste_waarnemingen", driver = "gpkg")
  
```

Op basis hiervan kunnen we een prioritering maken van de her te bevestigen puntlocaties.

```{r}

colorpal <- c(inbo_rood, "blue", "green")
factpal <- colorFactor(colorpal, obs_most_recent$laatste_wmn)

obs_most_recent %>%
  st_transform(4326) %>%
  leaflet() %>%
  addTiles() %>%
  addCircleMarkers(color =  ~factpal(laatste_wmn), label = ~maxjaar_buffer) %>%
  addLegend(pal = factpal, values = ~laatste_wmn)
```




## Selectie prioritait te herbezoeken locaties

We selecteren de puntwaarnemingen waarvoor de meest recente waarneming in een straal van 500 meter dateert van 12 jaar geleden of langer geleden. 

Ronde deze geselecteerde punten selecteren we het potentieel leefgebied (ruime variant) dat binnen een straal van 150 meter gelegen is.
Polygonen die op een afstand van minder dan 100 meter van elkaar gelegen zijn, voegen we samen.
Zo vormen we de te onderzoeken gebieden die in meetnetten.be zullen opgeladen worden.
De namen van de gebieden worden manueel toegevoegd op basis van open street map.


```{r}
wnm_herbezoek <- obs_most_recent %>%
  filter(laatste_wmn == ">= 12 jaar geleden") 

wnm_herbezoek_buffer <- wnm_herbezoek %>%
  st_buffer(dist = 150) %>%
  select(maxjaar_buffer)

leefgebied_herbezoek <- habitatmap_leefgebied_ruim %>%
  st_join(wnm_herbezoek_buffer) %>%
  filter(!is.na(maxjaar_buffer))

locaties_herbezoek_buffer <- leefgebied_herbezoek %>%
  st_buffer(100) %>%
  st_combine() %>%
  st_union(by_feature = TRUE) %>%
  st_as_sf() %>%
  st_cast(to = "POLYGON") 

locaties_herbezoek_buffer <- locaties_herbezoek_buffer %>%
  mutate(id  = 1:nrow(locaties_herbezoek_buffer))

namen <- read_csv2("../data/namen_locaties_herbezoek.csv")

leefgebied_herbezoek_locaties <- leefgebied_herbezoek %>%
  st_join(locaties_herbezoek_buffer) %>%
  group_by(id) %>%
  summarise(n_pol = n()) %>%
  ungroup() %>%
  left_join(namen, by = "id") %>%
  select(naam) %>%
  st_cast("MULTIPOLYGON") %>%
  st_join(select(locaties_prioritair, locatie), largest = TRUE) %>%
  filter(is.na(locatie)) %>%
  select(-locatie)

st_write(leefgebied_herbezoek_locaties, dsn = "../output/zeggekorfslak_prioritering.gpkg", layer = "locaties_herbezoek", delete_layer = TRUE)

st_write(wnm_herbezoek, dsn = "../output/zeggekorfslak_prioritering.gpkg", layer = "wnm_herbezoek", append = TRUE)

leefgebied_herbezoek_locaties %>%
  st_transform(crs = 4326) %>%
  st_write(dsn = "../output/zeggekorfslak_prioritering", layer = "locaties_herbezoek", append = TRUE, driver = "ESRI Shapefile")

```
In onderstaande tabel vind je de lijst de te herbezoeken locaties.

```{r}
leefgebied_herbezoek_locaties %>%
  arrange(naam) %>%
  st_drop_geometry() %>% 
  kable(caption = "Lijst met te herbezoeken locaties") %>%
  kable_styling()
  
```


Onderstaande kaart toon de te herbezoeken locaties. De kaart geeft ook de ligging van rbbmc weer. Gebruik het vergrootglasicoon om een locatie te selecteren en hierop in te zoomen.

```{r}

overlay_rbbmc <- habitatmap_rbbmc_polygons %>%
  st_join(leefgebied_herbezoek_locaties, largest = TRUE) %>%
  filter(!is.na(naam))

st_write(overlay_rbbmc, dsn = "../output/zeggekorfslak_prioritering.gpkg", layer = "overlay_rbbmc_herbezoek", append = TRUE)

# locaties_dubbel <- locaties_prioritair %>%
#   filter(locatie %in% leefgebied_herbezoek_locaties$locatie)

leefgebied_herbezoek_locaties %>%
  st_transform(crs = 4326) %>%
  leaflet() %>%
  addTiles() %>%
  # addPolygons(data = st_transform(locaties_dubbel, crs = 4326), label = ~locatie,  color = "orange") %>%
  addPolygons(label = ~naam, group = "locaties", color = "blue") %>%
  addPolygons(data = st_transform(overlay_rbbmc, crs = 4326), group = "rbbmc", color = "green", opacity = 0, fillOpacity = 1) %>%
  addCircleMarkers(data = st_transform(wnm_herbezoek, crs = 4326), color = "grey", label = ~jaar, group = "waarnemingen") %>%
  addLayersControl(overlayGroups = c("locaties", "rbbmc", "waarnemingen"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
  addSearchFeatures(
    targetGroups = "locaties",
    options = searchFeaturesOptions(
      zoom=15, openPopup = TRUE, firstTipSubmit = TRUE,
      autoCollapse = TRUE, hideMarkerOnCollapse = TRUE
    ))
```





<!--chapter:end:30_herbevestiging.Rmd-->

