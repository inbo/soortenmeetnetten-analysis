# Selectie analyseset

```{r}

species_group <- "amfibieën"

path = fileman_up("soortenmeetnetten-queries")
```

## Raw data

```{r}
visits <- get_visits_smp(species_group = species_group) %>%
  mutate(protocol = ifelse(protocol == "Amfibieën - Fuiken (v1)", 
                           "Amfibieën - Fuiken", 
                           protocol),
         protocol = ifelse(protocol == "Vuursalamander - Transect (v1)", 
                           "Vuursalamander - Transect", 
                           protocol),
         protocol = ifelse(protocol == "Rugstreeppad - Transect (v1)", 
                           "Rugstreeppad - Transect", 
                           protocol))

covar <- get_covariates_smp() 

covar_sample <- get_covariates_smp(linked_to = "sample")

counts <- get_counts_smp()

locations <- get_locations_smp(only_active = FALSE) %>%
  st_drop_geometry() %>%
  filter(locatie_type == "locatie")

```

## Preprocessing locaties 

```{r}

locatie_clusters <- locations %>%
  filter(meetnet %in% c("Kamsalamander", "Heikikker", "Boomkikker", "Poelkikker")) %>%
  select(meetnet, locatie, is_active, is_sample) %>%
  mutate(cluster = ifelse(str_detect(locatie, " - "), 
                          str_sub(locatie,  end = str_locate(locatie, " - ")),
                          locatie),
         cluster = str_remove_all(cluster, str_c(as.character(c(0:9)), collapse = "|")),
         cluster = str_remove(cluster, "NR"),
         cluster = str_trim(cluster),
         poel =  str_extract(locatie, str_c(str_c("(n|[:space:])", c(1:35), "([:alpha:]|$)"), collapse = "|")),
         poel = ifelse(cluster == "Merkske",  str_sub(locatie, start = str_locate(locatie, "B")[,"start"]),
                       poel),
         poel = ifelse(is.na(poel), "1", poel)) 

locaties <- locations %>%
  filter(meetnet %in% c("Knoflookpad", "Rugstreeppad", "Vuursalamander", "Vroedmeesterpad")) %>%
  select(meetnet, locatie, is_active, is_sample)
  
```


## Preprocessing larvetellingen

+ Bij het protocol voor larvetellingen werden initieel de aantallen per schep ingevoerd. Later werd het protocol gewijzigd en werd het totaal aantal larven en het aantal schepbewegingen ingevoerd. We sommeren de aantallen per schep en werken verder met de totalen en het aantal schepbewegingen.

+ Bij larvetellingen wordt ook aangegeven of er enkel larventellingen, enkel tellingen van metamorfen of beide tellingen werden uitgevoerd. In de databank wordt er een nul gegenereerd voor aantal larven ook al geeft men aan dat er enkel metamorfen werden geteld. Ook omgekeerd is dit het geval voor aantal metamorfen. Deze nullen zetten we om naar ontbrekende waarden.    


```{r select data, warning = FALSE}

catch_effort <- covar %>%
  filter(bezoekvariabele %in% c("aantal keer geschept", "zoekinspanning")) %>%
  select(visit_id, bezoekvariabele, waarde) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(n_catch = "aantal keer geschept") %>%
  mutate(n_catch = as.numeric(n_catch))

counts_larven <- counts %>%
  filter(protocol %in% c("Amfibieën - Larven", "Amfibieën - Larven en metamorfen")) %>%
  group_by(meetnet, protocol, visit_id, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() %>%
  left_join(catch_effort, by = "visit_id") %>%
  mutate(larvetelling = zoekinspanning %in% c("alleen larven geschept", "larven geschept en metamorfen op land geteld") | (is.na(zoekinspanning) & levensstadium == "Larva"),
         metamorftelling = zoekinspanning %in% c("alleen metamorfen op land geteld", "larven geschept en metamorfen op land geteld")) %>%
  mutate(aantal = ifelse(levensstadium == "Larva" & larvetelling, aantal, 
                         ifelse(levensstadium == "metamorf" & metamorftelling, aantal,
                                ifelse(levensstadium == "adult", aantal, NA)))) %>%
  filter(!((protocol == "Amfibieën - Larven en metamorfen") & (levensstadium == "adult")))

dataset_larven <-  visits %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  inner_join(select(counts_larven, visit_id,  soort_nl, soort_wet, aantal, levensstadium, primaire_soort, n_catch, zoekinspanning, larvetelling, metamorftelling), by = "visit_id") 
  
```
+ Bij vroedmeesterpad gebeurt er een telling per sublocatie. Per telling noteren we hoeveel keer er is geschept.

```{r select data, warning = FALSE}

catch_effort_sample <- covar_sample %>%
  filter(bezoekvariabele %in% c("aantal keer geschept")) %>%
  select(visit_id, sample_id, bezoekvariabele, waarde) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(n_catch = "aantal keer geschept") %>%
  mutate(n_catch = as.numeric(n_catch))

counts_larven_vroedmeesterpad <- counts %>%
  filter(protocol %in% c("Vroedmeesterpad - Larven")) %>%
  group_by(meetnet, protocol, visit_id, sample_id, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() %>%
  left_join(catch_effort_sample, by = c("visit_id", "sample_id")) %>%
  filter(levensstadium == "Larva")

dataset_larven_vroedmeesterpad <-  visits %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  inner_join(select(counts_larven_vroedmeesterpad, visit_id, sample_id,  soort_nl, soort_wet, aantal, levensstadium, primaire_soort, n_catch), by = c("visit_id")) 
  
```

## Analyseset larvetelling

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_larven %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_larven_actief <- dataset_larven %>%
  filter(is_active)

locaties_niet_actief <- dataset_larven %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_larven_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  + Geen veldwerk mogelijk - locatie ongeschikt: wanneer de poel droog staat rekenen we dit mee als een nulwaarneming (dit moet aangepast worden in de databank: voor_analyse = TRUE)
  
```{r}

check_gvm <- dataset_larven_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  filter(levensstadium == "Larva") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, opmerking) 

check_gvm %>%
  datatable(rownames = FALSE,
            filter = 'top')
```

```{r}
dataset_larven_actief_voor_analyse <- dataset_larven_actief %>%
  mutate(voor_analyse = ifelse(visit_id %in% check_gvm$visit_id, TRUE, voor_analyse)) %>%
  filter(voor_analyse)

dataset_larven <- dataset_larven_actief_voor_analyse
```

### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

Alles lijkt OK!

```{r}

dataset_check2 <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, zoekinspanning, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```
### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}

duur_cyclus <- 3

analyseset_larven <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  mutate(start_cyclus = ifelse(meetnet == "Kamsalamander", 2017, 2016),
    meetcyclus = ceiling((jaar - start_cyclus + 1) / duur_cyclus),
    meetcyclus = ifelse(meetnet == "Kamsalamander", 
                        ifelse(jaar <= 2020, 1,
                               ifelse(jaar <= 2023, 2, 3)),
                        meetcyclus)) %>%
  group_by(meetcyclus, meetnet) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, doy, visit_id, bezoek_status, zoekinspanning, larvetelling, metamorftelling, n_catch, primaire_soort, soort_nl, soort_wet, levensstadium, aantal, opmerking, hoofdteller)
```

## Analyseset roepkoren Boomkikker

```{r}
dataset_roepkoren <-  visits %>%
  filter(meetnet == "Boomkikker") %>%
  filter(protocol == "Padden en kikkers - Roepkoren") %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") 
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_roepkoren %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_roepkoren_actief <- dataset_roepkoren %>%
  filter(is_active)

locaties_niet_actief <- dataset_roepkoren %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_roepkoren_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  + Geen veldwerk mogelijk - locatie ongechikt: wanneer de poel droog staat rekenen we dit mee als een nulwaarning (dit moet aangepast worden in de databank: voor_analyse = TRUE)
  
```{r}

check_gvm <- dataset_roepkoren_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, opmerking) 

check_gvm %>%
  datatable(rownames = FALSE)
```

```{r}
dataset_roepkoren_actief_voor_analyse <- dataset_roepkoren_actief %>%
  mutate(voor_analyse = ifelse(visit_id %in% check_gvm$visit_id, TRUE, voor_analyse),
         aantal = ifelse(visit_id %in% check_gvm$visit_id, 0, aantal),
         levensstadium = ifelse(visit_id %in% check_gvm$visit_id, "adult", levensstadium),
         soort_nl = ifelse(visit_id %in% check_gvm$visit_id, "Boomkikker", soort_nl),
          primaire_soort = ifelse(visit_id %in% check_gvm$visit_id, TRUE, primaire_soort),
         soort_wet = ifelse(visit_id %in% check_gvm$visit_id, "Hyla arborea", soort_wet)) %>%
  filter(voor_analyse)

dataset_roepkoren <- dataset_roepkoren_actief_voor_analyse
```



### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

Alles lijkt OK!


```{r}

dataset_check2 <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}

analyseset_roepkoren_boomkikker <-  dataset_roepkoren %>%
  filter(!is.na(aantal))
```

```{r}
duur_cyclus <- 3
start_cyclus <- 2016

analyseset_roepkoren_boomkikker <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium,  aantal, opmerking, hoofdteller)
```

## Analyseset roepkoren Vroedmeesterpad

```{r}
dataset_roepkoren <-  visits %>%
  filter(meetnet == "Vroedmeesterpad") %>%
  filter(protocol == "Vroedmeesterpad - Roepkoren") %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(select(counts, visit_id, sample_id,  soort_nl, soort_wet, primaire_soort, activiteit, levensstadium, aantal), by = "visit_id") 
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_roepkoren %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht van de type tellingen: primaire soort, activiteit, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ primaire soort
+ activiteit
+ levensstadium

```{r}

dataset_check2 <- dataset_roepkoren %>%
  group_by(meetnet, protocol,  primaire_soort, activiteit, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

We selecteren enkel de roepkoortellingen (niet de zichtwaarnemingen).

```{r}
dataset_roepkoren <- dataset_roepkoren %>%
  filter(activiteit == "calling")
```


### We someren de aantallen per locatie

```{r}

analyseset_roepkoren_vroedmeesterpad <-  dataset_roepkoren %>%
  group_by(soortgroep, meetnet, protocol, locatie, is_sample, jaar, datum, visit_id, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium, opmerking, hoofdteller) %>%
  summarise(aantal = sum(aantal),
            n_points = n()) %>%
  ungroup()

analyseset_roepkoren_vroedmeesterpad %>%
  filter(primaire_soort) %>%
  select(meetnet, protocol, locatie, jaar, datum, primaire_soort, soort_nl, soort_wet, levensstadium, aantal, n_points, opmerking) %>%
  arrange(locatie, datum) %>%
  write_csv2("../output/aantallen_vroedmeesterpad.csv")
```

## Analyseset Fuiken Kamsalamander

```{r}
visits_kam <- visits %>%
  filter(protocol == "Amfibieën - Fuiken") 

counts_kam <- counts %>%
  semi_join(visits_kam, by = "visit_id") %>%
  group_by(protocol, visit_id) %>%
  mutate( n_fuiken = n_distinct(sample_id)) %>%
  ungroup() %>%
  group_by(visit_id, n_fuiken, soort_nl, soort_wet, primaire_soort, levensstadium, geslacht) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() 

dataset_fuiken <-  visits_kam %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  inner_join(counts_kam, by = "visit_id") 

```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_fuiken %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}

dataset_fuiken_actief <- dataset_fuiken %>%
  filter(is_active)

locaties_niet_actief <- dataset_fuiken %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_fuiken_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()

```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  
```{r}

check_gvm <- dataset_fuiken_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, opmerking) 

check_gvm %>%
  datatable(rownames = FALSE)
```

### Overzicht van aantal fuiken

```{r}

dataset_fuiken_actief_voor_analyse <- dataset_fuiken_actief %>%
  filter(voor_analyse)

dataset_fuiken <- dataset_fuiken_actief_voor_analyse

controle_aantal_fuiken <- dataset_fuiken %>%
  filter(n_fuiken != 2) %>%
  distinct(meetnet, locatie, is_sample, datum, hoofdteller, visit_id, n_fuiken)

controle_aantal_fuiken %>%
  write_csv2("../output/controle_aantal_fuiken.csv")

dataset_fuiken %>%
  distinct(visit_id, bezoek_status, n_fuiken, is_sample) %>%
  ggplot(aes(x = factor(n_fuiken), fill = is_sample)) +
  geom_bar() +
  labs(x = "Aantal fuiken", y = "Aantal bezoeken", fill = "Meetnetlocatie")
```

### Overzicht van de type tellingen: primaire soort, levensstadium, geslacht

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium
+ geslacht

```{r}

dataset_check2 <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium, geslacht) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE)
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}
locaties_geen_data <- locatie_clusters %>%
  filter(meetnet == "Kamsalamander") %>%
  filter(is_sample) %>%
  anti_join(dataset_fuiken, by = "locatie")
```

### Overzicht tellingen per meetcyclus


```{r}
duur_cyclus <- 3
start_cyclus <- 2017

analyseset_fuiken_detail <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ifelse(jaar <= 2020, 1, 
                             ifelse(jaar <= 2023, 2, 3))) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = ifelse(meetcyclus == 1, 2020, meetcyclus_start + 2)) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, n_fuiken, primaire_soort, soort_nl, soort_wet, levensstadium, geslacht, aantal, opmerking, hoofdteller)

analyseset_fuiken_totaal <- analyseset_fuiken_detail %>%
  group_by(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, n_fuiken, primaire_soort, soort_nl, soort_wet, opmerking, hoofdteller) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup() %>%
  group_by(protocol, locatie) %>%
  mutate(paired = n_distinct(meetcyclus) > 1) %>%
  ungroup()

overzicht_meetcyclus <- analyseset_fuiken_totaal %>%
  group_by(protocol, meetcyclus,meetcyclus_start, meetcyclus_end, is_sample,  paired) %>%
  summarise(n_locaties = n_distinct(locatie))
```

```{r}
overzicht_meetcyclus %>%
  kable() %>%
  kable_styling()
```



## Analyseset roepkoren Knoflookpad

```{r}
dataset_roepkoren_knoflookpad <-  visits %>%
  filter(meetnet == "Knoflookpad") %>%
  filter(protocol %in% c("Padden en kikkers - Roepkoren", "Knoflookpad - Roepkoren")) %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(select(counts, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal, type_aantal), by = "visit_id") %>%
  rename(hydrofoon = waarde) %>%
  select(-bezoekvariabele)

check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(visit_id, type_aantal) %>%
  filter(n() > 1)
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse
+ gebruik hydrofoon

```{r}
dataset_check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse, hydrofoon) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_roepkoren_knoflookpad_actief <- dataset_roepkoren_knoflookpad %>%
  filter(is_active)

locaties_niet_actief <- dataset_roepkoren_knoflookpad %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_roepkoren_knoflookpad_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_roepkoren_knoflookpad <- dataset_roepkoren_knoflookpad_actief %>%
  filter(voor_analyse)
```

### Overzicht van type telling met of zonder hydrofoon

```{r}
dataset_check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, hydrofoon, type_aantal) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ Records met hydrofoon = FALSE en 'aantal met hydrofoon' = 0 verwijderen

```{r}
dataset_roepkoren_knoflookpad <- dataset_roepkoren_knoflookpad %>%
  mutate(hydrofoon = ifelse(is.na(hydrofoon), "FALSE", hydrofoon),
         hydrofoon = ifelse(hydrofoon == "TRUE", TRUE, FALSE),
         type_aantal = ifelse(type_aantal == "exact count", "aantal zonder hydrofoon", type_aantal)) %>%
  filter(!(hydrofoon == FALSE & type_aantal == "aantal met hydrofoon" ))
```

### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

```{r}

dataset_check2 <- dataset_roepkoren_knoflookpad %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

```{r}

analyseset_roepkoren_knoflookpad <-  dataset_roepkoren_knoflookpad 
```

## Analyseset Vuursalamander

```{r}

counts_vuursalamander <- counts %>%
  filter(meetnet == "Vuursalamander") %>%
  group_by(visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

dataset_vuursalamander <-  visits %>%
  filter(meetnet == "Vuursalamander") %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(select(counts_vuursalamander, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") 

check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(visit_id, type_aantal) %>%
  filter(n() > 1)
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_vuursalamander %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_vuursalamander_actief <- dataset_vuursalamander %>%
  filter(is_active)

locaties_niet_actief <- dataset_vuursalamander %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_vuursalamander_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_vuursalamander <- dataset_vuursalamander %>%
  filter(voor_analyse) %>%
  filter(!is.na(aantal))
```

+ Na te kijken: voor_analyse = TRUE en 'weersomstandigheden ongunstig'

```{r}
dataset_vuursalamander %>%
  filter(bezoek_status == "Weersomstandigheden ongunstig") %>%
  select(locatie, datum, bezoek_status, voor_analyse,  aantal,  visit_id) %>%
  mutate(visit_id = str_c('<a href = "https://www.meetnetten.be/fieldwork/visits/', visit_id,'">', visit_id, '</a>')) %>%
  datatable(rownames = FALSE,
            escape = FALSE)
```



### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium


```{r}

dataset_check2 <- dataset_vuursalamander %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties.

```{r}
dataset_check3 <- dataset_vuursalamander %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}
dataset_vuursalamander %>%
  distinct(locatie, is_sample) %>%
  datatable(rownames = FALSE,
            filter = 'top')
```
Van de ‘niet verplichte’ locaties kunnen de locaties die systematisch geteld worden wel meegenomen worden in de analyse:

+ Heilig-Geestgoed
+ Trimpont
+ Buggenhoutbos zuid


```{r}
dataset_vuursalamander <- dataset_vuursalamander %>%
  filter(is_sample | locatie %in% c("Heilig-Geestgoed", "Trimpont", "Buggenhoutbos zuid")) 
```



### Lengte transecten

```{r}
transects <- get_locations_smp(only_active = TRUE) %>%
  filter(meetnet == "Vuursalamander",
         locatie_type == "sublocatie") %>%
  mutate(lengte_transect = drop_units(st_length(geom))) %>%
  select(meetnet, id = parent_id, lengte_transect) %>%
  st_drop_geometry() %>%
  left_join(select(locations, meetnet, locatie, id), by = c("meetnet", "id"))
```

Voor een aantal locaties is er geen transect gedefinieerd. We stellen de transectlengte gelijk aan gemiddelde transectlengte.

```{r}
transects %>%
  filter(lengte_transect == 0)
```

```{r}
transects <- transects %>%
  mutate(lengte_transect = ifelse(lengte_transect == 0, mean(lengte_transect), lengte_transect)) %>%
  select(-id)
```


```{r}

analyseset_vuursalamander <-  dataset_vuursalamander %>%
  left_join(transects, by = c("meetnet", "locatie"))
```


## Analyseset Heikikker

```{r}

counts_heikikker <- counts %>%
  filter(meetnet == "Heikikker") %>%
  group_by(visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, type_aantal) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

dataset_heikikker <-  visits %>%
  filter(meetnet == "Heikikker") %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts_heikikker, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") %>%
  filter(!(locatie == "Klein Schietveld noord 1" & is_sample)) #verkeerde locatie

check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(visit_id, type_aantal) %>%
  filter(n() > 1)
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_heikikker %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_heikikker <- dataset_heikikker %>%
  filter(voor_analyse) %>%
  filter(!is.na(aantal))
```

### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium

```{r}

dataset_check2 <- dataset_heikikker %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties.

```{r}
dataset_check3 <- dataset_heikikker %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```


```{r}

duur_cyclus <- 3
start_cyclus <- 2021

analyseset_heikikker_long <- dataset_heikikker %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, is_active, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, hoofdteller, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium,  aantal, bezoekvariabele, waarde)

analyseset_heikikker_wide <- analyseset_heikikker_long %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, is_active, meetcyclus, meetcyclus_start, meetcyclus_end, datum, visit_id, hoofdteller,  doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium, bezoekvariabele, waarde, aantal) %>%
  pivot_wider(names_from = bezoekvariabele,
              values_from = waarde) %>%
  rename(aantal_totaal = "aantal eiklompen totaal", aantal_bemonsterd = "Aantal eiklompen bemonsterd", aandeel_doelsoort = "Procentueel aandeel doelsoort", staalcode = Staalcode, aantal_doelsoort = aantal) %>%
  mutate(jaar = year(datum),
         aantal_bemonsterd = as.numeric(aantal_bemonsterd),
         aantal_totaal = as.numeric(aantal_totaal),
         aantal_doelsoort = as.numeric(aantal_doelsoort),
         aandeel_doelsoort = as.numeric(aandeel_doelsoort),
         staalcode = ifelse(staalcode == "", NA, staalcode),
         aantal_doelsoort = ifelse(!is.na(staalcode) & is.na(aandeel_doelsoort), NA, aantal_doelsoort),
         staalname = !is.na(staalcode),
         resultaat_ingevoerd = ifelse(staalname, !is.na(aandeel_doelsoort), NA)) %>%
  arrange(datum) %>%
  filter(!is.na(aantal_doelsoort)) %>%
  mutate(aantal = aantal_doelsoort)

analyseset_heikikker_wide_correct <- analyseset_heikikker_wide %>%
  mutate(aantal_doelsoort = ifelse(aandeel_doelsoort > 0 & aantal_doelsoort == 0 & !is.na(aandeel_doelsoort), NA, aantal_doelsoort),
         aantal_totaal = ifelse(aandeel_doelsoort > 0 & aantal_totaal == 0 & !is.na(aandeel_doelsoort), NA, aantal_totaal))

```

## Analyseset Poelkikker

```{r}

counts_poelkikker <- counts %>%
  filter(meetnet == "Poelkikker") %>%
  group_by(visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, type_aantal) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup() %>%
  mutate(soort_nl = ifelse(soort_wet == "Pelophylax lessonae/ kl. esculentus", "Poelkikker/bastaardkikker", soort_nl))


dataset_poelkikker <-  visits %>%
  filter(meetnet == "Poelkikker") %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts_poelkikker, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") %>%
  filter(!(protocol == "Poelkikker - DNA larven" & soort_nl != "Poelkikker")) %>%
  filter(bezoekvariabele != "staalcode" | is.na(bezoekvariabele)) # staalcode niet ingevuld

```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_poelkikker %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```


+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_poelkikker_actief <- dataset_poelkikker %>%
  filter(is_active)

locaties_niet_actief <- dataset_poelkikker %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_poelkikker_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_poelkikker <- dataset_poelkikker %>%
  filter(voor_analyse) %>%
  filter(!is.na(aantal))
```

### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium

```{r}

dataset_check2 <- dataset_poelkikker %>%
  group_by(meetnet, protocol,  primaire_soort, soort_wet, soort_nl, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ meerkikker primaire soort?

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties.

```{r}
dataset_check3 <- dataset_poelkikker %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```


```{r}

duur_cyclus <- 3
start_cyclus <- 2021

analyseset_poelkikker <- dataset_poelkikker %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, is_active, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, hoofdteller, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium, bezoekvariabele, waarde, aantal)

analyseset_poelkikker_wide <- analyseset_poelkikker%>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, is_active, meetcyclus, meetcyclus_start, meetcyclus_end, datum, jaar, visit_id, hoofdteller,  doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium, bezoekvariabele, waarde, aantal) %>%
  pivot_wider(names_from = bezoekvariabele,
              values_from = waarde) %>%
  select(-"NA") %>%
  rename(aantal_bemonsterd = "aantal larven bemonsterd", aandeel_doelsoort = "Procentueel aandeel doelsoort") %>%
  mutate(aantal_bemonsterd = as.numeric(aantal_bemonsterd),
         aandeel_doelsoort = as.numeric(aandeel_doelsoort)) %>%
  arrange(datum)
```



## Analyseset Rugstreeppad

```{r}

counts_rugstreeppad_sample <- counts %>%
  filter(meetnet == "Rugstreeppad") %>%
  group_by(visit_id, sample_id,  soort_nl, soort_wet, primaire_soort, levensstadium,  activiteit, x, y) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

counts_rugstreeppad_visit <- counts %>%
  filter(meetnet == "Rugstreeppad") %>%
  group_by(visit_id, soort_nl, soort_wet, primaire_soort, levensstadium, activiteit) %>%
  summarise(aantal = sum(aantal),
            n_samples = n_distinct(sample_id)) %>%
  ungroup()

zoekinspanning_rugstreeppad <- covar %>%
  filter(meetnet == "Rugstreeppad") %>%
  select(visit_id, zoekinspanning = waarde)

dataset_rugstreeppad_sample <-  visits %>%
  filter(meetnet == "Rugstreeppad") %>%
  left_join(zoekinspanning_rugstreeppad, by = "visit_id") %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(counts_rugstreeppad_sample, by = "visit_id") %>%
  left_join(type_habitat, by = c("visit_id", "sample_id"))  

dataset_rugstreeppad <-  visits %>%
  filter(meetnet == "Rugstreeppad") %>%
  left_join(zoekinspanning_rugstreeppad, by = "visit_id") %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(counts_rugstreeppad_visit, by = "visit_id")

```

### Controle van ontbrekende waarden voor aantallen

Nulwaarnemingen worden vaak niet ingevoerd. 
Daardoor bevat de databank ontbrekende waarden voor aantallen, wat tot verkeerde interpretaties kan leiden.
Je krijgt namelijk ook ontbrekende waarden wanneer het veldwerk onmogelijk is (locatie ongeschikt of ontoegankelijk).
Het expliciet invoeren van nullen is dus noodzakelijk.

In tussentijd veronderstellen we een nulwaarneming bij ontbrekende waarden wanneer bezoek_status = 'conform protocol'.

```{r}
check_na <- dataset_rugstreeppad %>%
  filter(is.na(aantal)) %>%
  select(visit_id, meetnet, locatie, datum, hoofdteller, bezoek_status, voor_analyse, is_active,  aantal, opmerking)

dataset_rugstreeppad_nul <- dataset_rugstreeppad %>%
  filter(is.na(aantal) & bezoek_status == "Conform protocol") %>%
  select(-levensstadium, -activiteit, -aantal, -n_samples, -soort_nl, -soort_wet, -primaire_soort)

nulwaarneming <- dataset_rugstreeppad %>%
  tidyr::expand(visit_id, nesting(levensstadium, activiteit)) %>%
  filter(!is.na(levensstadium)) %>% 
  filter(levensstadium %in% c("egg", "adult")) %>%
  semi_join(dataset_rugstreeppad_nul, by = "visit_id") %>%
  mutate(aantal = 0,
         n_samples = 1,
         soort_nl = "Rugstreeppad",
         soort_wet = "Epidalea calamita",
         primaire_soort = TRUE)

dataset_rugstreeppad_nul <- dataset_rugstreeppad_nul %>%
  left_join(nulwaarneming, by = "visit_id")

dataset_rugstreeppad <- dataset_rugstreeppad %>%
  anti_join(dataset_rugstreeppad_nul, by = "visit_id") %>%
  bind_rows(dataset_rugstreeppad_nul)

check_na %>%
  datatable(rownames = FALSE,
            filter = "top")
  
dataset_rugstreeppad_nul %>%
  filter(jaar == 2024) %>%
  distinct(meetnet, locatie, datum, visit_id, zoekinspanning, opmerking) %>%
  write_csv2("../output/rugstreeppad_aantal_missing.csv")

check_tijdstip <- dataset_rugstreeppad %>%
  filter(jaar == 2024) %>%
  filter(is.na(start_time)) %>%
  filter(bezoek_status %in% c("Conform protocol", "Weersomstandigheden ongunstig")) %>%
  distinct(meetnet, locatie, bezoek_status, datum, start_time, visit_id, hoofdteller, zoekinspanning, opmerking)

check_tijdstip %>%
  write_csv2("../output/rugstreeppad_tijdstip_missing.csv")
```

### Controle zoekinspanning

Sinds 2024 kan de zoekinspanning ingegeven worden.

```{r}
dataset_rugstreeppad %>%
  filter(!is.na(zoekinspanning)) %>%
  group_by(zoekinspanning) %>%
  summarise(n_bezoeken = n_distinct(visit_id)) %>%
  ungroup()
``` 

Indien niet alle levensstadia worden geteld, bevat de databanken toch nullen.
Dit moet gewijzigd worden naar ontbrekende waarden.

```{r}
dataset_rugstreeppad_corr <- dataset_rugstreeppad %>%
  mutate(telling_eisnoer = str_detect(zoekinspanning, "eisnoer"),
         telling_adult_roepend = str_detect(zoekinspanning, "roepen"),
         telling_adult_andere = str_detect(zoekinspanning, "andere")) %>%
  mutate(aantal_na = (!telling_eisnoer & levensstadium == "egg") |
           (!telling_adult_roepend & levensstadium == "adult" & activiteit == "calling") |
           (!telling_adult_andere & levensstadium == "adult" & activiteit == "present")) %>%
  mutate(aantal = ifelse(!is.na(zoekinspanning) & aantal_na, NA, aantal))
              
```



### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_rugstreeppad_corr %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_rugstreeppad_actief <- dataset_rugstreeppad_corr %>%
  filter(is_active | is.na(is_active))

locaties_niet_actief <- dataset_rugstreeppad_corr %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_rugstreeppad_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_rugstreeppad <- dataset_rugstreeppad_actief %>%
  filter(voor_analyse) 
```

+ Na te kijken: voor_analyse = TRUE en 'weersomstandigheden ongunstig' of 'locatie ongeschikt'

```{r}
dataset_rugstreeppad %>%
  filter(!bezoek_status %in% c("Conform protocol", "Telmethode niet gevolgd")) %>%
  group_by(locatie, datum, bezoek_status, voor_analyse, visit_id, opmerking) %>%
  summarise(aantal_tot = sum(aantal)) %>%
  ungroup() %>%
  select(locatie, datum, bezoek_status, voor_analyse, aantal_tot, visit_id, opmerking) %>%
  mutate(visit_id = str_c('<a href = "https://www.meetnetten.be/fieldwork/visits/', visit_id,'">', visit_id, '</a>')) %>%
  datatable(rownames = FALSE,
            escape = FALSE)
```



### Overzicht van de type tellingen: primaire soort, levensstadium, geslacht

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium


```{r}

dataset_check2 <- dataset_rugstreeppad %>%
  group_by(meetnet, protocol,  primaire_soort,  levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

```{r}
duur_cyclus <- 3
start_cyclus <- 2019

analyseset_rugstreeppad <- dataset_rugstreeppad %>%
  filter(protocol == "Rugstreeppad - Transect") %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, start_time, end_time, visit_id, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, zoekinspanning, telling_eisnoer, telling_adult_roepend, telling_adult_andere, levensstadium, activiteit, aantal, n_samples, opmerking, hoofdteller)

analyseset_rugstreeppad <- analyseset_rugstreeppad %>%
  filter(primaire_soort) %>%
  group_by(locatie, protocol) %>%
  mutate(paired = n_distinct(meetcyclus) > 1,
         multiple_year = n_distinct(jaar) > 1) %>%
  ungroup() %>%
  mutate(periode = str_c(meetcyclus_start, " - ", meetcyclus_end)) %>%
  mutate(start_hour = as.numeric(str_sub(start_time, 1, 2)),
         type_telling = ifelse(is.na(start_hour), "onbekend",
                               ifelse(start_hour > 5 & start_hour < 17, "dagtelling", "avondtelling")),
         type_telling = ifelse(zoekinspanning == "enkel eisnoeren" & !is.na(zoekinspanning), "dagtelling", type_telling)) 



```

## Analyseset habitatkenmerken

```{r}
habitatkenmerken_boomkikker_kamsalamander <- analyseset_larven %>%
  distinct(meetnet, cluster, locatie, poel, visit_id, datum, bezoek_status, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, opmerking) %>%
  left_join(covar, by = c("visit_id", "meetnet")) %>%
  filter(!bezoekvariabele %in% c("aantal keer geschept", "zoekinspanning")) %>%
  mutate(waarde = ifelse(waarde == "3" & bezoekvariabele == "waterkwaliteit", "goed (helder water, typische oever en/of waterplanten, weinig verlanding, niet zichtbaar vervuild)", waarde)) %>% 
  mutate(waarde = ifelse(waarde == "no shade" & bezoekvariabele == "beschaduwing", "geen schaduw", waarde)) %>% 
  group_by(visit_id) %>%
  mutate(habitatkenmerken_bepaald = ifelse(all(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "niet",
                                       ifelse(any(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "deels", "volledig")),
         n_habitatkenmerken = sum(!waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup()

check <- habitatkenmerken_boomkikker_kamsalamander %>%
  group_by(meetnet, protocol, bezoekvariabele, waarde) %>%
  summarise(n_records = n()) %>%
  ungroup()

check <- habitatkenmerken_boomkikker_kamsalamander %>%
  filter(waarde == "no shade")
check$visit_id

habitatkenmerken_boomkikker_kamsalamander_wide <- habitatkenmerken_boomkikker_kamsalamander %>%
  select(-eenheid) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(ph = "pH (zuurtegraad)", oppervlakte_waterpartij = "oppervlakte waterpartij", maximale_diepte = "maximale diepte", aanwezigheid_vis = "aanwezigheid vis", permanente_waterkolom = "permanente waterkolom") %>%
  mutate(ph = as.numeric(ph),
         oppervlakte_waterpartij = factor(oppervlakte_waterpartij, levels = c("onbekend", "niet bekeken/niet van toepassing","<10", "10-100", "101-250", "251-400", ">400")),
         maximale_diepte = factor(maximale_diepte, levels = c("onbekend", "niet bekeken/niet van toepassing", "<0.5", "0.5-1", ">1", ">1.5")),
         aanwezigheid_vis = ifelse(aanwezigheid_vis %in% c("TRUE", "ja"), TRUE,
                                   ifelse(aanwezigheid_vis %in% c("FALSE", "nee"), FALSE, NA)),
         permanente_waterkolom = ifelse(permanente_waterkolom %in% c("TRUE", "ja"), TRUE,
                                   ifelse(permanente_waterkolom %in% c("FALSE", "nee"), FALSE, NA)),
         beschaduwing = factor(beschaduwing, levels = c("onbekend", "niet bekeken/niet van toepassing", "geen schaduw", "<30%", "30-60%", ">60%")),
         waterkwaliteit = ifelse(str_detect(waterkwaliteit, "goed"), "goed",
                                 ifelse(str_detect(waterkwaliteit, "middelmatig"), "middelmatig",
                                      ifelse(str_detect(waterkwaliteit, "slecht"), "slecht", waterkwaliteit))),
         waterkwaliteit = factor(waterkwaliteit, levels = c("onbekend", "niet bekeken/niet van toepassing", "plas verdwenen of volledig verland", "slecht", "middelmatig", "goed")))


covar_rugstreeppad_vroedmeesterpad <- covar_sample %>%
  filter(meetnet %in% c("Rugstreeppad", "Vroedmeesterpad"))

type_habitat <- covar_rugstreeppad_vroedmeesterpad %>%
  filter(bezoekvariabele == "type habitat") %>%
  select(visit_id, sample_id, type_habitat = waarde)

habitatkenmerken_bepaald <- covar_rugstreeppad_vroedmeesterpad %>%
  filter(bezoekvariabele == "habitatkenmerken werden bepaald?") %>%
  select(visit_id, sample_id, habitatkenmerken = waarde) %>%
  mutate(habitatkenmerken = ifelse(habitatkenmerken == "ja", TRUE,
                                   ifelse(habitatkenmerken == "nee", FALSE, NA)))

covar_rugstreeppad_vroedmeesterpad <- covar_rugstreeppad_vroedmeesterpad %>%
  filter(bezoekvariabele %in% c("aanwezigheid vis", "beschaduwing", "drijvende vegetatie",
                                "maximale diepte", "onderwatervegetatie", "pH (zuurtegraad)",
                                "verticale vegetatie", "waterkwaliteit", "oppervlakte waterpartij",
                                "permanente waterkolom")) %>%
  left_join(habitatkenmerken_bepaald, by = c("visit_id", "sample_id")) %>%
  left_join(type_habitat, by = c("visit_id", "sample_id"))


habitatkenmerken_rugstreeppad_vroedmeesterpad <- dataset_rugstreeppad_sample %>%
  bind_rows(dataset_larven_vroedmeesterpad) %>%
  distinct(meetnet, protocol, locatie, visit_id, sample_id, datum, bezoek_status, voor_analyse, is_sample, is_active) %>%
  left_join(covar_rugstreeppad_vroedmeesterpad, by = c("meetnet", "protocol","visit_id", "sample_id")) %>%
  mutate(waarde = ifelse(waarde == "3" & bezoekvariabele == "waterkwaliteit", "goed (helder water, typische oever en/of waterplanten, weinig verlanding, niet zichtbaar vervuild)", waarde),
         waarde = ifelse(waarde == "0" & bezoekvariabele == "waterkwaliteit", "plas verdwenen of volledig verland", waarde),
         waarde = ifelse(waarde == "bad" & bezoekvariabele == "waterkwaliteit", "slecht (verwaarloosde poel met eutroof water (algen, kroos), anders vervuild of verregaand verland", waarde),
         waarde = ifelse(waarde == "average" & bezoekvariabele == "waterkwaliteit", "middelmatig (tussen slecht en goed)", waarde),
         waarde = ifelse(waarde == "no shade" & bezoekvariabele == "beschaduwing", "geen schaduw", waarde),
         waarde = ifelse(waarde == "unknown", "onbekend", waarde)) %>% 
  group_by(visit_id, sample_id) %>%
  mutate(habitatkenmerken_bepaald = ifelse(all(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "niet",
                                       ifelse(any(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "deels", "volledig")),
         n_habitatkenmerken = sum(!waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup() %>%
  filter(!is.na(bezoekvariabele)) %>%
  filter(voor_analyse)
  

check_ontbrekend_type <- habitatkenmerken_rugstreeppad_vroedmeesterpad %>%
  filter(is.na(type_habitat)) %>%
  filter(bezoekvariabele == "oppervlakte waterpartij") %>%
  filter(habitatkenmerken_bepaald != "niet")

check_wrong_category <- habitatkenmerken_rugstreeppad_vroedmeesterpad %>%
  filter(waarde %in% c("no shade", "unknown", "bad", "average", "0", "3")) %>%
  select(datum, visit_id, sample_id, bezoekvariabele, waarde)

# check_wrong_category %>%
#   write_csv2("../output/bezoekvariabele_rugstreeppad_anomalie.csv")

habitatkenmerken_rugstreeppad_vroedmeesterpad_wide <- habitatkenmerken_rugstreeppad_vroedmeesterpad %>%
  select(-eenheid) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(oppervlakte_waterpartij = "oppervlakte waterpartij", maximale_diepte = "maximale diepte", aanwezigheid_vis = "aanwezigheid vis", permanente_waterkolom = "permanente waterkolom", drijvende_vegetatie = "drijvende vegetatie", verticale_vegetatie = "verticale vegetatie") %>%
  mutate(oppervlakte_waterpartij = factor(oppervlakte_waterpartij, levels = c("onbekend", "niet bekeken/niet van toepassing","<10", "10-100", "101-250", "251-400", ">400")),
         maximale_diepte = factor(maximale_diepte, levels = c("onbekend", "niet bekeken/niet van toepassing", "<0.5", "0.5-1", ">1", ">1.5")),
         aanwezigheid_vis = ifelse(aanwezigheid_vis %in% c("TRUE", "ja"), TRUE,
                                   ifelse(aanwezigheid_vis %in% c("FALSE", "nee"), FALSE, NA)),
         permanente_waterkolom = ifelse(permanente_waterkolom %in% c("TRUE", "ja"), TRUE,
                                   ifelse(permanente_waterkolom %in% c("FALSE", "nee"), FALSE, NA)),
         beschaduwing = factor(beschaduwing, levels = c("onbekend", "niet bekeken/niet van toepassing", "geen schaduw", "<30%", "30-60%", ">60%")),
         drijvende_vegetatie = factor(drijvende_vegetatie, levels = c("onbekend", "niet bekeken/niet van toepassing", "0%", "1-25%", "26-50%", "51-75%", "76-100%")),
         onderwatervegetatie = factor(onderwatervegetatie, levels = c("onbekend", "niet bekeken/niet van toepassing", "0%", "1-25%", "26-50%", "51-75%", "76-100%")),
         verticale_vegetatie = factor(verticale_vegetatie, levels = c("onbekend", "niet bekeken/niet van toepassing", "0%", "1-25%", "26-50%", "51-75%", "76-100%")))
```

### Boomkikker en kamsalamander

```{r}
habitatkenmerken_boomkikker_kamsalamander_wide %>%
  group_by(meetnet,  bezoek_status, habitatkenmerken_bepaald) %>%
  summarise(n_bezoeken = n_distinct(visit_id),
            n_habitatkenmerken = round(mean(n_habitatkenmerken), 1)) %>%
  ungroup() %>%
  kable(caption = "Overzicht bepaling habitatkenmerken voor meetnet Boomkikker en Kamsalamander") %>%
  kable_styling()
```

### Rugstreeppad

```{r}
habitatkenmerken_rugstreeppad_vroedmeesterpad_wide %>%
  group_by(meetnet,  bezoek_status, voor_analyse, type_habitat, habitatkenmerken_bepaald) %>%
  summarise(n_samples = n_distinct(sample_id),
            n_habitatkenmerken = round(mean(n_habitatkenmerken), 1)) %>%
  ungroup() %>%
  kable() %>%
  kable_styling()
```

+ Habitatkenmerken voor landpunten verwijderen.

+ Geen habitatkenmerken bepaald bij eitellingen in havengebied ('Telmethode niet gevolgd')

```{r}
habitatkenmerken_rugstreeppad_vroedmeesterpad_wide <- habitatkenmerken_rugstreeppad_vroedmeesterpad_wide %>%
  filter(type_habitat != "land" | is.na(type_habitat)) %>%
  filter(bezoek_status != "Telmethode niet gevolgd")
```

# Data wegschrijven

```{r}
write_vc(analyseset_larven, file = "analyseset_larven", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "levensstadium"), strict = FALSE)

write_vc(analyseset_roepkoren_boomkikker, file = "analyseset_roepkoren_boomkikker", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_fuiken_totaal, file = "analyseset_fuiken_totaal", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_fuiken_detail, file = "analyseset_fuiken_detail", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "levensstadium", "geslacht"), strict = FALSE)

write_vc(analyseset_roepkoren_knoflookpad, file = "analyseset_roepkoren_knoflookpad", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "hydrofoon", "type_aantal"), strict = FALSE)

write_vc(analyseset_vuursalamander, file = "analyseset_vuursalamander", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_heikikker_wide_correct, file = "analyseset_heikikker", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_poelkikker_wide, file = "analyseset_poelkikker", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_wet", "visit_id"), strict = FALSE)

write_vc(analyseset_rugstreeppad, file = "analyseset_rugstreeppad", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "levensstadium", "activiteit"), strict = FALSE)

write_vc(analyseset_roepkoren_vroedmeesterpad, file = "analyseset_vroedmeesterpad_roepkoren", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(dataset_larven_vroedmeesterpad, file = "analyseset_vroedmeesterpad_larven", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "sample_id"), strict = FALSE)

write_vc(habitatkenmerken_boomkikker_kamsalamander_wide, file = "habitatkenmerken_boomkikker_kamsalamander_wide", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "visit_id"), strict = FALSE)

write_vc(habitatkenmerken_rugstreeppad_vroedmeesterpad_wide, file = "habitatkenmerken_rugstreeppad_vroedmeesterpad_wide", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "visit_id", "sample_id"), strict = FALSE)

check <- analyseset_roepkoren_knoflookpad %>%
  group_by(meetnet, locatie, datum, soort_nl) %>%
  filter(n() > 1)
```



