---
title: "Analyse Amfibiënmeetnetten"
author: 
  -
    name: "Toon Westra, Jeroen Speybroeck, Loïc van Doorn, Sam Van De Poel,  Frederic Piesschaert, Thierry Onkelinx"
    email: "Toon.Westra@inbo.be"
subtitle: "Technisch rapport"
link-citations: TRUE
always_allow_html: yes
site: bookdown::bookdown_site
output:
  bookdown::html_document2:
    keep_md: TRUE
    toc: TRUE
    code_folding: hide
    toc_depth: 2
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---


```{r setup, include = FALSE}
library(knitr)
options(knitr.kable.NA = '')

opts_chunk$set(
  echo = FALSE, 
  eval = TRUE,
  cache = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 180 / 25.4,
  fig.height = 120 / 25.4,
  fig.align = "center"
)

```


```{r, cache = FALSE}

library(tidyverse)
library(INBOtheme)
library(INBOmd)
library(sf)
library(DT)
library(effectclass)
library(kableExtra)
library(INLA)
library(git2rdata)
library(here)
library(n2khab)
library(inlatools)
library(openssl)
library(units)

library(conflicted)
conflicts_prefer(dplyr::filter())
conflicts_prefer(dplyr::lag)
```

```{r}
source(here("src", "functions_smp.R"))
```


<!--chapter:end:index.Rmd-->

# Selectie analyseset

```{r}

species_group <- "amfibieën"

```

## Raw data

```{r}
visits <- get_visits_smp(species_group = species_group) %>%
  mutate(protocol = ifelse(protocol == "Amfibieën - Fuiken (v1)", 
                           "Amfibieën - Fuiken", 
                           protocol),
         protocol = ifelse(protocol == "Vuursalamander - Transect (v1)", 
                           "Vuursalamander - Transect", 
                           protocol)) 

covar <- get_covariates_smp(species_group = species_group) 

covar_sample <- get_covariates_smp(linked_to = "sample")

counts <- get_counts_smp(species_group = species_group)

locations <- get_locations_smp(only_active = FALSE) %>%
  st_drop_geometry() %>%
  filter(locatie_type == "locatie")

```

## Preprocessing locaties 

```{r}

locatie_clusters <- locations %>%
  filter(meetnet %in% c("Kamsalamander", "Heikikker", "Boomkikker", "Poelkikker")) %>%
  select(meetnet, locatie, is_active, is_sample) %>%
  mutate(cluster = ifelse(str_detect(locatie, " - "), 
                          str_sub(locatie,  end = str_locate(locatie, " - ")),
                          locatie),
         cluster = str_remove_all(cluster, str_c(as.character(c(0:9)), collapse = "|")),
         cluster = str_remove(cluster, "NR"),
         cluster = str_trim(cluster),
         poel =  str_extract(locatie, str_c(str_c("(n|[:space:])", c(1:35), "([:alpha:]|$)"), collapse = "|")),
         poel = ifelse(cluster == "Merkske",  str_sub(locatie, start = str_locate(locatie, "B")[,"start"]),
                       poel),
         poel = ifelse(is.na(poel), "1", poel)) 

locaties <- locations %>%
  filter(meetnet %in% c("Knoflookpad", "Rugstreeppad", "Vuursalamander")) %>%
  select(meetnet, locatie, is_active, is_sample)
  
```


## Preprocessing larvetellingen

+ Bij het protocol voor larvetellingen werden initieel de aantallen per schep ingevoerd. Later werd het protocol gewijzigd en werd het totaal aantal larven en het aantal schepbewegingen ingevoerd. We sommeren de aantallen per schep en werken verder met de totalen en het aantal schepbewegingen.

+ Bij larvetellingen wordt ook aangegeven of er enkel larventellingen, enkel tellingen van metamorfen of beide tellingen werden uitgevoerd. In de databank wordt er een nul gegenereerd voor aantal larven ook al geeft men aan dat er enkel metamorfen werden geteld. Ook omgekeerd is dit het geval voor aantal metamorfen. Deze nullen zetten we om naar ontbrekende waarden.    


```{r select data, warning = FALSE}

catch_effort <- covar %>%
  filter(bezoekvariabele %in% c("aantal keer geschept", "zoekinspanning")) %>%
  select(visit_id, bezoekvariabele, waarde) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(n_catch = "aantal keer geschept") %>%
  mutate(n_catch = as.numeric(n_catch))

counts_larven <- counts %>%
  filter(protocol %in% c("Amfibieën - Larven", "Amfibieën - Larven en metamorfen")) %>%
  group_by(meetnet, protocol, visit_id, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() %>%
  left_join(catch_effort, by = "visit_id") %>%
  mutate(larvetelling = zoekinspanning %in% c("alleen larven geschept", "larven geschept en metamorfen op land geteld") | (is.na(zoekinspanning) & levensstadium == "larve"),
         metamorftelling = zoekinspanning %in% c("alleen metamorfen op land geteld", "larven geschept en metamorfen op land geteld")) %>%
  mutate(aantal = ifelse(levensstadium == "larve" & larvetelling, aantal, 
                         ifelse(levensstadium == "metamorf" & metamorftelling, aantal,
                                ifelse(levensstadium == "adult", aantal, NA)))) %>%
  filter(!((protocol == "Amfibieën - Larven en metamorfen") & (levensstadium == "adult")))

dataset_larven <-  visits %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  inner_join(select(counts_larven, visit_id,  soort_nl, soort_wet, aantal, levensstadium, primaire_soort, n_catch, zoekinspanning, larvetelling, metamorftelling), by = "visit_id") 
  
  
```

## Analyseset larvetelling

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_larven %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_larven_actief <- dataset_larven %>%
  filter(is_active)

locaties_niet_actief <- dataset_larven %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_larven_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  + Geen veldwerk mogelijk - locatie ongeschikt: wanneer de poel droog staat rekenen we dit mee als een nulwaarneming (dit moet aangepast worden in de databank: voor_analyse = TRUE)
  
```{r}

check_gvm <- dataset_larven_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  filter(levensstadium == "larve") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, notes) 

check_gvm %>%
  datatable(rownames = FALSE,
            filter = 'top')
```

```{r}
dataset_larven_actief_voor_analyse <- dataset_larven_actief %>%
  mutate(voor_analyse = ifelse(visit_id %in% check_gvm$visit_id, TRUE, voor_analyse)) %>%
  filter(voor_analyse)

dataset_larven <- dataset_larven_actief_voor_analyse
```

### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

Alles lijkt OK!

```{r}

dataset_check2 <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, zoekinspanning, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```
### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}

duur_cyclus <- 3

analyseset_larven <- dataset_larven %>%
  filter(!is.na(aantal)) %>%
  mutate(start_cyclus = ifelse(meetnet == "Kamsalamander", 2017, 2016),
    meetcyclus = ceiling((jaar - start_cyclus + 1) / duur_cyclus)) %>%
  group_by(meetcyclus, meetnet) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, doy, visit_id, bezoek_status, zoekinspanning, larvetelling, metamorftelling, n_catch, primaire_soort, soort_nl, soort_wet, levensstadium, aantal, notes)
```

## Analyseset roepkoren Boomkikker

```{r}
dataset_roepkoren <-  visits %>%
  filter(meetnet == "Boomkikker") %>%
  filter(protocol == "Padden en kikkers - Roepkoren") %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") 
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_roepkoren %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_roepkoren_actief <- dataset_roepkoren %>%
  filter(is_active)

locaties_niet_actief <- dataset_roepkoren %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_roepkoren_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  + Geen veldwerk mogelijk - locatie ongechikt: wanneer de poel droog staat rekenen we dit mee als een nulwaarning (dit moet aangepast worden in de databank: voor_analyse = TRUE)
  
```{r}

check_gvm <- dataset_roepkoren_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, notes) 

check_gvm %>%
  datatable(rownames = FALSE)
```

```{r}
dataset_roepkoren_actief_voor_analyse <- dataset_roepkoren_actief %>%
  mutate(voor_analyse = ifelse(visit_id %in% check_gvm$visit_id, TRUE, voor_analyse),
         aantal = ifelse(visit_id %in% check_gvm$visit_id, 0, aantal),
         levensstadium = ifelse(visit_id %in% check_gvm$visit_id, "adult", levensstadium),
         soort_nl = ifelse(visit_id %in% check_gvm$visit_id, "Boomkikker", soort_nl),
          primaire_soort = ifelse(visit_id %in% check_gvm$visit_id, TRUE, primaire_soort),
         soort_wet = ifelse(visit_id %in% check_gvm$visit_id, "Hyla arborea", soort_wet)) %>%
  filter(voor_analyse)

dataset_roepkoren <- dataset_roepkoren_actief_voor_analyse
```



### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium

Alles lijkt OK!


```{r}

dataset_check2 <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}

analyseset_roepkoren_boomkikker <-  dataset_roepkoren %>%
  filter(!is.na(aantal))
```

```{r}
duur_cyclus <- 3
start_cyclus <- 2016

analyseset_roepkoren_boomkikker <- dataset_roepkoren %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium,  aantal)
```

## Analyseset Fuiken Kamsalamander

```{r}
visits_kam <- visits %>%
  filter(protocol == "Amfibieën - Fuiken") 

counts_kam <- counts %>%
  semi_join(visits_kam, by = "visit_id") %>%
  group_by(protocol, visit_id) %>%
  mutate( n_fuiken = n_distinct(sample_id)) %>%
  ungroup() %>%
  group_by(visit_id, n_fuiken, soort_nl, soort_wet, primaire_soort, levensstadium, geslacht) %>%
  summarise(aantal = sum(aantal),
            n_records = n()) %>%
  ungroup() 

dataset_fuiken <-  visits_kam %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  inner_join(counts_kam, by = "visit_id") 

```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse


```{r}
dataset_check <- dataset_fuiken %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}

dataset_fuiken_actief <- dataset_fuiken %>%
  filter(is_active)

locaties_niet_actief <- dataset_fuiken %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_fuiken_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()

```

+ We selecteren enkel tellingen die geschikt zijn voor analyse
  
```{r}

check_gvm <- dataset_fuiken_actief %>%
  filter(bezoek_status == "Geen veldwerk mogelijk - locatie ongeschikt") %>%
  distinct(meetnet, locatie, datum, visit_id, bezoek_status, is_sample, voor_analyse, aantal, notes) 

check_gvm %>%
  datatable(rownames = FALSE)
```

### Overzicht van aantal fuiken

```{r}

dataset_fuiken_actief_voor_analyse <- dataset_fuiken_actief %>%
  filter(voor_analyse)

dataset_fuiken <- dataset_fuiken_actief_voor_analyse

controle_aantal_fuiken <- dataset_fuiken %>%
  filter(n_fuiken != 2) %>%
  distinct(meetnet, locatie, is_sample, datum, hoofdteller, visit_id, n_fuiken)

controle_aantal_fuiken %>%
  write_csv2("../output/controle_aantal_fuiken.csv")

dataset_fuiken %>%
  distinct(visit_id, bezoek_status, n_fuiken, is_sample) %>%
  ggplot(aes(x = factor(n_fuiken), fill = is_sample)) +
  geom_bar() +
  labs(x = "Aantal fuiken", y = "Aantal bezoeken", fill = "Meetnetlocatie")
```

### Overzicht van de type tellingen: primaire soort, levensstadium, geslacht

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium
+ geslacht

```{r}

dataset_check2 <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium, geslacht) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE)
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties. In de verdere dataverkenningen nemen we de tellingen voor niet-steekproefloacties mee, maar voor de uiteindelijke analyse gebruiken we enkel de tellingen voor de steekproeflocaties.

```{r}
dataset_check3 <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}
locaties_geen_data <- locatie_clusters %>%
  filter(meetnet == "Kamsalamander") %>%
  filter(is_sample) %>%
  anti_join(dataset_fuiken, by = "locatie")
```

### Overzicht tellingen per meetcyclus


```{r}
duur_cyclus <- 3
start_cyclus <- 2017

analyseset_fuiken_detail <- dataset_fuiken %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ifelse(jaar <= 2020, 1, 2)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = ifelse(meetcyclus == 1, 2020, 2023)) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, n_fuiken, primaire_soort, soort_nl, soort_wet, levensstadium, geslacht, aantal)

analyseset_fuiken_totaal <- analyseset_fuiken_detail %>%
  group_by(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, n_fuiken, primaire_soort, soort_nl, soort_wet) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup() %>%
  group_by(protocol, locatie) %>%
  mutate(paired = n_distinct(meetcyclus) > 1) %>%
  ungroup()

overzicht_meetcyclus <- analyseset_fuiken_totaal %>%
  group_by(protocol, meetcyclus,meetcyclus_start, meetcyclus_end, is_sample,  paired) %>%
  summarise(n_locaties = n_distinct(locatie))
```

```{r}
overzicht_meetcyclus %>%
  kable() %>%
  kable_styling()
```



## Analyseset roepkoren Knoflookpad

```{r}
dataset_roepkoren_knoflookpad <-  visits %>%
  filter(meetnet == "Knoflookpad") %>%
  filter(protocol %in% c("Padden en kikkers - Roepkoren", "Knoflookpad - Roepkoren")) %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(select(counts, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal, type_aantal), by = "visit_id") %>%
  rename(hydrofoon = waarde) %>%
  select(-bezoekvariabele)

check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(visit_id, type_aantal) %>%
  filter(n() > 1)
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse
+ gebruik hydrofoon

```{r}
dataset_check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse, hydrofoon) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_roepkoren_knoflookpad_actief <- dataset_roepkoren_knoflookpad %>%
  filter(is_active)

locaties_niet_actief <- dataset_roepkoren_knoflookpad %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_roepkoren_knoflookpad_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```



+ We selecteren enkel tellingen die geschikt zijn voor analyse

  

```{r}

dataset_roepkoren_knoflookpad <- dataset_roepkoren_knoflookpad_actief %>%
  filter(voor_analyse)
```

### Overzicht van type telling met of zonder hydrofoon

```{r}
dataset_check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, hydrofoon, type_aantal) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ Records met hydrofoon = FALSE en 'aantal met hydrofoon' = 0 verwijderen

```{r}
dataset_roepkoren_knoflookpad <- dataset_roepkoren_knoflookpad %>%
  mutate(hydrofoon = ifelse(is.na(hydrofoon), "FALSE", hydrofoon),
         hydrofoon = ifelse(hydrofoon == "TRUE", TRUE, FALSE),
         type_aantal = ifelse(type_aantal == "exact count", "aantal zonder hydrofoon", type_aantal)) %>%
  filter(!(hydrofoon == FALSE & type_aantal == "aantal met hydrofoon" ))
```

### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ zoekinspanning
+ levensstadium


```{r}

dataset_check2 <- dataset_roepkoren_knoflookpad %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```



```{r}

analyseset_roepkoren_knoflookpad <-  dataset_roepkoren_knoflookpad 
```


## Analyseset Vuursalamander

```{r}

counts_vuursalamander <- counts %>%
  filter(meetnet == "Vuursalamander") %>%
  group_by(visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

dataset_vuursalamander <-  visits %>%
  filter(meetnet == "Vuursalamander") %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(select(counts_vuursalamander, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id") 

check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(visit_id, type_aantal) %>%
  filter(n() > 1)
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_vuursalamander %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_vuursalamander_actief <- dataset_vuursalamander %>%
  filter(is_active)

locaties_niet_actief <- dataset_vuursalamander %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_vuursalamander_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_vuursalamander <- dataset_vuursalamander %>%
  filter(voor_analyse) %>%
  filter(!is.na(aantal))
```

+ Na te kijken: voor_analyse = TRUE en 'weersomstandigheden ongunstig'

```{r}
dataset_vuursalamander %>%
  filter(bezoek_status == "Weersomstandigheden ongunstig") %>%
  select(locatie, datum, bezoek_status, voor_analyse,  aantal,  visit_id) %>%
  mutate(visit_id = str_c('<a href = "https://www.meetnetten.be/fieldwork/visits/', visit_id,'">', visit_id, '</a>')) %>%
  datatable(rownames = FALSE,
            escape = FALSE)
```



### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium


```{r}

dataset_check2 <- dataset_vuursalamander %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties.

```{r}
dataset_check3 <- dataset_vuursalamander %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```

```{r}
dataset_vuursalamander %>%
  distinct(locatie, is_sample) %>%
  datatable(rownames = FALSE,
            filter = 'top')
```
Van de ‘niet verplichte’ locaties kunnen de locaties die systematisch geteld worden wel meegenomen worden in de analyse:

+ Heilig-Geestgoed
+ Trimpont
+ Buggenhoutbos zuid

### Lengte transecten

```{r}
transects <- get_locations_smp(only_active = TRUE) %>%
  filter(meetnet == "Vuursalamander",
         locatie_type == "sublocatie") %>%
  mutate(lengte_transect = drop_units(st_length(geom))) %>%
  select(meetnet, id = parent_id, lengte_transect) %>%
  st_drop_geometry() %>%
  left_join(select(locations, meetnet, locatie, id), by = c("meetnet", "id"))
```

Voor een aantal locaties is er geen transect gedefinieerd. We stellen de transectlengte gelijk aan gemiddelde transectlengte.

```{r}
transects %>%
  filter(lengte_transect == 0)
```

```{r}
transects <- transects %>%
  mutate(lengte_transect = ifelse(lengte_transect == 0, mean(lengte_transect), lengte_transect)) %>%
  select(-id)
```


```{r}

analyseset_vuursalamander <-  dataset_vuursalamander %>%
  left_join(transects, by = c("meetnet", "locatie"))
```

## Analyseset Heikikker

```{r}

counts_heikikker <- counts %>%
  filter(meetnet == "Heikikker") %>%
  group_by(visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, type_aantal) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

dataset_heikikker <-  visits %>%
  filter(meetnet == "Heikikker") %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts_heikikker, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id")

check <- dataset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(visit_id, type_aantal) %>%
  filter(n() > 1)
```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_heikikker %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_heikikker_actief <- dataset_heikikker %>%
  filter(is_active)

locaties_niet_actief <- dataset_heikikker %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_heikikker_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_heikikker <- dataset_heikikker %>%
  filter(voor_analyse) %>%
  filter(!is.na(aantal))
```





### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium


```{r}

dataset_check2 <- dataset_heikikker %>%
  group_by(meetnet, protocol,  primaire_soort, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties.

```{r}
dataset_check3 <- dataset_heikikker %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```


```{r}

duur_cyclus <- 3
start_cyclus <- 2021

analyseset_heikikker <- dataset_heikikker %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, hoofdteller, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium,  aantal, bezoekvariabele, waarde)
```



## Analyseset Poelkikker

```{r}

counts_poelkikker <- counts %>%
  filter(meetnet == "Poelkikker") %>%
  group_by(visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, type_aantal) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

dataset_poelkikker <-  visits %>%
  filter(meetnet == "Poelkikker") %>%
  left_join(select(covar, visit_id, bezoekvariabele, waarde), by = c("visit_id")) %>%
  left_join(locatie_clusters, by = c("meetnet", "locatie")) %>%
  left_join(select(counts_poelkikker, visit_id,  soort_nl, soort_wet, primaire_soort, levensstadium, aantal), by = "visit_id")

```

### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_poelkikker %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ Ontoegankelijke locatie en locatie ongeschikt op inactief zetten? 



+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_poelkikker_actief <- dataset_poelkikker %>%
  filter(is_active)

locaties_niet_actief <- dataset_poelkikker %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_poelkikker_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_poelkikker <- dataset_poelkikker %>%
  filter(voor_analyse) %>%
  filter(!is.na(aantal))
```





### Overzicht van de type tellingen: primaire soort, zoekinspanning, levensstadium

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium


```{r}

dataset_check2 <- dataset_poelkikker %>%
  group_by(meetnet, protocol,  primaire_soort, soort_wet, soort_nl, levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ meerkikker primaire soort?

### Overzicht tellingen in steekproeflocaties en niet-steekproeflocaties

Hieronder overzicht van van de tellingen voor steekproeflocaties en niet-steekproeflocaties.

```{r}
dataset_check3 <- dataset_poelkikker %>%
  filter(!is.na(aantal)) %>%
  group_by(meetnet, protocol, is_sample) %>%
  summarise(n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check3 %>%
  datatable(rownames = FALSE)
```


```{r}

duur_cyclus <- 3
start_cyclus <- 2021

analyseset_poelkikker <- dataset_poelkikker %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, cluster, poel, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, hoofdteller, doy, bezoek_status, primaire_soort, soort_nl, soort_wet, levensstadium,  aantal)
```



## Analyseset Rugstreeppad

```{r}

counts_rugstreeppad_sample <- counts %>%
  filter(meetnet == "Rugstreeppad") %>%
  group_by(visit_id, sample_id,  soort_nl,  primaire_soort, levensstadium,  activiteit) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup()

counts_rugstreeppad_visit <- counts %>%
  filter(meetnet == "Rugstreeppad") %>%
  group_by(visit_id, soort_nl,  primaire_soort, levensstadium, activiteit) %>%
  summarise(aantal = sum(aantal),
            n_samples = n_distinct(sample_id)) %>%
  ungroup()

covar_rugstreeppad <- covar_sample %>%
  filter(meetnet == "Rugstreeppad")

type_habitat <- covar_rugstreeppad %>%
  filter(bezoekvariabele == "type habitat") %>%
  select(visit_id, sample_id, type_habitat = waarde)

habitatkenmerken_bepaald <- covar_rugstreeppad %>%
  filter(bezoekvariabele == "habitatkenmerken werden bepaald?") %>%
  select(visit_id, sample_id, habitatkenmerken = waarde) %>%
  mutate(habitatkenmerken = ifelse(habitatkenmerken == "ja", TRUE,
                                   ifelse(habitatkenmerken == "nee", FALSE, NA)))

covar_rugstreeppad <- covar_rugstreeppad %>%
  filter(!bezoekvariabele %in% c("type habitat", "habitatkenmerken werden bepaald?", "sample type amfibieën")) %>%
  left_join(habitatkenmerken_bepaald, by = c("visit_id", "sample_id")) %>%
  left_join(type_habitat, by = c("visit_id", "sample_id"))

dataset_rugstreeppad_sample <-  visits %>%
  filter(meetnet == "Rugstreeppad") %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(counts_rugstreeppad_sample, by = "visit_id") %>%
  left_join(type_habitat, by = c("visit_id", "sample_id")) 

dataset_rugstreeppad <-  visits %>%
  filter(meetnet == "Rugstreeppad") %>%
  left_join(locaties, by = c("meetnet", "locatie")) %>%
  left_join(counts_rugstreeppad_visit, by = "visit_id")

```

### Controle van ontbrekende waarden voor aantallen

Nulwaarnemingen worden vaak niet ingevoerd. 
Daardoor bevat de databank ontbrekende waarden voor aantallen, wat tot verkeerde interpretaties kan leiden.
Je krijgt namelijk ook ontbrekende waarden wanneer het veldwerk onmogelijk is (locatie ongeschikt of ontoegankelijk).
Het expliciet invoeren van nullen is dus noodzakelijk.

In tussentijd veronderstellen we een nulwaarneming bij ontbrekende waarden wanneer bezoek_status = 'conform protocol'.

```{r}
check_na <- dataset_rugstreeppad %>%
  filter(is.na(aantal)) %>%
  select(visit_id, meetnet, locatie, datum, hoofdteller, bezoek_status, voor_analyse, is_active,  aantal, notes)

dataset_rugstreeppad_nul <- dataset_rugstreeppad %>%
  filter(is.na(aantal) & bezoek_status == "Conform protocol") %>%
  select(-levensstadium, -activiteit, -aantal, -n_samples)

nulwaarneming <- dataset_rugstreeppad %>%
  tidyr::expand(visit_id, nesting(levensstadium, activiteit)) %>%
  filter(!is.na(levensstadium)) %>% 
  semi_join(dataset_rugstreeppad_nul, by = "visit_id") %>%
  mutate(aantal = 0,
         n_samples = 1)

dataset_rugstreeppad_nul <- dataset_rugstreeppad_nul %>%
  left_join(nulwaarneming, by = "visit_id")

dataset_rugstreeppad <- dataset_rugstreeppad %>%
  anti_join(dataset_rugstreeppad_nul, by = "visit_id") %>%
  bind_rows(dataset_rugstreeppad_nul)

check_na %>%
  datatable(rownames = FALSE,
            filter = "top")
  
```


### Overzicht tellingen per type locatie (actief of niet-actief) en al dan niet geschikt voor analyse

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties voor de verschillende combinaties van:

+ protocol
+ bezoek_status
+ is_active
+ voor_analyse

```{r}
dataset_check <- dataset_rugstreeppad %>%
  filter(primaire_soort) %>%
  group_by(meetnet, protocol, bezoek_status, is_active,  voor_analyse) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()

dataset_check %>%
  datatable(rownames = FALSE,
            filter = "top")
```

+ **We selecteren enkel tellingen op actieve locaties**

```{r}
dataset_rugstreeppad_actief <- dataset_rugstreeppad %>%
  filter(is_active)

locaties_niet_actief <- dataset_rugstreeppad %>%
  distinct(meetnet, locatie) %>%
  anti_join(dataset_rugstreeppad_actief, by = c("meetnet", "locatie"))

locaties_niet_actief %>%
  kable(caption = "Niet actieve locaties waarvoor bezoeken niet geselecteerd werden") %>%
  kable_styling()
```

+ We selecteren enkel tellingen die geschikt zijn voor analyse

```{r}

dataset_rugstreeppad <- dataset_rugstreeppad %>%
  filter(voor_analyse) 
```

+ Na te kijken: voor_analyse = TRUE en 'weersomstandigheden ongunstig' of 'locatie ongeschikt'

```{r}
dataset_rugstreeppad %>%
  filter(!bezoek_status %in% c("Conform protocol", "Telmethode niet gevolgd")) %>%
  group_by(locatie, datum, bezoek_status, voor_analyse, visit_id, notes) %>%
  summarise(aantal_tot = sum(aantal)) %>%
  ungroup() %>%
  select(locatie, datum, bezoek_status, voor_analyse, aantal_tot, visit_id, notes) %>%
  mutate(visit_id = str_c('<a href = "https://www.meetnetten.be/fieldwork/visits/', visit_id,'">', visit_id, '</a>')) %>%
  datatable(rownames = FALSE,
            escape = FALSE)
```



### Overzicht van de type tellingen: primaire soort, levensstadium, geslacht

Onderstaande tabel geeft een overzicht van het aantal records, bezoeken en locaties en de totale aantallen voor de verschillende combinaties van:

+ protocol
+ primaire soort
+ levensstadium


```{r}

dataset_check2 <- dataset_rugstreeppad %>%
  group_by(meetnet, protocol,  primaire_soort,  levensstadium) %>%
  summarise(n_records = n(),
            n_visits = n_distinct(visit_id),
            n_locaties = n_distinct(locatie),
            aantal_tot = sum(aantal)) %>%
  ungroup()

dataset_check2 %>%
  datatable(rownames = FALSE,
            filter = "top")
```

```{r}
duur_cyclus <- 3
start_cyclus <- 2019

analyseset_rugstreeppad <- dataset_rugstreeppad %>%
  filter(protocol == "Rugstreeppad - Transect") %>%
  filter(!is.na(aantal)) %>%
  mutate(meetcyclus = ceiling((jaar - start_cyclus + 1 ) / duur_cyclus)) %>%
  group_by(meetcyclus) %>%
  mutate(meetcyclus_start = min(jaar),
         meetcyclus_end = min(jaar) + duur_cyclus - 1) %>%
  ungroup() %>%
  select(soortgroep, meetnet, protocol, locatie, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, jaar, datum, visit_id, doy, bezoek_status, primaire_soort, soort_nl, levensstadium, activiteit, aantal, n_samples)
```

## Analyseset habitatkenmerken

```{r}
habitatkenmerken_boomkikker_kamsalamander <- analyseset_larven %>%
  distinct(meetnet, cluster, locatie, poel, visit_id, datum, bezoek_status, is_sample, meetcyclus, meetcyclus_start, meetcyclus_end, notes) %>%
  left_join(covar, by = c("visit_id", "meetnet")) %>%
  filter(!bezoekvariabele %in% c("aantal keer geschept", "zoekinspanning")) %>%
  mutate(waarde = ifelse(waarde == "3" & bezoekvariabele == "waterkwaliteit", "goed (helder water, typische oever en/of waterplanten, weinig verlanding, niet zichtbaar vervuild)", waarde)) %>% 
  mutate(waarde = ifelse(waarde == "no shade" & bezoekvariabele == "beschaduwing", "geen schaduw", waarde)) %>% 
  group_by(visit_id) %>%
  mutate(habitatkenmerken_bepaald = ifelse(all(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "niet",
                                       ifelse(any(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "deels", "volledig")),
         n_habitatkenmerken = sum(!waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup()

check <- habitatkenmerken_boomkikker_kamsalamander %>%
  group_by(meetnet, protocol, bezoekvariabele, waarde) %>%
  summarise(n_records = n()) %>%
  ungroup()

check <- habitatkenmerken_boomkikker_kamsalamander %>%
  filter(waarde == "no shade")
check$visit_id

habitatkenmerken_boomkikker_kamsalamander_wide <- habitatkenmerken_boomkikker_kamsalamander %>%
  select(-eenheid) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(ph = "pH (zuurtegraad)", oppervlakte_waterpartij = "oppervlakte waterpartij", maximale_diepte = "maximale diepte", aanwezigheid_vis = "aanwezigheid vis", permanente_waterkolom = "permanente waterkolom") %>%
  mutate(ph = as.numeric(ph),
         oppervlakte_waterpartij = factor(oppervlakte_waterpartij, levels = c("onbekend", "niet bekeken/niet van toepassing","<10", "10-100", "101-250", "251-400", ">400")),
         maximale_diepte = factor(maximale_diepte, levels = c("onbekend", "niet bekeken/niet van toepassing", "<0.5", "0.5-1", ">1", ">1.5")),
         aanwezigheid_vis = ifelse(aanwezigheid_vis %in% c("TRUE", "ja"), TRUE,
                                   ifelse(aanwezigheid_vis %in% c("FALSE", "nee"), FALSE, NA)),
         permanente_waterkolom = ifelse(permanente_waterkolom %in% c("TRUE", "ja"), TRUE,
                                   ifelse(permanente_waterkolom %in% c("FALSE", "nee"), FALSE, NA)),
         beschaduwing = factor(beschaduwing, levels = c("onbekend", "niet bekeken/niet van toepassing", "geen schaduw", "<30%", "30-60%", ">60%")),
         waterkwaliteit = ifelse(str_detect(waterkwaliteit, "goed"), "goed",
                                 ifelse(str_detect(waterkwaliteit, "middelmatig"), "middelmatig",
                                      ifelse(str_detect(waterkwaliteit, "slecht"), "slecht", waterkwaliteit))),
         waterkwaliteit = factor(waterkwaliteit, levels = c("onbekend", "niet bekeken/niet van toepassing", "plas verdwenen of volledig verland", "slecht", "middelmatig", "goed")))

habitatkenmerken_rugstreeppad <- dataset_rugstreeppad_sample %>%
  distinct(meetnet, protocol, locatie, visit_id, sample_id, datum, bezoek_status, voor_analyse, is_sample, is_active) %>%
  left_join(covar_rugstreeppad, by = c("meetnet", "protocol","visit_id", "sample_id")) %>%
  mutate(waarde = ifelse(waarde == "3" & bezoekvariabele == "waterkwaliteit", "goed (helder water, typische oever en/of waterplanten, weinig verlanding, niet zichtbaar vervuild)", waarde),
         waarde = ifelse(waarde == "0" & bezoekvariabele == "waterkwaliteit", "plas verdwenen of volledig verland", waarde),
         waarde = ifelse(waarde == "bad" & bezoekvariabele == "waterkwaliteit", "slecht (verwaarloosde poel met eutroof water (algen, kroos), anders vervuild of verregaand verland", waarde),
         waarde = ifelse(waarde == "average" & bezoekvariabele == "waterkwaliteit", "middelmatig (tussen slecht en goed)", waarde),
         waarde = ifelse(waarde == "no shade" & bezoekvariabele == "beschaduwing", "geen schaduw", waarde),
         waarde = ifelse(waarde == "unknown", "onbekend", waarde)) %>% 
  group_by(visit_id, sample_id) %>%
  mutate(habitatkenmerken_bepaald = ifelse(all(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "niet",
                                       ifelse(any(waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing")), "deels", "volledig")),
         n_habitatkenmerken = sum(!waarde %in% c("", "onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup() %>%
  filter(!is.na(bezoekvariabele)) %>%
  filter(voor_analyse)
  

check_ontbrekend_type <- habitatkenmerken_rugstreeppad %>%
  filter(is.na(type_habitat)) %>%
  filter(bezoekvariabele == "oppervlakte waterpartij") %>%
  filter(habitatkenmerken_bepaald != "niet")

check_wrong_category <- habitatkenmerken_rugstreeppad %>%
  filter(waarde %in% c("no shade", "unknown", "bad", "average", "0", "3")) %>%
  select(datum, visit_id, sample_id, bezoekvariabele, waarde)

check_wrong_category %>%
  write_csv2("../output/bezoekvariabele_rugstreeppad_anomalie.csv")

habitatkenmerken_rugstreeppad_wide <- habitatkenmerken_rugstreeppad %>%
  select(-eenheid) %>%
  pivot_wider(names_from = bezoekvariabele, values_from = waarde) %>%
  rename(oppervlakte_waterpartij = "oppervlakte waterpartij", maximale_diepte = "maximale diepte", aanwezigheid_vis = "aanwezigheid vis", permanente_waterkolom = "permanente waterkolom", drijvende_vegetatie = "drijvende vegetatie", verticale_vegetatie = "verticale vegetatie") %>%
  mutate(oppervlakte_waterpartij = factor(oppervlakte_waterpartij, levels = c("onbekend", "niet bekeken/niet van toepassing","<10", "10-100", "101-250", "251-400", ">400")),
         maximale_diepte = factor(maximale_diepte, levels = c("onbekend", "niet bekeken/niet van toepassing", "<0.5", "0.5-1", ">1", ">1.5")),
         aanwezigheid_vis = ifelse(aanwezigheid_vis %in% c("TRUE", "ja"), TRUE,
                                   ifelse(aanwezigheid_vis %in% c("FALSE", "nee"), FALSE, NA)),
         permanente_waterkolom = ifelse(permanente_waterkolom %in% c("TRUE", "ja"), TRUE,
                                   ifelse(permanente_waterkolom %in% c("FALSE", "nee"), FALSE, NA)),
         beschaduwing = factor(beschaduwing, levels = c("onbekend", "niet bekeken/niet van toepassing", "geen schaduw", "<30%", "30-60%", ">60%")),
         drijvende_vegetatie = factor(drijvende_vegetatie, levels = c("onbekend", "niet bekeken/niet van toepassing", "0%", "1-25%", "26-50%", "51-75%", "76-100%")),
         onderwatervegetatie = factor(onderwatervegetatie, levels = c("onbekend", "niet bekeken/niet van toepassing", "0%", "1-25%", "26-50%", "51-75%", "76-100%")),
         verticale_vegetatie = factor(verticale_vegetatie, levels = c("onbekend", "niet bekeken/niet van toepassing", "0%", "1-25%", "26-50%", "51-75%", "76-100%")))
```

### Boomkikker en kamsalamander

```{r}
habitatkenmerken_boomkikker_kamsalamander_wide %>%
  group_by(meetnet,  bezoek_status, habitatkenmerken_bepaald) %>%
  summarise(n_bezoeken = n_distinct(visit_id),
            n_habitatkenmerken = round(mean(n_habitatkenmerken), 1)) %>%
  ungroup() %>%
  kable(caption = "Overzicht bepaling habitatkenmerken voor meetnet Boomkikker en Kamsalamander") %>%
  kable_styling()
```

### Rugstreeppad

```{r}
habitatkenmerken_rugstreeppad_wide %>%
  group_by(meetnet,  bezoek_status, voor_analyse, type_habitat, habitatkenmerken_bepaald) %>%
  summarise(n_samples = n_distinct(sample_id),
            n_habitatkenmerken = round(mean(n_habitatkenmerken), 1)) %>%
  ungroup() %>%
  kable() %>%
  kable_styling()
```

+ Habitatkenmerken voor landpunten verwijderen.

+ Geen habitatkenmerken bepaald bij eitellingen in havengebied ('Telmethode niet gevolgd')

```{r}
habitatkenmerken_rugstreeppad_wide <- habitatkenmerken_rugstreeppad_wide %>%
  filter(type_habitat != "land" | is.na(type_habitat)) %>%
  filter(bezoek_status != "Telmethode niet gevolgd")
```

# Data wegschrijven

```{r}
write_vc(analyseset_larven, file = "analyseset_larven", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "levensstadium"), strict = FALSE)

write_vc(analyseset_roepkoren_boomkikker, file = "analyseset_roepkoren_boomkikker", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_fuiken_totaal, file = "analyseset_fuiken_totaal", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_fuiken_detail, file = "analyseset_fuiken_detail", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "levensstadium", "geslacht"), strict = FALSE)

write_vc(analyseset_roepkoren_knoflookpad, file = "analyseset_roepkoren_knoflookpad", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "hydrofoon", "type_aantal"), strict = FALSE)

write_vc(analyseset_vuursalamander, file = "analyseset_vuursalamander", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id"), strict = FALSE)

write_vc(analyseset_heikikker, file = "analyseset_heikikker", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "bezoekvariabele"), strict = FALSE)

write_vc(analyseset_poelkikker, file = "analyseset_poelkikker", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_wet", "visit_id"), strict = FALSE)

write_vc(analyseset_rugstreeppad, file = "analyseset_rugstreeppad", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "soort_nl", "visit_id", "levensstadium", "activiteit"), strict = FALSE)

write_vc(habitatkenmerken_boomkikker_kamsalamander_wide, file = "habitatkenmerken_boomkikker_kamsalamander_wide", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "visit_id"), strict = FALSE)

write_vc(habitatkenmerken_rugstreeppad_wide, file = "habitatkenmerken_rugstreeppad_wide", root = "../output/analyseset", sorting = c("meetnet", "locatie", "datum", "visit_id"), strict = FALSE)

check <- analyseset_roepkoren_knoflookpad %>%
  group_by(meetnet, locatie, datum, soort_nl) %>%
  filter(n() > 1)
```




<!--chapter:end:1_selectie_analyseset.Rmd-->



# Dataverkenning Boomkikker

```{r}
analyseset_larven <- read_vc(file = "analyseset_larven", root = "../output/analyseset")

analyseset_roepkoren_boomkikker <- read_vc(file = "analyseset_roepkoren_boomkikker", root = "../output/analyseset")

datasetset_boomkikker <- analyseset_larven %>%
  bind_rows(analyseset_roepkoren_boomkikker) %>%
  filter(meetnet == "Boomkikker") %>%
  filter(primaire_soort) %>%
  mutate(protocol = ifelse(str_detect(protocol, "Larve"), "larventelling", "roepkoren")) %>%
  group_by(locatie, protocol) %>%
  mutate(paired = n_distinct(meetcyclus) > 1) %>%
  ungroup() %>%
  mutate(periode = str_c(meetcyclus_start, " - ", meetcyclus_end))

```

## Overzicht tellingen

```{r}
overzicht <- datasetset_boomkikker %>%
  filter(is_sample) %>%
  group_by(protocol, paired, cluster, poel, periode) %>%
  summarise(n_tellingen = n_distinct(visit_id)) %>%
  ungroup()

overzicht_roepkoren <- overzicht %>%
  filter(protocol == "roepkoren") %>%
  pivot_wider(names_from = "periode", values_from = n_tellingen, values_fill = 0)

overzicht_larven <- overzicht %>%
  filter(protocol == "larventelling") %>%
  pivot_wider(names_from = "periode", values_from = n_tellingen, values_fill = 0)

overzicht_roepkoren %>%
  select(cluster, poel, "2016 - 2018", "2019 - 2021", "2022 - 2024") %>%
  arrange(cluster, poel) %>%
  kable(caption = "Aantal roepkoortellingen per cyclus") %>%
  kable_styling() %>%
  collapse_rows(1)
```

```{r}
overzicht_larven %>%
  select(cluster, poel, "2016 - 2018", "2019 - 2021", "2022 - 2024") %>%
  arrange(cluster, poel) %>%
  kable(caption = "Aantal larventellingen per cyclus") %>%
  kable_styling() %>%
  collapse_rows(1)
```

### Tijdstip van de tellingen

```{r, fig.height=9}

datasetset_boomkikker %>%
  ggplot(aes(y = poel, x = datum, size = aantal, colour = is_sample, shape = levensstadium)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~cluster, scales = "free_y")
```

+ poelen in clusters meestal in zelfde jaar geteld
  + confounding tussen cluster en jaar
  + jaar niet meenemen in model, enkel meetcyclus
+ Merkske enkel in tweede meetcyclus opgemeten
  + Merkske niet meenemen om trend te bepalen
+ Er zijn ook al tellingen van de 3de meetcyclus, maar 3de meetcyclus is nog niet afgerond dus die tellingen nemen we niet mee

```{r}
analyseset_boomkikker <- datasetset_boomkikker %>%
  filter(jaar <= 2021)
```


### Verschil steekproeflocaties niet-steekproeflocaties

```{r}
analyseset_boomkikker %>%
  ggplot(aes(x = is_sample, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```
+ Weinig verschil in aantallen


## Vergelijking meetcycli: alle meetpunten

```{r}
analyseset_boomkikker %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
analyseset_boomkikker %>%
  ggplot(aes(x = aantal, fill = periode)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```
```{r}
analyseset_boomkikker %>%
  mutate( aantalsklasse = ifelse(aantal == 0, "0", 
                                ifelse(aantal <= 10, "1 - 10", 
                                       ifelse(aantal <= 25, "11 - 25",
                                              ifelse(aantal <= 50, "26 - 50",
                                              ifelse(aantal <= 100, "51 - 100", "> 100")))))) %>%
  mutate(aantalsklasse = factor(aantalsklasse, levels = c("0", "1 - 10", "11 - 25", "26 - 50", "51 - 100", "> 100"))) %>%
  ggplot(aes(x = aantalsklasse, fill = periode)) +
  geom_bar(alpha = 0.5, position = "dodge") +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```

## Vergelijking meetcycli: enkel meetnetlocaties


```{r}
analyseset_boomkikker %>%
  filter(is_sample) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
analyseset_boomkikker %>%
  filter(is_sample) %>%
  ggplot(aes(x = jaar, y = aantal, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
analyseset_boomkikker %>%
  filter(is_sample) %>%
  ggplot(aes(x = aantal, fill = periode)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```

```{r}
analyseset_boomkikker %>%
  filter(is_sample) %>%
    mutate(aantalsklasse = ifelse(aantal == 0, "0", 
                                ifelse(aantal <= 10, "1 - 10", 
                                       ifelse(aantal <= 25, "11 - 25",
                                              ifelse(aantal <= 50, "26 - 50",
                                              ifelse(aantal <= 100, "51 - 100", "> 100")))))) %>%
  mutate(aantalsklasse = factor(aantalsklasse, levels = c("0", "1 - 10", "11 - 25", "26 - 50", "51 - 100", "> 100"))) %>%
  ggplot(aes(x = aantalsklasse, fill = periode)) +
  geom_bar(alpha = 0.5, position = "dodge") +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```



## Vergelijking gemiddelde aantallen per cluster 

### adulten

```{r}
analyseset_boomkikker %>%
  mutate(cluster = str_wrap(cluster)) %>%
  filter(levensstadium == "adult") %>%
  filter(is_sample) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
 # geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  #scale_y_log10() +
  facet_wrap(~ cluster, scales = "free_y")
```
`

### Larven


```{r}
analyseset_boomkikker %>%
  filter(levensstadium == "larve") %>%
  filter(is_sample) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
 # geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ cluster, scales = "free_y")
```

## Zoekinspanning larvetelling

```{r}
analyseset_boomkikker %>%
  filter(larvetelling) %>%
  filter(is_sample) %>%
  ggplot(aes(x = n_catch, fill = periode)) +
  geom_histogram(alpha = 0.5, position = "dodge")

check_catcheffort <- datasetset_boomkikker %>%
  filter(larvetelling) %>%
  filter(levensstadium == "larve") %>%
  group_by(cluster, poel, meetcyclus) %>%
  mutate(n_visits = n()) %>%
  ungroup() %>%
  select(visit_id, is_sample, cluster, poel, periode, n_visits, datum, n_catch, levensstadium, aantal)
  
```

+ Lager aantal scheppen in 2de meetcyclus: misschien deels omdat er minder water is?

```{r}
check_catcheffort_missing_value <- check_catcheffort %>%
  group_by(periode, is_sample) %>%
  summarise(n_records = n(),
            prop_missing = round(sum(is.na(n_catch)) / n(), 2),
            prop_ingevuld = round(sum(!is.na(n_catch)) / n(), 2)) %>%
  ungroup()

check_catcheffort_missing_value %>%
  kable(caption = "Proportie van de observatie waarbij 'aantal keer geschept' niet werd ingevuld per meetcyclus") %>%
  kable_styling() %>%
  collapse_rows(1)
```

```{r}
catcheffort_missing <- check_catcheffort %>%
  filter(is.na(n_catch)) %>%
  select(visit_id, cluster, poel, is_sample, datum, aantal) %>%
  left_join(select(visits, visit_id, hoofdteller), by = "visit_id") %>%
  arrange(datum)

catcheffort_missing %>%
  write_csv2("../output/boomkikkerlarve_aantalscheppen_ontbreekt.csv")

catcheffort_missing %>%
  select(-hoofdteller) %>%
  datatable(rownames = FALSE)
```

```{r, fig.height= 9}
check_catcheffort %>%
  filter(is_sample) %>%
  ggplot(aes(x = n_catch, y = poel, colour = periode, shape = periode)) +
  geom_point(alpha = 0.5, size = 4) +
  facet_wrap(~ cluster, scales = "free_y")
```

+ Voor heel wat clusters systematisch lager aantal scheppen per poel

In onderstaande figuur houden we rekening met de zoekinspanning: aantal larven per 10 scheppen. Maar als er vooral minder geschept wordt omdat het wateroppervlak kleiner is in de 2de meetcyclus, kan dit ook een vertekend beeld geven.

```{r}

analyseset_boomkikker %>%
  filter(levensstadium == "larve") %>%
  filter(is_sample) %>%
  filter(!is.na(n_catch)) %>%
  mutate(aantal_10catch = aantal / n_catch * 10) %>%
  ggplot(aes(x = periode, y = aantal_10catch, colour = is_sample)) +
  geom_boxplot(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") 

```

```{r}
analyseset_boomkikker %>%
  filter(levensstadium == "larve") %>%
  filter(is_sample) %>%
  filter(!is.na(n_catch)) %>%
  mutate(aantal_10catch = aantal / n_catch * 10) %>%
  ggplot(aes(x = periode, y = aantal_10catch, colour = is_sample)) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~cluster)
```

## Overzicht gemiddeldes per meetcyclus

```{r}
mean_sample <- analyseset_boomkikker %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  group_by(levensstadium, periode) %>%
  summarise(mean_count = round(mean(aantal, na.rm = TRUE), 2),
            se = sqrt(var(aantal, na.rm = TRUE)/n()),
            mean_n_catch = round(mean(n_catch, na.rm = TRUE), 2),
            occurence = round(sum(aantal > 0, na.rm = TRUE) / n(), 2),
            n_bezoeken = n(),
            n_locaties = n_distinct(locatie)) %>%
  ungroup() %>%
  mutate(mean_count = str_c(mean_count, " [", round(mean_count - 1.96 * se, 2), " - ", round(mean_count + 1.96 * se, 2), "]"))

mean_larve_10schep <- analyseset_boomkikker %>%
  filter(primaire_soort) %>%
  filter(is_sample) %>%
  filter(levensstadium == "larve") %>%
  filter(!is.na(n_catch)) %>%
  mutate(aantal = aantal/n_catch * 10) %>%
  group_by(cluster, locatie) %>%
  ungroup() %>%
  group_by(levensstadium, periode) %>%
  summarise(mean_count = round(mean(aantal, na.rm = TRUE), 2),
            se = sqrt(var(aantal, na.rm = TRUE)/n()),
            occurence = round(sum(aantal > 0, na.rm = TRUE)/ n(), 2),
            n_bezoeken = n(),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()  %>%
  mutate(mean_count = str_c(mean_count, " [", round(mean_count - 1.96 * se, 2), " - ", round(mean_count + 1.96 * se, 2), "]")) %>%
  mutate(levensstadium = "larve_per10schep")

mean_sample %>%
  bind_rows(mean_larve_10schep) %>%
  arrange(levensstadium) %>%
  mutate(mean_n_catch = ifelse(levensstadium == "larve", mean_n_catch, NA)) %>%
  select(-se) %>%
  kable %>%
  kable_styling() %>%
  collapse_rows(c(1, 2))
```





<!--chapter:end:2_1_dataverkenning_boomkikker.Rmd-->

# Dataverkenning Kamsalamander

```{r}

analyseset_larven <- read_vc(file = "analyseset_larven", root = "../output/analyseset")

analyseset_fuiken_totaal <- read_vc(file = "analyseset_fuiken_totaal", root = "../output/analyseset")

datasetset_kamsalamander <- analyseset_larven %>%
  bind_rows(analyseset_fuiken_totaal) %>%
  filter(meetnet == "Kamsalamander") %>%
  filter(primaire_soort) %>%
  group_by(cluster) %>%
  mutate(n_poelen = n_distinct(poel)) %>%
  ungroup() %>%
  mutate(meetcyclus = ifelse(jaar <= 2020, 1 , 2),
         meetcyclus_start = ifelse(meetcyclus == 1, 2017, 2021),
         meetcyclus_end = ifelse(meetcyclus == 1, 2020, 2023),
         periode = str_c(meetcyclus_start, " - ", meetcyclus_end),
         aantal_orig = aantal,
         aantal = ifelse(!is.na(n_fuiken), aantal/n_fuiken, aantal),
         protocol = ifelse(str_detect(protocol, "Larve"), "larventelling", "fuiken"),
         levensstadium = ifelse(is.na(levensstadium), "adult en juveniel", levensstadium)) %>%
  filter(!is.na(aantal)) %>%
  filter(levensstadium != "metamorf") %>%
  group_by(locatie, protocol) %>%
  mutate(paired = n_distinct(meetcyclus) > 1,
         multiple_year = n_distinct(jaar) > 1) %>%
  ungroup()

check_2 <- datasetset_kamsalamander %>%
  distinct(protocol, locatie, is_sample, paired, multiple_year) %>%
  group_by(protocol, is_sample) %>%
  summarise(n_paired = sum(paired),
             n_multiple_years = sum(multiple_year)) %>%
  ungroup()

check <- datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(paired) %>%
  group_by(protocol, periode) %>%
  summarise(n_locaties = n_distinct(locatie)) %>%
  ungroup()
```


## Overzicht tellingen

### Meetnetlocaties

```{r}
overzicht <- datasetset_kamsalamander %>%
  filter(is_sample) %>%
  group_by(protocol, paired, cluster, poel, locatie, periode) %>%
  summarise(n_tellingen = n_distinct(visit_id)) %>%
  ungroup()

overzicht_fuiken <- overzicht %>%
  filter(protocol == "fuiken") %>%
  pivot_wider(names_from = "periode", values_from = n_tellingen, values_fill = 0)

overzicht_larven <- overzicht %>%
  filter(protocol == "larventelling") %>%
  pivot_wider(names_from = "periode", values_from = n_tellingen, values_fill = 0)

overzicht_fuiken %>%
  select(cluster, poel, "2017 - 2020", "2021 - 2023", gepaard = paired) %>%
  arrange(cluster, poel) %>%
  kable(caption = "Aantal fuiktellingen per cyclus") %>%
  kable_styling() %>%
  collapse_rows(1)

overzicht_paired <- overzicht %>%
  group_by(protocol, paired) %>%
  summarise(n = n_distinct(locatie),
            meetcycli = str_c(unique(periode), collapse = "; ")) %>%
  ungroup()
```

```{r}
overzicht_larven %>%
  select(cluster, poel, "2017 - 2020", "2021 - 2023", gepaard = paired) %>%
  arrange(cluster, poel) %>%
  kable(caption = "Aantal fuiktellingen per cyclus") %>%
  kable_styling() %>%
  collapse_rows(1)
```


### Tijdstip van de tellingen

```{r, fig.height=9}

datasetset_kamsalamander %>%
  filter(n_poelen >= 3) %>%
  ggplot(aes(y = poel, x = datum, size = aantal, colour = is_sample, shape = protocol)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = as.Date("2021-01-01"), linetype = 2, alpha = 0.5) +
  facet_wrap(~cluster, scales = "free_y")
```

```{r, fig.height=9}

datasetset_kamsalamander %>%
  filter(n_poelen < 3) %>%
  ggplot(aes(y = locatie, x = datum, size = aantal, colour = is_sample, shape = protocol)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = as.Date("2021-01-01"), linetype = 2, alpha = 0.5)
```



### Verschil steekproeflocaties niet-steekproeflocaties

```{r}
datasetset_kamsalamander %>%
  ggplot(aes(x = is_sample, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```


## Vergelijking meetcycli: alle meetpunten

```{r}
datasetset_kamsalamander %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
datasetset_kamsalamander %>%
  ggplot(aes(x = aantal, fill = periode)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```
```{r}
datasetset_kamsalamander %>%
  mutate( aantalsklasse = ifelse(aantal == 0, "0", 
                                ifelse(aantal <= 10, "1 - 10", 
                                       ifelse(aantal <= 25, "11 - 25",
                                              ifelse(aantal <= 50, "26 - 50",
                                              ifelse(aantal <= 100, "51 - 100", "> 100")))))) %>%
  mutate(aantalsklasse = factor(aantalsklasse, levels = c("0", "1 - 10", "11 - 25", "26 - 50", "51 - 100", "> 100"))) %>%
  ggplot(aes(x = aantalsklasse, fill = periode)) +
  geom_bar(alpha = 0.5, position = "dodge") +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```

## Vergelijking meetcycli: enkel meetnetlocaties


```{r}
datasetset_kamsalamander %>%
  filter(is_sample) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
datasetset_kamsalamander %>%
  filter(is_sample) %>%
  ggplot(aes(x = jaar, y = aantal, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
datasetset_kamsalamander %>%
  filter(is_sample) %>%
  ggplot(aes(x = aantal, fill = periode)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```

```{r}
datasetset_kamsalamander %>%
  filter(is_sample) %>%
    mutate(aantalsklasse = ifelse(aantal == 0, "0", 
                                ifelse(aantal <= 10, "1 - 10", 
                                       ifelse(aantal <= 25, "11 - 25",
                                              ifelse(aantal <= 50, "26 - 50",
                                              ifelse(aantal <= 100, "51 - 100", "> 100")))))) %>%
  mutate(aantalsklasse = factor(aantalsklasse, levels = c("0", "1 - 10", "11 - 25", "26 - 50", "51 - 100", "> 100"))) %>%
  ggplot(aes(x = aantalsklasse, fill = periode)) +
  geom_bar(alpha = 0.5, position = "dodge") +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```
## Vergelijking meetcycli: enkel meetnetlocaties die in beide cycli werden geteld

```{r}

datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(paired) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}

datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(paired) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium, scales = "free_y")
```

```{r}
datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(paired) %>%
  ggplot(aes(x = aantal, fill = periode)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```

```{r}
datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(paired) %>%
    mutate(aantalsklasse = ifelse(aantal == 0, "0", 
                                ifelse(aantal <= 10, "1 - 10", 
                                       ifelse(aantal <= 25, "11 - 25",
                                              ifelse(aantal <= 50, "26 - 50",
                                              ifelse(aantal <= 100, "51 - 100", "> 100")))))) %>%
  mutate(aantalsklasse = factor(aantalsklasse, levels = c("0", "1 - 10", "11 - 25", "26 - 50", "51 - 100", "> 100"))) %>%
  ggplot(aes(x = aantalsklasse, fill = periode)) +
  geom_bar(alpha = 0.5, position = "dodge") +
  facet_wrap(~ levensstadium, scales = "free", nrow = 3)
```

## Vergelijking gemiddelde aantallen per cluster 

### adulten en juvenielen

```{r}
datasetset_kamsalamander %>%
  mutate(cluster = str_wrap(cluster)) %>%
  filter(levensstadium == "adult en juveniel") %>%
  filter(is_sample) %>%
  filter(n_poelen >= 3) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1) +
  #scale_y_log10() +
  facet_wrap(~ cluster, scales = "free_y")
```
`

### Larven


```{r}
datasetset_kamsalamander %>%
  filter(levensstadium == "larve") %>%
  filter(is_sample) %>%
    filter(n_poelen >= 3) %>%
  ggplot(aes(x = periode, y = aantal, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1) +
  facet_wrap(~ cluster, scales = "free_y")
```

## Zoekinspanning larvetelling

```{r}
datasetset_kamsalamander %>%
  filter(larvetelling) %>%
  filter(is_sample) %>%
  ggplot(aes(x = n_catch, fill = periode)) +
  geom_histogram(alpha = 0.5, position = "dodge")

check_catcheffort <- datasetset_kamsalamander %>%
  filter(larvetelling) %>%
  filter(levensstadium == "larve") %>%
  group_by(cluster, poel, meetcyclus) %>%
  mutate(n_visits = n()) %>%
  ungroup() %>%
  select(visit_id, is_sample, cluster, poel, periode, n_visits, datum, n_catch, levensstadium, aantal)
  
```



```{r}
check_catcheffort_missing_value <- check_catcheffort %>%
  group_by(periode, is_sample) %>%
  summarise(n_records = n(),
            prop_missing = round(sum(is.na(n_catch))/ n(), 2),
            prop_ingevuld = round(sum(!is.na(n_catch))/ n(), 2)) %>%
  ungroup()

check_catcheffort_missing_value %>%
  kable(caption = "Proportie van de observatie waarbij 'aantal keer geschept' niet werd ingevuld per meetcyclus") %>%
  kable_styling() %>%
  collapse_rows(1)
```

```{r}
catcheffort_missing <- check_catcheffort %>%
  filter(is.na(n_catch)) %>%
  select(visit_id, cluster, poel, is_sample, datum, aantal) %>%
  left_join(select(visits, visit_id, hoofdteller), by = "visit_id") %>%
  arrange(datum)

catcheffort_missing %>%
  write_csv2("../output/kamsalamanderlarve_aantalscheppen_ontbreekt.csv")

catcheffort_missing %>%
  select(-hoofdteller) %>%
  datatable(rownames = FALSE)
```

```{r, fig.height= 9}
check_catcheffort %>%
  filter(is_sample) %>%
  ggplot(aes(x = n_catch, y = poel, colour = periode, shape = periode)) +
  geom_point(alpha = 0.5, size = 4) +
  facet_wrap(~ cluster, scales = "free_y")
```

In onderstaande figuur houden we rekening met de zoekinspanning: aantal larven per 10 scheppen. Maar als er vooral minder geschept wordt omdat het wateroppervlak kleiener is in de 2de meetcyclus, kan dit ook een vertekend beeld geven.

```{r}
datasetset_kamsalamander <- datasetset_kamsalamander %>%
  mutate(n_catch = ifelse(is.na(n_catch) & aantal == 0, 1, n_catch),
        aantal_10catch = aantal / n_catch * 10)

datasetset_kamsalamander %>%
  filter(levensstadium == "larve") %>%
  filter(is_sample) %>%
  filter(!is.na(n_catch)) %>%
  ggplot(aes(x = periode, y = aantal_10catch, colour = is_sample)) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") 

```

```{r}
datasetset_kamsalamander %>%
  filter(levensstadium == "larve") %>%
  filter(is_sample) %>%
  filter(!is.na(n_catch)) %>%
  filter(n_poelen >= 3) %>%
  ggplot(aes(x = periode, y = aantal_10catch, colour = is_sample)) +
  geom_point(alpha = 0.5) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~cluster, scales = "free_y")
```

## Overzicht gemiddeldes per meetcyclus

```{r}
mean_sample <- datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  group_by(levensstadium, periode) %>%
  summarise(mean_count = round(mean(aantal, na.rm = TRUE), 2),
            se = sqrt(var(aantal, na.rm = TRUE)/n()),
            mean_n_catch = round(mean(n_catch, na.rm = TRUE), 2),
            occurence = round(sum(aantal > 0, na.rm = TRUE)/ n(), 2),
            n_bezoeken = n(),
            n_locaties = n_distinct(locatie)) %>%
  ungroup() %>%
  mutate(mean_count = str_c(mean_count, " [", round(mean_count - 1.96 * se, 2), " - ", round(mean_count + 1.96 * se, 2), "]"))

mean_larve_10schep <- datasetset_kamsalamander %>%
  filter(primaire_soort) %>%
  filter(is_sample) %>%
  filter(levensstadium == "larve") %>%
  filter(!is.na(n_catch)) %>%
  group_by(cluster, locatie) %>%
  ungroup() %>%
  group_by(levensstadium, periode) %>%
  summarise(mean_count = round(mean(aantal, na.rm = TRUE), 2),
            se = sqrt(var(aantal, na.rm = TRUE)/n()),
            occurence = round(sum(aantal > 0, na.rm = TRUE)/ n(), 2),
            n_bezoeken = n(),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()  %>%
  mutate(mean_count = str_c(mean_count, " [", round(mean_count - 1.96 * se, 2), " - ", round(mean_count + 1.96 * se, 2), "]")) %>%
  mutate(levensstadium = "larve_per10schep")

mean_sample %>%
  bind_rows(mean_larve_10schep) %>%
  arrange(levensstadium) %>%
  mutate(mean_n_catch = ifelse(levensstadium == "larve", mean_n_catch, NA)) %>%
  select(-se) %>%
  kable %>%
  kable_styling() %>%
  collapse_rows(c(1, 2))
```

## Overzicht gemiddeldes per meetcyclus, enkel locaties die in beide cycli werden geteld

```{r}
mean_sample <- datasetset_kamsalamander %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  filter(paired) %>%
  group_by(levensstadium, periode) %>%
  summarise(mean_count = round(mean(aantal, na.rm = TRUE), 2),
            se = sqrt(var(aantal, na.rm = TRUE)/n()),
            mean_n_catch = round(mean(n_catch, na.rm = TRUE), 2),
            occurence = round(sum(aantal > 0, na.rm = TRUE)/ n(), 2),
            n_bezoeken = n(),
            n_locaties = n_distinct(locatie)) %>%
  ungroup() %>%
  mutate(mean_count = str_c(mean_count, " [", round(mean_count - 1.96 * se, 2), " - ", round(mean_count + 1.96 * se, 2), "]"))

mean_larve_10schep<- datasetset_kamsalamander %>%
  filter(primaire_soort) %>%
  filter(is_sample) %>%
    filter(paired) %>%
  filter(levensstadium == "larve") %>%
  filter(!is.na(n_catch)) %>%
  mutate(aantal = aantal/n_catch * 10) %>%
  group_by(cluster, locatie) %>%
  ungroup() %>%
  group_by(levensstadium, periode) %>%
  summarise(mean_count = round(mean(aantal, na.rm = TRUE), 2),
            se = sqrt(var(aantal, na.rm = TRUE)/n()),
            occurence = round(sum(aantal > 0, na.rm = TRUE)/ n(), 2),
            n_bezoeken = n(),
            n_locaties = n_distinct(locatie)) %>%
  ungroup()  %>%
  mutate(mean_count = str_c(mean_count, " [", round(mean_count - 1.96 * se, 2), " - ", round(mean_count + 1.96 * se, 2), "]")) %>%
  mutate(levensstadium = "larve_per10schep")

mean_sample %>%
  bind_rows(mean_larve_10schep) %>%
  arrange(levensstadium) %>%
  mutate(mean_n_catch = ifelse(levensstadium == "larve", mean_n_catch, NA)) %>%
  select(-se) %>%
  kable %>%
  kable_styling() %>%
  collapse_rows(c(1, 2))
```




<!--chapter:end:2_2_dataverkenning_kamsalamander.Rmd-->


# Dataverkenning Knoflookpad

## Overzicht aantallen

### Meetnet

```{r}

analyseset_roepkoren_knoflookpad <- read_vc(file = "analyseset_roepkoren_knoflookpad", root = "../output/analyseset")

overzicht_meetnet <- analyseset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(hydrofoon, type_aantal, jaar) %>%
  summarise(aantal_gemiddeld = round(mean(aantal), 1)) %>%
  ungroup()

overzicht_meetnet %>%
  mutate(protocol = ifelse(hydrofoon, "hydrofoon gebruikt", "hydrofoon niet gebruikt")) %>%
  ggplot(aes(x = jaar, y = aantal_gemiddeld, colour = type_aantal, group = type_aantal)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ protocol)
  
```

### Per locatie

```{r}
overzicht_locatie <- analyseset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  group_by(hydrofoon, type_aantal, locatie, jaar) %>%
  summarise(aantal_gemiddeld = round(mean(aantal), 1)) %>%
  ungroup()

overzicht_wide <- overzicht_locatie %>%
  arrange(jaar) %>%
  pivot_wider(names_from = "jaar", values_from = aantal_gemiddeld, values_fill = 0)

```

```{r}
overzicht_wide %>%
  arrange(locatie, hydrofoon) %>%
  kable(caption = "gemiddeld aantal geteld per jaar en per locatie") %>%
  kable_styling()
```

```{r fig.height= 5}
overzicht_locatie %>%
  mutate(protocol = ifelse(hydrofoon, "hydrofoon gebruikt", "hydrofoon niet gebruikt")) %>%
  ggplot(aes(x = jaar, y = aantal_gemiddeld, colour = type_aantal, group = type_aantal)) +
  geom_point() +
  geom_line() +
  facet_grid(locatie ~ protocol)
```

Wanneer bij een bezoek wordt aangegeven dat er met hydrofoon werd geteld, kunnen zowel aantallen ingevuld worden zowel met hydrofoon als zonder hydrofoon. 
De aantallen zonder hydrofoon zijn op één telling na allemaal nulwaarnemingen.Gaat hier effectief om nulwaarnemingen of zijn het ontbrekende waarden?  


<!--chapter:end:2_3_dataverkenning_knoflookpad.Rmd-->

# Dataverkenning Vuurslamander

```{r}
analyseset_vuursalamander <- read_vc(file = "analyseset_vuursalamander", root = "../output/analyseset")

analyseset_vuursalamander <- analyseset_vuursalamander %>%
  mutate(aantal_100m = aantal / lengte_transect * 100)
```


## Verschilt meetnetlocatie en niet_meetnetlocatie

```{r}

analyseset_vuursalamander %>%
  ggplot(aes(x = is_sample, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.4) 
  
```

```{r}

analyseset_vuursalamander %>%
  ggplot(aes(x = is_sample, y = aantal_100m, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.4) +
  labs(y = "Aantal per 100 meter")
  
```
## Evolutie aantallen over  de jaren

```{r}
analyseset_vuursalamander %>%
  ggplot(aes(x = jaar, y = aantal, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.4)
```
```{r}

analyseset_vuursalamander %>%
  ggplot(aes(x = jaar, y = aantal_100m, colour = is_sample)) +
  geom_jitter(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.4) +
  labs(y = "Aantal per 100 meter")
  
```
## Aantallen in functie van tijdstip in veldseizoen

```{r}
analyseset_vuursalamander %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal)) +
  geom_point(alpha = 0.2) +
  geom_smooth()

```

```{r}
analyseset_vuursalamander %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal_100m)) +
  geom_point(alpha = 0.2) +
  geom_smooth()

```

```{r}
analyseset_vuursalamander %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  facet_wrap(~jaar)

```

Geen duidelijke patronen.

### Per locatie

```{r, fig.height= 12}

analyseset_vuursalamander %>%
  ggplot(aes(x = jaar, y = aantal, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 0.4, colour = "blue") + 
  labs(y = "Aantal") +
  facet_wrap(~locatie)
  
```



```{r, fig.height= 12}

analyseset_vuursalamander %>%
  ggplot(aes(x = jaar, y = aantal_100m, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(y = "Aantal per 100 meter") +
  facet_wrap(~locatie)
  
```

```{r}
overzicht_locatie <- analyseset_vuursalamander %>%
  group_by(meetnet, locatie, is_sample) %>%
  summarise(aantal_gemiddeld = round(mean(aantal)),
            aantal_100m_gemiddeld = round(mean(aantal_100m), 1),
         n_jaren = n_distinct(jaar)) %>%
  ungroup()
```

```{r}
overzicht_locatie %>%
  datatable(rownames = FALSE,
            filter = "top")
```










<!--chapter:end:2_4_dataverkenning_vuursalamander.Rmd-->


# Dataverkenning Heikikker

```{r}

analyseset_heikikker <- read_vc(file = "analyseset_heikikker", root = "../output/analyseset")

analyseset_heikikker <- analyseset_heikikker %>%
  select(meetnet, protocol, locatie, cluster, meetcyclus, datum, visit_id, hoofdteller, bezoekvariabele, waarde, aantal) %>%
  pivot_wider(names_from = bezoekvariabele,
              values_from = waarde) %>%
  rename(aantal_totaal = "Aantal eiklompen totaal", aantal_bemonsterd = "Aantal eiklompen bemonsterd", aandeel_doelsoort = "Procentueel aandeel doelsoort", staalcode = Staalcode, aantal_doelsoort = aantal) %>%
  mutate(jaar = year(datum),
         aantal_bemonsterd = as.numeric(aantal_bemonsterd),
         aantal_totaal = as.numeric(aantal_totaal),
         aantal_doelsoort = as.numeric(aantal_doelsoort),
         aandeel_doelsoort = as.numeric(aandeel_doelsoort),
         staalcode = ifelse(staalcode == "", NA, staalcode),
         aantal_doelsoort = ifelse(!is.na(staalcode) & is.na(aandeel_doelsoort), NA, aantal_doelsoort),
         staalname = !is.na(staalcode),
         resultaat_ingevoerd = ifelse(staalname, !is.na(aandeel_doelsoort), NA)) %>%
  arrange(datum)

analyseset_heikikker_check <- analyseset_heikikker %>%
  mutate(opmerking = ifelse(staalcode %in% c("2021HK016", "2021HK020", "2021HK057"), "Aandeel doelsoort = 0 invullen in meetnetten.be", NA),
         opmerking = ifelse(staalname & is.na(aantal_bemonsterd), "Aantal bemonsterd niet ingevoerd in meetnetten.be", opmerking),
         opmerking = ifelse(!staalname & is.na(aantal_totaal), "Aantal totaal = 0 invullen in meetnetten.be", opmerking),
         opmerking = ifelse(staalname & aantal_totaal == 0, "Staal van 0 eiklompen??", opmerking),
         opmerking = ifelse(staalcode == "2021HK015" & !is.na(staalcode), "Staal dubbel ingevoerd", opmerking)) %>%
  mutate(link = str_c("https://www.meetnetten.be/fieldwork/visits/", visit_id))

#write_csv2(analyseset_heikikker_check, "../output/datacontole_meetnet_heikikker.csv", na = "")
```

Er ontbreken nog veel resultaten van de DNA-analyses ('aandeel doelsoort'). 
We stellen voorlopig de ontbrekende waarden voor aandeel doelsoort gelijk aan het gemiddeld aandeel doelsoorten op basis van de resultaten die wel al beschikbaar zijn.

```{r}
overzicht_heikikker <- analyseset_heikikker %>%
  mutate(aandeel_doelsoort_gemiddeld = mean(aandeel_doelsoort, na.rm = TRUE),
         aandeel_doelsoort = ifelse(is.na(aandeel_doelsoort), aandeel_doelsoort_gemiddeld, aandeel_doelsoort),
         aantal_doelsoort_calc = ifelse(staalname, aantal_totaal * aandeel_doelsoort/100, aantal_doelsoort)) 

overzicht_heikikker_locatie <- overzicht_heikikker %>%
  mutate(jaar = year(datum)) %>%
  group_by(meetnet, protocol, locatie, cluster, meetcyclus, jaar) %>%
  summarise(staalname = any(staalname),
            aantal_doelsoort = sum(aantal_doelsoort_calc)) %>%
  ungroup() %>%
  mutate(aanwezig = aantal_doelsoort > 0)

overzicht_heikikker_cluster <- overzicht_heikikker_locatie %>%
  group_by(meetnet, protocol, cluster, meetcyclus, jaar) %>%
  summarise(staalname = any(staalname),
            aantal_doelsoort = sum(aantal_doelsoort)) %>%
  ungroup() %>%
  mutate(aanwezig = aantal_doelsoort > 0)
```
We sommeren de aantallen per locatie.

```{r}
overzicht_heikikker_locatie %>%
  group_by(meetnet, meetcyclus) %>%
  summarise(n_locaties = n_distinct(locatie), 
            n_clusters = n_distinct(cluster),
            prop_locatie_aanwezig = round(mean(aanwezig), 2),
            aantal_doelsoort_gem = round(mean(aantal_doelsoort))) %>%
  ungroup() %>%
  pivot_longer(cols = c("n_locaties", "n_clusters", "prop_locatie_aanwezig", "aantal_doelsoort_gem"), names_to = "parameter", values_to = "waarde") %>%
  kable(caption = "Overzicht meetcyclus") %>%
  kable_styling() %>%
  collapse_rows(c(1,2))

```

```{r}
overzicht_heikikker_locatie %>%
  group_by(meetnet, jaar) %>%
  summarise(n_locaties = n_distinct(locatie), 
            n_clusters = n_distinct(cluster),
            prop_locatie_aanwezig = round(mean(aanwezig), 2),
            aantal_doelsoort_gem = round(mean(aantal_doelsoort))) %>%
  ungroup() %>%
  pivot_longer(cols = c("n_locaties", "n_clusters", "prop_locatie_aanwezig", "aantal_doelsoort_gem"), names_to = "parameter", values_to = "waarde") %>%
  kable(caption = "Overzicht jaren") %>%
  kable_styling() %>%
  collapse_rows(c(1,2))

```

```{r}
overzicht_heikikker_locatie %>%
  ggplot(aes(y = aantal_doelsoort, x = jaar, colour = aanwezig)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.4)
```











<!--chapter:end:2_5_dataverkenning_heikikker.Rmd-->


# Dataverkenning Poelkikker


```{r}

analyseset_poelkikker <- read_vc(file = "analyseset_poelkikker", root = "../output/analyseset")

analyseset_poelkikker <- analyseset_poelkikker %>%
  mutate(soort_nl = ifelse(soort_wet == "Pelophylax lessonae/ kl. esculentus", "Poelkikker/bastaardkikker", soort_nl),
         aanwezig = aantal > 0) 

overzicht_poel_bastaard <- analyseset_poelkikker %>%
  filter(soort_nl != "Meerkikker") %>%
  group_by(meetnet, locatie, cluster, visit_id, datum, jaar, meetcyclus) %>%
  summarise(aantal = sum(aantal)) %>%
  ungroup() %>%
  group_by(meetnet, locatie) %>%
  mutate(aanwezig = sum(aantal) > 0) %>%
  ungroup()

```

```{r}
analyseset_poelkikker %>%
  ggplot(aes(y = aantal, x = factor(jaar), colour = aanwezig)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 1, alpha = 0.4) +
  facet_wrap(~soort_nl, scales = "free_y") +
  labs(x = "jaar")
```




```{r}
overzicht_poel_bastaard %>%
  group_by(meetnet, meetcyclus) %>%
  summarise(n_locaties = n_distinct(locatie), 
            n_clusters = n_distinct(cluster),
            prop_locatie_aanwezig = round(mean(aanwezig), 2),
            aantal_gem = round(mean(aantal))) %>%
  ungroup() %>%
  pivot_longer(cols = c("n_locaties", "n_clusters", "prop_locatie_aanwezig", "aantal_gem"), names_to = "parameter", values_to = "waarde") %>%
  kable(caption = "Overzicht meetcyclus roepkoren Poelkikker + Bastaardkikker") %>%
  kable_styling() %>%
  collapse_rows(c(1,2))

```
```{r}
overzicht_poel_bastaard %>%
  group_by(meetnet, jaar) %>%
  summarise(n_locaties = n_distinct(locatie), 
            n_clusters = n_distinct(cluster),
            prop_locatie_aanwezig = round(mean(aanwezig), 2),
            aantal_gem = round(mean(aantal))) %>%
  ungroup() %>%
  pivot_longer(cols = c("n_locaties", "n_clusters", "prop_locatie_aanwezig", "aantal_gem"), names_to = "parameter", values_to = "waarde") %>%
  kable(caption = "Overzicht per jaar voor roepkoren Poelkikker + Bastaardkikker") %>%
  kable_styling() %>%
  collapse_rows(c(1,2))

```











<!--chapter:end:2_6_dataverkenning_poelkikker.Rmd-->

# Dataverkenning Rugstreeppad

```{r}

analyseset_rugstreeppad <- read_vc(file = "analyseset_rugstreeppad", root = "../output/analyseset")

analyseset_rugstreeppad <- analyseset_rugstreeppad %>%
  filter(primaire_soort) %>%
  group_by(locatie, protocol) %>%
  mutate(paired = n_distinct(meetcyclus) > 1,
         multiple_year = n_distinct(jaar) > 1) %>%
  ungroup() %>%
  mutate(periode = str_c(meetcyclus_start, " - ", meetcyclus_end))
```

## Overzicht tellingen

### Meetnetlocaties

```{r}
overzicht <- analyseset_rugstreeppad %>%
  filter(is_sample) %>%
  group_by(protocol, paired,locatie, periode) %>%
  summarise(n_tellingen = n_distinct(visit_id)) %>%
  ungroup() %>%
  pivot_wider(names_from = "periode", values_from = n_tellingen, values_fill = 0)

```

```{r}
overzicht %>%
  select(locatie, "2019 - 2021", "2022 - 2024", gepaard = paired) %>%
  arrange(locatie) %>%
  kable(caption = "Aantal tellingen per cyclus") %>%
  kable_styling() 
```


### Tijdstip van de tellingen



```{r, fig.height=9}

analyseset_rugstreeppad %>%
  distinct(is_sample, locatie, datum, n_samples) %>%
  ggplot(aes(y = locatie, x = datum, size = n_samples, colour = is_sample)) +
  geom_point(alpha = 0.6) +
  geom_vline(xintercept = as.Date("2022-01-01"), linetype = 2, alpha = 0.5)
```



### Overzicht aantallen

```{r, fig.height= 8}
analyseset_rugstreeppad %>%
  ggplot(aes(x = jaar, y = aantal, colour = is_sample)) +
  geom_point(alpha = 0.3) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap(~ levensstadium + activiteit, scales = "free_y")
```

```{r}
overzicht_tellingen <- analyseset_rugstreeppad %>%
  mutate(aanwezig = aantal > 0) %>%
  group_by(periode, levensstadium, activiteit) %>%
  summarise(n_locaties = n_distinct(locatie),
            n_bezoeken = n_distinct(visit_id),
            prop_bezoeken_aanwezig = round(mean(aanwezig),2),
            aantal_gemiddeld = mean(aantal),
            aantal_max = max(aantal)) %>%
  ungroup()

overzicht_tellingen %>%
  kable() %>%
  kable_styling()
```



<!--chapter:end:2_7_dataverkenning_rugstreeppad.Rmd-->



# Dataverkenning habitatkenmerken

```{r}
habitatkenmerken_boomkikker_kamsalamander_wide <- read_vc(file = "habitatkenmerken_boomkikker_kamsalamander_wide", root = "../output/analyseset")

habitatkenmerken_rugstreeppad_wide <- read_vc(file = "habitatkenmerken_rugstreeppad_wide", root = "../output/analyseset")
```


## Overzicht tellingen Boomkikker

```{r}
overzicht_boomkikker <- habitatkenmerken_boomkikker_kamsalamander_wide %>%
  filter(meetnet == "Boomkikker") %>%
  mutate(periode = str_c(meetcyclus_start, "-", meetcyclus_end)) %>%
  group_by(is_sample, cluster, poel, periode) %>%
  summarise(n = n_distinct(visit_id),
            telling = str_c(unique(habitatkenmerken_bepaald), collapse = "; ")) %>%
  ungroup()  %>%
  pivot_wider(names_from = "periode", values_from = telling, values_fill = "")

```

```{r, fig.cap = "Overzicht tellingen boomkikker", fig.height=9}

habitatkenmerken_boomkikker_kamsalamander_wide %>%
  filter(meetnet == "Boomkikker") %>%
  ggplot(aes(y = poel, x = datum,  colour = is_sample, shape = habitatkenmerken_bepaald)) +
  geom_point(alpha = 0.6, size = 2) +
  facet_wrap(~cluster, scales = "free_y") +
  geom_vline(xintercept = as.Date("2019-01-01"), linetype = 2) +
  geom_vline(xintercept = as.Date("2022-01-01"), linetype = 2)
```

## Overzicht tellingen Kamsalamander

```{r, fig.cap = "Overzicht tellingen kamsalamander: clusters met minstens 2 poelen", fig.height=9}
habitatkenmerken_boomkikker_kamsalamander_wide %>%
  filter(meetnet == "Kamsalamander") %>%
  group_by(cluster) %>%
  filter(n_distinct(locatie) > 1 & any(is_sample)) %>%
  ungroup() %>%
  ggplot(aes(y = poel, x = datum,  colour = is_sample, shape = habitatkenmerken_bepaald)) +
  geom_point(alpha = 0.6, size = 2) +
  facet_wrap(~cluster, scales = "free_y") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = 2) +
  geom_vline(xintercept = as.Date("2023-01-01"), linetype = 2)
```
```{r, fig.cap = "Overzicht tellingen kamsalamander: overige poelen", fig.height=5}
habitatkenmerken_boomkikker_kamsalamander_wide %>%
  filter(meetnet == "Kamsalamander") %>%
  group_by(cluster) %>%
  filter(n_distinct(locatie) == 1 & any(is_sample)) %>%
  ungroup() %>%
  ggplot(aes(y = locatie, x = datum,  colour = is_sample, shape = habitatkenmerken_bepaald)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = 2) +
  geom_vline(xintercept = as.Date("2023-01-01"), linetype = 2)
```

## Ontbrekende waarden

```{r}

var_habitatkenmerken <- c("ph", "maximale_diepte", "oppervlakte_waterpartij", "permanente_waterkolom", "beschaduwing", "aanwezigheid_vis", "waterkwaliteit")

meting <- function(x)(!(is.na(x) | x %in% c("onbekend", "niet bekeken/niet van toepassing")))

missing_values <- habitatkenmerken_boomkikker_kamsalamander_wide %>% 
  mutate_at(var_habitatkenmerken, meting) %>%
  pivot_longer(cols = var_habitatkenmerken, names_to = "habitatkenmerk", values_to = "meting") 

missing_values_bezoek <- missing_values %>%
  group_by(meetnet, is_sample, habitatkenmerk) %>%
  summarise(prop_opgemeten = round(sum(meting)/n(), 2),
            n_bezoeken = n()) %>%
  ungroup() %>%
  select(meetnet, is_sample, n_bezoeken, everything())

missing_values_locatie <- missing_values %>%
  group_by(meetnet, is_sample, locatie, habitatkenmerk) %>%
  summarise(meting = any(meting)) %>%
  ungroup() %>%
  group_by(meetnet, is_sample, habitatkenmerk) %>%
  summarise(prop_opgemeten = round(sum(meting)/n(), 2),
            n_locaties = n()) %>%
  ungroup() %>%
  select(meetnet, is_sample, n_locaties, everything())
  
```

```{r}
missing_values_bezoek %>%
  kable(caption = "Proportie van de bezoeken met meting voor habitatkenmerk") %>%
  kable_styling() %>%
  collapse_rows(c(1, 2, 3))
```

```{r}
missing_values_locatie %>%
  kable(caption = "Proportie van de locatie met minstens één meting voor habitatkenmerk") %>%
  kable_styling() %>%
  collapse_rows(c(1, 2, 3))
```

## Verkenning variabelen

### Numerieke variabelen

```{r}
habitatkenmerken_boomkikker_kamsalamander_wide <- habitatkenmerken_boomkikker_kamsalamander_wide %>%
  mutate(periode = str_c(meetcyclus_start, "-", meetcyclus_end)) %>%
  mutate(jaar = year(datum))

habitatkenmerken_numeric <- habitatkenmerken_boomkikker_kamsalamander_wide %>%
  select(meetnet, meetcyclus, periode, datum, locatie, is_sample, ph, aanwezigheid_vis, permanente_waterkolom) %>%
  pivot_longer(cols = c("ph", "aanwezigheid_vis", "permanente_waterkolom"),
               names_to = "habitatkenmerk",
               values_to = "waarde")

habitatkenmerken_numeric_periode <- habitatkenmerken_numeric %>%
  filter(!is.na(waarde))
  
habitatkenmerken_numeric_status <- habitatkenmerken_numeric %>%
  filter(!is.na(waarde)) %>%
  group_by(meetnet, locatie) %>%
  filter(datum == max(datum)) %>%
  ungroup()
  
```

```{r, fig.height=6}
habitatkenmerken_numeric_periode %>%
  ggplot(aes(x = periode, y = waarde)) +
  stat_sum(alpha = 0.6) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_grid(habitatkenmerk ~ meetnet, scale = "free") +
  labs(size = "Aantal bezoeken")
  
  
```

```{r, fig.height=6, fig.cap = "Meest recente status per locatie voor aanwezigheid vis (aanwezig = 1, afwezig = 0), permanente waterkolom (ja = 1, nee = 0) en pH"}
habitatkenmerken_numeric_status %>%
  ggplot(aes(x = meetnet, y = waarde)) +
  stat_sum(alpha = 0.6) +
  stat_summary(fun.data = "mean_cl_boot", colour = "red") +
  facet_wrap( ~ habitatkenmerk, scale = "free")
```



### Waterkwaliteit

```{r}


waterkwaliteit_periode <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  group_by(meetnet, periode) %>%
  mutate(n_bezoeken = n(),
         n_meting = sum(!waterkwaliteit %in% c("onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup() %>%
  group_by(meetnet, periode, meetcyclus, n_bezoeken, n_meting, waterkwaliteit) %>%
  summarise(prop = round(n() / n_bezoeken, 2),
            prop_meting = round(n() / n_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()

waterkwaliteit_status <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  filter(!waterkwaliteit %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  group_by(meetnet, locatie) %>%
  filter(datum == max(datum)) %>%
  ungroup() %>%
  group_by(meetnet) %>%
  mutate(n_locaties_meting = n_distinct(locatie)) %>%
  ungroup() %>%
  group_by(meetnet, n_locaties_meting, waterkwaliteit) %>%
  summarise(prop_locatie = round(n() / n_locaties_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()


```

```{r, fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van waterhabitatkwaliteit, inclusief ontbrekende waarden"}
waterkwaliteit_periode %>%
  ggplot(aes(x = periode, y = prop, fill = waterkwaliteit)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```



```{r,fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van waterhabitatkwaliteit, exclusief ontbrekende waarden"}
waterkwaliteit_periode %>%
  filter(!waterkwaliteit %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  ggplot(aes(x = periode, y = prop_meting, fill = waterkwaliteit)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```

```{r}
habitatkenmerken_boomkikker_kamsalamander_wide %>%
  filter(waterkwaliteit == "plas verdwenen of volledig verland") %>%
  select(meetnet, locatie, datum, waterkwaliteit) %>%
  kable() %>%
  kable_styling()
```

```{r, fig.cap= "Meest recente status per locatie"}
waterkwaliteit_status %>%
  ggplot(aes(x = meetnet, y = prop_locatie, fill = waterkwaliteit)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") 
```


### Maximale diepte

```{r}

maximale_diepte_periode <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  group_by(meetnet, periode) %>%
  mutate(n_bezoeken = n(),
         n_meting = sum(!maximale_diepte %in% c("onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup() %>%
  group_by(meetnet, periode, meetcyclus, n_bezoeken, n_meting, maximale_diepte) %>%
  summarise(prop = round(n() / n_bezoeken, 2),
            prop_meting = round(n() / n_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()

maximale_diepte_status <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  filter(!maximale_diepte %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  group_by(meetnet, locatie) %>%
  filter(datum == max(datum)) %>%
  ungroup() %>%
  group_by(meetnet) %>%
  mutate(n_locaties_meting = n_distinct(locatie)) %>%
  ungroup() %>%
  group_by(meetnet, n_locaties_meting, maximale_diepte) %>%
  summarise(prop_locatie = round(n() / n_locaties_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()


```

```{r, fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van maximale_diepte, inclusief ontbrekende waarden"}
maximale_diepte_periode %>%
  ggplot(aes(x = periode, y = prop, fill = maximale_diepte)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```



```{r,fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van maximale_diepte, exclusief ontbrekende waarden"}
maximale_diepte_periode %>%
  filter(!maximale_diepte %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  ggplot(aes(x = periode, y = prop_meting, fill = maximale_diepte)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```

```{r, fig.cap= "Meest recente status per locatie"}
maximale_diepte_status %>%
  ggplot(aes(x = meetnet, y = prop_locatie, fill = maximale_diepte)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") 
```

### Beschaduwing

```{r}

beschaduwing_periode <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  group_by(meetnet, periode) %>%
  mutate(n_bezoeken = n(),
         n_meting = sum(!beschaduwing %in% c("onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup() %>%
  group_by(meetnet, periode, meetcyclus, n_bezoeken, n_meting, beschaduwing) %>%
  summarise(prop = round(n() / n_bezoeken, 2),
            prop_meting = round(n() / n_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()

beschaduwing_status <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  filter(!beschaduwing %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  group_by(meetnet, locatie) %>%
  filter(datum == max(datum)) %>%
  ungroup() %>%
  group_by(meetnet) %>%
  mutate(n_locaties_meting = n_distinct(locatie)) %>%
  ungroup() %>%
  group_by(meetnet, n_locaties_meting, beschaduwing) %>%
  summarise(prop_locatie = round(n() / n_locaties_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()


```

```{r, fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van beschaduwing, inclusief ontbrekende waarden"}
beschaduwing_periode %>%
  ggplot(aes(x = periode, y = prop, fill = beschaduwing)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```



```{r,fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van beschaduwing, exclusief ontbrekende waarden"}
beschaduwing_periode %>%
  filter(!beschaduwing %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  ggplot(aes(x = periode, y = prop_meting, fill = beschaduwing)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```

```{r, fig.cap= "Meest recente status per locatie"}
beschaduwing_status %>%
  ggplot(aes(x = meetnet, y = prop_locatie, fill = beschaduwing)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") 
```

### Oppervlakte waterpartij

```{r}

oppervlakte_waterpartij_periode <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  group_by(meetnet, periode) %>%
  mutate(n_bezoeken = n(),
         n_meting = sum(!oppervlakte_waterpartij %in% c("onbekend", "niet bekeken/niet van toepassing"))) %>%
  ungroup() %>%
  group_by(meetnet, periode, meetcyclus, n_bezoeken, n_meting, oppervlakte_waterpartij) %>%
  summarise(prop = round(n() / n_bezoeken, 2),
            prop_meting = round(n() / n_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()

oppervlakte_waterpartij_status <- habitatkenmerken_boomkikker_kamsalamander_wide  %>%
  filter(is_sample) %>%
  filter(!oppervlakte_waterpartij %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  group_by(meetnet, locatie) %>%
  filter(datum == max(datum)) %>%
  ungroup() %>%
  group_by(meetnet) %>%
  mutate(n_locaties_meting = n_distinct(locatie)) %>%
  ungroup() %>%
  group_by(meetnet, n_locaties_meting, oppervlakte_waterpartij) %>%
  summarise(prop_locatie = round(n() / n_locaties_meting, 2),
            n = n()) %>%
  ungroup() %>%
  unique()


```

```{r, fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van oppervlakte_waterpartij, inclusief ontbrekende waarden"}
oppervlakte_waterpartij_periode %>%
  ggplot(aes(x = periode, y = prop, fill = oppervlakte_waterpartij)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```



```{r,fig.width=9, fig.cap= "Proportie en aantal voor elke categorie van oppervlakte_waterpartij, exclusief ontbrekende waarden"}
oppervlakte_waterpartij_periode %>%
  filter(!oppervlakte_waterpartij %in% c("onbekend", "niet bekeken/niet van toepassing")) %>%
  ggplot(aes(x = periode, y = prop_meting, fill = oppervlakte_waterpartij)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") +
  facet_wrap(~meetnet, scales = "free_x")
```

```{r, fig.cap= "Meest recente status per locatie"}
oppervlakte_waterpartij_status %>%
  ggplot(aes(x = meetnet, y = prop_locatie, fill = oppervlakte_waterpartij)) + 
  geom_col() +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white") 
```

<!--chapter:end:2_8_dataverkenning_habitatkenmerken.Rmd-->

# Modelverkenning Boomkikker

## Roepkoren

We kiezen voor een mixed model met volgende kenmerken:
+ aantallen in functie van de meetcyclus (niet in functie van jaar, gezien de correlatie tussen cluster en jaar)
+ locatie als random intercept 
+ cluster als random intercept

Locaties met enkel nulwaarnemingen verwijderen we uit de analyseset.

```{r}
locatie_enkel_nulw <- analyseset_boomkikker %>%
  filter(protocol == "roepkoren") %>%
  group_by(meetnet,levensstadium, is_sample, locatie) %>%
  summarise(aantal_totaal = sum(aantal),
            n_bezoeken = n()) %>%
  ungroup() %>%
  filter(aantal_totaal == 0)
  
```
```{r}
locatie_enkel_nulw %>%
  kable(caption = "Locaties met enkel nultellingen voor roepkoren") %>%
  kable_styling()
```

Daarnaast onderzoeken we ook de toevoeging aan het model van volgende zaken:

+ seizonaliteit
+ gewichten voor locaties (bij grote clusters wordt een deel van de poelen geteld, bij kleine clusters alle poelen)
+ random slope voor cluster
+ aantal keer geschept via offset meenemen in model voor larven

```{r}
to_sigma <- function(tau){sqrt(1/tau)}
```

## Seizonaliteit opnemen in model?

### Tijdstip van de tellingen

Onderstaande figuur toont de spreidingen van de tellingen binnen het seizoen.

```{r}
analyseset_roepkoren_boomkikker %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum)) +
  geom_histogram() +
  labs(y = "aantal tellingen")

```

```{r}

analyseset_roepkoren_boomkikker <- analyseset_boomkikker %>%
  filter(protocol == "roepkoren") %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  mutate(periode = factor(periode),
         fdatum = factor(datum)) %>%
  group_by(meetnet, protocol) %>%
  mutate(doy_scaled = doy - min(doy) + 1) %>%
  ungroup() %>%
  mutate(jaar_scaled = jaar - min(jaar) + 1) %>%
  group_by(meetnet, locatie) %>%
  filter(sum(aantal) > 0) %>%
  ungroup()

data_sim_doy_add <- analyseset_roepkoren_boomkikker %>%
  as_tibble() %>%
  tidyr::expand(periode,  doy = full_seq(doy, 1)) %>%
  mutate(doy_scaled = doy - min(doy) + 1) %>%
  mutate(data_type = "simulated_doy")

data_combine <- analyseset_roepkoren_boomkikker %>%
  bind_rows(data_sim_doy_add)

doy_min <- min(data_combine$doy)

# 1st order random walk
indexmodel_iid_doyrw1 <- inla(formula = aantal ~ periode  + 
                                f(doy_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

# 2nd order random walk
indexmodel_iid_doyrw2 <- inla(formula = aantal ~ periode  + 
                                f(doy_scaled, 
                                  model = "rw2",
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

# 2nd order random walk variant
indexmodel_iid_doyrw2_bis <- inla(formula = aantal ~ periode  + 
                                f(doy_scaled, 
                                  model = "rw2",
                                  replicate = jaar_scaled, #variabele die groepen definieert --> bv. integer v jaar, of combinatie cluster en meetcyclus
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

# random effect datum
indexmodel_iid_datum <- inla(formula = aantal ~ periode  + 
                                f(fdatum, 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

# basismodel
indexmodel_iid <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

```

+ random effect voor datum, met sterke prior (bv. probabiliteit sigma > log(1.05) kleiner dan 5%)



### Verband tussen aantallen en datum

```{r}
analyseset_roepkoren_boomkikker %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal)) +
  geom_point(alpha = 0.4) +
  geom_smooth() +
  labs("aantal roepende adulten")
```

```{r}
analyseset_roepkoren_boomkikker %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal, group = periode, colour = periode)) +
  geom_point(alpha = 0.4) +
  geom_smooth() +
  labs("aantal roepende adulten")
```

### Modelering seizonaliteit via random walk

```{r}
results_seizoenseffect <- tibble(seizoenseffect = c("rw1 doy_scaled", "rw2 doy_scaled", "random intercept datum", "rw2 replicate jaar doy_scaled", "geen seizoenseffect"),
       sigma_rw = c(indexmodel_iid_doyrw1$marginals.hyperpar$`Precision for doy_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                         indexmodel_iid_doyrw2$marginals.hyperpar$`Precision for doy_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid_datum$marginals.hyperpar$`Precision for fdatum` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid_doyrw2_bis$marginals.hyperpar$`Precision for doy_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                         NA),
       waic = c(indexmodel_iid_doyrw1$waic$waic, 
                indexmodel_iid_doyrw2$waic$waic,
                indexmodel_iid_datum$waic$waic,
                indexmodel_iid_doyrw2_bis$waic$waic,
                indexmodel_iid$waic$waic))

results_seizoenseffect %>%
  kable() %>%
  kable_styling()
       
```

```{r}
sigma_rw1_est <- indexmodel_iid_doyrw1$marginals.hyperpar$`Precision for doy_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_doyrw1$summary.random$doy_scaled %>%
  select(doy_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(doy = doy_scaled - 1 + doy_min,
         datum = as.Date(doy, origin = "2018-01-01")) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = datum, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw1 =" ~ .(round(sigma_rw1_est, 3))),
        y = "relative effect")
```



```{r}
sigma_rw2_est <- indexmodel_iid_doyrw2$marginals.hyperpar$`Precision for doy_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_doyrw2$summary.random$doy_scaled %>%
  select(doy_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(doy = doy_scaled - 1 + doy_min,
         datum = as.Date(doy, origin = "2018-01-01")) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = datum, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw2 =" ~ .(round(sigma_rw2_est, 4))),
        y = "relative effect")
```

```{r}
sigma_rw2bis_est <- indexmodel_iid_doyrw2_bis$marginals.hyperpar$`Precision for doy_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_doyrw2_bis$summary.random$doy_scaled %>%
  select(doy_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
   mutate(doy = doy_scaled - 1 + doy_min,
         datum = as.Date(doy, origin = "2018-01-01")) %>%
  mutate(jaar = c(rep(2016, 46), rep(2017, 46), rep(2018, 46), rep(2019, 46), rep(2020, 46), rep(2021, 46))) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = datum, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw2 =" ~ .(round(sigma_rw2bis_est, 4))),
        y = "relative effect") +
  facet_wrap(~jaar)

check <- indexmodel_iid_doyrw2_bis$summary.random$doy_scaled  %>%
  mutate(jaar = c(rep(2016, 46), rep(2017, 46), rep(2018, 46), rep(2019, 46), rep(2020, 46), rep(2021, 46)))
```


```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid_doyrw1$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid_doyrw1$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid_doyrw1$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated_doy") %>%
  select(periode, doy, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_roepkoren_boomkikker, aantal_obs = aantal, doy, periode), by = c("doy", "periode")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = doy)) +
  facet_wrap(~periode)
```

+ geen duidelijke seizonaliteit in data
+ bij gemodelleerde seizonaliteit bevat betrouwbaarheidsinterval van relatief effect steeds 1 (geen relatief verchil in aantallen tussen dagen)

Conclusie: seizonaliteit niet meenemen in model.

## Random slope

```{r, fig.height= 6}

analyseset_roepkoren_boomkikker %>%
  ggplot(aes(x = periode, y = aantal)) +  
  geom_boxplot() +
  facet_wrap(~ cluster, scale = "free_y") +
  labs(y = "Aantal roepende mannetjes", x = "Meetcyclus") +
  theme(legend.position = "bottom") 
```


```{r}

data_sim_cluster_add <- analyseset_roepkoren_boomkikker %>%
  as_tibble() %>%
  tidyr::expand(nesting(meetcyclus, periode),  cluster) %>%
  mutate(data_type = "simulated_cluster")

data_combine <- analyseset_roepkoren_boomkikker %>%
  mutate(data_type = "observations") %>%
  bind_rows(data_sim_cluster_add) %>%
  mutate( cluster2 = cluster,
         meetcyclus_scaled = meetcyclus - 1)

trendmodel_iid <- inla(formula = aantal ~ meetcyclus_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2 <- inla(formula = aantal ~ meetcyclus_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  meetcyclus_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid2 <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  meetcyclus_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_interaction <- inla(formula = aantal ~ periode*cluster2  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))), 
                       family = "nbinomial",
                       data = data_combine,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))


```


```{r}

data_predict_random_slope <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_interaction$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_interaction$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_interaction$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated_cluster") %>%
  select(periode, meetcyclus, cluster, fitted_mean, fitted_0.025quant, fitted_0.975quant) 

data_predict_random_slope %>%
  left_join(select(analyseset_roepkoren_boomkikker, aantal_obs = aantal, cluster, periode), by = c("cluster", "periode")) %>%
  ggplot(aes(y = fitted_mean, x = periode,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_point(size = 4, colour = "red", alpha = 0.3) +
  geom_errorbar(alpha = 0.3, colour = "red") +
  facet_wrap(~cluster, scales = "free_y") 
```

```{r}
overview_results <- bind_rows(
  trendmodel_iid2$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "trendmodel_iid2",
           waic = trendmodel_iid2$waic$waic),
  trendmodel_iid$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "trendmodel_iid",
           waic = trendmodel_iid$waic$waic),
  indexmodel_iid$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_iid",
           waic = indexmodel_iid$waic$waic),
  indexmodel_iid2$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_iid2",
           waic = indexmodel_iid2$waic$waic),
  indexmodel_interaction$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_interaction",
           waic = indexmodel_interaction$waic$waic)
) %>%
  select(model, waic, parameter, mean, `0.025quant`, `0.975quant` )

overview_results %>%
  kable() %>%
  kable_styling %>%
  collapse_rows(c(1,2))
```

```{r}

get_trend_mean <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame()
  
} 

get_trend_quantiles <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
} 

trend_cluster_mean <- map_df(trendmodel_iid2$marginals.random$cluster2, get_trend_mean) 

trend_cluster_quantiles <- map_df(trendmodel_iid2$marginals.random$cluster2, get_trend_quantiles) %>%
  mutate(cluster = unique(data_sim_cluster_add$cluster)) %>%
  bind_cols(trend_cluster_mean)

```

```{r, fig.cap= "Schatting en classificatie van trend per locatie met 90%-betrouwbaarheidsinterval"}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- trend_cluster_quantiles %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) * 100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) * 100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c( -50, -25, 0, 33, 100)/100 + 1)
labels_show <- str_c(c( -50, -25, 0, 33, 100), " %")

volgorde_clusters <- (trend %>%
  arrange(mean))$cluster

trend %>%
  mutate(cluster = factor(cluster, levels = volgorde_clusters)) %>%
  ggplot( aes(x = cluster, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 + 1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "cluster") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```
## Gewichten

+ gewichten voor clusterts?

```{r}

gewichten <- locatie_clusters %>%
  st_drop_geometry() %>%
  filter(is_active) %>%
  group_by(cluster) %>%
  summarise(n = n_distinct(poel),
            n_sample = sum(is_sample)) %>%
  ungroup() %>%
  mutate(weight = n/n_sample)
  
analyseset_roepkoren_boomkikker <- analyseset_roepkoren_boomkikker %>%
  left_join(gewichten, by = "cluster") 

```

```{r}
gewichten %>%
  kable(digits = 2) %>%
  kable_styling()
```

## Validatie

```{r}
indexmodel_iid <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))
```

## Dispersion

```{r}
plot(dispersion_check(indexmodel_iid))
```
## Distribution

```{r}
plot(fast_distribution_check(indexmodel_iid))
```
## Random effect


### Location

```{r}

 precision_location <- indexmodel_iid$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```

### Cluster

```{r}

 precision_cluster <- indexmodel_iid$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```

<!--chapter:end:3_1_modelverkennin_boomkikker.Rmd-->

# Modelverkenning larven Boomkikker en Kamsalamander

```{r}
analyseset_larven <- read_vc(file = "analyseset_larven", root = "../output/analyseset")

analyseset_larven <- analyseset_larven %>%
  filter(primaire_soort) %>%
  filter(larvetelling) %>%
  filter(is_sample) %>%
  filter(levensstadium == "larve") %>%
  mutate(meetcyclus = str_c(meetcyclus_start, meetcyclus_end, sep = "_"),
         jaar_scaled = jaar - min(jaar) + 1) %>%
  mutate(n_catch = ifelse(is.na(n_catch) | n_catch == 0, 1, n_catch),
         n_10catch = round(n_catch/10, 1)) 

analyseset_larven_boomkikker <- analyseset_larven %>%
  filter(meetnet == "Boomkikker") %>%
  mutate(occurence = ifelse(aantal > 0, 1, 0)) %>%
  filter(jaar <= 2021)

analyseset_larven_boomkikker_all <- analyseset_larven %>%
  filter(meetnet == "Boomkikker") %>%
  mutate(occurence = ifelse(aantal > 0, 1, 0)) 

overzicht <- analyseset_larven_boomkikker %>%
  mutate(weight = 1/n_10catch) %>%
  group_by(meetcyclus) %>%
  summarise(mean_occurence = mean(occurence),
            mean_aantal = mean(aantal),
            mean_aantal_10catch = mean(aantal/n_10catch),
            mean_n_10catch = mean(n_10catch)) %>%
  ungroup()
```


## Boomkikker

```{r}
to_sigma <- function(tau){sqrt(1/tau)}
```

```{r}
indexmodel_larven_iid_offset <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_10catch,
                       data = analyseset_larven_boomkikker,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_larven_iid <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",data = analyseset_larven_boomkikker,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_larven_iid_offset_jaar <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) +  
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_10catch,
                       data = analyseset_larven_boomkikker_all,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

summary(indexmodel_larven_iid_offset_jaar)

result_boomkikker_meetcyclus_offset <- derive_index_meetcyclus_inla(analyseset_larven_boomkikker, indexmodel_larven_iid_offset)
result_boomkikker_meetcyclus <- derive_index_meetcyclus_inla(analyseset_larven_boomkikker, indexmodel_larven_iid)
result_boomkikker_jaar_offset <- derive_index_rw_inla(analyseset_larven_boomkikker_all, indexmodel_larven_iid_offset_jaar)
```

```{r}
indexmodel_occurence_iid_offset <- inla(formula = occurence ~ 0 + meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "binomial",
                       data = analyseset_larven_boomkikker,
                       offset = n_10catch,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE),
                       quantiles = c(0.025, 0.05, 0.5, 0.95, 0.975))

indexmodel_occurence_iid <- inla(formula = occurence ~ 0 + meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "binomial",
                       data = analyseset_larven_boomkikker,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE),
                       quantiles = c(0.025, 0.05, 0.5, 0.95, 0.975))

# summary(indexmodel_occurence_iid_offset)
#periode1
# # plogis(-0.197)
# # [1] 0.4509087
#periode2
# # plogis(-0.838)
# # 0.3019562

# summary(indexmodel_occurence_iid)
#periode1
# > plogis(1.337)
# [1] 0.7919962
#periode2
# > plogis(0.33)
# [1] 0.5817594
```


## Validatie



## Dispersion

```{r}
plot(dispersion_check(indexmodel_larven_iid_offset))
```
## Distribution

```{r}
plot(fast_distribution_check(indexmodel_larven_iid_offset))
```
## Random effect


### Location

```{r}

 precision_location <- indexmodel_larven_iid_offset$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```

### Cluster

```{r}

 precision_cluster <- indexmodel_larven_iid_offset$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```

<!--chapter:end:3_1_modelverkennin_larven.Rmd-->

# Modelverkenning Kamsalamander

We kiezen voor een mixed model met volgende kenmerken:
+ aantallen in functie van de meetcyclus (niet in functie van jaar, gezien de correlatie tussen cluster en jaar)
+ locatie als random intercept 
+ cluster als random intercept

Locaties met enkel nulwaarnemingen verwijderen we uit de analyseset.

```{r}
locatie_enkel_nulw <- analyseset_fuiken_totaal %>%
  filter(primaire_soort) %>%
  group_by(meetnet, is_sample, locatie) %>%
  summarise(aantal_totaal = sum(aantal),
            n_bezoeken = n()) %>%
  ungroup() %>%
  filter(aantal_totaal == 0)
  
```
```{r}
locatie_enkel_nulw %>%
  kable(caption = "Locaties met enkel nultellingen voor roepkoren") %>%
  kable_styling()
```

Daarnaast onderzoeken we ook of we volgende zaken toevoegen aan model:
+ modellering seizonaliteit
+ toevoegen van gewichten voor locaties (bij grote clusters wordt een deel van de poelen geteld, bij kleine clusters alle poelen)
+ random slope voor cluster
+ aantal keer geschept via offset meenemen in model voor larven

```{r}
to_sigma <- function(tau){sqrt(1/tau)}
```

## Seizonaliteit opnemen in model?

### Tijdstip van de tellingen

```{r}

analyseset_fuiken_totaal <- analyseset_fuiken_totaal %>%
  filter(is_sample) %>%
  #filter(paired) %>%
  filter(primaire_soort) %>%
  mutate(periode = str_c(meetcyclus_start, " - ", meetcyclus_end)) %>%
  mutate(periode = factor(periode),
         fdatum = factor(datum)) %>%
  group_by(meetnet, protocol) %>%
  mutate(doy_scaled = doy - min(doy) + 1) %>%
  ungroup() %>%
  mutate(year_scaled = jaar - min(jaar) + 1) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)

check <- analyseset_fuiken_totaal %>%
  group_by(protocol, periode, is_sample,  paired) %>%
  summarise(n = n_distinct(locatie))

data_sim_doy_add <- analyseset_fuiken_totaal %>%
  as_tibble() %>%
  tidyr::expand(periode,  doy = full_seq(doy, 1)) %>%
  mutate(doy_scaled = doy - min(doy) + 1) %>%
  mutate(data_type = "simulated_doy")

data_combine <- analyseset_fuiken_totaal %>%
  bind_rows(data_sim_doy_add)

doy_min <- min(data_combine$doy)

indexmodel_iid_doyrw1 <- inla(formula = aantal ~ periode  + 
                                f(doy_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid_doyrw2 <- inla(formula = aantal ~ periode  + 
                                f(doy_scaled, 
                                  model = "rw2",
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid_doyrw2_bis <- inla(formula = aantal ~ periode  + 
                                f(doy_scaled, 
                                  model = "rw2",
                                  replicate = year_scaled, #variabele die groepen definieert --> bv. integer v jaar, of combinatie cluster en meetcyclus
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid_datum <- inla(formula = aantal ~ periode  + 
                                f(fdatum, 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.01, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

```

+ random effect voor datum, met sterke prior (bv. probabiliteit sigma > log(1.05) kleiner dan 5%)

```{r}
analyseset_fuiken_totaal %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum)) +
  geom_histogram() +
  labs(y = "aantal tellingen")
```
### Verband tussen aantallen en datum

```{r}
analyseset_fuiken_totaal %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal)) +
  geom_point(alpha = 0.4) +
  geom_smooth() +
  labs("aantal")
```

```{r}
analyseset_fuiken_totaal %>%
  mutate(datum = as.Date(doy, origin = "2018-01-01")) %>%
  ggplot(aes(x = datum, y = aantal, group = periode, colour = periode)) +
  geom_point(alpha = 0.4) +
  geom_smooth() +
  labs("aantal")
```
### Modelering seizonaliteit via random walk


```{r}
results_seizoenseffect <- tibble(seizoenseffect = c("rw1 doy_scaled", "rw2 doy_scaled", "random intercept datum", "rw2 replicate jaar doy_scaled", "geen seizoenseffect"),
       sigma_rw = c(indexmodel_iid_doyrw1$marginals.hyperpar$`Precision for doy_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                         indexmodel_iid_doyrw2$marginals.hyperpar$`Precision for doy_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid_datum$marginals.hyperpar$`Precision for fdatum` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid_doyrw2_bis$marginals.hyperpar$`Precision for doy_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                         NA),
       waic = c(indexmodel_iid_doyrw1$waic$waic, 
                indexmodel_iid_doyrw2$waic$waic,
                indexmodel_iid_datum$waic$waic,
                indexmodel_iid_doyrw2_bis$waic$waic,
                indexmodel_iid$waic$waic))

results_seizoenseffect %>%
  kable() %>%
  kable_styling()
       
```

```{r}
sigma_rw1_est <- indexmodel_iid_doyrw1$marginals.hyperpar$`Precision for doy_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_doyrw1$summary.random$doy_scaled %>%
  select(doy_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(doy = doy_scaled -1 + doy_min,
         datum = as.Date(doy, origin = "2018-01-01")) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = datum, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw1 =" ~ .(round(sigma_rw1_est, 3))),
        y = "relative effect")
```
```{r}
sigma_rw2_est <- indexmodel_iid_doyrw2$marginals.hyperpar$`Precision for doy_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_doyrw2$summary.random$doy_scaled %>%
  select(doy_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(doy = doy_scaled -1 + doy_min,
         datum = as.Date(doy, origin = "2018-01-01")) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = datum, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw2 =" ~ .(round(sigma_rw2_est, 4))),
        y = "relative effect")
```




```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid_doyrw2$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid_doyrw2$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid_doyrw2$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated_doy") %>%
  select(periode, doy, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_fuiken_totaal, aantal_obs = aantal, n_fuiken, doy, periode), by = c("doy", "periode")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = doy,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs/n_fuiken, x = doy)) +
  facet_wrap(~periode)
```

## Random slope

```{r, fig.height= 6}
analyseset_fuiken_totaal %>%
  ggplot(aes(x= periode, y = aantal/ n_fuiken)) +  
  geom_boxplot() +
  facet_wrap(~ cluster, scale = "free_y") +
  labs(y = "Aantal adulten per fuik", x = "Meetcyclus") +
  theme(legend.position = "bottom") 
```


```{r}

data_sim_cluster_add <- analyseset_fuiken_totaal %>%
  as_tibble() %>%
  tidyr::expand(nesting(meetcyclus, periode),  cluster) %>%
  mutate(data_type = "simulated_cluster")

data_combine <- analyseset_fuiken_totaal %>%
  mutate(data_type = "observations") %>%
  bind_rows(data_sim_cluster_add) %>%
  mutate( cluster2 = cluster,
         meetcyclus_scaled = meetcyclus - 1)

trendmodel_iid <- inla(formula = aantal ~ meetcyclus_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2 <- inla(formula = aantal ~ meetcyclus_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  meetcyclus_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid2 <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  meetcyclus_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_interaction <- inla(formula = aantal ~ periode*cluster2  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))), 
                       family = "nbinomial",
                       data = data_combine,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))


```


```{r}

data_predict_random_slope <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_interaction$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_interaction$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_interaction$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated_cluster") %>%
  select(periode, meetcyclus, cluster, fitted_mean, fitted_0.025quant, fitted_0.975quant) 

data_predict_random_slope %>%
  left_join(select(analyseset_fuiken_totaal, aantal_obs = aantal, cluster, periode), by = c("cluster", "periode")) %>%
  ggplot(aes(y = fitted_mean, x = periode,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_point(size = 4, colour = "red", alpha = 0.3) +
  geom_errorbar(alpha = 0.3, colour = "red") +
  facet_wrap(~cluster, scales = "free_y") 
```

```{r}
overview_results <- bind_rows(
  trendmodel_iid2$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "trendmodel_iid2",
           waic = trendmodel_iid2$waic$waic),
  trendmodel_iid$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "trendmodel_iid",
           waic = trendmodel_iid$waic$waic),
  indexmodel_iid$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_iid",
           waic = indexmodel_iid$waic$waic),
  indexmodel_iid2$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_iid2",
           waic = indexmodel_iid2$waic$waic)) %>%
  select(model, waic, parameter, mean, `0.025quant`, `0.975quant` )

overview_results %>%
  kable() %>%
  kable_styling %>%
  collapse_rows(c(1, 2), target = 1)
```



```{r}

get_trend_mean <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame()
  
} 

get_trend_quantiles <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
} 

trend_cluster_mean <- map_df(trendmodel_iid2$marginals.random$cluster2, get_trend_mean) 

trend_cluster_quantiles <- map_df(trendmodel_iid2$marginals.random$cluster2, get_trend_quantiles) %>%
  mutate(cluster = unique(data_sim_cluster_add$cluster)) %>%
  bind_cols(trend_cluster_mean)


```




```{r, fig.cap= "Schatting en classificatie van trend per locatie met 90%-betrouwbaarheidsinterval"}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- trend_cluster_quantiles %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) * 100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) * 100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c(-95,-75, -50, -25, 0, 33, 100, 200, 500, 2000)/100 + 1)
labels_show <- str_c(c(-95,-75, -50, -25, 0, 33, 100, 200, 500, 2000), " %")

volgorde_clusters <- (trend %>%
  arrange(mean))$cluster

trend %>%
  mutate(cluster = factor(cluster, levels = volgorde_clusters)) %>%
  ggplot( aes(x = cluster, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 + 1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "cluster") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```

## Enkel gepaarde poelen?

```{r}

analyseset_fuiken_totaal_gepaard <- analyseset_fuiken_totaal %>%
  filter(paired)

check <- analyseset_fuiken_totaal_gepaard %>%
  group_by(meetcyclus) %>%
  summarise(aantal_gemiddeld = mean(aantal),
            aantal_per_fuik_gemiddeld = mean(aantal/n_fuiken)) %>%
  ungroup()

check2 <- analyseset_fuiken_totaal %>%
  group_by(meetcyclus) %>%
  summarise(aantal_gemiddeld = mean(aantal),
            aantal_per_fuik_gemiddeld = mean(aantal/n_fuiken)) %>%
  ungroup()

indexmodel_iid_paired <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal_gepaard,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))
```

```{r}
overview_results <- bind_rows(
  indexmodel_iid$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_iid",
           waic = indexmodel_iid$waic$waic),
  indexmodel_iid_paired$summary.fixed %>%
    rownames_to_column("parameter") %>%
    select(parameter, mean, `0.025quant`, `0.975quant`) %>%
    mutate(model = "indexmodel_iid_paired",
           waic = indexmodel_iid_paired$waic$waic)
)

overview_results %>%
  kable() %>%
  kable_styling()
```


## Gewichten

+ gewichten voor clusters? nee

```{r, eval = FALSE}

gewichten <- locatie_detail %>%
  st_drop_geometry() %>%
  filter(is_active) %>%
  group_by(cluster) %>%
  summarise(n = n_distinct(poel),
            n_sample = sum(is_sample)) %>%
  ungroup() %>%
  mutate(weight = n/n_sample)
  
analyseset_fuiken_totaal <- analyseset_fuiken_totaal %>%
  left_join(gewichten, by = "cluster") 

```

## Validatie model

```{r}
indexmodel_iid <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

analyseset_fuiken_totaal <- analyseset_fuiken_totaal %>%
  mutate(cluster2 = cluster,
         meetcyclus_scaled = meetcyclus - 1)

indexmodel_iid2 <- inla(formula = aantal ~ periode  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  meetcyclus_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))
```

### Dispersion

+ random intercept

```{r}
plot(dispersion_check(indexmodel_iid))
```
+ random intercept en random slope

```{r}
plot(dispersion_check(indexmodel_iid2))
```

### Distribution

```{r}
plot(fast_distribution_check(indexmodel_iid))
```
```{r}
plot(fast_distribution_check(indexmodel_iid2))
```

### Random effect

#### Location

```{r}

 precision_location <- indexmodel_iid$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```
#### Cluster

```{r}

 precision_cluster <- indexmodel_iid$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```

<!--chapter:end:3_2_modelverkenning_kamsalamander.Rmd-->

# Modelverkenning Knoflookpad

We kiezen voor een mixed model met volgende kenmerken:
+ locatie als random intercept 
+ aantal in functie van jaar of jaar als 1ste orde random walk

Daarnaast onderzoeken we ook of we volgende zaken toevoegen aan model:
+ type telling (met of zonder hydrofoon)

```{r}
to_sigma <- function(tau){sqrt(1/tau)}
```

## Alle tellingen of enkel die met hydrofoon?

### Alle tellingen

```{r}

analyseset_knoflookpad <- analyseset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)

data_sim_add <- analyseset_knoflookpad %>%
  as_tibble() %>%
  tidyr::expand(jaar, type_aantal) %>%
  mutate(jaar_scaled = jaar - min(jaar) + 1,
         fjaar = factor(jaar)) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_knoflookpad %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

indexmodel_iid_rw1year <- inla(formula = aantal ~ type_aantal + f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = data_combine,
                       family = "nbinomial",
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid <- inla(formula = aantal ~  fjaar + type_aantal + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = data_combine,
                       family = "nbinomial",
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

```


#### Random walk voor jaar

```{r}
sigma_rw1_est <- indexmodel_iid_rw1year$marginals.hyperpar$`Precision for jaar_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_rw1year$summary.random$jaar_scaled %>%
  select(jaar_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(jaar = jaar_scaled - 1 + min(analyseset_roepkoren_knoflookpad$jaar)) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = jaar, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw1 =" ~ .(round(sigma_rw1_est, 3))),
        y = "relative effect")
```

#### Vergelijking modeloutput met geobserveerde data

+ jaar als 1ste orde random walk

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid_rw1year$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid_rw1year$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid_rw1year$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(jaar, type_aantal, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_roepkoren_knoflookpad, jaar, aantal_obs = aantal, type_aantal), by = c("jaar", "type_aantal")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = jaar,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = jaar, colour = type_aantal), alpha = 0.4) +
  facet_wrap(~type_aantal)
```

+ jaar als factor

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(jaar, type_aantal, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_roepkoren_knoflookpad, jaar, aantal_obs = aantal, type_aantal), by = c("jaar", "type_aantal")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = jaar,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = jaar, colour = type_aantal), alpha = 0.4) +
  facet_wrap(~type_aantal)
```



### Enkel met hydrofoon

```{r}

analyseset_knoflookpad_hydrofoon <- analyseset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  filter(type_aantal == "aantal met hydrofoon") %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)

data_sim_add <- analyseset_knoflookpad_hydrofoon %>%
  as_tibble() %>%
  tidyr::expand(jaar) %>%
  mutate(jaar_scaled = jaar - min(jaar) + 1,
         fjaar = factor(jaar)) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_knoflookpad_hydrofoon %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

indexmodel_iid_rw1year_hydrofoon <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = data_combine,
                       family = "nbinomial",
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid_hydrofoon <- inla(formula = aantal ~  fjaar +
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = data_combine,
                       family = "nbinomial",
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))



```

#### Random walk voor jaar

```{r}
sigma_rw1_est <- indexmodel_iid_rw1year_hydrofoon$marginals.hyperpar$`Precision for jaar_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_rw1year_hydrofoon$summary.random$jaar_scaled %>%
  select(jaar_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(jaar = jaar_scaled - 1 + min(analyseset_knoflookpad_hydrofoon$jaar)) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = jaar, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw1 =" ~ .(round(sigma_rw1_est, 3))),
        y = "relative effect")
```

#### Vergelijking modeloutput met geobserveerde data

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid_rw1year_hydrofoon$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid_rw1year_hydrofoon$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid_rw1year_hydrofoon$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(jaar, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_knoflookpad_hydrofoon, jaar, aantal_obs = aantal), by = c("jaar")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = jaar,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = jaar), alpha = 0.4)
```

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid_hydrofoon$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid_hydrofoon$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid_hydrofoon$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(jaar, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_knoflookpad_hydrofoon, jaar, aantal_obs = aantal), by = c("jaar")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = jaar,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = jaar), alpha = 0.4)
```

## vergelijking modellen

```{r}
overzicht_modellen <- tibble(tellingen = c("alle", "alle", "enkel hydrofoon", "enkel hydrofoon"),
                            jaareffect = c("rw1", "jaar als factor", "rw1", "jaar als factor"),
       sigma_rw = c(indexmodel_iid_rw1year$marginals.hyperpar$`Precision for jaar_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                    NA,
                    indexmodel_iid_rw1year_hydrofoon$marginals.hyperpar$`Precision for jaar_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                    NA),
       waic = c(indexmodel_iid_rw1year$waic$waic, 
                indexmodel_iid$waic$waic,
                indexmodel_iid_rw1year_hydrofoon$waic$waic,
                indexmodel_iid_hydrofoon$waic$waic))

overzicht_modellen %>%
  kable() %>%
  kable_styling()
```

```{r}
compare_index <- bind_rows(
  derive_index_rw_inla(analyseset_species = analyseset_knoflookpad, 
                       inlamodel_rw = indexmodel_iid_rw1year) %>%
    filter(parameter == "index") %>%
    mutate(tellingen = "alle",
           jaareffect = "rw1 jaar"),
  derive_index_inla(analyseset_species = analyseset_knoflookpad, 
                  indexmodel_nbinom_inla = indexmodel_iid) %>%
    mutate(tellingen = "alle",
           jaareffect = "factor jaar"),
  derive_index_rw_inla(analyseset_species = analyseset_knoflookpad_hydrofoon, 
                       inlamodel_rw = indexmodel_iid_rw1year_hydrofoon) %>%
    filter(parameter == "index") %>%
    mutate(tellingen = "enkel hydrofoon",
           jaareffect = "rw1 jaar"),
  derive_index_inla(analyseset_species = analyseset_knoflookpad_hydrofoon, 
                  indexmodel_nbinom_inla = indexmodel_iid_hydrofoon) %>%
    mutate(tellingen = "enkel hydrofoon",
           jaareffect = "factor jaar")
) %>%
  select(tellingen, jaareffect, jaar, ref_jaar, mean, lcl_0.90, ucl_0.90) 
```
```{r}
compare_index %>%
  kable() %>%
  kable_styling() %>%
  collapse_rows(c(1,2))
```

## Trends

```{r, eval=FALSE}
trendmodel_iid <- inla(formula = aantal ~ year_scaled + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_knoflookpad,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid_hydrofoon <- inla(formula = aantal ~ year_scaled +  
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_knoflookpad_hydrofoon,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trend <- bind_rows(
  derive_trend(analyseset_species = analyseset_knoflookpad, trendmodel_nbinom = trendmodel_iid) %>%
    mutate(tellingen = "alle tellingen"),
  derive_trend(analyseset_species = analyseset_knoflookpad_hydrofoon, trendmodel_nbinom = trendmodel_iid_hydrofoon) %>%
    mutate(tellingen = "enkel hydrofoon")) %>%
  select(tellingen, jaar_min, jaar_max, mean, lcl_0.90, ucl_0.90)
  
  
```


## Validatie model

```{r}
indexmodel_iid_rw1year_hydrofoon <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_knoflookpad_hydrofoon,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid_rw1year <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_knoflookpad,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))
```

### Dispersion

+ alle tellingen

```{r}
plot(dispersion_check(indexmodel_iid_rw1year))
```
+ enkel hydrofoon

```{r}
plot(dispersion_check(indexmodel_iid_rw1year_hydrofoon))
```

### Distribution

```{r}
plot(fast_distribution_check(indexmodel_iid_rw1year))
```


```{r}
plot(fast_distribution_check(indexmodel_iid_rw1year_hydrofoon))
```

### Random effect



```{r}

 precision_location <- indexmodel_iid_rw1year$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```

```{r}

 precision_location <- indexmodel_iid_rw1year_hydrofoon$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```

<!--chapter:end:3_3_modelverkenning_knoflookpad.Rmd-->

# Modelverkenning Vuursalamander

We kiezen voor een mixed model met volgende kenmerken:
+ locatie als random intercept 
+ aantal als 1ste orde random walk
+ transectlengte als offset

```{r}
to_sigma <- function(tau){sqrt(1/tau)}
```


```{r}

analyseset_vuursalamander <- analyseset_vuursalamander %>%
  filter(is_sample | locatie %in% c("Heilig-Geestgoed", "Trimpont", "Buggenhoutbos zuid")) %>%
  filter(primaire_soort) %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1,
        year_scaled = jaar_scaled,
        n_100m = round(lengte_transect / 100)) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0) %>%
  filter(jaar <= 2022)

data_sim_add <- analyseset_vuursalamander %>%
  as_tibble() %>%
  tidyr::expand(jaar) %>%
  mutate(jaar_scaled = jaar - min(jaar) + 1,
         fjaar = factor(jaar)) %>%
  mutate(data_type = "simulated")

data_combine <- analyseset_vuursalamander %>%
  mutate(data_type = "observed") %>%
  bind_rows(data_sim_add)

indexmodel_iid_rw1year <- inla(formula = aantal ~  f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = data_combine,
                       family = "nbinomial",
                       offset = n_100m,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_iid <- inla(formula = aantal ~  fjaar + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = data_combine,
                       family = "nbinomial",
                       #offset = n_100m,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

```


## Random walk voor jaar

```{r}
sigma_rw1_est <- indexmodel_iid_rw1year$marginals.hyperpar$`Precision for jaar_scaled` %>%
  inla.emarginal(fun = to_sigma)

indexmodel_iid_rw1year$summary.random$jaar_scaled %>%
  select(jaar_scaled = ID, mean, lcl = `0.025quant`, ucl = `0.975quant`) %>%
  mutate(jaar = jaar_scaled - 1 + min(analyseset_vuursalamander$jaar)) %>%
  mutate_at(c("mean", "lcl", "ucl"), exp) %>%
  ggplot(aes(x = jaar, y = mean, ymin = lcl, ymax = ucl)) +
  geom_ribbon(alpha = 0.2) + 
  geom_line() +
  labs(title = bquote(sigma ~ " rw1 =" ~ .(round(sigma_rw1_est, 3))),
        y = "relative effect")
```

## Vergelijking modeloutput met geobserveerde data

+ jaar als 1ste orde random walk

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid_rw1year$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid_rw1year$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid_rw1year$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(jaar, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_vuursalamander, jaar, aantal_obs = aantal_100m), by = c("jaar")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = jaar,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = jaar), alpha = 0.4)
```

+ jaar als factor

```{r}
data_predict <- data_combine %>%
    mutate(fitted_mean = exp(indexmodel_iid$summary.fitted.values$mean),
         fitted_0.025quant = exp(indexmodel_iid$summary.fitted.values$`0.025quant`),
         fitted_0.975quant = exp(indexmodel_iid$summary.fitted.values$`0.975quant`)) %>%
  filter(data_type == "simulated") %>%
  select(jaar, fitted_mean, fitted_0.025quant, fitted_0.975quant) %>%
  left_join(select(analyseset_vuursalamander, jaar, aantal_obs = aantal_100m), by = c("jaar")) 

data_predict %>%
  ggplot(aes(y = fitted_mean, x = jaar,  ymin = fitted_0.025quant, ymax = fitted_0.975quant)) +
  geom_line() +
  geom_ribbon(alpha = 0.3) +
  geom_point(aes(y = aantal_obs, x = jaar), alpha = 0.4) 
```

```{r}
indexmodel_iid_rw1year_hoofdteller <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(hoofdteller, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = analyseset_vuursalamander,
                       family = "nbinomial",
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))


```



## vergelijking modellen

```{r}
overzicht_modellen <- tibble(jaareffect = c("rw1", "rw1", "jaar als factor"),
                             randomeffect_teller = c("nee", "ja", "nee"),
       sigma_rw = c(indexmodel_iid_rw1year$marginals.hyperpar$`Precision for jaar_scaled` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid_rw1year_hoofdteller$marginals.hyperpar$`Precision for jaar_scaled` %>%
                                 inla.emarginal(fun = to_sigma), NA),
       sigma_loc = c(indexmodel_iid_rw1year$marginals.hyperpar$`Precision for locatie` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid_rw1year_hoofdteller$marginals.hyperpar$`Precision for locatie` %>%
                                 inla.emarginal(fun = to_sigma),
                    indexmodel_iid$marginals.hyperpar$`Precision for locatie` %>%
                                 inla.emarginal(fun = to_sigma)),
       sigma_teller = c(NA,
                    indexmodel_iid_rw1year_hoofdteller$marginals.hyperpar$`Precision for hoofdteller` %>%
                                 inla.emarginal(fun = to_sigma),
                    NA),
       waic = c(indexmodel_iid_rw1year$waic$waic,
                indexmodel_iid_rw1year_hoofdteller$waic$waic,
                indexmodel_iid$waic$waic))

overzicht_modellen %>%
  kable() %>%
  kable_styling()
```

```{r}

fun_2016_2022 <-  function(...) {
        c(exp(fjaar2017), exp(fjaar2018), exp(fjaar2019), exp(fjaar2020), exp(fjaar2021), exp(fjaar2022))
      }

compare_index <- bind_rows(
  derive_index_rw_inla(analyseset_species = analyseset_vuursalamander, 
                       inlamodel_rw = indexmodel_iid_rw1year) %>%
    filter(parameter == "index") %>%
    mutate(jaareffect = "rw1 jaar",
           randomeffect_teller = "nee"),
  derive_index_rw_inla(analyseset_species = analyseset_vuursalamander, 
                       inlamodel_rw = indexmodel_iid_rw1year_hoofdteller) %>%
    filter(parameter == "index") %>%
    mutate(jaareffect = "rw1 jaar",
           randomeffect_teller = "ja"),
  derive_index_inla(analyseset_species = analyseset_vuursalamander, 
                  indexmodel_nbinom_inla = indexmodel_iid,
                  fun = fun_2016_2022) %>%
    mutate(jaareffect = "factor jaar",
           randomeffect_teller = "nee")
) %>%
  select(jaareffect,randomeffect_teller, jaar, ref_jaar, mean, lcl_0.90, ucl_0.90) 
```
```{r}
compare_index %>%
  kable() %>%
  kable_styling() %>%
  collapse_rows(c(1,2))
```



## Trends

Enkel model met random slope runt.

```{r}

#model zonder random slope geeft een error

# trendmodel_iid <- inla(formula = aantal ~ year_scaled + 
#                                 f(locatie, 
#                                   model = "iid", 
#                                   hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
#                        family = "nbinomial",
#                        data = analyseset_vuursalamander,
#                        offset = n_100m,
#                        control.compute = list(config = TRUE, waic = TRUE),
#                        control.predictor = list(compute = TRUE))
# 
# trend <-  derive_trend(analyseset_species = analyseset_vuursalamander, trendmodel_nbinom = trendmodel_iid) 
  

analyseset_vuursalamander <- analyseset_vuursalamander %>%
  mutate(locatie2 = locatie)

trendmodel_iid2 <- inla(formula = aantal ~ year_scaled + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(locatie2,
                                  year_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_100m,
                       data = analyseset_vuursalamander,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2_hoofdteller <- inla(formula = aantal ~ year_scaled + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(hoofdteller, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(locatie2,
                                  year_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_100m,
                       data = analyseset_vuursalamander,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trend <-  derive_trend(analyseset_species = analyseset_vuursalamander, trendmodel_nbinom = trendmodel_iid2) 

trend_hoofdeller <- derive_trend(analyseset_species = analyseset_vuursalamander, trendmodel_nbinom = trendmodel_iid2_hoofdteller) 

trend %>%
  bind_rows(trend_hoofdeller) %>%
  mutate(randomeffect_teller = c("nee", "nee", "ja", "ja")) %>%
  select(randomeffect_teller, parameter, jaar_min, jaar_max, mean, lcl_0.90, ucl_0.90) %>%
  kable() %>%
  kable_styling()
```


```{r}

get_trend_mean <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.zmarginal(silent = TRUE) %>%
    data.frame()
  
} 

get_trend_quantiles <- function(marginals_location) {
  marginals_location %>%
    inla.tmarginal(fun = function(x) (exp(x) - 1) * 100) %>%
    inla.qmarginal(p = c(0.05, 0.20, 0.35, 0.65, 0.80, 0.95)) %>%
    data.frame() %>%
    mutate(type = c("lcl_0.90", "lcl_0.60", "lcl_0.30", "ucl_0.30", "ucl_0.60", "ucl_0.90")) %>%
    spread(key = "type", value = ".")
  
} 

trend_locatie_mean <- map_df(trendmodel_iid2$marginals.random$locatie2, get_trend_mean) 

trend_locatie_quantiles <- map_df(trendmodel_iid2$marginals.random$locatie2, get_trend_quantiles) %>%
  bind_cols(trend_locatie_mean) %>%
  mutate(locatie = unique(analyseset_vuursalamander$locatie))

trend_locatie_teller_mean <- map_df(trendmodel_iid2_hoofdteller$marginals.random$locatie2, get_trend_mean) 

trend_locatie_teller_quantiles <- map_df(trendmodel_iid2_hoofdteller$marginals.random$locatie2, get_trend_quantiles) %>%
  bind_cols(trend_locatie_teller_mean) %>%
  mutate(locatie = unique(analyseset_vuursalamander$locatie))

```

```{r, fig.cap= "Schatting en classificatie van trend per locatie met 90%-betrouwbaarheidsinterval voor model zonder random effect voor teller", fig.height=8}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- trend_locatie_quantiles %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) * 100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) * 100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c( -25, 0, 33)/100 + 1)
labels_show <- str_c(c( -25, 0, 33), " %")

volgorde_locaties <- (trend %>%
  arrange(mean))$locatie

trend %>%
  mutate(locatie = factor(locatie, levels = volgorde_locaties)) %>%
  ggplot( aes(x = locatie, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 + 1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 7, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "cluster") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```

```{r, fig.cap= "Schatting en classificatie van trend per locatie met 90%-betrouwbaarheidsinterval met random effect voor teller", fig.height=8}
klasse_color <- c("++" = inbo_groen, "+" = inbo_groen, "--" = inbo_rood, "-" = inbo_rood, "?+" = inbo_grijsblauw, "?-" = inbo_grijsblauw, "?" = inbo_grijsblauw, "~" = inbo_geelgr, "+~" = inbo_groen, "-~" = inbo_rood, "R" = inbo_grijsblauw)

trend <- trend_locatie_teller_quantiles %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1)) %>%
  mutate(n_jaar = 6,
         treshold_low = round((exp(log(0.75)/(n_jaar - 1)) - 1) * 100, 1),
         treshold_high = round((exp(log(1.33)/(n_jaar - 1)) - 1) * 100, 1)) %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

breaks_log <- log(c( -25, 0, 33)/100 + 1)
labels_show <- str_c(c( -25, 0, 33), " %")

volgorde_locaties <- (trend %>%
  arrange(mean))$locatie

trend %>%
  mutate(locatie = factor(locatie, levels = volgorde_locaties)) %>%
  ggplot( aes(x = locatie, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  geom_hline(aes(yintercept = max(log(treshold_low/100 + 1))), linetype = 3) +
  geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 7, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "cluster") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
```


## Validatie model

```{r}

indexmodel_iid_rw1year <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_100m,
                       data = analyseset_vuursalamander,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))
```

### Dispersion

```{r}
plot(dispersion_check(indexmodel_iid_rw1year))
```


### Distribution

```{r}
plot(fast_distribution_check(indexmodel_iid_rw1year))
```


### Random effect


```{r}

 precision_location <- indexmodel_iid_rw1year$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```



<!--chapter:end:3_4_modelverkenning_vuursalamander.Rmd-->

# Analyse

## Boomkikker roepkoren

### Analyseset

+ enkel meetnetlocaties met totaal aantal waargenomen individuen > 0
+ vergelijking meetcycli: enkel gegevens t.e.m. 2021 (meetcyclus 2016-2018 en 2019-2021)

```{r}
analyseset_roepkoren_boomkikker <- read_vc("analyseset_roepkoren_boomkikker", "../output/analyseset")

analyseset_roepkoren_boomkikker_meetcyclus <-  analyseset_roepkoren_boomkikker %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  group_by(meetnet, locatie) %>%
  filter(sum(aantal) > 0) %>%
  ungroup() %>%
  filter(jaar <= 2021) %>%
  mutate(meetcyclus_scaled = meetcyclus - 1,
         meetcyclus = ifelse(meetcyclus == 1, "2016_2018", "2019_2021"),
         year_scaled = jaar - min(jaar) + 1,
         jaar_scaled = year_scaled,
         cluster2 = cluster)

analyseset_roepkoren_boomkikker_jaar <-  analyseset_roepkoren_boomkikker %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  group_by(meetnet, locatie) %>%
  filter(sum(aantal) > 0) %>%
  ungroup() %>%
  mutate(year_scaled = jaar - min(jaar) + 1,
         jaar_scaled = year_scaled,
         cluster2 = cluster)
```

### Model

+ vergelijking meetcycli
  + meetcyclus als factor
  + random effect voor locatie
  + random effect voor cluster
  
+ vergelijking jaren
  + 1ste orde random walk voor jaar (herschaald)
  + random effect voor locatie
  + random effect voor cluster
  
+ jaarlijkse trend
  + jaar (herschaald) als continue variabele
  + random effect voor locatie
  + random effect voor cluster
  + random slope voor cluster

```{r}

indexmodel_meetcyclus_iid <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker_meetcyclus,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_jaar_rw1_iid <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker_jaar,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2 <- inla(formula = aantal ~ year_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  year_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker_meetcyclus,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

```

### Modeloutput

```{r}

set.seed(54654)
results_index_jaar_boomkikker <- derive_index_rw_inla(analyseset_roepkoren_boomkikker_jaar, indexmodel_jaar_rw1_iid, set_seed = 1231)

set.seed(6821)
results_index_meetcyclus_boomkikker <- derive_index_meetcyclus_inla(indexmodel_nbinom_inla = indexmodel_meetcyclus_iid, 
                                                                    function_eval = function(...) {exp(meetcyclus2019_2021)}, 
                                                                    set_seed =  21354)

set.seed(6778)
results_trend_boomkikker <- derive_trend(analyseset_roepkoren_boomkikker_meetcyclus, trendmodel_iid2)
```
```{r checkreproducible, eval = FALSE}

indexmodel_meetcyclus_iid <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker_meetcyclus,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_jaar_rw1_iid <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker_jaar,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2 <- inla(formula = aantal ~ year_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) + 
                                f(cluster2,
                                  year_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_roepkoren_boomkikker_meetcyclus,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

set.seed(54654)
results_index_jaar_boomkikker_2 <- derive_index_rw_inla(analyseset_roepkoren_boomkikker_jaar, indexmodel_jaar_rw1_iid, set_seed = 1231)

set.seed(6821)
results_index_meetcyclus_boomkikker_2 <- derive_index_meetcyclus_inla(indexmodel_nbinom_inla = indexmodel_meetcyclus_iid, 
                                                                    function_eval = function(...) {exp(meetcyclus2019_2021)}, 
                                                                    set_seed =  21354)

set.seed(6778)
results_trend_boomkikker_2 <- derive_trend(analyseset_roepkoren_boomkikker_meetcyclus, trendmodel_iid2)

check1 <- all.equal(results_index_jaar_boomkikker, results_index_jaar_boomkikker_2)

check2 <- all.equal(results_index_meetcyclus_boomkikker, results_index_meetcyclus_boomkikker_2)

check3 <- all.equal(results_trend_boomkikker, results_trend_boomkikker_2)
```

### Validatie

#### Dispersion

```{r}
plot(dispersion_check(indexmodel_meetcyclus_iid))
```

#### Distribution

```{r}
plot(fast_distribution_check(indexmodel_meetcyclus_iid))
```

#### Random effect

+ Location

```{r}

 precision_location <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```
+ cluster

```{r}

 precision_cluster <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```

## Boomkikker larven

### Analyseset

+ vergelijking meetcycli: enkel gegevens t.e.m. 2021 (meetcyclus 2016-2018 en 2019-2021)

```{r}
analyseset_larven <- read_vc("analyseset_larven", "../output/analyseset")

analyseset_larven <- analyseset_larven %>%
  filter(is_sample) %>%
  filter(primaire_soort) %>%
  filter(levensstadium == "larve") %>%
  mutate(meetcyclus = str_c(meetcyclus_start, "_", meetcyclus_end),
         occurence = ifelse(aantal > 0, 1, 0),
         year_scaled = jaar - min(jaar) + 1,
         jaar_scaled = year_scaled,
         cluster2 = cluster,
         n_10catch = n_catch/10)

analyseset_larven_boomkikker_meetcyclus <-  analyseset_larven %>%
  filter(meetnet == "Boomkikker") %>%
  filter(jaar <= 2021)

analyseset_larven_boomkikker_jaar <-  analyseset_larven %>%
  filter(meetnet == "Boomkikker")
  
overzicht <- analyseset_larven_boomkikker_meetcyclus %>%
  group_by(meetnet, meetcyclus, levensstadium) %>%
  summarise(occurence_mean = mean(occurence)) %>%
  ungroup()
```

### Model

+ vergelijking aantallen meetcycli
  + meetcyclus als factor
  + random effect voor locatie
  + random effect voor cluster
  + aantal 10 scheppen als offset
  
+ vergelijking aantallen jaren
  + 1ste orde random walk voor jaar (herschaald)
  + random effect voor locatie
  + random effect voor cluster
  + aantal 10 scheppen als offset
  
+ vergelijking occurence meetcycli
  + meetcyclus als factor
  + random effect voor locatie
  + random effect voor cluster
  + aantal 10 scheppen als offset?
  

```{r}

indexmodel_meetcyclus_iid <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_larven_boomkikker_meetcyclus,
                       offset = n_10catch,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_jaar_rw1_iid <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_larven_boomkikker_jaar,
                       offset = n_10catch,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

model_occurence_iid <- inla(formula = occurence ~ 0 + meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "binomial",
                       data = analyseset_larven_boomkikker_meetcyclus,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE),
                       quantiles = c(0.025, 0.05, 0.5, 0.95, 0.975))

```

### Modeloutput

```{r}

set.seed(953)

results_index_jaar_boomkikker_larve <- derive_index_rw_inla(analyseset_larven_boomkikker_jaar, indexmodel_jaar_rw1_iid, set_seed = 84562)

set.seed(3297)

results_index_meetcyclus_boomkikker_larve <- derive_index_meetcyclus_inla(analyseset_larven_boomkikker_jaar, indexmodel_meetcyclus_iid, set_seed = 55469)

results_occurence_boomkikker_larve <- model_occurence_iid$summary.fixed %>%
  rownames_to_column("meetcyclus") %>%
  select(meetcyclus, mean, lcl_0.95 = "0.025quant", lcl_0.90 = "0.05quant", ucl_0.95 = "0.975quant", ucl_0.90 = "0.95quant") %>%
  mutate(mean = plogis(mean),
         lcl_0.90 = plogis(lcl_0.90),
         lcl_0.95 = plogis(lcl_0.95),
         ucl_0.90 = plogis(ucl_0.90),
         ucl_0.95 = plogis(ucl_0.95),
         soort_nl = unique(analyseset_larven_boomkikker_meetcyclus$soort_nl),
         soort_wet = unique(analyseset_larven_boomkikker_meetcyclus$soort_nl),
         levensstadium = unique(analyseset_larven_boomkikker_meetcyclus$levensstadium),
         parameter = "occurence") %>%
  select(parameter, soort_nl, soort_wet, levensstadium, everything())

```

### Validatie

#### Dispersion

```{r}
plot(dispersion_check(indexmodel_meetcyclus_iid))
```

#### Distribution

```{r}
plot(fast_distribution_check(indexmodel_meetcyclus_iid))
```

#### Random effect

+ Location

```{r}

 precision_location <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```
+ cluster

```{r}

 precision_cluster <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```


## Kamsalamander fuiken

### Analyseset

+ enkel meetnetlocaties met totaal aantal waargenomen individuen > 0
+ vergelijking meetcycli 2017-2020 en 2021-2023
+ minstens in twee jaar geteld

```{r}
analyseset_fuiken_totaal <- read_vc(file = "analyseset_fuiken_totaal", root = "../output/analyseset")

analyseset_fuiken_totaal <- analyseset_fuiken_totaal %>%
  filter(primaire_soort) %>%
    filter(is_sample) %>%
  group_by(meetnet, locatie) %>%
  mutate(aantal_tot = sum(aantal),
         n_years = n_distinct(jaar)) %>%
  ungroup() %>%
  mutate(meetcyclus_scaled = meetcyclus,
         meetcyclus = ifelse(meetcyclus == 1, "2017_2020", "2021_2023"),
         meetcyclus = ifelse(n_years > 1 & !paired & meetcyclus == "2017_2020" & jaar == 2020, "2021_2023", meetcyclus),
        year_scaled = jaar - min(jaar) + 1,
        jaar_scaled = year_scaled) %>%
  filter(aantal_tot > 0,
         n_years > 1) %>%
  mutate(cluster2 = cluster) 
  
```


### Model

Idem als bij Boomkikker, maar met het aantal fuiken als offset.

```{r}

indexmodel_meetcyclus_iid <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_jaar_iid <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2 <- inla(formula = aantal ~ year_scaled  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(cluster2,
                                  year_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_fuiken_totaal,
                       offset = n_fuiken,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))



```

### Model output

```{r}

set.seed(56487)

results_index_meetcyclus_kamsalamander <- derive_index_meetcyclus_inla(indexmodel_nbinom_inla = indexmodel_meetcyclus_iid, 
                                                                    function_eval = function(...) {exp(meetcyclus2021_2023)}, set_seed = 9332)

set.seed(9865)
results_index_jaar_kamsalamander <- derive_index_rw_inla(analyseset_fuiken_totaal, indexmodel_jaar_iid, set_seed =  123466)

set.seed(556644)
results_trend_kamsalamander <- derive_trend(analyseset_fuiken_totaal, trendmodel_iid2)
```
### Validatie

#### Dispersion

```{r}
plot(dispersion_check(indexmodel_meetcyclus_iid))
```

#### Distribution

```{r}
plot(fast_distribution_check(indexmodel_meetcyclus_iid))
```

#### Random effect

+ Location

```{r}

 precision_location <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```
+ cluster

```{r}

 precision_cluster <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```


## Kamsalamander larven

### Analyseset


```{r}

analyseset_larven_kamsalamander <-  analyseset_larven %>%
  filter(meetnet == "Kamsalamander") %>%
  filter(levensstadium == "larve") %>%
  mutate(meetcyclus = ifelse(jaar <= 2020, "2017_2020", "2021_2023"))
  
```

### Model

Idem larven boomkikker
  
```{r}

indexmodel_meetcyclus_iid <- inla(formula = aantal ~ meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_larven_kamsalamander,
                       offset = n_10catch,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

indexmodel_jaar_rw1_iid <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_larven_kamsalamander,
                       offset = n_10catch,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

model_occurence_iid <- inla(formula = occurence ~ 0 + meetcyclus  + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05))))  + 
                                f(cluster,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "binomial",
                       data = analyseset_larven_kamsalamander,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE),
                       quantiles = c(0.025, 0.05, 0.5, 0.95, 0.975))

```

### Modeloutput

```{r}

set.seed(74564)

results_index_jaar_kamsalamander_larve <- derive_index_rw_inla(analyseset_larven_kamsalamander, indexmodel_jaar_rw1_iid, set_seed = 33254)
  
set.seed(9856)

results_index_meetcyclus_kamsalamander_larve <- derive_index_meetcyclus_inla(indexmodel_nbinom_inla = indexmodel_meetcyclus_iid, 
                                                                    function_eval = function(...) {exp(meetcyclus2021_2023)}, set_seed = 545464)

set.seed(78787)

results_occurence_kamsalamander_larve <- model_occurence_iid$summary.fixed %>%
  rownames_to_column("meetcyclus") %>%
  select(meetcyclus, mean, lcl_0.95 = "0.025quant", lcl_0.90 = "0.05quant", ucl_0.95 = "0.975quant", ucl_0.90 = "0.95quant") %>%
  mutate(mean = plogis(mean),
         lcl_0.90 = plogis(lcl_0.90),
         lcl_0.95 = plogis(lcl_0.95),
         ucl_0.90 = plogis(ucl_0.90),
         ucl_0.95 = plogis(ucl_0.95),
         soort_nl = unique(analyseset_larven_kamsalamander$soort_nl),
         soort_wet = unique(analyseset_larven_kamsalamander$soort_nl),
         levensstadium = unique(analyseset_larven_kamsalamander$levensstadium),
         parameter = "occurence") %>%
  select(parameter, soort_nl, soort_wet, levensstadium, everything())

```
### Validatie

#### Dispersion

```{r}
plot(dispersion_check(indexmodel_meetcyclus_iid))
```

#### Distribution

```{r}
plot(fast_distribution_check(indexmodel_meetcyclus_iid))
```

#### Random effect

+ Location

```{r}

 precision_location <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```
+ cluster

```{r}

 precision_cluster <- indexmodel_meetcyclus_iid$summary.hyperpar$mean[3]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_cluster),
                  precision = precision_cluster,
                  sim_iid = as.numeric(simulate_iid(tau = precision_cluster))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_cluster), 3))))
    
```


## Knoflookpad

### Analyseset

+ enkel tellingen met hydrofoon
+ locaties met totaal aantal waargenomen individuen > 0

```{r}
analyseset_roepkoren_knoflookpad <- read_vc(file = "analyseset_roepkoren_knoflookpad", root = "../output/analyseset")

analyseset_knoflookpad_hydrofoon <- analyseset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  filter(type_aantal == "aantal met hydrofoon") %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1,
        year_scaled = jaar_scaled) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)
```

### Model

+ vergelijking jaren
  + 1ste orde random walk voor jaar (herschaald)
  + random effect voor locatie
  
+ jaarlijkse trend
  + jaar (herschaald) als continue variabele
  + random effect voor locatie

```{r}

analyseset_roepkoren_knoflookpad <- read_vc(file = "analyseset_roepkoren_knoflookpad", root = "../output/analyseset")

analyseset_knoflookpad_hydrofoon <- analyseset_roepkoren_knoflookpad %>%
  filter(primaire_soort) %>%
  filter(type_aantal == "aantal met hydrofoon") %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1,
        year_scaled = jaar_scaled) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0)

indexmodel_iid_rw1year_hydrofoon <- inla(formula = aantal ~ f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = analyseset_knoflookpad_hydrofoon,
                       family = "nbinomial",
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid_hydrofoon <- inla(formula = aantal ~ year_scaled +  
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       data = analyseset_knoflookpad_hydrofoon,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

```
### Modeloutput

```{r}

set.seed(45688)

results_index_knoflookpad <- derive_index_rw_inla(analyseset_species = analyseset_knoflookpad_hydrofoon, 
                       inlamodel_rw = indexmodel_iid_rw1year_hydrofoon, set_seed = 8254)

set.seed(2645)

results_trend_knoflookpad <- derive_trend(analyseset_species = analyseset_knoflookpad_hydrofoon, trendmodel_nbinom = trendmodel_iid_hydrofoon)
```

### Validatie

#### Dispersion

```{r}
plot(dispersion_check(indexmodel_iid_rw1year_hydrofoon))
```

#### Distribution

```{r}
plot(fast_distribution_check(indexmodel_iid_rw1year_hydrofoon))
```

#### Random effect

+ Location

```{r}

 precision_location <- indexmodel_iid_rw1year_hydrofoon$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```

## Vuursalamander

### Analyseset

+ locaties met totaal aantal waargenomen individuen > 0
+ verplichte locaties (is_sample = TRUE) + regelmatig getelde optionele locaties (Heilig-Geestgoed, Trimpont, Buggenhoutbos zuid)

```{r}

analyseset_vuursalamander <- read_vc(file = "analyseset_vuursalamander", root = "../output/analyseset")

analyseset_vuursalamander <- analyseset_vuursalamander %>%
  filter(is_sample | locatie %in% c("Heilig-Geestgoed", "Trimpont", "Buggenhoutbos zuid")) %>%
  filter(primaire_soort) %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1,
        year_scaled = jaar_scaled,
        n_100m = round(lengte_transect / 100),
        locatie2 = locatie) %>%
  group_by(locatie) %>%
  mutate(aantal_totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(aantal_totaal > 0) %>%
  filter(jaar <= 2022)

analyseset_vuursalamander_2018_2022 <- analyseset_vuursalamander %>%
  filter(jaar >= 2018) %>%
  mutate(year_min = min(jaar),
         fjaar = factor(jaar),
        jaar_scaled = jaar - year_min + 1,
        year_scaled = jaar_scaled)
```

### Model

+ vergelijking jaren
  + 1ste orde random walk voor jaar (herschaald)
  + random effect voor locatie
  
+ jaarlijkse trend
  + jaar (herschaald) als continue variabele
  + random effect voor locatie
  + random slope voor locatie

```{r}

indexmodel_iid_rw1year <- inla(formula = aantal ~  f(jaar_scaled, 
                                  model = "rw1", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(0.3, 0.05)))) + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       data = analyseset_vuursalamander,
                       family = "nbinomial",
                       offset = n_100m,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2 <- inla(formula = aantal ~ year_scaled + 
                                f(locatie, 
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(locatie2,
                                  year_scaled,
                                  model = "iid", 
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_100m,
                       data = analyseset_vuursalamander,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

trendmodel_iid2_2018_2022 <- inla(formula = aantal ~ year_scaled +
                                f(locatie,
                                  model = "iid",
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))) +
                                f(locatie2,
                                  year_scaled,
                                  model = "iid",
                                  hyper = list(theta = list(prior = "pc.prec", param = c(1, 0.05)))),
                       family = "nbinomial",
                       offset = n_100m,
                       data = analyseset_vuursalamander_2018_2022,
                       control.compute = list(config = TRUE, waic = TRUE),
                       control.predictor = list(compute = TRUE))

results_trend_vuursalamander_2018_2022 <- derive_trend(analyseset_species = analyseset_vuursalamander_2018_2022, trendmodel_nbinom = trendmodel_iid2_2018_2022)
```
### Modeloutput

```{r}
set.seed(4646422)

results_index_vuursalamander <- derive_index_rw_inla(analyseset_species = analyseset_vuursalamander, 
                       inlamodel_rw = indexmodel_iid_rw1year, set_seed = 7122)

set.seed(845)

results_trend_vuursalamander <- derive_trend(analyseset_species = analyseset_vuursalamander, trendmodel_nbinom = trendmodel_iid2)

set.seed(23784845)

results_trend_vuursalamander_2018_2022 <- derive_trend(analyseset_species = analyseset_vuursalamander_2018_2022, trendmodel_nbinom = trendmodel_iid2_2018_2022)

```


### Validatie

#### Dispersion

```{r}
plot(dispersion_check(indexmodel_iid_rw1year))
```

#### Distribution

```{r}
plot(fast_distribution_check(indexmodel_iid_rw1year))
```

#### Random effect

+ Location

```{r}

 precision_location <- indexmodel_iid_rw1year$summary.hyperpar$mean[2]
  
  iid_checked_plot <- data.frame(sigma = 1/sqrt(precision_location),
                  precision = precision_location,
                  sim_iid = as.numeric(simulate_iid(tau = precision_location))) %>%
    mutate(x_c = sim_iid - mean(sim_iid),
           y = exp(x_c + log(1))) 
  
iid_checked_plot %>%
  mutate(sigma_tekst = str_c("sigma = ", round(sigma, 3))) %>%
  ggplot(aes(x = y)) +
      geom_density() +
      scale_x_continuous("relative effect", labels = scales::percent) +
      labs(title = bquote(sigma ~ " = " ~ .(round(1/sqrt(precision_location), 3))))
    
```


# Resultaten

### Vergelijking aantallen tussen meetcycli

```{r}

results_index_meetcyclus <- results_index_meetcyclus_boomkikker %>%
  mutate(levensstadium = "adult") %>%
  bind_rows(results_index_meetcyclus_kamsalamander %>%
              mutate(levensstadium = "adult"),
            results_index_meetcyclus_boomkikker_larve %>%
               mutate(levensstadium = "larve"),
            results_index_meetcyclus_kamsalamander_larve %>%
               mutate(levensstadium = "larve")) %>%
  mutate(klasse = classification(lcl_0.90, ucl_0.90, threshold = c(0.75, 1.33), reference = 1),
         klasse = format(klasse, type = "markdown")) %>%
  select( soort_nl, soort_wet, levensstadium, meetcyclus_ref, meetcyclus, klasse, mean, lcl_0.90, ucl_0.90) 
  
```

```{r}
results_indexmodel_cyclus_refvalue <- results_index_meetcyclus %>%
  distinct(soort_nl, soort_wet, levensstadium, meetcyclus_ref) %>%
  mutate(meetcyclus = meetcyclus_ref,
        mean = 1,
         klasse = "R") 

results_indexmodel_cyclus_table <- results_index_meetcyclus %>%
  bind_rows(results_indexmodel_cyclus_refvalue) %>%
  mutate(mean_log = log(mean) + 1,
          lcl_0.90_log = log(lcl_0.90) + 1,
         ucl_0.90_log = log(ucl_0.90) + 1)

```


```{r, fig.height = 6}
c(rev(traffic_palette(7)), "grey65", "grey35", "grey50") %>%
  setNames(
    c("++", "+", "+~", "~", "-~", "-", "--", "?+", "?-", "?")
  ) -> klasse_color
klasse_color[4] <- inbo_steun_blauw

breaks_log <- log(c(0.01, 0.1, 0.25, 0.5, 0.75, 1, 1.33, 2, 3, 6)) + 1
labels_show <- str_c(c(-99, -90, -75, -50, -25, 0, 33, 100, 200, 500), " %")

results_indexmodel_cyclus_table %>%
  ggplot(aes(x = meetcyclus, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse)) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_hline(yintercept = log(0.75) + 1, linetype = 3) +
  geom_hline(yintercept = log(1.33) + 1, linetype = 3) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Verschil t.o.v. referentiemeetcyclus", x = "meetcyclus") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show) +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide") +
  facet_wrap(~soort_nl + levensstadium, scales = "free_x")
```

### Vergelijking proportie aanwezig tussen meetcycli

```{r}
results_occurence <- results_occurence_boomkikker_larve %>%
  bind_rows(results_occurence_kamsalamander_larve)

results_occurence %>%
  ggplot(aes(x = meetcyclus, y = mean, ymin = lcl_0.90, ymax = ucl_0.90)) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  facet_wrap(~soort_nl + levensstadium, scales = "free_x") +
  ylim(0,1) +
  scale_y_continuous(labels = scales::percent)
```


## Vergelijking tussen jaren

```{r}
results_index_jaar <- results_index_knoflookpad %>%
  bind_rows(results_index_vuursalamander) %>%
  bind_rows(results_index_jaar_kamsalamander) %>%
  bind_rows(results_index_jaar_boomkikker) %>%
  mutate(levensstadium = "adult") %>%
  bind_rows(results_index_jaar_kamsalamander_larve %>%
              mutate(levensstadium = "larve"),
            results_index_jaar_boomkikker_larve %>%
              mutate(levensstadium = "larve")) %>%
  filter(parameter == "index") %>%
  filter(!is.na(mean)) %>%
  mutate(klasse = classification(lcl_0.90, ucl_0.90, threshold = c(0.75, 1.33), reference = 1),
         klasse = format(klasse, type = "markdown")) %>%
  select( soort_nl, soort_wet, levensstadium, ref_jaar, jaar, klasse, mean, lcl_0.90, ucl_0.90) 

results_indexmodel_jaar_refvalue <- results_index_jaar %>%
  distinct(soort_nl, soort_wet, levensstadium, ref_jaar) %>%
  mutate(jaar = ref_jaar,
        mean = 1,
         klasse = "R") 

result_indexmodel_jaar_table <- results_index_jaar %>%
  bind_rows(results_indexmodel_jaar_refvalue) %>%
  mutate(mean_log = log(mean) + 1,
          lcl_0.90_log = log(lcl_0.90) + 1,
         ucl_0.90_log = log(ucl_0.90) + 1)
```


```{r, fig.height=}
breaks_log <- log(c(0.01, 0.1, 0.25, 0.5, 0.75, 1, 1.33, 2, 3, 6)) + 1
labels_show <- str_c(c(-99, -90, -75, -50, -25, 0, 33, 100, 200, 500), " %")

result_indexmodel_jaar_table %>%
  ggplot(aes(x = jaar, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse)) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  geom_point(size = 7, alpha = 0.6) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_hline(yintercept = log(0.75) + 1, linetype = 3) +
  geom_hline(yintercept = log(1.33) + 1, linetype = 3) +
  geom_text(size = 4, colour = "black") +
  labs(y = "Verschil t.o.v. referentiejaar", x = "jaar") +
  scale_y_continuous(breaks = breaks_log, labels = labels_show) +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide") +
  facet_wrap(~soort_nl + levensstadium, scales = "free")
```



### Trend

```{r}

trend <- results_trend_kamsalamander %>%
  bind_rows(results_trend_boomkikker) %>%
  bind_rows(results_trend_knoflookpad) %>%
  bind_rows(results_trend_vuursalamander) %>%
  bind_rows(results_trend_vuursalamander_2018_2022) %>%
  group_by(soort_nl) %>%
  mutate(periode_tekst = str_c(jaar_min, " - ", jaar_max),
         n_jaar = jaar_max - jaar_min + 1,
         treshold_low = ifelse(parameter == "trend_average", 
                               round((exp(log(0.75)/(n_jaar - 1)) - 1) *100, 1),
                               -25),
         treshold_high = ifelse(parameter == "trend_average", 
                                round((exp(log(1.33)/(n_jaar - 1)) - 1) *100, 1),
                                33)) %>%
  ungroup() %>%
  mutate(klasse = classification_tw(lcl_0.90, ucl_0.90, threshold_low = treshold_low, treshold_high =  treshold_high, reference = 0)) 

```

In Tabel \@ref(tab:tabtrendresultaat) geven we een overzicht van de gemiddelde jaarlijkse trend en de totale trend over de meetnetperiode. We duiden ook aan of de trend al dan niet lineair is. Een lineaire trend betekent dat de jaarlijkse daling of stijging relatief constant is. Bij een niet-lineaire trend fluctueren de aantallen sterk van jaar tot jaar, maar hebben we gemiddeld gezien over de hele tijdsperiode wel een stijging of een daling.

```{r }

overzicht_trend_tabel <- trend %>%
  mutate(trend = round(mean, 0),
         trend_lcl = round(lcl_0.90, 0),
         trend_ucl = round(ucl_0.90, 0),
         trend_tbl = str_c(ifelse(trend > 0, "+", ""),
                           trend, "% (",
                           ifelse(trend_lcl > 0, "+", ""),
                           trend_lcl, "%; ",
                           ifelse(trend_ucl > 0, "+", ""),
                           trend_ucl, "%)")
         ) %>%
  select(parameter, soort_nl, soort_wet, periode_tekst, klasse, trend_tbl) %>%
  spread(key = "parameter", value = "trend_tbl") %>%
  mutate(klasse = as.character(klasse)) %>%
  select("Nederlandse naam" = soort_nl,  Periode = periode_tekst, Klasse = klasse,  "Jaarlijkse wijziging" = trend_average, "Wijziging over de looptijd" = trend_total)

```


```{r tabtrendresultaat, eval = TRUE}

overzicht_trend_tabel %>%
  kable(align = "lcclcc",
        caption = "Jaarlijkse wijziging en wijziging over de looptijd",
      booktabs = TRUE)  %>%
  kable_styling()
```
\needspace{50mm}

De gemiddelde jaarlijkse trend wordt ook visueel voorgesteld in Figuur \@ref(fig:figtrend). De x-as van deze figuur heeft een logaritmische schaal. Een halvering (-50 %) is immers een even sterk effect als een verdubbeling (+100 %). Opnieuw maken we gebruik van de [classificatie](#h:classtrend) zoals besproken in paragraaf \@ref(h:classtrend) met -25 % als ondergrens en +33 % als bovengrens voor de totale trend over de meetperiode. Voor een periode van zes jaar (2016 - 2021) komt de ondergrens overeen met een gemiddelde jaarlijkse trend van -5,6 % en de bovengrens met een gemiddelde jaarlijkse trend van +5,9 %. 

```{r figtrend, fig.cap= str_c("Gemiddelde jaarlijkse trend met 90 \\% betrouwbaarheidsinterval ", legend_klasses, ". De stippellijnen tonen de referentiewaarde (0 \\%), de ondergrens (-6.7 \\%) en de bovengrens (+7.4 \\%) waarop de classificatie gebaseerd is.")}

trend <- trend %>%
  mutate(mean_log = log(mean/100 + 1),
          lcl_0.90_log = log(lcl_0.90/100 + 1),
         ucl_0.90_log = log(ucl_0.90/100 + 1),
         soort_periode = str_c(soort_nl, jaar_min, jaar_max, sep = "_"))

order_trend <- (trend %>%
  filter(parameter == "trend_average") %>%
  arrange(mean))$soort_periode

breaks_log <- log(c( -50, -25, 0, 33, 50)/100 + 1)
labels_show <- str_c(c( -50, -25, 0, 33, 50), " %")

plot <- trend %>%
  filter(parameter == "trend_average") %>%
  mutate(soort_periode = factor(soort_periode, levels = order_trend)) %>%
  #ggplot( aes(x = soort_nl, y = mean/100, ymin = lcl_0.90/100, ymax = ucl_0.90/100, label = klasse, colour = klasse)) +
  ggplot( aes(x = soort_periode, y = mean_log, ymin = lcl_0.90_log, ymax = ucl_0.90_log, label = klasse, colour = klasse)) +
  # geom_hline(aes(yintercept = max(log(treshold_low/100 + 1))), linetype = 3) +
  # geom_hline(aes(yintercept = min(log(treshold_high/100 + 1))), linetype = 3) +
  # geom_hline(aes(yintercept = max(treshold_low/100)), linetype = 3) +
  # geom_hline(aes(yintercept = min(treshold_high/100)), linetype = 3) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_errorbar(width = 0, size = 10, alpha = 0.3) +
  # geom_errorbar(aes(ymin = lcl_0.60/100, ymax = ucl_0.60/100), width = 0, size = 10, alpha = 0.3) +
  # geom_errorbar(aes(ymin = lcl_0.30/100, ymax = ucl_0.30/100), width = 0, size = 10, alpha = 0.3) +
  # stat_effect(threshold = c(treshold_low/100, treshold_high/100), reference = 0, size = 3) +
  # scale_effect() +
  geom_point(size = 7, alpha = 0.6) +
  geom_text(size = 4, colour = "white") +
  labs(y = "Gemiddelde jaarlijkse trend (%)", x = "Soort") +
  #scale_y_continuous(breaks = c(-50, -25, 0, 33, 100)/100, labels = scales::percent, limits = c(-0.6, 1)) +
  scale_y_continuous(breaks = breaks_log, labels = labels_show, limits = c(min(breaks_log), max(breaks_log))) +
  coord_flip() +
  scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide")
# trend -> (exp(x) - 1) * 100
# x -> log(trend/100 + 1)


plot


```

# Resultaten wegschrijven

```{r}
trend %>%
  write_vc(root = "../output/results", file = "results_trendmodel_amfibieën", sorting = c("parameter", "soort_nl", "jaar_min"), strict = FALSE)
```
```{r}
 results_index_jaar %>%
  write_vc(root = "../output/results", file = "results_indexmodel_amfibieën", sorting = c("soort_nl", "levensstadium", "jaar"))
```
```{r}
 results_index_meetcyclus %>%
  write_vc(root = "../output/results", file = "results_indexmodel_meetcyclus_amfibieën", sorting = c("soort_nl", "levensstadium", "meetcyclus"))
```


```{r}
 results_occurence %>%
  write_vc(root = "../output/results", file = "results_occurence_meetcyclus_amfibieën", sorting = c("soort_nl", "levensstadium", "meetcyclus"))
```

<!--chapter:end:4_analyse.Rmd-->

